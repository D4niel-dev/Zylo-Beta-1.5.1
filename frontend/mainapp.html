<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Zylo | Main Window</title>
  <link rel="icon" href="/images/Zylo_icon.ico" type="image/x-icon" />
  <link rel="manifest" href="/js/manifest.webmanifest" />
  <meta name="theme-color" content="#202225" />
  <script src="/files/vendor/tailwindcss.js"></script>
  <link rel="stylesheet" href="/files/style.css">
  <script src="/files/vendor/feather-icons.js"></script>
  <link href="/files/vendor/cropper.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/files/vendor/emoji-mart.css" />
  <script src="/files/vendor/emoji-mart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // Discord-like palette
            'discord-gray-900': '#202225', // Server nav
            'discord-gray-800': '#2f3136', // Channel list
            'discord-gray-700': '#36393f', // Main content
            'discord-gray-600': '#40444b', // Input / Active
            'discord-gray-500': '#4f545c', // User panel
            'discord-gray-400': '#b9bbbe', // Muted text
            'discord-gray-300': '#dcddde', // Normal text
            'discord-blurple': '#5865F2',
          },
          animation: {
            ringPulse: 'ringPulse 4s infinite ease-in-out',
            fadeIn: 'fadeIn 0.5s ease-out',
            slideIn: 'slideIn 0.3s ease-out',
            pop: 'pop 0.3s ease-out'
          },
          keyframes: {
            ringPulse: {
              '0%, 100%': { boxShadow: '0 0 0 0 rgba(88,101,242,0.7)' },
              '50%': { boxShadow: '0 0 0 6px rgba(88,101,242,0)' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideIn: {
              '0%': { transform: 'translateX(-100%)' },
              '100%': { transform: 'translateX(0)' }
            },
            pop: {
              '0%': { transform: 'scale(0.9)', opacity: '0' },
              '100%': { transform: 'scale(1)', opacity: '1' }
            }
          }
        }
      }
    };
  </script>
</head>

<body class="h-[100dvh] flex overflow-hidden">

  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden" onclick="toggleSidebar()"></div>

  <nav
    class="flex-shrink-0 w-18 md:w-20 h-full flex flex-col items-center py-3 space-y-3 overflow-y-auto scrollbar-hide">

    <a id="homeTab" href="#" data-tab="home" onclick="switchTab('home');" class="sidebar-tab active group" title="Home">
      <div class="sidebar-pill"></div>
      <div class="sidebar-icon">
        <i data-feather="home" class="w-6 h-6"></i>
      </div>
    </a>

    <div id="navDivider" class="h-0.5 w-8 bg-discord-gray-700 rounded-full"></div>

    <!-- Groups Section -->
    <div id="groupIconsContainer" class="flex flex-col items-center space-y-3 w-full">
      <!-- Group icons will be dynamically added here -->
    </div>

    <!-- Add Group Button -->
    <button id="addGroupBtn" onclick="showGroupsModal()" class="add-group-btn" title="Add a Group">
      <i data-feather="plus" class="w-6 h-6"></i>
    </button>

    <a id="messagesTab" href="#" data-tab="messages" onclick="switchTab('messages');" class="sidebar-tab group"
      title="Messages">
      <div class="sidebar-pill"></div>
      <div class="sidebar-icon">
        <i data-feather="message-square" class="w-6 h-6"></i>
      </div>
    </a>

    <a href="#" data-tab="profile" onclick="switchTab('profile');" class="sidebar-tab group" title="Profile">
      <div class="sidebar-pill"></div>
      <div class="sidebar-icon">
        <i data-feather="user" class="w-6 h-6"></i>
      </div>
    </a>

    <a href="#" data-tab="explore" onclick="switchTab('explore');" class="sidebar-tab group" title="Explore">
      <div class="sidebar-pill"></div>
      <div class="sidebar-icon">
        <i data-feather="compass" class="w-6 h-6"></i>
      </div>
    </a>
  </nav>

  <aside id="subPanelContainer"
    class="fixed md:static inset-y-0 left-0 z-40 w-64 h-full flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-200 ease-in-out">

    <header class="flex-shrink-0 h-12 shadow-md flex items-center justify-between px-4">
      <h2 id="subPanelTitle" class="text-white font-semibold text-sm truncate">Zylo (Beta)</h2>
      <button onclick="toggleSidebar()" class="md:hidden text-discord-gray-400 hover:text-white">
        <i data-feather="x" class="w-5 h-5"></i>
      </button>
    </header>

    <div
      class="flex-1 overflow-y-auto p-2 space-y-2 scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">

      <div id="sub-panel-home" class="sub-panel-content hidden">
        <h3 class="sub-panel-header">Home</h3>
        <a href="#" onclick="switchTab('home');" class="sub-panel-item active">
          <i data-feather="home" class="w-5 h-5 mr-2"></i> Welcome
        </a>
      </div>

      <div id="sub-panel-profile" class="sub-panel-content hidden">
        <h3 class="sub-panel-header">Profile</h3>
        <a href="#" onclick="switchTab('profile');" class="sub-panel-item">
          <i data-feather="user" class="w-5 h-5 mr-2"></i> My Profile
        </a>
      </div>

      <!-- Group Sub-Panel -->
      <div id="sub-panel-group" class="sub-panel-content hidden flex flex-col h-full">
        <!-- Group Info -->
        <div
          class="p-3 border-b border-discord-gray-900 group cursor-pointer hover:bg-discord-gray-600/30 transition-colors duration-200"
          onclick="openGroupSettings()">
          <h2 id="groupPanelName" class="text-white font-bold text-lg truncate">Group Name</h2>
          <div class="flex items-center text-discord-gray-400 text-xs">
            <span id="groupPanelDesc" class="truncate mr-1">Group description</span>
            <i data-feather="chevron-down" class="w-3 h-3"></i>
          </div>
        </div>

        <!-- Channels List -->
        <div class="flex-1 overflow-y-auto">
          <h3 class="sub-panel-header">Text Channels</h3>
          <div id="groupChannelsList" class="space-y-1">
            <!-- Channels will be added here dynamically -->
          </div>
        </div>

        <!-- Members List -->
        <div class="border-t border-discord-gray-900 p-2">
          <h3 class="sub-panel-header">Members</h3>
          <div id="groupMembersList" class="space-y-1 max-h-32 overflow-y-auto">
            <!-- Members will be added here dynamically -->
          </div>
        </div>
      </div>

      <div id="sub-panel-messages" class="sub-panel-content flex flex-col h-full">
        <!-- Sub-tabs for Messages -->
        <div class="flex border-b border-discord-gray-900 mb-2">
          <button id="btnMessagesTabCommunity" onclick="switchMessagesView('community')"
            class="flex-1 px-3 py-2 text-sm font-medium text-white bg-discord-gray-600/50 border-b-2 border-discord-blurple">
            Community
          </button>
          <button id="btnMessagesTabFriends" onclick="switchMessagesView('friends')"
            class="flex-1 px-3 py-2 text-sm font-medium text-discord-gray-400 hover:text-white">
            Friends
          </button>
        </div>

        <!-- Community View -->
        <div id="messagesViewCommunity" class="flex-1 overflow-y-auto">
          <h3 class="sub-panel-header">Text Channels</h3>
          <button id="btnRoomCommunity" class="sub-panel-item w-full text-left" onclick="switchChatRoom('community')">
            <span class="mr-2">#</span> Community
          </button>
          <button id="btnRoomAI" class="sub-panel-item w-full text-left" onclick="switchChatRoom('ai')">
            <span class="mr-2">#</span> AI Chat
          </button>

          <div id="aiControls" class="hidden text-xs space-y-2 p-2 bg-discord-gray-900/50 rounded-lg mt-2">
            <label for="aiPersonaSelect" class="text-discord-gray-400">Persona</label>
            <select id="aiPersonaSelect"
              class="w-full text-xs bg-discord-gray-700 border border-discord-gray-900 rounded px-2 py-1 text-discord-gray-300"></select>
            <label for="aiModelSelect" class="text-discord-gray-400">Model</label>
            <select id="aiModelSelect"
              class="w-full text-xs bg-discord-gray-700 border border-discord-gray-900 rounded px-2 py-1 text-discord-gray-300"></select>
            <button id="aiClearBtn"
              class="w-full px-2 py-1 rounded bg-discord-gray-600 hover:bg-discord-gray-500 text-white text-xs"
              onclick="clearAiConversation()">Clear Chat</button>
          </div>
        </div>

        <!-- Friends & Groups View -->
        <div id="messagesViewFriends" class="hidden flex-1 overflow-y-auto flex flex-col">
          <div class="p-2 space-y-1">
            <button onclick="showFriendsDashboard()"
              class="sub-panel-item w-full text-left font-semibold text-white bg-discord-gray-600/50">
              <i data-feather="users" class="w-5 h-5 mr-3"></i> Friends
            </button>
          </div>

          <div class="flex-1 overflow-y-auto space-y-1 px-2" id="sidebarDMList">
          </div>

          <div class="p-2 border-t border-discord-gray-900 hidden">
            <button onclick="createGroup()" class="flex items-center text-xs text-discord-gray-400 hover:text-white">
              <i data-feather="plus" class="w-4 h-4 mr-1"></i> Create Group
            </button>
          </div>
        </div>
      </div>

      <!-- Remove old sub-panel-friends, now merged into sub-panel-messages -->

      <div id="sub-panel-profile" class="sub-panel-content hidden">
        <h3 class="sub-panel-header">Profile</h3>
      </div>

      <div id="sub-panel-explore" class="sub-panel-content hidden">
        <h3 class="sub-panel-header">Explore</h3>
      </div>

      <div id="sub-panel-settings" class="sub-panel-content hidden">
        <h3 class="sub-panel-header">User Settings</h3>
        <button type="button" id="tabBtnGeneral" class="settings-tab sub-panel-item w-full text-left"
          data-target="generalSettings">
          General
        </button>
        <button type="button" id="tabBtnSounds" class="settings-tab sub-panel-item w-full text-left"
          data-target="soundSettings">
          Sounds
        </button>
        <button type="button" id="tabBtnAccount" class="settings-tab sub-panel-item w-full text-left"
          data-target="accountSettings">
          My Account
        </button>
        <button type="button" id="tabBtnAbout" class="settings-tab sub-panel-item w-full text-left"
          data-target="aboutSettings">
          About Us
        </button>
      </div>

    </div>

    <div class="flex-shrink-0 h-14 bg-discord-gray-500/30 flex items-center justify-between px-3">
      <div class="flex items-center gap-2 min-w-0">
        <img id="userPanelAvatar" src="/images/default_avatar.png" alt="Avatar" class="w-8 h-8 rounded-full">
        <div class="flex flex-col min-w-0">
          <span id="userPanelUsername" class="text-white text-sm font-semibold truncate">ZyloUser</span>
          <span id="userPanelUsertag" class="text-discord-gray-400 text-xs truncate">@zylo1234</span>
        </div>
      </div>
      <div class="flex items-center">
        <button data-tab="settings" onclick="switchTab('settings')"
          class="p-1 text-discord-gray-400 hover:text-white hover:bg-discord-gray-600/50 rounded" title="Settings">
          <i data-feather="settings" class="w-5 h-5"></i>
        </button>
        <a href="/login.html" class="p-1 text-discord-gray-400 hover:text-red-400 hover:bg-discord-gray-600/50 rounded"
          title="Logout">
          <i data-feather="log-out" class="w-5 h-5"></i>
        </a>
      </div>
    </div>
  </aside>

  <main class="flex-1 flex flex-col h-full min-w-0">

    <header class="flex-shrink-0 h-12 bg-discord-gray-700 shadow-md flex items-center justify-between px-4">
      <div class="flex items-center">
        <button id="mobileMenuBtn" class="p-1 mr-2 text-discord-gray-300 hover:text-white md:hidden"
          onclick="toggleSidebar()">
          <i id="mobileMenuIcon" data-feather="menu" class="w-6 h-6"></i>
        </button>
        <h1 id="main-content-title" class="text-white text-lg font-semibold truncate">Home</h1>
      </div>
    </header>

    <div id="mainContent" class="flex-1 flex flex-col min-h-0 overflow-hidden">

      <section id="tab-home"
        class="tab-content h-full overflow-y-auto p-4 md:p-6 space-y-6 hidden animate-fadeIn scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">

        <div
          class="bg-gradient-to-r from-discord-blurple to-purple-500 p-6 rounded-xl shadow-md text-white text-center">
          <h1 class="text-3xl font-bold mb-2">Welcome to Zylo!</h1>
          <p class="text-sm sm:text-base">Connect. Chat. Share. All in one place!</p>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
          <div class="bg-discord-gray-800 p-4 rounded-xl shadow-lg text-center">
            <p class="text-sm text-discord-gray-400">Friends/Users</p>
            <p class="text-lg font-semibold text-white" id="stat-users">0</p>
          </div>
          <div class="bg-discord-gray-800 p-4 rounded-xl shadow-lg text-center">
            <p class="text-sm text-discord-gray-400">Messages</p>
            <p class="text-lg font-semibold text-white" id="stat-messages">0</p>
          </div>
          <div class="bg-discord-gray-800 p-4 rounded-xl shadow-lg text-center">
            <p class="text-sm text-discord-gray-400">Rooms/Groups</p>
            <p class="text-lg font-semibold text-white" id="stat-rooms">0</p>
          </div>
        </div>

        <div>
          <h2 class="text-xl font-bold mb-2 text-white">üí° Zylo Tips</h2>
          <ul class="space-y-2 text-sm text-discord-gray-300 list-disc list-inside">
            <li>Click the ‚öôÔ∏è icon in the user panel to customize your experience.</li>
            <li>Use the chat tab to connect with your team instantly.</li>
            <li>Upload files, images, or audio directly from the chat.</li>
          </ul>
        </div>

        <div>
          <h2 class="text-xl font-bold mb-2 text-white">üì¢ Announcements</h2>
          <div class="bg-discord-gray-800 p-4 rounded-xl shadow-lg">
            <div class="text-sm text-discord-gray-300 space-y-1">
              <p>üöÄ v1.1 adds Friends and Groups with room chat.</p>
              <p>‚ú® Home quick stats now update from backend.</p>
              <p>ü§ñ Optional AI chat toggle in Chats tab.</p>
            </div>
          </div>
        </div>
      </section>

      <div id="tab-messages" class="tab-content chat-area flex flex-col h-full">
        <div id="chatMessagesCommunity" class="chat-messages"></div>
        <div id="chatMessagesAI" class="chat-messages hidden"></div>

        <div id="typingIndicator" class="typing-indicator"></div>

        <div class="flex-shrink-0 p-4 border-t border-discord-gray-900">
          <div class="flex items-center gap-2 bg-discord-gray-600 rounded-lg p-2">
            <label class="p-2 rounded-full hover:bg-discord-gray-500/70 cursor-pointer transition"
              title="Attach a file">
              <i data-feather="plus-circle" class="w-5 h-5 text-gray-200"></i>
              <input type="file" id="fileInput" class="hidden" onchange="sendFile(event)">
            </label>
            <textarea id="chatInput" placeholder="Message #community" rows="1"
              class="flex-1 bg-transparent border-none text-white resize-none focus:outline-none"
              onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendMessage();}"></textarea>
            <button class="p-2 rounded-full hover:bg-discord-gray-500/70 transition" onclick="openEmojiPicker()"
              title="Pick an emoji">
              <i data-feather="smile" class="w-5 h-5 text-gray-200"></i>
            </button>
            <button onclick="sendMessage()" class="text-discord-gray-400 hover:text-white">
              <i data-feather="send" class="w-5 h-5"></i>
            </button>
            <div id="emojiPicker"
              class="hidden absolute bottom-16 right-4 bg-discord-gray-800 rounded-lg shadow-lg z-50"></div>
          </div>
        </div>
      </div>

      <section id="tab-friends" class="tab-content hidden h-full flex flex-col animate-fadeIn overflow-hidden">

        <div id="friendsDashboard" class="flex flex-col h-full w-full">
          <header
            class="flex-shrink-0 h-12 border-b border-discord-gray-900 p-4 flex items-center gap-4 bg-discord-gray-700">
            <div class="flex items-center gap-2 pr-4 border-r border-discord-gray-600">
              <i data-feather="users" class="text-discord-gray-400"></i>
              <span class="font-bold text-white">Friends</span>
            </div>
            <div class="flex items-center gap-2 text-sm overflow-x-auto scrollbar-hide">
              <button class="friend-toolbar-btn active" onclick="filterFriends('all')">All</button>
              <button class="friend-toolbar-btn" onclick="filterFriends('online')">Online</button>
              <button class="friend-toolbar-btn" onclick="filterFriends('pending')">Pending</button>
              <button class="friend-toolbar-btn add-friend" onclick="filterFriends('add')">Add Friend</button>
            </div>
          </header>

          <div class="flex-1 overflow-y-auto p-4" id="friendsDashboardContent">
          </div>

          <div id="addFriendSection" class="hidden p-6">
            <h2 class="text-white font-bold uppercase mb-2 text-base">Add Friend</h2>
            <p class="text-discord-gray-400 text-sm mb-4">You can add friends with their username.</p>
            <div
              class="flex gap-2 max-w-2xl bg-discord-gray-900/50 p-2 rounded-lg border border-discord-gray-900 focus-within:border-discord-blurple transition">
              <input id="addFriendInputMain" type="text"
                class="bg-transparent border-none flex-1 text-white focus:ring-0 p-2"
                placeholder="Enter a username (e.g. ZyloUser)" />
              <button onclick="requestFriendMain()"
                class="bg-discord-blurple text-white px-4 py-1 rounded hover:bg-opacity-80 text-sm font-medium">Send
                Friend Request</button>
            </div>
          </div>
        </div>

        <div id="friendsChatView" class="hidden flex flex-col h-full w-full">
          <div
            class="flex-shrink-0 h-12 border-b border-discord-gray-900 flex items-center justify-between px-4 bg-discord-gray-700 shadow-sm">
            <div class="flex items-center gap-3">
              <span class="text-discord-gray-400 cursor-pointer md:hidden" onclick="showFriendsDashboard()">
                <i data-feather="arrow-left"></i>
              </span>
              <i data-feather="at-sign" class="text-discord-gray-400 w-5 h-5"></i>
              <span id="chatHeaderTitle" class="font-bold text-white">Username</span>
            </div>
            <div class="flex gap-4 text-discord-gray-400">
              <i data-feather="phone" class="w-5 h-5 hover:text-white cursor-pointer"></i>
              <i data-feather="video" class="w-5 h-5 hover:text-white cursor-pointer"></i>
            </div>
          </div>

          <div id="friendsChatMessages"
            class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin scrollbar-thumb-discord-gray-900">
          </div>

          <div class="p-4 flex-shrink-0">
            <div class="chat-input-container relative flex items-center gap-3 px-4 py-3 bg-discord-gray-600 rounded-lg">
              <label class="cursor-pointer hover:text-white text-discord-gray-400">
                <i data-feather="plus-circle" class="w-5 h-5"></i>
                <input type="file" id="friendsChatFile" class="hidden" onchange="sendFriendFile(event)">
              </label>
              <textarea id="friendsChatInput" rows="1"
                class="chat-input flex-1 bg-transparent border-none focus:ring-0 text-white"
                placeholder="Message @User"></textarea>
              <button onclick="sendFriendMessage()" class="text-discord-blurple hover:text-white transition">
                <i data-feather="send" class="w-5 h-5"></i>
              </button>
              <div id="emojiPicker"
                class="hidden absolute bottom-16 right-4 bg-discord-gray-800 rounded-lg shadow-lg z-50"></div>
            </div>
          </div>
        </div>
      </section>

      <div id="tab-profile"
        class="tab-content h-full overflow-y-auto scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">
        <section id="profileView" class="w-full h-full p-4 md:p-6">
          <div class="profile-card max-w-5xl mx-auto bg-discord-gray-800 rounded-2xl shadow-xl overflow-hidden z-0">

            <div class="profile-banner flex flex-col items-start relative z-10">
              <img id="bannerImage" src="/images/default_banner.png" alt="Banner" class="profile-banner-img banner-img">
              <div class="-mt-16 ml-6">
                <img id="avatarImage" src="/images/default_avatar.png" alt="Avatar"
                  class="profile-avatar avatar-img relative z-30" />
              </div>
            </div>

            <div class="pt-20 px-6 pb-6">
              <h2 id="profileUsername" class="text-2xl font-semibold text-white">ZyloUser</h2>
              <p id="profileUsertag" class="text-discord-gray-400">@zylo1234</p>
              <div class="mt-3 group flex items-center gap-2" style="max-width:70%;">
                <p id="profileBio" class="text-discord-gray-300 truncate max-w-[70%]">This user haven't said anything
                  about them self yet...</p>
                <button id="editBioBtn" title="Edit bio"
                  class="hidden group-hover:inline-flex items-center gap-1 text-discord-gray-400 hover:text-white p-1 rounded"
                  onclick="startEditBio()">
                  <i data-feather="edit-2" class="w-4 h-4"></i>
                </button>
              </div>

              <div id="profileActionButtons" class="mt-5 flex gap-3" style="display: none;">
                <button id="profileMessageBtn" class="bg-discord-blurple hover:bg-opacity-80 px-4 py-2 rounded-lg"
                  onclick="openDMFromProfile()">Message</button>
                <button id="profileAddFriendBtn"
                  class="bg-discord-gray-600 hover:bg-discord-gray-500 px-4 py-2 rounded-lg"
                  onclick="addFriendFromProfile()">Add Friend</button>
              </div>
            </div>

            <div id="profileTabs"
              class="border-t border-discord-gray-700/50 px-6 py-3 flex gap-6 text-discord-gray-400">
              <button class="profile-tab active text-white" data-tab="about">About Me</button>
              <button class="profile-tab" data-tab="servers">Mutual Servers</button>
              <button class="profile-tab" data-tab="friends">Mutual Friends</button>
              <button class="profile-tab" data-tab="effects" onclick="openProfileEffectsModal()">Profile
                Effects</button>
            </div>

            <div id="profileTabContent" class="p-6 text-discord-gray-300">
              <div class="tab-pane" data-tab="about">
                <div id="profileAboutContent">
                  <div class="group flex items-start gap-2">
                    <p id="profileAboutBio" class="text-discord-gray-300 whitespace-pre-wrap">Loading...</p>
                    <button id="editAboutBtn" title="Edit about"
                      class="hidden group-hover:inline-flex items-center gap-1 text-discord-gray-400 hover:text-white p-1 rounded mt-1"
                      onclick="startEditAbout()">
                      <i data-feather="edit-2" class="w-4 h-4"></i>
                    </button>
                  </div>
                </div>
                <div class="tab-pane hidden" data-tab="servers">
                  <p>No mutual servers to show.</p>
                </div>
                <div class="tab-pane hidden" data-tab="friends">
                  <p id="mutualFriendsContent">No mutual friends to show.</p>
                </div>
              </div>
            </div>
        </section>
      </div>

      <div id="cropperModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-discord-gray-800 rounded-lg p-4 w-full max-w-md space-y-4 shadow-lg">
          <h3 class="text-lg font-semibold text-center text-white">Adjust your image</h3>
          <div class="w-full h-64 overflow-hidden rounded border border-discord-gray-600">
            <img id="cropperImage" class="max-w-full" />
          </div>
          <div class="flex justify-between items-center gap-2">
            <button onclick="rotateImage(-90)" class="bg-discord-gray-700 text-white px-3 py-1 rounded">‚ü≤
              Rotate</button>
            <input type="range" min="0.1" max="3" step="0.01" value="1" id="zoomSlider" class="w-full">
            <button onclick="rotateImage(90)" class="bg-discord-gray-700 text-white px-3 py-1 rounded">‚ü≥ Rotate</button>
          </div>
          <div class="flex justify-end gap-2">
            <button onclick="closeCropper()"
              class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded">Cancel</button>
            <button onclick="applyCrop()"
              class="px-4 py-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded">Apply</button>
          </div>
        </div>
      </div>

      <div id="tab-files"
        class="tab-content h-full overflow-y-auto p-4 md:p-6 space-y-6 hidden animate-fadeIn scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">
        <h1 class="text-xl font-bold mb-4 text-white">üì¶ Download Page</h1>
        <div class="mb-6">
          <label for="speed" class="block text-sm font-semibold mb-1">Enter your internet speed (Mbps):</label>
          <input type="number" id="speed"
            class="w-full border px-3 py-2 rounded-md bg-discord-gray-800 border-discord-gray-600"
            placeholder="e.g., 50">
          <button onclick="estimateTimes()"
            class="mt-3 px-4 py-2 bg-discord-blurple text-white rounded hover:bg-opacity-80">Estimate</button>
        </div>
        <div id="downloads" class="space-y-6">
        </div>
      </div>

      <section id="tab-explore"
        class="tab-content h-full overflow-y-auto hidden animate-fadeIn scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">
        <div class="max-w-3xl mx-auto w-full space-y-4 p-4 md:p-6">
          <h1 class="text-2xl font-bold text-white">üß≠ Explore</h1>
          <p class="text-discord-gray-300">Share images, videos, audio, or files with the community.</p>

          <div class="p-4 rounded-lg bg-discord-gray-800 space-y-3">
            <div class="flex items-center gap-2">
              <input id="exploreCaption" class="zylo-input flex-1 p-2"
                placeholder="Say something about your media..." />
              <label class="px-3 py-2 rounded bg-discord-blurple text-white cursor-pointer">
                Attach
                <input type="file" id="exploreFile" class="hidden" />
              </label>
              <button id="exploreShareBtn" class="px-3 py-2 rounded bg-green-600 text-white">Share</button>
            </div>
            <div id="explorePreview" class="rounded overflow-hidden"></div>
          </div>

          <div id="exploreFeed" class="space-y-3"></div>
        </div>
      </section>

      <section id="tab-group" class="tab-content h-full hidden animate-fadeIn flex flex-col">
        <!-- Group Chat Header -->
        <header
          class="flex-shrink-0 h-12 border-b border-discord-gray-900 px-4 flex items-center justify-between bg-discord-gray-700 shadow-sm">
          <div class="flex items-center gap-2">
            <span class="text-discord-gray-400">#</span>
            <span id="groupChatChannelName" class="font-semibold text-white">general</span>
          </div>
          <div class="flex items-center gap-2">
            <span id="groupChatMemberCount" class="text-xs text-discord-gray-400">0 members</span>
          </div>
        </header>

        <!-- Group Messages -->
        <div id="groupChatMessages"
          class="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">
          <!-- Messages will be added here dynamically -->
        </div>

        <!-- Group Chat Input -->
        <div class="flex-shrink-0 p-4 border-t border-discord-gray-900">
          <div class="flex items-center gap-2 bg-discord-gray-600 rounded-lg p-2">
            <label class="p-2 rounded-full hover:bg-discord-gray-500/70 cursor-pointer transition"
              title="Attach a file">
              <i data-feather="plus-circle" class="w-5 h-5 text-gray-200"></i>
              <input type="file" id="groupFileInput" class="hidden" onchange="sendGroupFile(event)">
            </label>
            <textarea id="groupChatInput" placeholder="Message #general" rows="1"
              class="flex-1 bg-transparent border-none text-white resize-none focus:outline-none"
              onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendGroupChatMessage();}"></textarea>
            <button onclick="sendGroupChatMessage()" class="text-discord-gray-400 hover:text-white">
              <i data-feather="send" class="w-5 h-5"></i>
            </button>
            <div id="emojiPicker"
              class="hidden absolute bottom-16 right-4 bg-discord-gray-800 rounded-lg shadow-lg z-50"></div>
          </div>
        </div>
      </section>

      <section id="tab-settings"
        class="tab-content h-full overflow-y-auto p-4 md:p-6 hidden animate-fadeIn scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">
        <div class="w-full max-w-4xl mx-auto space-y-8">

          <div id="generalSettings" class="settings-content w-full space-y-6">
            <h2 class="text-2xl font-bold text-white">General Settings</h2>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span id="labelEnableAnimations">Enable Animations</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="animationsToggle" class="sr-only peer">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-discord-blurple rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span id="labelCompactMode">Compact Mode</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="compactToggle" class="sr-only peer">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-purple-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span id="labelShowTooltips">Show Tooltips</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="tooltipToggle" class="sr-only peer">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-green-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span id="labelShowHomeTab">Show Home Tab</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="showHomeTabToggle" class="sr-only peer"
                  onchange="toggleHomeTab(this.checked)">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-discord-blurple rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <label id="labelLanguage" for="languageSelect" class="block mb-2">Language</label>
              <select id="languageSelect" class="w-full p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
                <option value="en">English</option>
                <option value="vi">Ti·∫øng Vi·ªát</option>
                <option value="es">Espa√±ol</option>
              </select>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <label id="labelStartupPage" for="startupPage" class="block mb-2">Startup Page</label>
              <select id="startupPage" class="w-full p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
                <option value="home">Home</option>
                <option value="profile">Profile</option>
                <option value="chats">Messages</option>
                <option value="friends">Friends</option>
                <option value="explore">Explore</option>
                <option value="settings">Settings</option>
              </select>
            </div>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span id="labelAutoSave">Auto Save Changes</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="autoSaveToggle" class="sr-only peer">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-yellow-500 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span id="labelConfirmExit">Confirm Before Exit</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="confirmExitToggle" class="sr-only peer">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-red-500 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>

            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h2 id="titleAppearance" class="text-xl font-semibold mb-3 text-white">Appearance</h2>
              <div class="flex items-center gap-3 flex-wrap">
                <div class="flex items-center gap-2">
                  <span>Theme</span>
                  <span id="themeColorSwatch"
                    class="inline-flex items-center gap-2 px-2 py-1 rounded border text-xs border-discord-gray-600">
                    <span id="themeColorDot" class="w-4 h-4 rounded-full border"></span>
                    <span id="themeColorText">#ffffff</span>
                  </span>
                </div>
                <div class="flex items-center gap-2">
                  <button onclick="setTheme('light')" data-theme-btn="light"
                    class="px-3 py-1 bg-gray-200 text-gray-800 rounded">Light</button>
                  <button onclick="setTheme('dark')" data-theme-btn="dark"
                    class="px-3 py-1 bg-discord-gray-600 text-white rounded">Dark</button>
                  <button onclick="setTheme('system')" data-theme-btn="system"
                    class="px-3 py-1 bg-discord-gray-600 text-white rounded">System</button>
                  <button onclick="setTheme('custom')" data-theme-btn="custom"
                    class="px-3 py-1 bg-discord-gray-600 text-white rounded">Custom</button>
                  <input type="color" id="customThemeColorPicker"
                    class="h-9 w-12 p-1 rounded border bg-discord-gray-700 border-discord-gray-600 hidden" />
                </div>
              </div>
              <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <label class="inline-flex items-center gap-2">
                  <input type="checkbox" id="solidBgToggle" class="accent-discord-blurple">
                  <span id="labelSolidBg">Solid BG</span>
                </label>
                <div class="flex items-center gap-2">
                  <input type="file" id="bgImageInput" accept="image/*"
                    class="block w-full text-sm text-discord-gray-300 file:mr-3 file:py-1 file:px-3 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-discord-gray-600 file:text-white hover:file:bg-discord-gray-500" />
                  <button id="previewBgBtn" class="px-3 py-1 bg-green-700 rounded"
                    title="Preview background">Preview</button>
                  <button id="clearBgImageBtn" class="px-3 py-1 bg-discord-gray-600 rounded">Clear Image</button>
                </div>
              </div>
            </div>

            <div id="saveSettingsBtn" class="pt-4 border-t border-discord-gray-600" style="display: none;">
              <button onclick="showSaveSettingsModal()"
                class="w-full px-4 py-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded-lg mb-3">
                <i data-feather="save" class="w-4 h-4 inline mr-2"></i>
                Save Changes
              </button>
            </div>
            <div class="pt-4 border-t border-discord-gray-600">
              <button id="btnResetAll" onclick="resetAllSettings()"
                class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Reset All Settings</button>
            </div>
          </div>

          <div id="soundSettings" class="settings-content w-full hidden space-y-6">
            <h2 class="text-2xl font-bold text-white">Sound Settings</h2>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <label for="soundVolume" class="block mb-2">Sound Effects Volume</label>
              <input type="range" id="soundVolume" min="0" max="100" value="75" class="w-full accent-discord-blurple">
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <label for="musicVolume" class="block mb-2">Music Volume</label>
              <input type="range" id="musicVolume" min="0" max="100" value="60" class="w-full accent-green-500">
            </div>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span>Mute All Sounds</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="muteAll" class="sr-only peer">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-red-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg space-y-2">
              <div class="flex items-center gap-2">
                <input type="checkbox" id="enableSound" class="accent-discord-blurple">
                <label for="enableSound">Enable Sound Effects</label>
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="enableMusic" class="accent-discord-blurple">
                <label for="enableMusic">Enable Background Music</label>
              </div>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <label for="soundProfile" class="block mb-2">Sound Profile</label>
              <select id="soundProfile" class="w-full p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
                <option value="default">Default</option>
                <option value="soft">Soft</option>
                <option value="retro">Retro</option>
                <option value="clicky">Clicky</option>
              </select>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="font-semibold mb-2">Play on events</h3>
              <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" id="playSend" class="accent-discord-blurple" checked>
                <label for="playSend">Message sent</label>
              </div>
              <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" id="playReceive" class="accent-discord-blurple" checked>
                <label for="playReceive">Message received</label>
              </div>
              <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" id="playUi" class="accent-discord-blurple" checked>
                <label for="playUi">UI interactions</label>
              </div>
            </div>
            <div class="flex items-center gap-2 p-3 bg-discord-gray-800 rounded-lg">
              <input type="checkbox" id="duckMusic" class="accent-discord-blurple">
              <label for="duckMusic">Duck music when playing effects</label>
            </div>
            <div id="saveSoundSettingsBtn" class="pt-4 border-t border-discord-gray-600" style="display: none;">
              <button onclick="showSaveSettingsModal()"
                class="w-full px-4 py-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded-lg">
                <i data-feather="save" class="w-4 h-4 inline mr-2"></i>
                Save Sound Settings
              </button>
            </div>
          </div>

          <div id="aboutSettings" class="settings-content w-full hidden space-y-6">
            <h2 class="text-2xl font-bold text-white">About Us</h2>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <p class="text-discord-gray-300"><strong>Zylo v1.5.7</strong> ‚Äî Created by D4niel-dev</p>
              <p class="text-discord-gray-400 text-sm mt-1">¬© 2025 Zylo. All rights reserved.</p>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="text-lg font-semibold mb-2 text-white">Version Details</h3>
              <ul class="list-disc list-inside text-discord-gray-300 text-sm space-y-1">
                <li>Build: 1.5.7-stable</li>
                <li>Release Date: August 2025</li>
                <li>UI Framework: Tailwind CSS</li>
                <li>Backend: Python (Flask)</li>
                <li>Platform: Web/Desktop Hybrid</li>
              </ul>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="text-lg font-semibold mb-2 text-white">System Status</h3>
              <div id="aboutSystemStatus" class="text-discord-gray-300 text-sm">Checking backend status...</div>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="text-lg font-semibold mb-2 text-white">Quick Actions</h3>
              <div class="flex flex-col gap-2">
                <button onclick="checkForUpdates()"
                  class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow">üîÑ Check for
                  Updates</button>
                <button onclick="openChangelog()"
                  class="px-4 py-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded-lg shadow">üìú View
                  Changelog</button>
                <button onclick="openPrivacyPolicy()"
                  class="px-4 py-2 bg-discord-gray-600 hover:bg-discord-gray-500 text-white rounded-lg shadow">üîí
                  Privacy Policy</button>
              </div>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="text-lg font-semibold mb-2 text-white">Credits</h3>
              <p class="text-discord-gray-300 text-sm">Special thanks to testers, designers, and contributors who made
                Zylo possible.</p>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="text-lg font-semibold mb-2 text-white">Resources</h3>
              <div class="flex flex-col gap-2">
                <a href="https://github.com/D4niel-dev" target="_blank" class="text-blue-400 hover:underline">üîó My
                  GitHub</a>
                <a href="https://www.youtube.com/@d4niel_1f" target="_blank" class="text-blue-400 hover:underline">üîó My
                  YouTube</a>
                <a href="mailto:zylosupp0rt@gmail.com" class="text-blue-400 hover:underline">üìß Contact Support</a>
              </div>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="text-lg font-semibold mb-2 text-white">License</h3>
              <p class="text-discord-gray-300 text-sm">This project is licensed under the MIT License.</p>
            </div>
          </div>

          <div id="accountSettings" class="settings-content w-full hidden space-y-6">
            <h2 class="text-2xl font-bold text-white">My Account</h2>
            <div class="relative rounded-xl shadow-sm bg-discord-gray-800 p-4">
              <label for="settingsBannerUpload" class="banner-label block cursor-pointer">
                <img id="settingsBanner" src="/images/default_banner.png" alt="Banner"
                  class="w-full h-40 object-cover rounded-xl" />
                <span class="edit-overlay" title="Change banner"><i data-feather="edit-2"></i></span>
              </label>
              <input type="file" id="settingsBannerUpload" accept="image/*" class="hidden">
              <div class="relative -mt-10 ml-6 drop-shadow z-10">
                <label for="settingsAvatarUpload" class="avatar-label cursor-pointer">
                  <img id="settingsAvatar" src="/images/default_avatar.png" alt="Avatar"
                    class="w-30 h-30 rounded-full border-4 border-discord-gray-800 object-cover avatar-img" />
                  <span class="edit-overlay" title="Change avatar"><i data-feather="edit-2"></i></span>
                </label>
                <input type="file" id="settingsAvatarUpload" accept="image/*" class="hidden">
                <button onclick="setAsBackground('avatar')"
                  class="absolute -bottom-2 -right-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded-full p-1 text-xs"
                  title="Set as background">
                  <i data-feather="image"></i>
                </button>
              </div>
            </div>

            <div class="space-y-3 p-4 bg-discord-gray-800 rounded-lg" aria-label="Account details">
              <div class="editable-row">
                <div>
                  <div class="editable-label">Username</div>
                  <div id="currentUsername" class="editable-value"></div>
                </div>
                <button class="edit-icon" onclick="promptUsernameEdit()" title="Edit username"><i
                    data-feather="edit-2"></i></button>
              </div>
              <div class="editable-row">
                <div>
                  <div class="editable-label">Usertag</div>
                  <div id="currentUsertag" class="editable-value"></div>
                </div>
                <button class="edit-icon" onclick="promptUsertagEdit()" title="Edit usertag"><i
                    data-feather="edit-2"></i></button>
              </div>
              <div class="editable-row">
                <div>
                  <div class="editable-label">Email</div>
                  <div id="currentEmail" class="editable-value">Hidden</div>
                </div>
                <button class="edit-icon" onclick="promptEmailEdit()" title="Edit email"><i
                    data-feather="edit-2"></i></button>
              </div>
              <div class="mb-4">
                <label class="editable-label">Bio</label>
                <div id="settingsProfileBioDisplay"
                  class="p-2 bg-discord-gray-700 rounded text-discord-gray-300 truncate" style="min-height:38px;">&nbsp;
                </div>
              </div>
              <div class="mb-4">
                <label class="editable-label">About me</label>
                <div id="settingsAboutMeDisplay" class="p-3 bg-discord-gray-700 rounded text-discord-gray-300"
                  style="white-space:pre-wrap; max-height:200px; overflow:auto;">&nbsp;</div>
              </div>
            </div>

            <div class="mt-4 p-4 rounded-lg bg-discord-gray-800" aria-label="Security settings">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-semibold text-white">Two-Factor Authentication (2FA)</div>
                  <div class="text-sm text-discord-gray-400">Add an extra layer of protection.</div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="twoFactorToggle" class="sr-only peer">
                  <div
                    class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-purple-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                  </div>
                </label>
              </div>
            </div>

            <div class="grid sm:grid-cols-2 gap-3" aria-label="Preferences">
              <div class="editable-row">
                <div>
                  <div class="editable-label">Language</div>
                  <div class="editable-value">
                    <select id="settingsLanguage" class="p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
                      <option value="en">English</option>
                      <option value="es">Spanish</option>
                      <option value="fr">French</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="editable-row">
                <div>
                  <div class="editable-label">Show Email on Profile</div>
                  <div class="editable-value"><input type="checkbox" id="showEmail" class="accent-discord-blurple">
                  </div>
                </div>
              </div>
            </div>

            <div class="p-4 rounded-lg bg-discord-gray-800">
              <div class="font-semibold mb-2 text-white">Change Password</div>
              <div class="grid sm:grid-cols-3 gap-2">
                <input type="password" id="oldPassword" placeholder="Current password"
                  class="p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
                <input type="password" id="newPassword" placeholder="New password"
                  class="p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
                <input type="password" id="confirmPassword" placeholder="Confirm new password"
                  class="p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
              </div>
              <button onclick="updatePassword()"
                class="mt-3 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">Change Password</button>
            </div>

            <div class="border-t border-discord-gray-600 pt-4">
              <button onclick="deleteAccount()"
                class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white w-full">Delete Account</button>
            </div>

            <div id="saveAccountSettingsBtn" class="pt-4 border-t border-discord-gray-600" style="display: none;">
              <button onclick="showSaveSettingsModal()"
                class="w-full px-4 py-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded-lg">
                <i data-feather="save" class="w-4 h-4 inline mr-2"></i>
                Save Account Settings
              </button>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <div id="profileEffectsModal"
    class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden flex items-center justify-center px-4">
    <div
      class="bg-discord-gray-800 max-w-4xl w-full p-6 rounded-lg shadow-xl animate-fadeIn max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-white">Profile Effects</h3>
        <button onclick="closeProfileEffectsModal()" class="text-discord-gray-400 hover:text-red-500">
          <i data-feather="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <h4 class="text-lg font-semibold mb-3 text-discord-gray-200">Avatar Effects</h4>
          <p class="text-xs text-discord-gray-400 mb-2">Choose how your avatar appears across Zylo.</p>
          <div class="space-y-3">
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="none" class="mr-3" checked>
              <span class="flex-1">None</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="none"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="glow" class="mr-3">
              <span class="flex-1">Neon Glow</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="glow"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="pulse" class="mr-3">
              <span class="flex-1">Soft Pulse</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="pulse"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="ring" class="mr-3">
              <span class="flex-1">Status Ring</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="ring"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="sparkle" class="mr-3">
              <span class="flex-1">Sparkle</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="sparkle"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="vintage" class="mr-3">
              <span class="flex-1">Vintage</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="vintage"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="neon-border" class="mr-3">
              <span class="flex-1">Neon Border</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="neon-border"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="gradient-border" class="mr-3">
              <span class="flex-1">Gradient Border</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="gradient-border">
              </div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="frosted" class="mr-3">
              <span class="flex-1">Frosted Glass</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="frosted"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="holographic" class="mr-3">
              <span class="flex-1">Holographic</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="holographic"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="matrix" class="mr-3">
              <span class="flex-1">Matrix Code</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="matrix"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="cyberpunk" class="mr-3">
              <span class="flex-1">Cyberpunk</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="cyberpunk"></div>
            </label>
          </div>
        </div>
        <div>
          <h4 class="text-lg font-semibold mb-3 text-discord-gray-200">Banner Effects</h4>
          <p class="text-xs text-discord-gray-400 mb-2">Stylize the banner behind your profile.</p>
          <div class="space-y-3">
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="none" class="mr-3" checked>
              <span class="flex-1">None</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="blur-overlay" class="mr-3">
              <span class="flex-1">Blur Overlay</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="gradient-overlay" class="mr-3">
              <span class="flex-1">Gradient Overlay</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="vignette" class="mr-3">
              <span class="flex-1">Vignette</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="neon-glow" class="mr-3">
              <span class="flex-1">Neon Glow</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="cyber-grid" class="mr-3">
              <span class="flex-1">Cyber Grid</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="holographic-banner" class="mr-3">
              <span class="flex-1">Holographic</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="matrix-banner" class="mr-3">
              <span class="flex-1">Matrix Stream</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="retro-wave" class="mr-3">
              <span class="flex-1">Retro Wave</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="neon-city" class="mr-3">
              <span class="flex-1">Neon City</span>
            </label>
          </div>
        </div>
      </div>
      <div class="flex gap-3 justify-end">
        <button onclick="closeProfileEffectsModal()"
          class="px-4 py-2 bg-discord-gray-600 hover:bg-discord-gray-500 text-white rounded-lg">Cancel</button>
        <button onclick="applyProfileEffects()"
          class="px-4 py-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded-lg">Apply Effects</button>
      </div>
    </div>
  </div>

  <div id="saveSettingsModal"
    class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden flex items-center justify-center px-4">
    <div class="bg-discord-gray-800 max-w-md w-full p-6 rounded-lg shadow-xl animate-fadeIn">
      <div class="flex items-center mb-4">
        <div class="flex-shrink-0">
          <i data-feather="save" class="w-6 h-6 text-discord-blurple"></i>
        </div>
        <div class="ml-3">
          <h3 class="text-lg font-semibold text-white">Save Settings</h3>
        </div>
      </div>
      <p class="text-sm text-discord-gray-300 mb-6">You have unsaved changes. Do you want to save your settings before
        continuing?</p>
      <div class="flex gap-3">
        <button onclick="confirmSaveSettings()"
          class="flex-1 bg-discord-blurple hover:bg-opacity-80 text-white py-2 px-4 rounded-lg">
          <i data-feather="save" class="w-4 h-4 inline mr-2"></i> Save Changes
        </button>
        <button onclick="discardSettingsChanges()"
          class="flex-1 bg-discord-gray-600 hover:bg-discord-gray-500 text-white py-2 px-4 rounded-lg">
          <i data-feather="x" class="w-4 h-4 inline mr-2"></i> Discard
        </button>
        <button onclick="cancelSaveSettings()"
          class="flex-1 bg-discord-gray-700 hover:bg-discord-gray-600 text-discord-gray-300 py-2 px-4 rounded-lg">
          <i data-feather="arrow-left" class="w-4 h-4 inline mr-2"></i> Cancel
        </button>
      </div>
    </div>
  </div>

  <div id="themeEditorOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden"></div>
  <div id="themeEditorModal"
    class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-[210] w-[95%] max-w-4xl max-h-[90vh] overflow-hidden rounded-xl shadow-2xl hidden">
    <div class="bg-discord-gray-800 text-discord-gray-300 h-full flex flex-col">
      <div class="flex items-center justify-between px-4 py-3 border-b border-discord-gray-900">
        <h3 class="text-lg font-semibold text-white">Theme Editor</h3>
        <div class="flex items-center gap-2">
          <select id="savedThemesSelect"
            class="text-sm bg-discord-gray-700 border rounded px-2 py-1 border-discord-gray-900">
            <option value="">Select saved theme‚Ä¶</option>
          </select>
          <button id="saveThemeBtn" class="px-3 py-1 rounded bg-discord-blurple text-white text-sm">Save</button>
          <button id="deleteThemeBtn" class="px-3 py-1 rounded bg-red-600 text-white text-sm">Delete</button>
          <button id="closeThemeEditorBtn" class="px-2 py-1 rounded bg-discord-gray-700">‚úñ</button>
        </div>
      </div>

      <div class="p-6">
        <!-- Theme Editor Content would go here if populated -->
        <p class="text-sm">Customize your theme settings here.</p>
      </div>
    </div>
  </div>

  <div id="groupsModal"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center px-4">
    <div class="bg-discord-gray-800 text-discord-gray-300 w-full max-w-md p-6 rounded-xl shadow-2xl flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-white">Add a Group</h3>
        <button onclick="closeGroupsModal()" class="text-discord-gray-400 hover:text-red-500">
          <i data-feather="x" class="w-6 h-6"></i>
        </button>
      </div>

      <!-- Tabs -->
      <div class="flex border-b border-discord-gray-700 mb-4">
        <button id="createGroupTab" onclick="switchGroupModalTab('create')"
          class="flex-1 px-4 py-2 text-white border-b-2 border-discord-blurple font-medium">
          Create Group
        </button>
        <button id="joinGroupTab" onclick="switchGroupModalTab('join')"
          class="flex-1 px-4 py-2 text-discord-gray-400 hover:text-white font-medium">
          Join Group
        </button>
      </div>

      <!-- Create Group Form -->
      <div id="createGroupForm" class="space-y-4">
        <div class="flex flex-col items-center justify-center mb-4">
          <div class="relative w-24 h-24">
            <div id="groupIconPreview"
              class="w-full h-full rounded-full bg-discord-gray-700 border-2 border-dashed border-discord-gray-500 flex items-center justify-center cursor-pointer hover:border-discord-blurple overflow-hidden"
              onclick="document.getElementById('newGroupIconInput').click()">
              <i data-feather="camera" class="text-discord-gray-400"></i>
            </div>
            <input type="file" id="newGroupIconInput" class="hidden" accept="image/*"
              onchange="previewGroupIcon(event)">
          </div>
          <p class="text-xs text-discord-gray-400 mt-2">Upload Icon</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-discord-gray-300 mb-2">Group Name</label>
          <input type="text" id="newGroupNameInput" placeholder="My Awesome Group"
            class="w-full p-3 rounded-lg bg-discord-gray-700 border border-discord-gray-600 text-white focus:border-discord-blurple focus:outline-none">
        </div>
        <div>
          <label class="block text-sm font-medium text-discord-gray-300 mb-2">Description (Optional)</label>
          <textarea id="newGroupDescInput" placeholder="What's your group about?" rows="3"
            class="w-full p-3 rounded-lg bg-discord-gray-700 border border-discord-gray-600 text-white focus:border-discord-blurple focus:outline-none resize-none"></textarea>
        </div>
        <button onclick="createNewGroup()"
          class="w-full bg-discord-blurple hover:bg-opacity-80 text-white font-medium py-3 rounded-lg transition">
          Create Group
        </button>
      </div>

      <!-- Join Group Form -->
      <div id="joinGroupForm" class="hidden space-y-4">
        <div>
          <label class="block text-sm font-medium text-discord-gray-300 mb-2">Group ID or Invite Code</label>
          <input type="text" id="joinGroupIdInput" placeholder="Enter group ID..."
            class="w-full p-3 rounded-lg bg-discord-gray-700 border border-discord-gray-600 text-white focus:border-discord-blurple focus:outline-none">
        </div>
        <button onclick="joinExistingGroup()"
          class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-lg transition">
          Join Group
        </button>
      </div>
    </div>
  </div>

  <!-- Group Settings Modal -->
  <div id="groupSettingsModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
    <div class="bg-discord-gray-700 w-full max-w-lg rounded-lg shadow-lg flex flex-col max-h-[90vh]">
      <!-- Header -->
      <div class="flex justify-between items-center p-6 border-b border-discord-gray-900">
        <h3 class="text-white text-xl font-bold">Group Settings</h3>
        <button onclick="closeGroupSettings()" class="text-discord-gray-400 hover:text-white">
          <i data-feather="x"></i>
        </button>
      </div>

      <!-- Content -->
      <div class="p-6 space-y-6 overflow-y-auto">
        <!-- Icon -->
        <div class="flex flex-col items-center">
          <div class="relative w-24 h-24 group cursor-pointer"
            onclick="document.getElementById('editGroupIconInput').click()">
            <div id="editGroupIconPreview"
              class="w-full h-full rounded-full bg-discord-gray-600 flex items-center justify-center overflow-hidden border-2 border-transparent hover:border-discord-blurple transition">
              <span class="text-white text-2xl font-bold" id="editGroupIconInitial">G</span>
            </div>
            <div
              class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 rounded-full transition">
              <span class="text-white text-xs font-bold">CHANGE</span>
            </div>
            <input type="file" id="editGroupIconInput" class="hidden" accept="image/*"
              onchange="previewEditGroupIcon(event)">
          </div>
        </div>

        <!-- Name -->
        <div>
          <label class="block text-xs font-bold text-discord-gray-400 uppercase tracking-wide mb-2">Group Name</label>
          <input type="text" id="editGroupName"
            class="w-full bg-discord-gray-900 border-none rounded p-2 text-white focus:ring-2 focus:ring-discord-blurple">
        </div>

        <!-- Description -->
        <div>
          <label class="block text-xs font-bold text-discord-gray-400 uppercase tracking-wide mb-2">Description</label>
          <textarea id="editGroupDesc" rows="3"
            class="w-full bg-discord-gray-900 border-none rounded p-2 text-white focus:ring-2 focus:ring-discord-blurple resize-none"></textarea>
        </div>
      </div>

      <!-- Footer -->
      <div class="p-6 bg-discord-gray-800 rounded-b-lg flex justify-between items-center">
        <button onclick="deleteGroup()" class="text-red-500 hover:underline font-medium text-sm">Delete Group</button>
        <button onclick="saveGroupSettings()"
          class="bg-discord-blurple hover:bg-discord-blurple/80 text-white px-6 py-2 rounded font-medium transition">Save
          Changes</button>
      </div>
    </div>
  </div>

  <script src="/files/vendor/socket.io.min.js"></script>
  <script src="/js/app-extras.js"></script>
  <script>

    // Chat Functions (Socket.IO, etc. - Kept as is)
    const baseUrl = window.location.origin;
    const socket = navigator.onLine ? io(baseUrl) : { emit: function () { }, on: function () { }, off: function () { } };
    window.socket = socket;
    const chatInput = document.getElementById("chatInput");
    const chatMessagesCommunity = document.getElementById("chatMessagesCommunity");
    const chatMessagesAI = document.getElementById("chatMessagesAI");
    const aiControls = document.getElementById("aiControls");
    const aiModelSelect = document.getElementById("aiModelSelect");
    const aiPersonaSelect = document.getElementById("aiPersonaSelect");
    let currentChatRoom = localStorage.getItem('chatRoom') || 'community';
    let aiConversation = [];
    const username = localStorage.getItem("savedUsername") || "N/A";
    const email = localStorage.getItem("savedEmail") || "N/A";
    const typingIndicator = document.getElementById("typingIndicator");
    const activeTypers = new Set();
    let emojiPickerVisible = false;
    const avatarCache = new Map();

    // Function to get avatar URL (Kept as is)
    async function getUserAvatarUrl(username) {
      if (!username || username === 'N/A') return '/images/default_avatar.png';
      if (avatarCache.has(username)) {
        return avatarCache.get(username);
      }
      try {
        if (navigator.onLine) {
          const res = await fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`);
          if (res.ok) {
            const data = await res.json();
            if (data.success && data.user && data.user.avatar) {
              const avatarUrl = data.user.avatar;
              avatarCache.set(username, avatarUrl);
              return avatarUrl;
            }
          }
        }
      } catch (e) {
        console.log('Failed to fetch avatar for', username, e);
      }
      const fallbackUrl = `/uploads/${username}/avatar.png`;
      avatarCache.set(username, fallbackUrl);
      return fallbackUrl;
    }

    // Friends & Groups state (Kept as is)
    let friendsState = { friends: [], incoming: [], outgoing: [] };
    // groupsState removed in favor of groupsData to prevent sync issues
    let groupsData = [];

    // Chat input listeners (Kept as is)
    chatInput.addEventListener("input", () => {
      if (navigator.onLine && currentChatRoom === 'community') {
        socket.emit("typing", { username });
      }
    });
    chatInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        if (event.shiftKey) {
          event.preventDefault();
          const start = this.selectionStart;
          const end = this.selectionEnd;
          const value = this.value;
          this.value = value.substring(0, start) + "\n" + value.substring(end);
          this.selectionStart = this.selectionEnd = start + 1;
        } else {
          event.preventDefault();
          sendMessage();
        }
      }
    });
    chatInput.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = (this.scrollHeight > 150 ? 150 : this.scrollHeight) + "px"; // Add max-height
    });

    // Register user for DM rooms
    if (navigator.onLine && username && username !== 'N/A') {
      try { socket.emit('register_user', { username }); } catch { }
    }

    // === NEW MESSAGE RENDERING FUNCTION ===
    // This helper creates the new Discord-style message layout
    async function createDiscordMessage(data) {
      const msgWrapper = document.createElement("div");
      msgWrapper.classList.add("flex", "items-start", "gap-3", "p-2", "rounded", "hover:bg-discord-gray-600/20", "leading-snug");

      const avatar = document.createElement("img");
      const fallbackAvatar = '/images/default_avatar.png';
      const avatarUrl = await getUserAvatarUrl(data.username || data.from);
      avatar.src = avatarUrl;
      avatar.alt = `${data.username || data.from}'s avatar`;
      avatar.className = "w-10 h-10 rounded-full object-cover cursor-pointer"; // Added cursor-pointer
      avatar.onerror = function () { this.onerror = null; this.src = fallbackAvatar; };
      msgWrapper.appendChild(avatar);

      const contentWrapper = document.createElement("div");

      const header = document.createElement("div");
      header.className = "flex items-baseline gap-2";
      const userSpan = document.createElement("span");
      userSpan.className = "text-white font-semibold cursor-pointer hover:underline";
      userSpan.textContent = data.username || data.from;
      const timeSpan = document.createElement("span");
      timeSpan.className = "text-discord-gray-400 text-xs";
      timeSpan.textContent = new Date(data.ts ? data.ts * 1000 : Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      header.appendChild(userSpan);
      header.appendChild(timeSpan);
      contentWrapper.appendChild(header);

      // Body (text OR file)
      if (data.fileData && data.fileName) {
        const ext = data.fileName.split(".").pop().toLowerCase();
        const imageExts = ["png", "jpg", "jpeg", "gif", "webp", "svg"];
        const videoExts = ["mp4", "webm", "ogg", "mov", "m4v"];
        const audioExts = ["mp3", "wav", "ogg", "m4a", "aac", "flac"];

        let body;
        if (imageExts.includes(ext)) {
          body = document.createElement("img");
          body.src = data.fileData;
          body.alt = data.fileName;
          body.className = "max-w-xs rounded shadow-md cursor-pointer mt-1";
        } else if (videoExts.includes(ext)) {
          body = document.createElement("video");
          body.controls = true;
          body.src = data.fileData;
          body.className = "max-w-xs rounded mt-1";
        } else if (audioExts.includes(ext)) {
          body = document.createElement("audio");
          body.controls = true;
          body.src = data.fileData;
          body.className = "mt-1";
        } else {
          body = document.createElement("a");
          body.href = data.fileData;
          body.download = data.fileName;
          body.textContent = `üìé ${data.fileName}`;
          body.className = "text-blue-400 hover:underline mt-1 block";
        }
        contentWrapper.appendChild(body);
      } else if (data.message) {
        const body = document.createElement("div");
        body.textContent = data.message;
        body.className = "text-white";
        contentWrapper.appendChild(body);
      }

      msgWrapper.appendChild(contentWrapper);
      return msgWrapper;
    }

    async function appendCommunityMessage(data) {
      const msgElement = await createDiscordMessage(data);
      chatMessagesCommunity.appendChild(msgElement);
      chatMessagesCommunity.scrollTop = chatMessagesCommunity.scrollHeight;
    }

    async function appendAiBubble(role, content) {
      const isOwn = role === 'user';
      const data = {
        username: isOwn ? username : 'AI',
        message: content,
        from: isOwn ? username : 'AI'
      };

      const msgElement = await createDiscordMessage(data);

      // AI-specific: Use AI avatar
      if (!isOwn) {
        msgElement.querySelector('img').src = '/images/Zylo_icon.ico';

        // Add feedback actions
        const actions = document.createElement('div');
        actions.className = 'mt-1 flex gap-2 opacity-70 text-xs';
        const like = document.createElement('button');
        like.textContent = 'üëç';
        like.className = 'hover:opacity-100';
        like.onclick = async () => { /* ... feedback logic ... */ like.textContent = '‚úÖ'; };
        const dislike = document.createElement('button');
        dislike.textContent = 'üëé';
        dislike.className = 'hover:opacity-100';
        dislike.onclick = async () => { /* ... feedback logic ... */ dislike.textContent = '‚úÖ'; };
        actions.appendChild(like);
        actions.appendChild(dislike);
        msgElement.querySelector('div').appendChild(actions);
      }

      chatMessagesAI.appendChild(msgElement);
      chatMessagesAI.scrollTop = chatMessagesAI.scrollHeight;
    }

    // sendMessage function (Kept as is, logic is sound)
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;
      if (currentChatRoom === 'community') {
        socket.emit("send_message", { username, message });
        chatInput.value = "";
        chatInput.style.height = "auto";
        return;
      }
      // AI chat path
      const model = aiModelSelect?.value || '';
      const persona = aiPersonaSelect?.value || localStorage.getItem('ai_persona') || 'helper';
      const payload = {
        model,
        persona,
        username,
        messages: [...aiConversation, { role: 'user', content: message }]
      };
      await appendAiBubble('user', message);
      aiConversation.push({ role: 'user', content: message });
      localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
      chatInput.value = "";
      chatInput.style.height = "auto";
      try {
        const res = await fetch('/api/ai/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        const reply = data.reply || data.response || 'Sorry, no reply available.';
        await appendAiBubble('assistant', reply);
        aiConversation.push({ role: 'assistant', content: reply });
        localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
      } catch (e) {
        await appendAiBubble('assistant', 'There was an error contacting the AI.');
      }
    }

    // openEmojiPicker (Kept as is)
    function openEmojiPicker() {
      const picker = document.getElementById("emojiPicker");
      if (!emojiPickerVisible) {
        picker.classList.remove("hidden");
        const pickerInstance = new EmojiMart.Picker({
          onEmojiSelect: (emoji) => {
            chatInput.value += emoji.native;
            chatInput.focus();
          },
          theme: "dark",
        });
        picker.innerHTML = ""; // Clear existing
        picker.appendChild(pickerInstance);
        emojiPickerVisible = true;
      } else {
        picker.classList.add("hidden");
        emojiPickerVisible = false;
      }
    }

    // sendFile (Kept as is)
    function sendFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const fileData = e.target.result;
        socket.emit("send_file", {
          username,
          fileName: file.name,
          fileType: file.type,
          fileData: fileData
        });
      };
      reader.readAsDataURL(file); // encodes file as base64
    }

    // Typing indicator logic (Kept as is)
    socket.on("typing", (data) => {
      activeTypers.add(data.username);
      updateTypingIndicator();
      clearTimeout(typingIndicator[data.username]);
      typingIndicator[data.username] = setTimeout(() => {
        activeTypers.delete(data.username);
        updateTypingIndicator();
      }, 2500);
    });

    // Socket message receivers (use NEW rendering function)
    socket.on("receive_message", async (data) => {
      await appendCommunityMessage(data);
    });

    socket.on("receive_file", async (data) => {
      // This is now handled by createDiscordMessage, which appendCommunityMessage uses
      await appendCommunityMessage(data);
    });

    // updateTypingIndicator (Kept as is)
    function updateTypingIndicator() {
      if (activeTypers.size === 0) {
        typingIndicator.classList.add("hidden");
        typingIndicator.textContent = "";
      } else {
        typingIndicator.classList.remove("hidden");
        const users = Array.from(activeTypers);
        if (users.length === 1) {
          typingIndicator.textContent = `${users[0]} is typing...`;
        } else if (users.length === 2) {
          typingIndicator.textContent = `${users[0]} and ${users[1]} are typing...`;
        } else {
          typingIndicator.textContent = `Several people are typing...`;
        }
      }
    }

    // Fetch old messages (Kept as is)
    if (navigator.onLine) {
      fetch("/api/messages")
        .then((res) => res.json())
        .then(async (msgs) => {
          for (const msg of msgs) {
            await appendCommunityMessage(msg);
          }
        })
        .catch(() => { });
    }

    // switchChatRoom (Updated to handle new sub-panel UI)
    function switchChatRoom(room) {
      currentChatRoom = room;
      localStorage.setItem('chatRoom', room);
      const btnCommunity = document.getElementById('btnRoomCommunity');
      const btnAI = document.getElementById('btnRoomAI');
      const title = document.getElementById('main-content-title');

      // Ensure we're showing tab-messages, not tab-friends
      const tabMessages = document.getElementById('tab-messages');
      const tabFriends = document.getElementById('tab-friends');
      if (tabMessages && tabFriends) {
        tabMessages.classList.remove('hidden');
        tabFriends.classList.add('hidden');
      }

      if (room === 'community') {
        chatMessagesCommunity.classList.remove('hidden');
        chatMessagesAI.classList.add('hidden');
        aiControls.classList.add('hidden');
        btnCommunity.classList.add('active');
        btnAI.classList.remove('active');
        if (title) title.textContent = '# Community';
      } else {
        chatMessagesCommunity.classList.add('hidden');
        chatMessagesAI.classList.remove('hidden');
        aiControls.classList.remove('hidden');
        btnAI.classList.add('active');
        btnCommunity.classList.remove('active');
        if (title) title.textContent = 'ü§ñ AI Chat';
        restoreAiConversation();
      }
    }

    // AI functions (restore, clear, load) (Kept as is)
    function restoreAiConversation() {
      try {
        aiConversation = JSON.parse(localStorage.getItem('ai_conversation') || '[]');
      } catch { aiConversation = []; }
      chatMessagesAI.innerHTML = '';
      (async () => {
        for (const msg of aiConversation) {
          await appendAiBubble(msg.role, msg.content);
        }
      })();
    }

    function clearAiConversation() {
      aiConversation = [];
      localStorage.removeItem('ai_conversation');
      chatMessagesAI.innerHTML = '';
    }

    async function loadAiModels() {
      try {
        const res = await fetch('/api/ai/models');
        const data = await res.json();
        const models = data.models || [];
        aiModelSelect.innerHTML = '';
        models.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m;
          opt.textContent = m;
          aiModelSelect.appendChild(opt);
        });
        const saved = localStorage.getItem('ai_model');
        if (saved && models.includes(saved)) {
          aiModelSelect.value = saved;
        }
        aiModelSelect.addEventListener('change', () => {
          localStorage.setItem('ai_model', aiModelSelect.value);
        });
      } catch { }
    }

    async function loadAiPersonas() {
      try {
        const res = await fetch('/api/ai/personas');
        const data = await res.json();
        const personas = (data.personas || []).map(p => ({ key: p.key, name: p.name }));
        aiPersonaSelect.innerHTML = '';
        personas.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.key;
          opt.textContent = p.name;
          aiPersonaSelect.appendChild(opt);
        });
        const saved = localStorage.getItem('ai_persona');
        if (saved) aiPersonaSelect.value = saved;
        aiPersonaSelect.addEventListener('change', () => {
          localStorage.setItem('ai_persona', aiPersonaSelect.value);
        });
      } catch { }
    }

    // Friends UI logic
    let currentFriendFilter = 'all';
    let activeFriendChat = null; // Can be a username (DM) or Group Object

    async function loadFriends() {
      const u = localStorage.getItem('username');
      if (!u) return;
      try {
        const resFriends = await fetch(`/api/friends?username=${encodeURIComponent(u)}`);
        const dataFriends = await resFriends.json();

        friendsState = {
          friends: dataFriends.friends || [],
          incoming: dataFriends.incoming || [],
          outgoing: dataFriends.outgoing || []
        };

        renderSidebarList(); // Update Friend List
        renderFriendsDashboard(); // Update Main View
      } catch (e) { console.error(e); }
    }

    // Helper: Generate consistent color for group avatar based on name
    function getGroupColor(groupName) {
      let hash = 0;
      for (let i = 0; i < groupName.length; i++) {
        hash = groupName.charCodeAt(i) + ((hash << 5) - hash);
      }
      const hue = Math.abs(hash % 360);
      return `hsl(${hue}, 60%, 50%)`;
    }

    // Helper: Get first letter of group name
    function getGroupInitial(groupName) {
      return (groupName || 'G')[0].toUpperCase();
    }

    function renderSidebarList() {
      const container = document.getElementById('sidebarDMList');
      if (!container) return;
      container.innerHTML = '';

      // Groups removed from this list. Rendered in main sidebar.

      // Render DMs Section
      if (friendsState.friends.length > 0) {
        const dmsHeader = document.createElement('div');
        dmsHeader.className = 'dm-list-section';
        dmsHeader.textContent = 'Direct Messages';
        container.appendChild(dmsHeader);

        friendsState.friends.forEach(f => {
          const item = document.createElement('button');
          // item.className is 'group-item' plus active check
          item.className = `group-item ${activeFriendChat === f ? 'active' : ''}`;

          let avatar = avatarCache.get(f) || '/images/default_avatar.png';

          item.innerHTML = `
            <div class="dm-avatar-wrapper">
              <img src="${avatar}" alt="${f}'s avatar">
              <span class="status-indicator offline"></span>
            </div>
            <div class="group-info">
              <span class="group-name">${f}</span>
            </div>
          `;

          if (!avatarCache.has(f)) {
            getUserAvatarUrl(f).then(url => {
              const img = item.querySelector('img');
              if (img) img.src = url;
            });
          }

          item.onclick = () => openDM(f);
          container.appendChild(item);
        });
      }
    }

    function renderGroupSidebar() {
      const container = document.getElementById('groupIconsContainer');
      if (!container) return;
      container.innerHTML = '';

      groupsState.list.forEach(g => {
        const item = document.createElement('div');
        item.className = 'group-icon-wrapper group relative flex items-center justify-center cursor-pointer my-2';

        const isActive = groupsState.activeId === g.id;
        const pillHeight = isActive ? 'h-10' : 'h-2';
        const pillOpacity = isActive ? 'opacity-100' : 'opacity-0 group-hover:opacity-100';

        const color = getGroupColor(g.name);
        const initial = getGroupInitial(g.name);

        item.onclick = () => {
          setActiveGroup(g);
          // Switch to Group Tab (needs implementation if not exists, but we have tab-group)
          // Trigger logic to show group tab
          document.getElementById('sub-panel-group').classList.remove('hidden');
          document.querySelectorAll('.sub-panel-content:not(#sub-panel-group)').forEach(e => e.classList.add('hidden'));

          document.getElementById('tab-group').classList.remove('hidden');
          document.querySelectorAll('.tab-content:not(#tab-group)').forEach(e => e.classList.add('hidden'));

          // Update sidebar active states
          renderGroupSidebar();
        };

        item.innerHTML = `
                <div class="absolute left-0 w-1 bg-white rounded-r-full transition-all duration-200 ${pillHeight} ${pillOpacity}"></div>
                <div class="sidebar-icon w-12 h-12 flex items-center justify-center bg-discord-gray-700 hover:bg-discord-blurple text-white font-semibold transition-all duration-200 ${isActive ? 'rounded-2xl bg-discord-blurple' : 'rounded-[24px] hover:rounded-2xl'}" style="${!isActive ? 'background-color:' + color : ''}">
                   ${initial}
                </div>
                <!-- Tooltip -->
                <div class="absolute left-full ml-4 px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-50 transition-opacity">
                   ${g.name}
                </div>
             `;
        container.appendChild(item);
      });
    }

    function showGroupsModal() {
      document.getElementById('groupsModal').classList.remove('hidden');
    }

    function closeGroupsModal() {
      document.getElementById('groupsModal').classList.add('hidden');
    }

    function switchGroupModalTab(tab) {
      const createTab = document.getElementById('createGroupTab');
      const joinTab = document.getElementById('joinGroupTab');
      const createForm = document.getElementById('createGroupForm');
      const joinForm = document.getElementById('joinGroupForm');

      if (tab === 'create') {
        createTab.classList.add('border-b-2', 'border-discord-blurple', 'text-white');
        createTab.classList.remove('text-discord-gray-400');
        joinTab.classList.remove('border-b-2', 'border-discord-blurple', 'text-white');
        joinTab.classList.add('text-discord-gray-400');

        createForm.classList.remove('hidden');
        joinForm.classList.add('hidden');
      } else {
        joinTab.classList.add('border-b-2', 'border-discord-blurple', 'text-white');
        joinTab.classList.remove('text-discord-gray-400');
        createTab.classList.remove('border-b-2', 'border-discord-blurple', 'text-white');
        createTab.classList.add('text-discord-gray-400');

        joinForm.classList.remove('hidden');
        createForm.classList.add('hidden');
      }
    }

    function showFriendsDashboard() {
      document.getElementById('friendsDashboard').classList.remove('hidden');
      document.getElementById('friendsChatView').classList.add('hidden');
      activeFriendChat = null;
      renderSidebarList(); // clear active state
      renderFriendsDashboard();
    }

    function filterFriends(filter) {
      currentFriendFilter = filter;

      // Update toolbar buttons
      document.querySelectorAll('.friend-toolbar-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-discord-gray-600/50', 'text-white');
        if (btn.textContent.toLowerCase().includes(filter) || (filter === 'add' && btn.classList.contains('add-friend'))) {
          btn.classList.add('active');
        }
      });

      renderFriendsDashboard();
    }

    function renderFriendsDashboard() {
      const container = document.getElementById('friendsDashboardContent');
      const addSection = document.getElementById('addFriendSection');
      if (!container) return;

      container.innerHTML = '';

      if (currentFriendFilter === 'add') {
        container.classList.add('hidden');
        addSection.classList.remove('hidden');
        return;
      }

      container.classList.remove('hidden');
      addSection.classList.add('hidden');

      // Helper to create row
      const createRow = (username, subtext, actions) => {
        const div = document.createElement('div');
        div.className = 'friend-row group';

        getUserAvatarUrl(username).then(url => {
          const img = div.querySelector('.row-avatar');
          if (img) img.src = url;
        });

        div.innerHTML = `
              <div class="flex items-center gap-3" onclick="openDM('${username}')">
                  <img src="/images/default_avatar.png" class="row-avatar w-10 h-10 rounded-full bg-discord-gray-700">
                  <div>
                      <div class="font-semibold text-white">${username}</div>
                      <div class="text-xs text-discord-gray-400">${subtext}</div>
                  </div>
              </div>
              <div class="flex items-center gap-2">
                  ${actions}
              </div>
          `;
        return div;
      };

      // Render based on filter
      if (currentFriendFilter === 'all' || currentFriendFilter === 'online') {
        // Note: We don't have real presence yet, assuming all friends are "Offline" visually for now or just listing them
        friendsState.friends.forEach(f => {
          const actions = `
                  <button class="action-icon-btn" onclick="openDM('${f}')" title="Message"><i data-feather="message-square" class="w-4 h-4"></i></button>
                  <button class="action-icon-btn danger" onclick="removeFriend('${f}')" title="Remove"><i data-feather="trash-2" class="w-4 h-4"></i></button>
              `;
          container.appendChild(createRow(f, "Friend", actions));
        });
        if (friendsState.friends.length === 0) container.innerHTML = `<div class="text-center mt-10 text-discord-gray-400">No friends found. Wumpus is lonely.</div>`;
      }

      if (currentFriendFilter === 'pending') {
        const headerIn = document.createElement('h3');
        headerIn.className = "uppercase text-xs font-bold text-discord-gray-400 mb-2 mt-4";
        headerIn.textContent = `Incoming - ${friendsState.incoming.length}`;
        container.appendChild(headerIn);

        friendsState.incoming.forEach(f => {
          const actions = `
                  <button class="action-icon-btn success" onclick="acceptFriend('${f}')"><i data-feather="check" class="w-4 h-4"></i></button>
                  <button class="action-icon-btn danger" onclick="declineFriend('${f}')"><i data-feather="x" class="w-4 h-4"></i></button>
              `;
          container.appendChild(createRow(f, "Incoming Friend Request", actions));
        });

        const headerOut = document.createElement('h3');
        headerOut.className = "uppercase text-xs font-bold text-discord-gray-400 mb-2 mt-4";
        headerOut.textContent = `Outgoing - ${friendsState.outgoing.length}`;
        container.appendChild(headerOut);

        friendsState.outgoing.forEach(f => {
          const actions = `
                  <button class="action-icon-btn danger" onclick="cancelFriendRequest('${f}')"><i data-feather="x" class="w-4 h-4"></i></button>
              `;
          container.appendChild(createRow(f, "Outgoing Friend Request", actions));
        });
      }

      feather.replace();
    }

    async function requestFriend() {
      const input = document.getElementById('addFriendInput');
      const to = (input?.value || '').trim();
      const from = localStorage.getItem('username');
      if (!to || !from) return;

      try {
        const res = await fetch('/api/friends/request', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ from, to }) });
        await res.json();
        input.value = '';
        loadFriends();
      } catch { }
    }

    function requestFriendMain() {
      const input = document.getElementById('addFriendInputMain');
      const to = input.value.trim();
      if (to) {
        // Call your existing API
        const from = localStorage.getItem('username');
        fetch('/api/friends/request', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ from, to }) })
          .then(r => r.json()).then(d => {
            if (d.success) { alert('Request sent!'); input.value = ''; loadFriends(); }
            else alert(d.error || 'Failed');
          });
      }
    }

    async function acceptFriend(from) {
      const username = localStorage.getItem('username');
      if (!username) return;
      await fetch('/api/friends/accept', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, from }) });
      loadFriends();
    }

    async function declineFriend(from) {
      const username = localStorage.getItem('username');
      if (!username) return;
      await fetch('/api/friends/decline', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, from }) });
      loadFriends();
    }

    async function cancelFriendRequest(target) {
      const username = localStorage.getItem('username');
      if (!username) return;
      await fetch('/api/friends/cancel', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, to: target }) });
      loadFriends();
    }

    async function removeFriend(friend) {
      const username = localStorage.getItem('username');
      if (!username) return;
      await fetch('/api/friends/remove', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, friend }) });
      loadFriends();
    }

    // ---- Groups UI logic ----
    async function openGroupChat(group) {
      activeFriendChat = group; // Object
      renderSidebarList();

      document.getElementById('friendsDashboard').classList.add('hidden');
      const view = document.getElementById('friendsChatView');
      view.classList.remove('hidden');

      document.getElementById('chatHeaderTitle').textContent = group.name;

      const msgsContainer = document.getElementById('friendsChatMessages');
      msgsContainer.innerHTML = '';

      if (navigator.onLine) socket.emit('join_group', { groupId: group.id, username: localStorage.getItem('username') });

      try {
        const res = await fetch(`/api/groups/${group.id}/messages`);
        const msgs = await res.json();
        for (const m of msgs) {
          const el = await createDiscordMessage(m);
          msgsContainer.appendChild(el);
        }
        msgsContainer.scrollTop = msgsContainer.scrollHeight;
      } catch (e) { }
    }

    function setActiveGroup(group) {
      groupsState.activeId = group?.id || null;
      // Map to HTML IDs: groupChatChannelName, groupChatMemberCount, groupChatMessages
      const titleEl = document.getElementById('groupChatChannelName');
      if (titleEl) titleEl.textContent = group ? `${group.name}` : 'Select a group';

      const meta = document.getElementById('groupChatMemberCount');
      if (meta) meta.textContent = group ? `${(group.members || []).length} members` : '';

      const msgsContainer = document.getElementById('groupChatMessages');
      if (msgsContainer) msgsContainer.innerHTML = '';

      if (!group) return;

      if (navigator.onLine) socket.emit('join_group', { groupId: group.id, username: localStorage.getItem('username') });

      fetch(`/api/groups/${group.id}/messages`).then(r => r.json()).then(async msgs => {
        for (const m of msgs) {
          await appendGroupMessage(m);
        }
      }).catch(() => { });
    }

    async function appendGroupMessage(data) {
      const msgElement = await createDiscordMessage(data);
      const container = document.getElementById('groupChatMessages');
      if (container) {
        container.appendChild(msgElement);
        container.scrollTop = container.scrollHeight;
      }
    }

    async function refreshGroups() {
      return loadGroups();
    }

    // (createNewGroup, joinExistingGroup, sendGroupMessage, sendGroupFile)
    async function createNewGroup() {
      const owner = localStorage.getItem('username');
      const nameInput = document.getElementById('newGroupNameInput');
      const descInput = document.getElementById('newGroupDescInput');
      let name = nameInput?.value?.trim();

      if (!name) { alert("Please enter a group name."); return; }

      const description = descInput?.value?.trim() || "";

      if (!owner) return;
      try {
        const res = await fetch('/api/groups/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ owner, name, description }) });
        const data = await res.json();
        if (res.ok && data.success) {
          closeGroupsModal();
          refreshGroups();
          if (nameInput) nameInput.value = '';
          if (descInput) descInput.value = '';
        } else {
          alert(data.error || "Failed to create group.");
        }
      } catch { }
    }

    async function joinExistingGroup() {
      const groupIdInput = document.getElementById('joinGroupIdInput');
      const groupId = groupIdInput?.value?.trim();
      const username = localStorage.getItem('username');

      if (!username || !groupId) return;

      try {
        const res = await fetch('/api/groups/join', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, groupId }) });
        const data = await res.json();

        if (data.success) {
          closeGroupsModal();
          refreshGroups();
          // Optionally auto-switch
          // const g = (groupsState.list || []).find(x => x.id === groupId);
          // if (g) setActiveGroup(g);
          if (groupIdInput) groupIdInput.value = '';
        } else {
          alert(data.error || "Failed to join group.");
        }
      } catch { }
    }
    function sendGroupChatMessage() {
      const input = document.getElementById('groupChatInput');
      const message = (input?.value || '').trim();
      if (!message || !groupsState.activeId) return;
      const payload = { groupId: groupsState.activeId, username: localStorage.getItem('username'), message };
      if (navigator.onLine) socket.emit('send_group_message', payload);
      else (async () => { await appendGroupMessage(payload); })();
      input.value = ''; input.style.height = 'auto';
    }

    function sendGroupFile(event) {
      const file = event.target.files?.[0];
      if (!file || !groupsState.activeId) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const payload = { groupId: groupsState.activeId, username: localStorage.getItem('username'), fileName: file.name, fileType: file.type, fileData: e.target.result };
        if (navigator.onLine) {
          socket.emit('send_group_file', payload);
        } else {  // Don't render optimistically when online - socket will handle it
          (async () => { await appendGroupMessage(payload); })(); // Only render optimistically when offline
        }
        event.target.value = '';
      };
      reader.readAsDataURL(file);
    }

    // Socket listeners for group messages (use new render function)
    if (typeof io !== 'undefined') {
      socket.on('receive_group_message', async (data) => {
        if (data.groupId === groupsState.activeId) await appendGroupMessage(data);
      });
      socket.on('receive_group_file', async (data) => {
        if (data.groupId === groupsState.activeId) await appendGroupMessage(data);
      });
    }

    window.addEventListener("DOMContentLoaded", async () => {
      const username = localStorage.getItem("username");
      if (!username) {
        document.getElementById("profileUsername").textContent = "N/A";
        document.getElementById("profileUsertag").textContent = "N/A";
        return;
      }

      try {
        if (!navigator.onLine) throw new Error('offline');
        const res = await fetch(`/api/get-user?identifier=${username}`);
        const data = await res.json();

        if (data.success) {
          const updated = data.user || {};

          document.getElementById("profileUsername").textContent = updated.username;
          document.getElementById("profileUsertag").textContent = updated.usertag;
          const el_aboutMe = document.getElementById("aboutMe"); if (el_aboutMe) el_aboutMe.value = updated.aboutMe || "";
          document.getElementById("avatarImage").src = updated.avatar || "/images/default_avatar.png";
          document.getElementById("bannerImage").src = updated.banner || "/images/default_banner.png";

          // Update settings avatar and banner too
          const settingsAvatar = document.getElementById("settingsAvatar");
          const settingsBanner = document.getElementById("settingsBanner");
          if (settingsAvatar) settingsAvatar.src = updated.avatar || "/images/default_avatar.png";
          if (settingsBanner) settingsBanner.src = updated.banner || "/images/default_banner.png";
        } else {
          console.error("User not found");
        }
      } catch (err) {
        const cached = {  // Offline fallback: populate from localStorage if available
          username: localStorage.getItem('username'),
          usertag: localStorage.getItem('usertag'),
          aboutMe: localStorage.getItem('aboutMe') || '',
          avatar: localStorage.getItem('avatar') || '/images/default_avatar.png',
          banner: localStorage.getItem('banner') || '/images/default_banner.png',
          level: parseInt(localStorage.getItem('level') || '0', 10),
          gold: parseInt(localStorage.getItem('gold') || '0', 10),
          rank: localStorage.getItem('rank') || 'Unranked'
        };
        document.getElementById("profileUsername").textContent = cached.username || 'N/A';
        document.getElementById("profileUsertag").textContent = cached.usertag || 'N/A';
        const el_aboutMe = document.getElementById("aboutMe"); if (el_aboutMe) el_aboutMe.value = cached.aboutMe;
        document.getElementById("avatarImage").src = cached.avatar;
        document.getElementById("bannerImage").src = cached.banner;
        document.getElementById("statLevel").textContent = cached.level;
        document.getElementById("statGold").textContent = cached.gold;
        document.getElementById("statRank").textContent = cached.rank;
      }
    });

    // ---- DMs ----
    let dmState = { active: null };

    function setActiveDM(peer) {
      dmState.active = peer || null;
      const header = document.getElementById('dmHeader');
      const msgs = document.getElementById('dmMessages');
      if (header) header.textContent = peer ? `Direct Message with ${peer}` : 'Select a friend and click Message to start.';
      if (!peer) { if (msgs) msgs.innerHTML = ''; return; }
      const me = localStorage.getItem('username');
      fetch(`/api/dm/history?userA=${encodeURIComponent(me)}&userB=${encodeURIComponent(peer)}`).then(r => r.json()).then(async list => {
        msgs.innerHTML = '';
        for (const m of list) {
          await appendDMMessage(m);
        }
        msgs.scrollTop = msgs.scrollHeight;
      }).catch(() => { });
    }

    async function sendFriendMessage() {
      const input = document.getElementById('friendsChatInput');
      const text = input.value.trim();
      if (!text || !activeFriendChat) return;
      const me = localStorage.getItem('username');

      // Check if DM (string) or Group (object)
      if (typeof activeFriendChat === 'string') {
        // DM Logic
        const payload = { from: me, to: activeFriendChat, message: text };
        if (navigator.onLine) socket.emit('send_dm', payload);
        else {
          const el = await createDiscordMessage({ ...payload, username: me });
          document.getElementById('friendsChatMessages').appendChild(el);
        }
        // Also fetch to persist
        fetch('/api/dm/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).catch(() => { });

      } else {
        // Group Logic
        const payload = { groupId: activeFriendChat.id, username: me, message: text };
        if (navigator.onLine) socket.emit('send_group_message', payload);
      }

      input.value = '';
    }

    function sendFriendFile(e) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const fileData = e.target.result;
        socket.emit("send_file", {
          username,
          fileName: file.name,
          fileType: file.type,
          fileData: fileData
        });
      };
      reader.readAsDataURL(file); // encodes file as base64
    }

    async function openDM(username) {
      activeFriendChat = username;
      renderSidebarList(); // Update active highlight

      // Switch View
      document.getElementById('friendsDashboard').classList.add('hidden');
      const view = document.getElementById('friendsChatView');
      view.classList.remove('hidden');

      // Update Header
      document.getElementById('chatHeaderTitle').textContent = username;

      // Clear & Load Messages
      const msgsContainer = document.getElementById('friendsChatMessages');
      msgsContainer.innerHTML = '';

      const me = localStorage.getItem('username');
      try {
        const res = await fetch(`/api/dm/history?userA=${encodeURIComponent(me)}&userB=${encodeURIComponent(username)}`);
        const msgs = await res.json();
        for (const m of msgs) {
          const el = await createDiscordMessage({ ...m, username: m.from }); // Reuse your existing message creator
          msgsContainer.appendChild(el);
        }
        msgsContainer.scrollTop = msgsContainer.scrollHeight;
      } catch (e) { }
    }

    async function appendDMMessage(data) {
      const me = localStorage.getItem('username') || '';
      const isOwn = (data.from || '') === me;
      const wrapper = document.createElement('div');
      wrapper.classList.add('flex', 'items-start', 'gap-2', 'mb-2');
      wrapper.classList.add(isOwn ? 'justify-end' : 'justify-start');

      const avatar = document.createElement('img');
      const author = isOwn ? me : (data.from || '');
      const avatarUrl = await getUserAvatarUrl(author);
      avatar.src = avatarUrl;
      avatar.alt = `${author}'s avatar`;
      avatar.className = 'w-8 h-8 rounded-full object-cover';
      avatar.onerror = function () { this.onerror = null; this.src = '/images/default_avatar.png'; };

      const bubble = document.createElement('div');
      bubble.classList.add('message', isOwn ? 'self' : 'other');
      const header = document.createElement('div');
      header.className = 'text-xs opacity-75 mb-1';
      header.textContent = `${author} | ${new Date((data.ts || Date.now()) * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;

      let body;
      if (data.fileData && data.fileName) {
        const ext = (data.fileName.split('.').pop() || '').toLowerCase();
        const imageExts = ["png", "jpg", "jpeg", "gif", "webp", "svg"];
        const videoExts = ["mp4", "webm", "ogg", "mov", "m4v"];
        const audioExts = ["mp3", "wav", "ogg", "m4a", "aac", "flac"];
        if (imageExts.includes(ext)) { body = document.createElement('img'); body.src = data.fileData; body.alt = data.fileName; body.className = 'max-w-xs rounded'; }
        else if (videoExts.includes(ext)) { const v = document.createElement('video'); v.controls = true; v.src = data.fileData; v.className = 'max-w-xs rounded'; body = v; }
        else if (audioExts.includes(ext)) { const a = document.createElement('audio'); a.controls = true; a.src = data.fileData; body = a; }
        else { const a = document.createElement('a'); a.href = data.fileData; a.download = data.fileName; a.textContent = `üìé ${data.fileName}`; a.className = 'text-blue-400 underline'; body = a; }

      } else if (data.message) {
        body = document.createElement('div');
        body.textContent = data.message;
      }
      bubble.appendChild(header); if (body) bubble.appendChild(body);
      if (isOwn) { wrapper.appendChild(bubble); wrapper.appendChild(avatar); }
      else { wrapper.appendChild(avatar); wrapper.appendChild(bubble); }
      const msgs = document.getElementById('dmMessages');
      msgs.appendChild(wrapper);
      msgs.scrollTop = msgs.scrollHeight;
    }

    function sendDMMessage() {
      const me = localStorage.getItem('username');
      const peer = dmState.active;
      if (!me || !peer) return;
      const input = document.getElementById('dmInput');
      const msg = (input?.value || '').trim();
      if (!msg) return;
      const payload = { from: me, to: peer, message: msg };
      if (navigator.onLine) socket.emit('send_dm', payload);
      else (async () => { await appendDMMessage(payload); })();
      input.value = ''; input.style.height = 'auto';
      fetch('/api/dm/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).catch(() => { });
    }
    function sendDMFile(event) {
      const file = event.target.files?.[0];
      const me = localStorage.getItem('username');
      const peer = dmState.active;
      if (!file || !me || !peer) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const payload = { from: me, to: peer, fileName: file.name, fileType: file.type, fileData: e.target.result };
        if (navigator.onLine) {
          socket.emit('send_dm', payload);
        } else {  // Don't render optimistically when online - socket will handle it
          (async () => { await appendDMMessage(payload); })();  // Only render optimistically when offline
        }
        fetch('/api/dm/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).catch(() => { });
        event.target.value = '';
      };
      reader.readAsDataURL(file);
    }

    if (typeof io !== 'undefined') {
      socket.on('receive_dm', async (data) => {
        const me = localStorage.getItem('username') || '';
        if (!dmState.active) return;
        const { from, to } = data || {};
        if ((from === me && to === dmState.active) || (to === me && from === dmState.active)) await appendDMMessage(data);
      });
    }

    // Profile Functions (Kept as is, selectors still valid)
    // (loadStats, cropper logic, loadUserData, profile tab switching, etc... all kept as is)
    async function loadStats() {
      const baseUrl = window.location.origin;
      try {
        if (!navigator.onLine) throw new Error('offline');
        const res = await fetch(`${baseUrl}/api/stats`);
        const data = await res.json();
        document.getElementById("stat-users").textContent = data.users;
        document.getElementById("stat-messages").textContent = data.messages;
        document.getElementById("stat-rooms").textContent = data.rooms;
      } catch (err) { // Populate with cached or default values when offline
        document.getElementById("stat-users").textContent = localStorage.getItem('stat-users') || '0';
        document.getElementById("stat-messages").textContent = localStorage.getItem('stat-messages') || '0';
        document.getElementById("stat-rooms").textContent = localStorage.getItem('stat-rooms') || '1';
      }
    }

    let cropper = null;
    let currentTarget = null;

    function openCropper(event, targetType) {
      const file = event.target.files[0];
      if (!file) return;

      currentTarget = targetType;

      const reader = new FileReader();
      reader.onload = function (e) {
        const img = document.getElementById('cropperImage');
        img.src = e.target.result;
        document.getElementById('cropperModal').classList.remove('hidden');

        if (cropper) cropper.destroy();

        cropper = new Cropper(img, {
          aspectRatio: targetType === 'avatar' ? 1 : 16 / 5,
          viewMode: 1,
          dragMode: 'move',
          responsive: true,
        });

        const zoomSlider = document.getElementById('zoomSlider');
        if (zoomSlider) {
          zoomSlider.oninput = (ev) => {
            try {
              const level = parseFloat(ev.target.value || '1');
              if (cropper) cropper.zoomTo(level);
            } catch { }
          };
        }
      };
      reader.readAsDataURL(file);

      // reset file input so selecting the same file twice still triggers change
      event.target.value = "";
    }

    function rotateImage(deg) {
      if (cropper) cropper.rotate(deg);
    }

    function closeCropper() {
      cropper?.destroy();
      cropper = null;
      document.getElementById('cropperModal').classList.add('hidden');
      const z = document.getElementById('zoomSlider');  // also clear zoom slider back to default
      if (z) z.value = '1';
    }

    function applyCrop() {
      const canvas = cropper.getCroppedCanvas({
        width: currentTarget === 'avatar' ? 200 : 800,
        height: currentTarget === 'avatar' ? 200 : 250
      });

      const imageUrl = canvas.toDataURL('image/png');

      if (currentTarget === 'avatar') {
        document.getElementById('avatarImage').src = imageUrl;
        localStorage.setItem('avatar', imageUrl);
        const settingsAvatar = document.getElementById('settingsAvatar'); // Update settings avatar too
        if (settingsAvatar) settingsAvatar.src = imageUrl;
      } else if (currentTarget === 'banner') {
        document.getElementById('bannerImage').src = imageUrl;
        localStorage.setItem('banner', imageUrl);
        const settingsBanner = document.getElementById('settingsBanner'); // Update settings banner too
        if (settingsBanner) settingsBanner.src = imageUrl;
      }

      // Ask user if they want to use this image as background
      if (confirm(`Would you like to use this ${currentTarget} as your background image?`)) {
        localStorage.setItem('bgImageDataUrl', imageUrl);
        localStorage.setItem('themeMode', 'custom');  // Set theme mode to custom to show the background
        applyBackground();
        applyThemeMode('custom');
        alert('Background updated! You can change this anytime in Settings > Appearance.');
      }

      closeCropper();
      document.getElementById("saveProfileBtn").classList.remove("hidden");
      checkProfileChanges();
    }

    async function loadUserData() {
      const username = localStorage.getItem("username");
      if (!username) return;
      try {
        const res = await fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`);
        const data = await res.json();
        if (!data.success) { console.error("Failed to load user:", data.error); return; }
        const user = data.user || {};

        // Update Profile Tab
        document.getElementById("profileUsername").textContent = user.username || "N/A";
        document.getElementById("profileUsertag").textContent = user.usertag || "N/A";
        document.getElementById("avatarImage").src = user.avatar || "/images/default_avatar.png";
        document.getElementById("bannerImage").src = user.banner || "/images/default_banner.png";

        // Update User Panel
        document.getElementById("userPanelUsername").textContent = user.username || "N/A";
        document.getElementById("userPanelUsertag").textContent = user.usertag || "N/A";
        document.getElementById("userPanelAvatar").src = user.avatar || "/images/default_avatar.png";

        // Update Settings Tab
        const settingsAvatar = document.getElementById("settingsAvatar");
        const settingsBanner = document.getElementById("settingsBanner");
        if (settingsAvatar) settingsAvatar.src = user.avatar || "/images/default_avatar.png";
        if (settingsBanner) settingsBanner.src = user.banner || "/images/default_banner.png";

        const shortBioText = (user.about && String(user.about).trim()) || "";
        const aboutText = (user.aboutMe && String(user.aboutMe).trim()) || "This user haven't said anything about them self yet...";
        const profileBio = document.getElementById("profileBio");
        const profileAboutBio = document.getElementById("profileAboutBio");
        if (profileBio) profileBio.textContent = shortBioText || aboutText;
        if (profileAboutBio) profileAboutBio.textContent = aboutText;

        if (user.settings) {
          const avatarEffect = user.settings.profileEffect || 'none';
          const bannerEffect = user.settings.bannerEffect || 'none';
          setTimeout(() => {
            applyAvatarEffect(avatarEffect);
            applyBannerEffect(bannerEffect);
          }, 100);
        }
        checkProfileViewingUser();
        loadProfileAboutTab();
      } catch (err) {
        console.error("Error fetching user data", err);
      }
    }

    // Check if viewing another user's profile and if they're a friend
    async function checkProfileViewingUser() {
      const currentUsername = localStorage.getItem("username");
      const profileUsername = document.getElementById("profileUsername")?.textContent;

      if (!profileUsername || profileUsername === "N/A" || profileUsername === currentUsername) {
        const actionButtons = document.getElementById("profileActionButtons"); // Own profile - hide buttons
        if (actionButtons) actionButtons.style.display = "none";
        return;
      }

      // Check if they're friends
      try {
        const res = await fetch(`/api/friends?username=${encodeURIComponent(currentUsername)}`);
        const data = await res.json();
        if (data.success) {
          const isFriend = (data.friends || []).includes(profileUsername);
          const actionButtons = document.getElementById("profileActionButtons");
          const messageBtn = document.getElementById("profileMessageBtn");
          const addFriendBtn = document.getElementById("profileAddFriendBtn");

          if (actionButtons) {
            if (isFriend) { // Show only message button
              if (messageBtn) messageBtn.style.display = "block";
              if (addFriendBtn) addFriendBtn.style.display = "none";
              actionButtons.style.display = "flex";
            } else { // Show add friend button
              if (messageBtn) messageBtn.style.display = "none";
              if (addFriendBtn) addFriendBtn.style.display = "block";
              actionButtons.style.display = "flex";
            }
          }
        }
      } catch (e) {
        console.error("Error checking friends:", e);
      }
    }

    function openDMFromProfile() {
      const profileUsername = document.getElementById("profileUsername")?.textContent;
      if (profileUsername) {
        setActiveDM(profileUsername);
        switchTab('chats');
      }
    }

    async function addFriendFromProfile() {
      const currentUsername = localStorage.getItem("username");
      const profileUsername = document.getElementById("profileUsername")?.textContent;

      if (!currentUsername || !profileUsername) return;

      try {
        const res = await fetch('/api/friends/request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ from: currentUsername, to: profileUsername })
        });
        const data = await res.json();
        if (data.success) {
          alert('Friend request sent!');
          checkProfileViewingUser();
        } else {
          alert(data.error || 'Failed to send friend request');
        }
      } catch (e) {
        alert('Failed to send friend request');
      }
    }

    document.querySelectorAll("#profileTabs .profile-tab").forEach(btn => {
      btn.addEventListener("click", (e) => {
        if (btn.dataset.tab === 'effects') return; // Don't handle click if it's the effects button (handled by onclick)

        e.preventDefault();
        document.querySelectorAll("#profileTabs .profile-tab").forEach(b => b.classList.remove("active", "text-white"));
        btn.classList.add("active", "text-white");
        const tab = btn.dataset.tab;
        document.querySelectorAll("#profileTabContent .tab-pane").forEach(p => {
          p.classList.toggle("hidden", p.dataset.tab !== tab);
        });

        // Load tab-specific content
        if (tab === 'about') {
          loadProfileAboutTab();
        } else if (tab === 'friends') {
          loadMutualFriendsTab();
        }
      });
    });

    function loadProfileAboutTab() {
      const username = localStorage.getItem("username");
      const profileUsername = document.getElementById("profileUsername")?.textContent;
      const targetUsername = profileUsername || username;

      if (!targetUsername) return;

      fetch(`/api/get-user?identifier=${encodeURIComponent(targetUsername)}`)
        .then(r => r.json())
        .then(data => {
          if (data.success && data.user) {
            const user = data.user;
            const profileAboutBio = document.getElementById("profileAboutBio");
            if (profileAboutBio) {
              profileAboutBio.textContent =
                (user.aboutMe && user.aboutMe.trim()) ||
                "This user haven't said anything about them self...";
            }
          }
        })
        .catch(() => { });
    }

    async function loadMutualFriendsTab() {
      const currentUsername = localStorage.getItem("username");
      const profileUsername = document.getElementById("profileUsername")?.textContent;

      if (!currentUsername || !profileUsername || currentUsername === profileUsername) {
        document.getElementById("mutualFriendsContent").textContent = "No mutual friends to show.";
        return;
      }

      try {
        const [currentRes, profileRes] = await Promise.all([
          fetch(`/api/friends?username=${encodeURIComponent(currentUsername)}`),
          fetch(`/api/friends?username=${encodeURIComponent(profileUsername)}`)
        ]);

        const currentData = await currentRes.json();
        const profileData = await profileRes.json();

        if (currentData.success && profileData.success) {
          const currentFriends = new Set(currentData.friends || []);
          const profileFriends = new Set(profileData.friends || []);
          const mutual = [...currentFriends].filter(f => profileFriends.has(f));

          const content = document.getElementById("mutualFriendsContent");
          if (content) {
            if (mutual.length === 0) {
              content.textContent = "No mutual friends to show.";
            } else {
              content.innerHTML = mutual.map(f => `<div class="p-2 bg-gray-700 rounded mb-2">${f}</div>`).join('');
            }
          }
        }
      } catch (e) {
        console.error("Error loading mutual friends:", e);
      }
    }

    function openProfileEffectsModal() {
      const modal = document.getElementById('profileEffectsModal');
      if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');

        // Load current effects
        const username = localStorage.getItem("username");
        fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`)
          .then(r => r.json())
          .then(data => {
            if (data.success && data.user && data.user.settings) {
              const settings = data.user.settings;
              const avatarEffect = settings.profileEffect || 'none';
              const bannerEffect = settings.bannerEffect || 'none';

              document.querySelector(`input[name="avatarEffect"][value="${avatarEffect}"]`).checked = true;
              document.querySelector(`input[name="bannerEffect"][value="${bannerEffect}"]`).checked = true;
            }
          })
          .catch(() => { });

        feather.replace();
      }
    }

    function closeProfileEffectsModal() {
      const modal = document.getElementById('profileEffectsModal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }
    }

    async function applyProfileEffects() {
      const avatarEffect = document.querySelector('input[name="avatarEffect"]:checked')?.value || 'none';
      const bannerEffect = document.querySelector('input[name="bannerEffect"]:checked')?.value || 'none';
      const username = localStorage.getItem("username");

      if (!username) return;

      try {
        const res = await fetch('/api/update-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username,
            settings: {
              profileEffect: avatarEffect,
              bannerEffect: bannerEffect
            }
          })
        });

        const data = await res.json();
        if (data.success) {
          alert('Profile effects applied successfully!');
          closeProfileEffectsModal();
          setTimeout(() => { // Apply effects immediately to DOM
            applyAvatarEffect(avatarEffect);
            applyBannerEffect(bannerEffect);
          }, 100);
          loadUserData(); // Reload user data to ensure sync
        } else {
          alert(data.error || 'Failed to apply effects');
        }
      } catch (e) {
        alert('Failed to apply effects');
      }
    }

    function startEditBio() {
      const el = document.getElementById('profileBio');
      if (!el) return;
      const current = (el.tagName.toLowerCase() === 'input' || el.tagName.toLowerCase() === 'textarea') ? el.value : el.textContent.trim();
      const input = document.createElement('input');  // Replace the <p> with an <input> (same id so saveProfileChanges reads it)
      input.id = 'profileBio';
      input.type = 'text';
      input.className = 'w-full border px-3 py-2 rounded-md bg-gray-900 text-white';
      input.value = current === PLACEHOLDER_BIO ? '' : current;
      el.replaceWith(input);
      showInlineEditControls('bio');  // show save/cancel controls
      input.focus();
    }

    function startEditAbout() {
      const el = document.getElementById('profileAboutBio');
      if (!el) return;
      const current = el.tagName.toLowerCase() === 'textarea' ? el.value : el.textContent.trim();
      const ta = document.createElement('textarea');  // Replace the <p> with a <textarea id="aboutMe"> so existing code reads it
      ta.id = 'aboutMe'; // reuse aboutMe id so saveProfileChanges/readers pick it
      ta.rows = 6;
      ta.className = 'w-full border px-3 py-2 rounded-md bg-gray-900 text-white';
      ta.value = current === PLACEHOLDER_ABOUT ? '' : current;
      el.replaceWith(ta);
      showInlineEditControls('about');
      ta.focus();
    }

    function showInlineEditControls(kind) {
      // Remove existing controls first
      const existing = document.getElementById(`inlineEditControls_${kind}`);
      if (existing) existing.remove();

      const container = document.createElement('div');
      container.className = 'inline-edit-controls mt-2 flex gap-2';
      container.id = `inlineEditControls_${kind}`;

      const save = document.createElement('button');
      save.className = 'px-3 py-1 bg-blue-600 rounded text-white';
      save.textContent = 'Save';
      save.onclick = async () => {
        try {
          const result = await saveProfileChanges();
          await new Promise(res => setTimeout(res, 120)); // allow DOM update
          hideInlineEditControls('bio', result);
          hideInlineEditControls('about', result);
          if (result?.success && typeof showToast !== 'undefined') {
            showToast('Profile updated');
          }
        } catch (e) {
          console.error('Save failed', e);
          alert('Failed to save profile');
        }
      };

      const cancel = document.createElement('button');
      cancel.className = 'px-3 py-1 bg-gray-600 rounded text-white';
      cancel.textContent = 'Cancel';
      cancel.onclick = () => cancelInlineEdit(kind);

      container.append(save, cancel);

      // Insert controls under the correct element
      let el;
      if (kind === 'bio') {
        el = document.getElementById('profileBio');
      } else {
        el = document.getElementById('aboutMe') || document.getElementById('profileAboutBio');
      }

      if (el) {
        el.insertAdjacentElement('afterend', container);
      } else {
        console.warn(`Cannot show inline edit controls, element not found for kind: ${kind}`);
      }
    }

    const PLACEHOLDER_BIO = "This user haven't said anything about them self yet...";
    const PLACEHOLDER_ABOUT = "This user haven't said anything about them self yet...";

    function hideInlineEditControls(kind, result) {
      const controls = document.getElementById(`inlineEditControls_${kind}`);
      if (controls) controls.remove();

      if (kind === 'bio') {
        const el = document.getElementById('profileBio');
        if (!el) return;

        const val = (result?.bio != null) ? result.bio.trim() : PLACEHOLDER_BIO;

        const p = document.createElement('p');
        p.id = 'profileBio';
        p.className = 'text-gray-300 truncate';
        p.textContent = val;
        el.replaceWith(p);

      } else if (kind === 'about') {
        const el = document.getElementById('aboutMe') || document.getElementById('profileAboutBio');
        if (!el) return;

        const val = (result?.about != null) ? result.about.trim() : PLACEHOLDER_ABOUT;

        const p = document.createElement('p');
        p.id = 'profileAboutBio';
        p.className = 'text-gray-300 whitespace-pre-wrap';
        p.textContent = val;
        el.replaceWith(p);
      }

      try { feather.replace(); } catch { }
    }

    function cancelInlineEdit(kind) {
      if (kind === 'bio') {
        const display = document.getElementById('settingsProfileBioDisplay');
        const val = display?.textContent?.trim() || PLACEHOLDER_BIO;
        const el = document.getElementById('profileBio');
        if (el) {
          const p = document.createElement('p');
          p.id = 'profileBio';
          p.className = 'text-gray-300 truncate';
          p.textContent = val;
          el.replaceWith(p);
        }
      } else {
        const display = document.getElementById('settingsAboutMeDisplay');
        const val = display?.textContent?.trim() || PLACEHOLDER_ABOUT;
        const el = document.getElementById('aboutMe') || document.getElementById('profileAboutBio');
        if (el) {
          const p = document.createElement('p');
          p.id = 'profileAboutBio';
          p.className = 'text-gray-300 whitespace-pre-wrap';
          p.textContent = val;
          el.replaceWith(p);
        }
      }

      hideInlineEditControls(kind);
    }

    /// Optional Status Functions
    function toRoman(num) {
      const roman = ["", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X"];
      return roman[num] || num;
    }

    function getSubTier(levelInRange, rangeSize, maxTier) {
      const tierSize = rangeSize / maxTier;
      let tier = Math.ceil(levelInRange / tierSize);
      if (tier < 1) tier = 1;
      if (tier > maxTier) tier = maxTier;
      return tier;
    }

    function getRank(level) {
      if (level <= 25) return `Stone ${toRoman(getSubTier(level, 25, 5))}`;
      if (level <= 55) return `Metal ${toRoman(getSubTier(level - 25, 30, 5))}`;
      if (level <= 80) return `Gold ${toRoman(getSubTier(level - 55, 25, 5))}`;
      if (level <= 110) return `Mithril ${toRoman(getSubTier(level - 80, 30, 7))}`;
      if (level <= 150) return `Black Mithril ${toRoman(getSubTier(level - 110, 40, 10))}`;

      // Master tier logic
      let masterLevel = level - 150;
      if (masterLevel <= 100) {
        return `Master ${toRoman(getSubTier(masterLevel, 100, 5))}`;
      } else if (masterLevel <= 200) {
        return `Grand Master ${toRoman(getSubTier(masterLevel - 100, 100, 5))}`;
      } else {
        return level >= 450 ? "Master Slayer" : `Grand Master ${toRoman(5)}`; // Level 450 special rank
      }
    }

    function getRankColor(rank) {
      const lowered = String(rank || '').toLowerCase();
      if (lowered.startsWith("stone")) return "#808080"; // gray
      if (lowered.startsWith("metal")) return "#a8a9ad"; // silver
      if (lowered.startsWith("gold")) return "#FFD700"; // gold yellow
      if (lowered.startsWith("mithril") && !lowered.startsWith("black")) return "#87CEFA"; // light blue
      if (lowered.startsWith("black mithril")) return "#4682B4"; // dark light blue
      if (lowered.startsWith("grand master")) return "#4B0082"; // dark purple
      if (lowered.startsWith("master slayer")) return "#FF4500"; // Bright orange-red
      if (lowered.startsWith("master")) return "#800080"; // purple
      return "#ffffff"; // default white
    }

    // Removed hidden stat hotkey handler
    const saveBtn = document.getElementById("saveProfileBtn");
    let initialProfileData = {};

    async function saveProfileChanges() {
      const username = localStorage.getItem("username");
      if (!username) return alert("No username found in local storage!");

      try {
        // Fetch current user data
        const resUser = await fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`);
        const userData = await resUser.json();
        if (!userData.success) return alert("User not found!");

        const usertag = userData.user?.usertag || '';
        const rawTag = String(usertag).replace(/^@+/, '');

        const readText = (el) => {
          if (!el) return "";
          const tag = el.tagName?.toLowerCase();
          if (tag === "input" || tag === "textarea") return (el.value || "").trim();
          return (el.textContent || "").trim();
        };

        // Short bio
        const shortBioEl = document.getElementById("settingsProfileBio")
          || document.getElementById("settingsProfileBioDisplay")
          || document.getElementById("profileBio");
        let shortBioRaw = readText(shortBioEl);
        if (shortBioRaw === PLACEHOLDER_BIO || shortBioRaw === PLACEHOLDER_ABOUT) shortBioRaw = "";
        const shortBio = shortBioRaw;

        // Long bio
        const aboutEl = document.getElementById("settingsAboutMe") || document.getElementById("aboutMe");
        const aboutMeValue = readText(aboutEl);

        console.log('Saving profile - shortBio:', shortBio, 'aboutMe:', aboutMeValue);

        // Build payload
        const currentServer = userData.user || {};
        const payload = {
          username,
          usertag: rawTag ? '@' + rawTag : '',
          avatar: document.getElementById("avatarImage")?.src || currentServer.avatar || '',
          banner: document.getElementById("bannerImage")?.src || currentServer.banner || '',
          about: shortBio,
          aboutMe: aboutMeValue
        };
        console.log('Sending update request:', payload);

        // Send update
        const res = await fetch(`/api/update-profile`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`Failed to save profile: ${res.statusText}`);
        const data = await res.json();

        if (!data.success) throw new Error(data.message || 'Failed to save profile');

        const updated = data.user || {};

        const returnedShort = (typeof data.user?.about !== 'undefined' && data.user.about?.trim() !== '')
          ? data.user.about.trim()
          : shortBio;

        const returnedLong = (typeof data.user?.aboutMe !== 'undefined' && data.user.aboutMe?.trim() !== '')
          ? data.user.aboutMe.trim()
          : aboutMeValue;

        // Update UI
        document.getElementById("profileUsername").textContent = updated.username || payload.username;
        const showTag = (updated.usertag || payload.usertag || '').replace(/^@+/, '');
        document.getElementById("profileUsertag").textContent = showTag ? '@' + showTag : '';
        document.getElementById("avatarImage").src = updated.avatar || payload.avatar;
        document.getElementById("bannerImage").src = updated.banner || payload.banner;

        const profileBio = document.getElementById("profileBio");
        if (profileBio) profileBio.textContent = returnedShort || PLACEHOLDER_BIO;

        const profileAboutBio = document.getElementById("profileAboutBio");
        if (profileAboutBio) profileAboutBio.textContent = returnedLong || PLACEHOLDER_ABOUT;

        // Sync settings inputs
        const inShort = document.getElementById("settingsProfileBio");
        const inLong = document.getElementById("settingsAboutMe");
        if (inShort) inShort.value = returnedShort;
        if (inLong) inLong.value = returnedLong;

        const editorAbout = document.getElementById("aboutMe");
        if (editorAbout) {
          if (editorAbout.tagName.toLowerCase() === "textarea" || editorAbout.tagName.toLowerCase() === "input") {
            editorAbout.value = returnedLong;
          } else {
            editorAbout.textContent = returnedLong;
          }
        }

        captureInitialProfileData?.();
        const sp = document.getElementById("saveProfileBtn");
        if (sp) sp.classList.add("hidden");

        return { success: true, bio: returnedShort, about: returnedLong };

      } catch (err) {
        console.error("Error saving profile:", err);
        alert("An error occurred while saving profile. Check console.");
        throw err;
      }
    }

    function captureInitialProfileData() {
      initialProfileData = {
        aboutMe: document.getElementById("aboutMe")?.value.trim(),
        banner: document.getElementById("bannerImage").src,
        avatar: document.getElementById("avatarImage").src
      };
    }
    captureInitialProfileData();

    function checkProfileChanges() {
      const currentData = {
        aboutMe: document.getElementById("aboutMe")?.value.trim(),
        banner: document.getElementById("bannerImage").src,
        avatar: document.getElementById("avatarImage").src
      };
      const hasChanges = JSON.stringify(currentData) !== JSON.stringify(initialProfileData);
      saveBtn.classList.toggle("hidden", !hasChanges);
    }

    // Watch for changes
    const elAbout = document.getElementById("aboutMe");
    if (elAbout) elAbout.addEventListener("input", checkProfileChanges);

    const elProfileBanner = document.getElementById("profileBannerUpload");
    if (elProfileBanner) elProfileBanner.addEventListener("change", (e) => openCropper(e, "banner"));

    const elProfileAvatar = document.getElementById("profileAvatarUpload");
    if (elProfileAvatar) elProfileAvatar.addEventListener("change", (e) => openCropper(e, "avatar"));

    const elSettingsBanner = document.getElementById("settingsBannerUpload");
    if (elSettingsBanner) elSettingsBanner.addEventListener("change", (e) => openCropper(e, "banner"));

    const elSettingsAvatar = document.getElementById("settingsAvatarUpload");
    if (elSettingsAvatar) elSettingsAvatar.addEventListener("change", (e) => openCropper(e, "avatar"));

    function promptUsernameEdit() {
      const current = localStorage.getItem('username') || '';
      const next = prompt('Enter new username', current || '');
      if (!next || next === current) return;
      const curEl = document.getElementById('currentUsername');
      if (curEl) curEl.textContent = next;
      updateUsername(next);
    }
    function promptUsertagEdit() {
      const current = (localStorage.getItem('usertag') || '').replace('@', '');
      const next = prompt('Enter new 4-digit usertag', current || '');
      if (!next) return;
      updateUsertag(next);
    }
    function promptEmailEdit() {
      const current = localStorage.getItem('savedEmail') || '';
      const next = prompt('Enter new email', current || '');
      if (!next) return;
      updateEmail(next);
    }

    // Account settings quick view
    (function hydrateAccountSettings() {
      const username = localStorage.getItem('username');
      if (!username) return;

      // Load from API to get latest data
      fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`)
        .then(r => r.json())
        .then(data => {
          if (data.success && data.user) {
            const user = data.user;
            const uEl = document.getElementById('currentUsername');
            if (uEl) uEl.textContent = user.username || '';
            const tEl = document.getElementById('currentUsertag');
            if (tEl) tEl.textContent = user.usertag || '';
            const eEl = document.getElementById('currentEmail');
            if (eEl) eEl.textContent = user.email || 'Hidden';
            const sa = document.getElementById('settingsAvatar');
            if (sa) sa.src = user.avatar || '/images/default_avatar.png';
            const sb = document.getElementById('settingsBanner');
            if (sb) sb.src = user.banner || '/images/default_banner.png';
            const pe = document.getElementById('profileEmail');
            if (pe) pe.textContent = user.email || 'Hidden';
            const lang = localStorage.getItem('language') || 'en';
            const sl = document.getElementById('settingsLanguage');
            if (sl) sl.value = lang;
            const pl = document.getElementById('profileLanguage');
            if (pl) pl.value = lang;
            const aboutMe = document.getElementById('settingsAboutMe');
            if (aboutMe) aboutMe.value = user.aboutMe || '';
            // also prefill short bio input
            const shortBio = document.getElementById('settingsProfileBio');
            if (shortBio) shortBio.value = user.about || '';

            // Track account settings changes
            trackAccountSettingsChanges();
          }
        })
        .catch(() => { });

      try { feather.replace(); } catch { }
    })();

    let accountSettingsChanged = false;
    let originalAccountSettings = {};

    function trackAccountSettingsChanges() {
      const username = localStorage.getItem('username');
      if (!username) return;

      // Store original values
      originalAccountSettings = {
        username: document.getElementById('currentUsername')?.textContent || '',
        usertag: document.getElementById('currentUsertag')?.textContent || '',
        email: document.getElementById('currentEmail')?.textContent || '',
        avatar: document.getElementById('settingsAvatar')?.src || '',
        banner: document.getElementById('settingsBanner')?.src || '',
        aboutMe: document.getElementById('settingsAboutMe')?.value || ''
      };

      // Watch for changes in avatar/banner uploads and about me
      const settingsAvatarUpload = document.getElementById('settingsAvatarUpload');
      const settingsBannerUpload = document.getElementById('settingsBannerUpload');
      const settingsAboutMe = document.getElementById('settingsAboutMe');

      if (settingsAvatarUpload) {
        settingsAvatarUpload.addEventListener('change', () => {
          accountSettingsChanged = true;
          updateAccountSaveButton();
        });
      }

      if (settingsBannerUpload) {
        settingsBannerUpload.addEventListener('change', () => {
          accountSettingsChanged = true;
          updateAccountSaveButton();
        });
      }

      if (settingsAboutMe) {
        settingsAboutMe.addEventListener('input', () => {
          accountSettingsChanged = true;
          updateAccountSaveButton();
        });
      }
    }

    function updateAccountSaveButton() {
      const saveBtn = document.getElementById('saveAccountSettingsBtn');
      if (saveBtn) {
        saveBtn.style.display = accountSettingsChanged ? 'block' : 'none';
      }
    }

    // Update account settings save function - hook into existing confirmSaveSettings
    if (typeof window.confirmSaveSettings === 'function') {
      const originalConfirmSaveSettings = window.confirmSaveSettings;
      window.confirmSaveSettings = function () {
        originalConfirmSaveSettings();
        if (accountSettingsChanged) {  // Also save account settings if changed
          saveAccountSettings();
        }
      };
    } else {
      window.confirmSaveSettings = function () {
        if (accountSettingsChanged) { // Also save account settings if changed
          saveAccountSettings();
        }
      };
    }

    async function saveAccountSettings() {
      const username = localStorage.getItem('username');
      if (!username) return;

      const avatar = document.getElementById('settingsAvatar')?.src || '';
      const banner = document.getElementById('settingsBanner')?.src || '';
      const shortBio = (document.getElementById('settingsProfileBio')?.value || '').trim();
      const aboutMe = (document.getElementById('settingsAboutMe')?.value || '').trim();

      // Convert data URLs to base64 if needed
      let avatarData = avatar;
      let bannerData = banner;

      if (avatar.startsWith('data:')) {
        avatarData = avatar;
      } else if (avatar.startsWith('/uploads/')) {
        avatarData = avatar;
      }

      if (banner.startsWith('data:')) {
        bannerData = banner;
      } else if (banner.startsWith('/uploads/')) {
        bannerData = banner;
      }

      try {
        const res = await fetch('/api/update-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username,
            avatar: avatarData,
            banner: bannerData,
            about: shortBio,   // send short bio as 'about'
            aboutMe: aboutMe   // send long about as 'aboutMe'
          })
        });

        const data = await res.json();
        if (data.success) {
          accountSettingsChanged = false;
          updateAccountSaveButton();

          const updated = data.user || {};
          const displayedShort = (updated.about && String(updated.about).trim()) || shortBio || "This user haven't said anything about them self...";
          const displayedLong = (updated.aboutMe && String(updated.aboutMe).trim()) || aboutMe || "This user haven't said anything about them self...";

          const elShort = document.getElementById('profileBio');
          const elLong = document.getElementById('profileAboutBio');

          if (elShort) elShort.textContent = displayedShort;
          if (elLong) elLong.textContent = displayedLong;

          // Also update inputs (keep UI in sync)
          const inShort = document.getElementById('settingsProfileBio');
          const inLong = document.getElementById('settingsAboutMe');
          if (inShort) inShort.value = displayedShort === "This user haven't said anything about them self..." ? '' : displayedShort;
          if (inLong) inLong.value = displayedLong === "This user haven't said anything about them self..." ? '' : displayedLong;

          // Refresh any cached user data if you have a loader
          if (typeof loadUserData === 'function') loadUserData();

          // Reload account settings UI
          hydrateAccountSettings();
        }
      } catch (e) {
        console.error('Failed to save account settings:', e);
      }
    }

    // Files Functions
    const files = [
      { name: "Zylo_v1.5.7", sizeMB: 94.1, filename: "Zylo_v1.5.7.zip" },
      { name: "Zylo_v1.6.1", sizeMB: 92.1, filename: "Zylo_v1.6.1.zip" },
      { name: "Zylo_v1.6.2", sizeMB: 88.1, filename: "Zylo_v1.6.2.zip" }
    ];

    let estimatedTimes = {};

    function estimateTimes() {
      const speedMbps = parseFloat(document.getElementById('speed').value);
      if (!speedMbps || speedMbps <= 0) {
        alert("Please enter a valid internet speed.");
        return;
      }

      files.forEach(file => {
        const estimatedSeconds = (file.sizeMB * 8) / speedMbps;
        estimatedTimes[file.filename] = estimatedSeconds;
        const timeDisplay = document.getElementById(`time-${file.filename}`);
        if (timeDisplay) {
          timeDisplay.innerText = `‚è±Ô∏è Estimated time : ${estimatedSeconds.toFixed(1)} seconds`;
        }
      });
    }

    function startDownload(filename) {
      const progressBar = document.getElementById(`progress-${filename}`);
      const estimatedTime = estimatedTimes[filename] || 5;
      let progress = 0;
      const interval = 100;
      const increment = 100 / ((estimatedTime * 1000) / interval);

      progressBar.style.width = '0%';
      progressBar.classList.remove('bg-green-500');
      const timer = setInterval(() => {
        progress += increment;
        if (progress >= 100) {
          progress = 100;
          clearInterval(timer);
          progressBar.classList.add('bg-green-500');
        }
        progressBar.style.width = `${progress}%`;
      }, interval);

      // Trigger actual download
      const a = document.createElement('a');
      a.href = `/files/${filename}`;
      a.download = filename;
      a.click();
    }

    function renderDownloads() {
      const container = document.getElementById('downloads');
      container.innerHTML = '';

      files.forEach(file => {
        const html = `
          <div class="p-4 border rounded-lg shadow-sm 
                      bg-gray-50/90 dark:bg-gray-800/80 
                      border-gray-200 dark:border-gray-700 
                      text-gray-800 dark:text-gray-100">
            
            <h2 class="text-xl font-semibold">${file.name}</h2>
            <p class="text-sm text-gray-600 dark:text-gray-300">${file.sizeMB} MB</p>
            <p id="time-${file.filename}" class="text-sm text-blue-600 dark:text-blue-400 mt-1">
              ‚è±Ô∏è Estimated time: not calculated
            </p>

            <div class="w-full bg-gray-300 dark:bg-gray-700 rounded h-3 mt-2 overflow-hidden">
              <div id="progress-${file.filename}" 
                  class="bg-blue-500 h-full w-0 transition-all duration-500 ease-in-out">
              </div>
            </div>

            <button onclick="startDownload('${file.filename}')"
                    class="mt-3 px-4 py-2 bg-green-600 text-white rounded 
                          hover:bg-green-700 
                          dark:bg-green-500 dark:hover:bg-green-400">
              Download
            </button>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
      });
    }

    renderDownloads();

    /// Settings Functions (Kept as is)
    let settingsChanged = false;
    let pendingSettingsChanges = {};
    let originalSettings = {};

    // Initialize original settings
    function initializeOriginalSettings() {

      // General settings
      settingsMap.forEach(({ key }) => {
        const el = document.getElementById(key.replace('Toggle', '').replace('Select', ''));
        if (el) {
          originalSettings[key] = el.type === 'checkbox' ? el.checked : el.value;
        }
      });

      // Sound settings
      soundSettingsMap.forEach(({ key }) => {
        const el = document.getElementById(key);
        if (el) {
          originalSettings[key] = el.type === 'checkbox' ? el.checked : el.value;
        }
      });
    }

    // Check if settings have changed
    function checkSettingsChanges() {
      let hasChanges = false;
      pendingSettingsChanges = {};

      // Check general settings
      settingsMap.forEach(({ key }) => {
        const el = document.getElementById(key.replace('Toggle', '').replace('Select', ''));
        if (el) {
          const currentValue = el.type === 'checkbox' ? el.checked : el.value;
          const originalValue = originalSettings[key];

          if (currentValue !== originalValue) {
            hasChanges = true;
            pendingSettingsChanges[key] = currentValue;
          }
        }
      });

      // Check sound settings
      soundSettingsMap.forEach(({ key }) => {
        const el = document.getElementById(key);
        if (el) {
          const currentValue = el.type === 'checkbox' ? el.checked : el.value;
          const originalValue = originalSettings[key];

          if (currentValue !== originalValue) {
            hasChanges = true;
            pendingSettingsChanges[key] = currentValue;
          }
        }
      });

      settingsChanged = hasChanges;
      updateSaveButtonVisibility();
    }

    // Update save button visibility
    function updateSaveButtonVisibility() {
      const generalSaveBtn = document.getElementById('saveSettingsBtn');
      const soundSaveBtn = document.getElementById('saveSoundSettingsBtn');
      const accountSaveBtn = document.getElementById('saveAccountSettingsBtn');

      if (generalSaveBtn) {
        generalSaveBtn.style.display = settingsChanged ? 'block' : 'none';
      }
      if (soundSaveBtn) {
        soundSaveBtn.style.display = settingsChanged ? 'block' : 'none';
      }
      if (accountSaveBtn) {
        accountSaveBtn.style.display = settingsChanged ? 'block' : 'none';
      }
    }

    // Show save confirmation modal
    function showSaveSettingsModal() {
      const modal = document.getElementById('saveSettingsModal');
      if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
      }
    }

    // Hide save confirmation modal
    function hideSaveSettingsModal() {
      const modal = document.getElementById('saveSettingsModal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }
    }

    // Confirm save settings
    window.confirmSaveSettings = function () {
      saveAllSettings();
      hideSaveSettingsModal();
    };

    // Discard settings changes
    window.discardSettingsChanges = function () {
      // Revert to original settings
      settingsMap.forEach(({ key }) => {
        const el = document.getElementById(key.replace('Toggle', '').replace('Select', ''));
        if (el) {
          const originalValue = originalSettings[key];
          if (el.type === 'checkbox') {
            el.checked = originalValue;
          } else {
            el.value = originalValue;
          }
        }
      });

      settingsChanged = false;
      pendingSettingsChanges = {};
      updateSaveButtonVisibility();
      hideSaveSettingsModal();
    };

    // Cancel save settings
    window.cancelSaveSettings = function () {
      hideSaveSettingsModal();
    };

    // Save all settings
    function saveAllSettings() { // Save general settings
      settingsMap.forEach(({ key }) => {
        const el = document.getElementById(key.replace('Toggle', '').replace('Select', ''));
        if (el) {
          const value = el.type === 'checkbox' ? el.checked : el.value;
          localStorage.setItem(key, value);
          originalSettings[key] = value;
        }
      });

      // Save sound settings
      soundSettingsMap.forEach(({ key }) => {
        const el = document.getElementById(key);
        if (el) {
          const value = el.type === 'checkbox' ? el.checked : el.value;
          localStorage.setItem(key, value);
          originalSettings[key] = value;
        }
      });

      // Persist to backend
      persistSettings(pendingSettingsChanges);
      settingsChanged = false;
      pendingSettingsChanges = {};
      updateSaveButtonVisibility();

      // Show success message
      showSettingsSaveSuccess();
    }

    // Show save success message
    function showSettingsSaveSuccess() { // Create temporary success message
      const successMsg = document.createElement('div');
      successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fadeIn';
      successMsg.innerHTML = '<i data-feather="check-circle" class="w-4 h-4 inline mr-2"></i>Settings saved successfully!';
      document.body.appendChild(successMsg);

      // Replace feather icons
      feather.replace();

      // Remove after 3 seconds
      setTimeout(() => {
        successMsg.remove();
      }, 3000);
    }

    /// General Settings
    function persistSettings(partial) {
      const username = localStorage.getItem('username');
      if (!username) return;
      fetch('/api/update-settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, settings: partial })
      }).catch(() => { });
    }

    async function hydrateSettingsFromBackend() {
      const username = localStorage.getItem('username');
      if (!username) return;
      try {
        const resp = await fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`);
        const data = await resp.json();
        if (!data?.success) return;
        const settings = data.user?.settings || {};
        Object.entries(settings).forEach(([k, v]) => { // Merge backend settings into localStorage without overwriting user's local changes for this session
          if (localStorage.getItem(k) == null) {
            localStorage.setItem(k, typeof v === 'boolean' ? String(v) : String(v));
          }
        });
      } catch { }
    }

    const settingsMap = [
      { id: "animationsToggle", key: "enableAnimations" },
      { id: "compactToggle", key: "compactMode" },
      { id: "tooltipToggle", key: "showTooltips" },
      { id: "languageSelect", key: "language" },
      { id: "startupPage", key: "startupPage" },
      { id: "autoSaveToggle", key: "autoSave" },
      { id: "confirmExitToggle", key: "confirmBeforeExit" }
    ];

    window.addEventListener("DOMContentLoaded", async () => {
      await hydrateSettingsFromBackend();
      settingsMap.forEach(({ id, key }) => {
        const el = document.getElementById(id);
        const savedValue = localStorage.getItem(key);
        if (el) {
          if (el.type === "checkbox") el.checked = savedValue === "true";
          else if (savedValue) el.value = savedValue;
        }
      });
      applyGeneralSettings();

      // Initialize settings change tracking
      initializeOriginalSettings();
      checkSettingsChanges();
    });

    settingsMap.forEach(({ id, key }) => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("change", function () {
          const value = this.type === "checkbox" ? this.checked : this.value;
          localStorage.setItem(key, value);
          applyGeneralSettings();

          // Track changes for save confirmation
          checkSettingsChanges();

          // Auto-save for some settings (optional)
          if (['enableAnimations', 'compactMode', 'showTooltips'].includes(key)) {
            persistSettings({ [key]: value });
          }
        });
      }
    });

    function applyGeneralSettings() { // Animations and compact mode
      const animationsEnabled = (localStorage.getItem("enableAnimations") ?? 'true') !== "false";
      document.body.classList.toggle("no-animations", !animationsEnabled);
      document.body.classList.toggle("compact", localStorage.getItem("compactMode") === "true");

      // Tooltips
      const showTips = (localStorage.getItem("showTooltips") ?? 'true') === "true";
      if (!showTips) {
        document.querySelectorAll("[title]").forEach(el => el.removeAttribute("title"));
      }

      // Confirm before exit
      const wantConfirm = localStorage.getItem("confirmBeforeExit") === "true";
      window.onbeforeunload = wantConfirm ? (e) => { e.preventDefault(); e.returnValue = ''; } : null;

      // Language runtime micro i18n for settings labels only
      applySettingsLocale();
    }

    function applySettingsLocale() {
      const lang = localStorage.getItem('language') || 'en';
      const dict = {
        en: {
          settingsTitle: '‚öôÔ∏è Settings', general: 'General', sounds: 'Sounds', account: 'Account', about: 'About Us',
          enableAnimations: 'Enable Animations', compactMode: 'Compact Mode', showTooltips: 'Show Tooltips', language: 'Language',
          startupPage: 'Startup Page', autoSave: 'Auto Save Changes', confirmExit: 'Confirm Before Exit', appearance: 'Appearance',
          solidBg: 'Solid BG', resetAll: 'Reset All Settings'
        },
        es: {
          settingsTitle: '‚öôÔ∏è Ajustes', general: 'General', sounds: 'Sonidos', account: 'Cuenta', about: 'Acerca de',
          enableAnimations: 'Habilitar animaciones', compactMode: 'Modo compacto', showTooltips: 'Mostrar consejos', language: 'Idioma',
          startupPage: 'P√°gina de inicio', autoSave: 'Guardar autom√°ticamente', confirmExit: 'Confirmar antes de salir', appearance: 'Apariencia',
          solidBg: 'Fondo s√≥lido', resetAll: 'Restablecer todos los ajustes'
        },
        vi: {
          settingsTitle: '‚öôÔ∏è C√†i ƒë·∫∑t', general: 'Chung', sounds: '√Çm thanh', account: 'T√†i kho·∫£n', about: 'Gi·ªõi thi·ªáu',
          enableAnimations: 'B·∫≠t hi·ªáu ·ª©ng', compactMode: 'Ch·∫ø ƒë·ªô g·ªçn', showTooltips: 'Hi·ªÉn th·ªã g·ª£i √Ω', language: 'Ng√¥n ng·ªØ',
          startupPage: 'Trang kh·ªüi ƒë·ªông', autoSave: 'T·ª± ƒë·ªông l∆∞u', confirmExit: 'X√°c nh·∫≠n tr∆∞·ªõc khi tho√°t', appearance: 'Giao di·ªán',
          solidBg: 'N·ªÅn ƒë·ªìng m√†u', resetAll: 'ƒê·∫∑t l·∫°i t·∫•t c·∫£ c√†i ƒë·∫∑t'
        }
      }[lang] || {};

      const byId = (id) => document.getElementById(id);
      if (byId('settingsTitle') && dict.settingsTitle) byId('settingsTitle').textContent = dict.settingsTitle;
      if (byId('tabBtnGeneral') && dict.general) byId('tabBtnGeneral').textContent = dict.general;
      if (byId('tabBtnSounds') && dict.sounds) byId('tabBtnSounds').textContent = dict.sounds;
      if (byId('tabBtnAccount') && dict.account) byId('tabBtnAccount').textContent = dict.account;
      if (byId('tabBtnAbout') && dict.about) byId('tabBtnAbout').textContent = dict.about;
      if (byId('labelEnableAnimations') && dict.enableAnimations) byId('labelEnableAnimations').textContent = dict.enableAnimations;
      if (byId('labelCompactMode') && dict.compactMode) byId('labelCompactMode').textContent = dict.compactMode;
      if (byId('labelShowTooltips') && dict.showTooltips) byId('labelShowTooltips').textContent = dict.showTooltips;
      if (byId('labelLanguage') && dict.language) byId('labelLanguage').textContent = dict.language;
      if (byId('labelStartupPage') && dict.startupPage) byId('labelStartupPage').textContent = dict.startupPage;
      if (byId('labelAutoSave') && dict.autoSave) byId('labelAutoSave').textContent = dict.autoSave;
      if (byId('labelConfirmExit') && dict.confirmExit) byId('labelConfirmExit').textContent = dict.confirmExit;
      if (byId('titleAppearance') && dict.appearance) byId('titleAppearance').textContent = dict.appearance;
      if (byId('labelSolidBg') && dict.solidBg) byId('labelSolidBg').textContent = dict.solidBg;
      if (byId('btnResetAll') && dict.resetAll) byId('btnResetAll').textContent = dict.resetAll;
    }

    function resetAllSettings() {
      if (confirm("Are you sure you want to reset all settings?\nThis action can not be undo.")) {
        settingsMap.forEach(({ key }) => localStorage.removeItem(key));
        location.reload();
      }
    }

    if (localStorage.getItem("confirmBeforeExit") === "true") {
      window.addEventListener("beforeunload", function (e) {
        e.preventDefault();
        e.returnValue = '';
      });
    }

    // Sound settings change tracking
    const soundSettingsMap = [
      { id: "soundVolume", key: "soundVolume" },
      { id: "musicVolume", key: "musicVolume" },
      { id: "muteAll", key: "muteAll" },
      { id: "enableSound", key: "enableSound" },
      { id: "enableMusic", key: "enableMusic" },
      { id: "soundProfile", key: "soundProfile" },
      { id: "duckMusic", key: "duckMusic" },
      { id: "playSend", key: "playSend" },
      { id: "playReceive", key: "playReceive" },
      { id: "playUi", key: "playUi" }
    ];

    // Add sound settings to change tracking
    soundSettingsMap.forEach(({ id, key }) => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("change", function () {
          const value = this.type === "checkbox" ? this.checked : this.value;
          localStorage.setItem(key, value);
          checkSettingsChanges();
        });
      }
    });

    // Event listeners for changes
    document.getElementById("animationsToggle").addEventListener("change", function () {
      localStorage.setItem("enableAnimations", this.checked);
      applyGeneralSettings();
      persistSettings({ enableAnimations: this.checked });
    });

    document.getElementById("compactToggle").addEventListener("change", function () {
      localStorage.setItem("compactMode", this.checked);
      applyGeneralSettings();
      persistSettings({ compactMode: this.checked });
    });

    document.getElementById("tooltipToggle").addEventListener("change", function () {
      localStorage.setItem("showTooltips", this.checked);
      applyGeneralSettings();
      persistSettings({ showTooltips: this.checked });
    });

    document.getElementById("languageSelect").addEventListener("change", function () {
      localStorage.setItem("language", this.value);
      applySettingsLocale();
      persistSettings({ language: this.value });
    });

    // Sound settings
    (function initSoundSettings() {
      const soundControls = [
        { id: 'soundVolume', key: 'soundVolume' },
        { id: 'musicVolume', key: 'musicVolume' },
        { id: 'muteAll', key: 'muteAll', checkbox: true },
        { id: 'enableSound', key: 'enableSound', checkbox: true },
        { id: 'enableMusic', key: 'enableMusic', checkbox: true },
        { id: 'soundProfile', key: 'soundProfile' },
        { id: 'duckMusic', key: 'duckMusic', checkbox: true },
        { id: 'playSend', key: 'playSend', checkbox: true },
        { id: 'playReceive', key: 'playReceive', checkbox: true },
        { id: 'playUi', key: 'playUi', checkbox: true },
      ];

      soundControls.forEach(({ id, key, checkbox }) => {
        const el = document.getElementById(id);
        if (!el) return;
        const saved = localStorage.getItem(key);
        if (saved != null) {
          if (checkbox) el.checked = saved === 'true';
          else el.value = saved;
        }
        el.addEventListener('change', function () {
          const value = checkbox ? this.checked : this.value;
          localStorage.setItem(key, value);
          persistSettings({ [key]: value });
        });
      });
    })();

    /// Account Settings
    async function updateUsername(newUsername) {
      if (!newUsername) {
        const el = document.getElementById("changeUsername");
        newUsername = (el ? el.value : '').trim();
      }

      const current = localStorage.getItem('username');
      if (!newUsername) return alert("Please enter a username.");
      if (!current) return alert("You are not logged in.");

      try {
        const res = await fetch('/api/update-username', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: current, newUsername })
        });

        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        localStorage.setItem('username', data.username);

        const saved = localStorage.getItem('savedUsername');
        if (saved === current) localStorage.setItem('savedUsername', data.username);
        document.getElementById('profileUsername').textContent = data.username;

        const curU = document.getElementById('currentUsername'); if (curU) curU.textContent = data.username;
        alert('Username updated.');
      } catch (e) {
        alert('Failed to update username: ' + (e.message || 'Unknown error'));
      }
    }

    async function updateUsertag(newTag) {
      if (!newTag) {
        const el = document.getElementById("changeUsertag");
        newTag = (el ? el.value : '').trim();
      }

      const username = localStorage.getItem('username');
      if (!newTag) return alert("Please enter a usertag.");
      if (!/^\d{4}$/.test(newTag)) return alert("Usertag must be exactly 4 digits.");

      try {
        const res = await fetch('/api/update-usertag', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, newUsertag: newTag })
        });

        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        document.getElementById('profileUsertag').textContent = data.usertag;

        const curT = document.getElementById('currentUsertag'); if (curT) curT.textContent = data.usertag;
        localStorage.setItem('usertag', data.usertag);
        alert('Usertag updated.');
      } catch (e) {
        alert('Failed to update usertag: ' + (e.message || 'Unknown error'));
      }
    }

    async function updateEmail(newEmail) {
      if (!newEmail) {
        const el = document.getElementById("changeEmail");
        newEmail = (el ? el.value : '').trim();
      }

      const username = localStorage.getItem('username');
      if (!newEmail) return alert("Please enter a new email.");

      try {
        const res = await fetch('/api/update-email', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, newEmail })
        });

        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        localStorage.setItem('savedEmail', data.email);

        const curE = document.getElementById('currentEmail'); if (curE) curE.textContent = data.email;
        const pe = document.getElementById('profileEmail'); if (pe) pe.textContent = data.email;
        alert('Email updated.');
      } catch (e) {
        alert('Failed to update email: ' + (e.message || 'Unknown error'));
      }
    }

    async function updatePassword() {
      const oldPass = document.getElementById("oldPassword").value;
      const newPass = document.getElementById("newPassword").value;
      const confirmPass = document.getElementById("confirmPassword").value;
      const username = localStorage.getItem('username');
      if (!oldPass || !newPass || !confirmPass) return alert("Fill out all password fields.");
      if (newPass !== confirmPass) return alert("New passwords do not match.");

      try {
        const res = await fetch('/api/update-password', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, oldPassword: oldPass, newPassword: newPass })
        });

        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        alert('Password updated successfully.');

        document.getElementById("oldPassword").value = '';
        document.getElementById("newPassword").value = '';
        document.getElementById("confirmPassword").value = '';
      } catch (e) {
        alert('Failed to update password: ' + (e.message || 'Unknown error'));
      }
    }

    // Two-factor authentication toggle
    document.getElementById("twoFactorToggle").addEventListener("change", function () {
      localStorage.setItem("twoFactorEnabled", this.checked);
      const username = localStorage.getItem('username');

      if (username) {
        fetch('/api/update-settings', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, settings: { twoFactorEnabled: this.checked } })
        }).catch(() => { });
      }
      alert(`Two-Factor Authentication ${this.checked ? 'enabled' : 'disabled'}.`);
    });

    // Privacy toggles (defensive binding)
    const showEmailEl = document.getElementById("showEmail");
    if (showEmailEl) {
      showEmailEl.addEventListener("change", function () {
        localStorage.setItem("showEmail", this.checked);
        const username = localStorage.getItem('username');
        if (username) fetch('/api/update-settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, settings: { showEmail: this.checked } }) }).catch(() => { });
      });
    }

    const shareActivityEl = document.getElementById("shareActivity");
    if (shareActivityEl) {
      shareActivityEl.addEventListener("change", function () {
        localStorage.setItem("shareActivity", this.checked);
        const username = localStorage.getItem('username');
        if (username) fetch('/api/update-settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, settings: { shareActivity: this.checked } }) }).catch(() => { });
      });
    }

    async function deleteAccount() {
      if (!confirm("Are you sure you want to delete your account?\nThis action cannot be undone.")) return;
      const username = localStorage.getItem('username');
      try {
        const res = await fetch('/api/delete-account', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });

        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        localStorage.clear(); // Clear local data and go to login
        window.location.href = '/login.html';
      } catch (e) {
        alert('Failed to delete account: ' + (e.message || 'Unknown error'));
      }
    }

    /// About Settings
    function populateAboutInfo() {
      const statusEl = document.getElementById('aboutSystemStatus');
      if (!statusEl) return;
      statusEl.textContent = 'Checking backend status...';

      try {
        fetch('/api/stats', { cache: 'no-store' })
          .then(r => r.json())
          .then(data => {
            if (data && typeof data.users !== 'undefined') {
              statusEl.textContent = `Backend OK ‚Ä¢ Users: ${data.users} ‚Ä¢ Messages: ${data.messages} ‚Ä¢ Rooms: ${data.rooms}`;
            } else {
              statusEl.textContent = 'Backend reachable, unexpected response.';
            }
          })
          .catch(() => {
            statusEl.textContent = 'Backend unreachable. You may be offline.';
          });
      } catch {
        statusEl.textContent = 'Backend unreachable. You may be offline.';
      }
    }

    function checkForUpdates() {
      alert("üîÑ Checking for updates...\nNo updates available.");
    }

    function openChangelog() {
      alert("üìú Changelog:\n- Improved settings UI\n- Fixed minor bugs");
    }

    function openPrivacyPolicy() {
      alert("üîí Privacy Policy:\nYour data is stored securely and never shared.");
    }

    /// === Sidebar + Navbar Functions ===
    function toggleSidebar() {
      // This function NOW toggles Column 2 on mobile
      const subPanel = document.getElementById("subPanelContainer");
      const overlay = document.getElementById("overlay");
      const isOpening = subPanel.classList.contains("-translate-x-full");

      if (isOpening) {
        subPanel.classList.remove("-translate-x-full");
        overlay.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
      } else {
        subPanel.classList.add("-translate-x-full");
        overlay.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      }
    }

    // Theme/Appearance functions (Kept as is)
    document.addEventListener("DOMContentLoaded", () => {
      const themeColorDot = document.getElementById('themeColorDot');
      const themeColorText = document.getElementById('themeColorText');
      const colorPicker = document.getElementById('customThemeColorPicker');
      const solidBgToggle = document.getElementById('solidBgToggle');
      const bgInput = document.getElementById('bgImageInput');
      const clearBgBtn = document.getElementById('clearBgImageBtn');
      const previewBgBtn = document.getElementById('previewBgBtn');

      const savedTheme = localStorage.getItem('theme');
      let themeMode = localStorage.getItem('themeMode');
      if (!themeMode) { // Back-compat with existing 'theme' storage
        themeMode = (savedTheme === 'dark' || savedTheme === 'light') ? savedTheme : 'light';
        localStorage.setItem('themeMode', themeMode);
      }

      const media = window.matchMedia('(prefers-color-scheme: dark)');
      function systemPrefersDark() { return media.matches; }

      function updateThemeButtons(activeMode) {
        document.querySelectorAll('[data-theme-btn]').forEach(btn => {
          if (btn.dataset.themeBtn === activeMode) {
            btn.classList.add('ring-2', 'ring-blue-500');
          } else {
            btn.classList.remove('ring-2', 'ring-blue-500');
          }
        });
      }

      function getCustomColor() {
        return localStorage.getItem('customThemeColor') || '#0b1020';
      }

      function setSwatch(hex) {
        if (!themeColorDot || !themeColorText) return;
        themeColorDot.style.backgroundColor = hex;
        themeColorText.textContent = hex.toUpperCase();
      }

      function clearInlineBackground() {
        const b = document.body.style;
        b.background = '';
        b.backgroundImage = '';
        b.backgroundSize = '';
        b.backgroundAttachment = '';
      }

      function applyBackground() {
        const img = localStorage.getItem('bgImageDataUrl');
        const solid = localStorage.getItem('solidBg') === 'true';
        const color = getCustomColor();
        clearInlineBackground();

        if (img) {
          document.body.style.backgroundImage = `url(${img})`;
          document.body.style.backgroundSize = 'cover';
          document.body.style.backgroundAttachment = 'fixed';
        } else if (solid) {
          document.body.style.background = color;
        }

        if (solidBgToggle) solidBgToggle.checked = solid;
        if (colorPicker) colorPicker.value = color;
        setSwatch(color);
      }

      function applyThemeMode(mode) {
        // CRITICAL FIX: Always clear dark class AND inline styles first to prevent theme conflicts
        document.body.classList.remove('dark');
        document.documentElement.classList.remove('dark');
        clearInlineBackground();

        // Persist chosen mode
        localStorage.setItem('themeMode', mode);

        // Remove listener to avoid duplicates
        media.removeEventListener?.('change', handleSystemChange);

        if (mode === 'dark') {
          document.body.classList.add('dark');
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');

        } else if (mode === 'light') {
          // Already cleared above, just set storage
          localStorage.setItem('theme', 'light');

        } else if (mode === 'system') {
          const isDark = systemPrefersDark();
          if (isDark) {
            document.body.classList.add('dark');
            document.documentElement.classList.add('dark');
          }
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
          media.addEventListener?.('change', handleSystemChange);

        } else if (mode === 'custom') {
          // Custom mode uses light base with custom colors
          localStorage.setItem('theme', 'custom');
          applyBackground();
        }

        updateThemeButtons(mode);

        // Toggle color picker visibility for custom mode
        if (colorPicker) {
          colorPicker.classList.toggle('hidden', mode !== 'custom');
        }
      }

      function handleSystemChange() {
        const storedMode = localStorage.getItem('themeMode');
        if (storedMode === 'system') {
          const isDark = systemPrefersDark();

          // CRITICAL FIX: Clear first to prevent conflicts
          document.body.classList.remove('dark');
          document.documentElement.classList.remove('dark');

          // Apply if needed
          if (isDark) {
            document.body.classList.add('dark');
            document.documentElement.classList.add('dark');
          }

          localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
      }

      // Expose to buttons
      window.setTheme = function (mode) {
        if (mode === 'custom' && typeof openThemeEditor === 'function') {
          openThemeEditor();
        } else {
          applyThemeMode(mode);
        }
      };

      // Wire controls
      colorPicker?.addEventListener('input', (e) => {
        const hex = e.target.value;
        localStorage.setItem('customThemeColor', hex);
        setSwatch(hex);
        if ((localStorage.getItem('themeMode') || 'light') === 'custom') {
          applyBackground();
        }
      });

      solidBgToggle?.addEventListener('change', (e) => {
        localStorage.setItem('solidBg', e.target.checked);
        if ((localStorage.getItem('themeMode') || 'light') === 'custom') {
          applyBackground();
        }
      });

      bgInput?.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        // Show loading state
        const originalValue = e.target.value;
        e.target.disabled = true;
        e.target.value = '';

        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            try {
              const maxDim = 1920;
              let { width, height } = img;
              if (width > maxDim || height > maxDim) {
                const scale = Math.min(maxDim / width, maxDim / height);
                width = Math.round(width * scale);
                height = Math.round(height * scale);
              }

              const canvas = document.createElement('canvas');
              canvas.width = width; canvas.height = height;

              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
              localStorage.setItem('bgImageDataUrl', dataUrl);

              // Automatically switch to custom theme mode to show the background
              localStorage.setItem('themeMode', 'custom');
              applyThemeMode('custom');
              applyBackground();

              // Show success message
              alert('Background image imported successfully! Your theme has been switched to Custom mode to show the image.');

            } catch (error) {
              console.error('Error processing image:', error);
              alert('Error processing the image. Please try again.');
            } finally {
              e.target.disabled = false;  // Re-enable the input
            }
          };

          img.onerror = () => {
            alert('Error loading the image. Please try a different file.');
            e.target.disabled = false;
          };
          img.src = reader.result;
        };

        reader.onerror = () => {
          alert('Error reading the file. Please try again.');
          e.target.disabled = false;
        };
        reader.readAsDataURL(file);
      });

      clearBgBtn?.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear the background image?')) {
          localStorage.removeItem('bgImageDataUrl');
          if ((localStorage.getItem('themeMode') || 'light') === 'custom') {
            applyBackground();
          }

          if (bgInput) bgInput.value = ''; // Clear the file input
          alert('Background image cleared!');
        }
      });

      previewBgBtn?.addEventListener('click', () => {
        const bgImage = localStorage.getItem('bgImageDataUrl');
        if (!bgImage) {
          alert('No background image found. Please import an image first.');
          return;
        }

        // Temporarily switch to custom mode to show the background
        const currentMode = localStorage.getItem('themeMode') || 'light';
        localStorage.setItem('themeMode', 'custom');
        applyThemeMode('custom');
        applyBackground();

        // Show preview message
        alert('Previewing background image! Click OK to keep it or go back to your previous theme.');

        // Ask if user wants to keep it
        if (confirm('Do you want to keep this background image?')) {
          alert('Background image applied! You can change this anytime in Settings > Appearance.'); // Keep the custom theme
        } else {
          localStorage.setItem('themeMode', currentMode); // Revert to previous theme
          applyThemeMode(currentMode);
          if (currentMode !== 'custom') {
            clearInlineBackground();
          }
        }
      });

      // Initial hydrate
      setSwatch(getCustomColor());
      applyThemeMode(themeMode);

      try { // If a full custom theme exists, apply its variables and background
        const customStr = localStorage.getItem('currentCustomTheme');
        if (customStr && (localStorage.getItem('themeMode') || 'light') === 'custom') {
          const t = JSON.parse(customStr);
          document.body.classList.add('theme-custom');
          const s = document.body.style;

          if (t && t.ui) {
            s.setProperty('--navbar-bg', t.ui.navbarBg || '');
            s.setProperty('--sidebar-bg', t.ui.sidebarBg || '');
            s.setProperty('--panel-bg', t.ui.panelBg || '');
          }

          if (t) {
            s.setProperty('--text-color', t.textColor || '');
            s.setProperty('--accent-color', t.accentColor || '');
          }

          // Apply background according to saved theme
          s.background = '';
          s.backgroundImage = '';
          s.backgroundSize = '';
          s.backgroundAttachment = '';
          const bg = t?.background || {};

          if (bg.mode === 'solid') {
            s.background = bg.solid || '';
          } else if (bg.mode === 'gradient') {
            const a = (bg.gradient?.angle ?? 135);
            s.background = `linear-gradient(${a}deg, ${bg.gradient?.from || '#1e293b'}, ${bg.gradient?.to || '#0f172a'})`;
            s.backgroundAttachment = 'fixed';
            s.backgroundSize = '400% 400%';

          } else if (bg.mode === 'image' && bg.imageDataUrl) {
            s.backgroundImage = `url(${bg.imageDataUrl})`;
            s.backgroundSize = 'cover';
            s.backgroundAttachment = 'fixed';

          } else if (bg.mode === 'animated') {
            s.background = 'linear-gradient(135deg, #1e293b, #0f172a)';
            s.backgroundSize = '400% 400%';
          }
        }
      } catch { }

      // Initialize chat room + models/personas
      loadAiModels();
      loadAiPersonas();
      switchChatRoom(currentChatRoom);

      // Initialize profile effects
      initializeProfileEffects();

      // Initialize profile effects
      initializeProfileEffects();

      // Explore: wiring share and feed
      const exploreFile = document.getElementById('exploreFile');
      const exploreCaption = document.getElementById('exploreCaption');
      const explorePreview = document.getElementById('explorePreview');
      const exploreFeed = document.getElementById('exploreFeed');
      const exploreShareBtn = document.getElementById('exploreShareBtn');

      function renderPreview(file) {
        explorePreview.innerHTML = '';
        if (!file) return;
        const url = URL.createObjectURL(file);
        const type = (file.type || '').toLowerCase();

        if (type.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = url; img.className = 'max-h-72 rounded';
          explorePreview.appendChild(img);

        } else if (type.startsWith('video/')) {
          const video = document.createElement('video');
          video.controls = true; video.src = url; video.className = 'w-full max-h-72 rounded';
          explorePreview.appendChild(video);

        } else if (type.startsWith('audio/')) {
          const audio = document.createElement('audio');
          audio.controls = true; audio.src = url; audio.className = 'w-full';
          explorePreview.appendChild(audio);

        } else {
          const a = document.createElement('div');
          a.textContent = `üìé ${file.name}`;
          explorePreview.appendChild(a);
        }
      }

      exploreFile?.addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        renderPreview(f);
      });

      async function loadExploreFeed() {
        try {
          const res = await fetch('/api/explore/posts');
          const data = await res.json();
          const posts = data.posts || [];
          exploreFeed.innerHTML = '';

          posts.forEach(p => {
            const card = document.createElement('div');
            card.className = 'p-3 rounded-lg bg-white/10 border border-white/10';
            const header = document.createElement('div');
            header.className = 'text-xs opacity-75 mb-2';
            const date = new Date((p.createdAt || 0) * 1000).toLocaleString();
            header.textContent = `${p.username} ‚Ä¢ ${date}`;
            const caption = document.createElement('div');
            caption.className = 'mb-2';
            caption.textContent = p.caption || '';
            const ext = (p.fileName || '').split('.').pop().toLowerCase();
            const mediaWrap = document.createElement('div');

            if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg'].includes(ext)) {
              const img = document.createElement('img');
              img.src = p.url; img.className = 'w-full rounded';
              mediaWrap.appendChild(img);

            } else if (['mp4', 'webm', 'ogg', 'mov', 'm4v'].includes(ext)) {
              const video = document.createElement('video');
              video.controls = true; video.src = p.url; video.className = 'w-full rounded';
              mediaWrap.appendChild(video);

            } else if (['mp3', 'wav', 'ogg', 'm4a', 'aac', 'flac'].includes(ext)) {
              const audio = document.createElement('audio');
              audio.controls = true; audio.src = p.url; audio.className = 'w-full';
              mediaWrap.appendChild(audio);

            } else {
              const a = document.createElement('a');
              a.href = p.url; a.download = p.fileName || 'download'; a.textContent = `üìé ${p.fileName || 'file'}`; a.className = 'underline';
              mediaWrap.appendChild(a);
            }

            card.appendChild(header);
            if (caption.textContent) card.appendChild(caption);
            card.appendChild(mediaWrap);
            exploreFeed.appendChild(card);
          });
        } catch { }
      }

      async function shareExplore() {
        const f = exploreFile?.files?.[0];
        if (!f) { alert('Attach a file first.'); return; }
        const caption = exploreCaption?.value || '';
        const username = localStorage.getItem('username') || localStorage.getItem('savedUsername') || 'Anonymous';
        const reader = new FileReader();

        reader.onload = async (e) => {
          try {
            const fileData = e.target.result;
            const res = await fetch('/api/explore/posts', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, caption, fileName: f.name, fileData })
            });

            const data = await res.json();
            if (!res.ok || !data.success) throw new Error(data.error || 'Failed to share');
            if (exploreCaption) exploreCaption.value = '';  // Reset and reload
            if (exploreFile) exploreFile.value = '';
            explorePreview.innerHTML = '';
            await loadExploreFeed();
          } catch (err) { alert('Failed to share.'); }
        };
        reader.readAsDataURL(f);
      }

      exploreShareBtn?.addEventListener('click', shareExplore);
      loadExploreFeed();

      // Apply startup page if set
      const startup = (localStorage.getItem('startupPage') || 'home');
      switchTab(startup);
      loadFriends();  // Load social data on entry
      loadFriends();  // Load social data on entry
      loadGroups();
    });

    // === Tab Switching Logic ===
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));  // 1. Hide all main content tabs
      const selectedMainTab = document.getElementById(`tab-${tabName}`);  // 2. Show the selected main content tab
      if (selectedMainTab) selectedMainTab.classList.remove('hidden');

      // 3. Update active state on Col 1 (Server Nav)
      document.querySelectorAll('.sidebar-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll(`[data-tab="${tabName}"]`).forEach(tab => tab.classList.add('active')); // 4. Hide all sub-panels in Col 2
      document.querySelectorAll('.sub-panel-content').forEach(panel => panel.classList.add('hidden'));
      const selectedSubPanel = document.getElementById(`sub-panel-${tabName}`); // 5. Show the correct sub-panel for the tab
      if (selectedSubPanel) selectedSubPanel.classList.remove('hidden');

      // 6. Update main header title
      const titleEl = document.getElementById('main-content-title');
      const subPanelTitleEl = document.getElementById('subPanelTitle');
      if (titleEl) {
        if (tabName === 'home') titleEl.textContent = 'Home';
        if (tabName === 'messages') {
          titleEl.textContent = '# Community'; // Default to community
          if (subPanelTitleEl) subPanelTitleEl.textContent = 'Messages';
        }
        if (tabName === 'profile') {
          titleEl.textContent = 'Profile';
          if (subPanelTitleEl) subPanelTitleEl.textContent = 'Profile';
        }
        if (tabName === 'explore') {
          titleEl.textContent = 'Explore';
          if (subPanelTitleEl) subPanelTitleEl.textContent = 'Explore';
        }
        if (tabName === 'settings') {
          titleEl.textContent = 'Settings';
          if (subPanelTitleEl) subPanelTitleEl.textContent = 'Settings';
        }
      }

      // 7. Handle special tab logic
      if (tabName === 'friends') {
        document.querySelector("#btnMessagesTabFriends")?.click(); // Default to showing friends list (Col 2) and DM view (Col 3)
      }
      if (tabName === 'settings') {
        document.querySelector("#tabBtnGeneral").click(); // Default to showing general settings
      }

      // 8. On mobile, close the sub-panel after clicking a nav icon
      if (window.innerWidth < 768) {
        toggleSidebar();
      }
    }

    // === Messages View Switching ===
    function switchMessagesView(view) {
      const communityView = document.getElementById('messagesViewCommunity');
      const friendsView = document.getElementById('messagesViewFriends');
      const btnCommunity = document.getElementById('btnMessagesTabCommunity');
      const btnFriends = document.getElementById('btnMessagesTabFriends');

      if (view === 'community') {
        communityView?.classList.remove('hidden');
        friendsView?.classList.add('hidden');
        btnCommunity?.classList.add('text-white', 'bg-discord-gray-600/50', 'border-b-2', 'border-discord-blurple');
        btnCommunity?.classList.remove('text-discord-gray-400');
        btnFriends?.classList.remove('text-white', 'bg-discord-gray-600/50', 'border-b-2', 'border-discord-blurple');
        btnFriends?.classList.add('text-discord-gray-400');
      } else if (view === 'friends') {
        communityView?.classList.add('hidden');
        friendsView?.classList.remove('hidden');
        btnFriends?.classList.add('text-white', 'bg-discord-gray-600/50', 'border-b-2', 'border-discord-blurple');
        btnFriends?.classList.remove('text-discord-gray-400');
        btnCommunity?.classList.remove('text-white', 'bg-discord-gray-600/50', 'border-b-2', 'border-discord-blurple');
        btnCommunity?.classList.add('text-discord-gray-400');
      }
    }

    // === Home Tab Toggle ===
    function toggleHomeTab(show) {
      const homeTab = document.getElementById('homeTab');
      const messagesTab = document.getElementById('messagesTab');
      const navDivider = document.getElementById('navDivider');
      const nav = homeTab?.parentElement;

      if (homeTab && messagesTab && navDivider && nav) {
        if (show) {
          // Show Home tab at the beginning, Messages after divider
          homeTab.style.display = 'flex';
          nav.insertBefore(homeTab, navDivider);
          // Ensure Messages is after divider
          nav.insertBefore(messagesTab, navDivider.nextSibling);
        } else {
          // Hide Home tab, move Messages before divider (first position)
          homeTab.style.display = 'none';
          nav.insertBefore(messagesTab, navDivider);
        }
      }
      localStorage.setItem('showHomeTab', show ? 'true' : 'false');
    }

    // Apply Home tab visibility on page load
    function applyHomeTabSetting() {
      // Default to true if not set
      const showHome = localStorage.getItem('showHomeTab') !== 'false';
      toggleHomeTab(showHome);
      // Update checkbox state
      const checkbox = document.getElementById('showHomeTabToggle');
      if (checkbox) checkbox.checked = showHome;
    }

    // === Show Friends Dashboard ===
    function showFriendsDashboard() {
      // Show the tab-friends content
      const tabFriends = document.getElementById('tab-friends');
      const tabMessages = document.getElementById('tab-messages');
      const friendsDashboard = document.getElementById('friendsDashboard');
      const friendsChatView = document.getElementById('friendsChatView');

      if (tabFriends && tabMessages) {
        // Hide messages tab content, show friends tab content
        tabMessages.classList.add('hidden');
        tabFriends.classList.remove('hidden');
      }

      if (friendsDashboard && friendsChatView) {
        // Show dashboard, hide chat view
        friendsDashboard.classList.remove('hidden');
        friendsChatView.classList.add('hidden');
      }

      // Update title
      const titleEl = document.getElementById('main-content-title');
      if (titleEl) titleEl.textContent = 'Friends';
    }

    // === Show Messages Tab (back from Friends) ===
    function showMessagesTab() {
      const tabFriends = document.getElementById('tab-friends');
      const tabMessages = document.getElementById('tab-messages');

      if (tabFriends && tabMessages) {
        tabFriends.classList.add('hidden');
        tabMessages.classList.remove('hidden');
      }

      // Update title
      const titleEl = document.getElementById('main-content-title');
      if (titleEl) titleEl.textContent = '# Community';
    }

    // === Groups Modal Functions ===
    function showGroupsModal() {
      const modal = document.getElementById('groupsModal');
      if (modal) {
        modal.classList.remove('hidden');
        // Reset to create tab
        switchGroupModalTab('create');
      }
      feather.replace();
    }

    function closeGroupsModal() {
      const modal = document.getElementById('groupsModal');
      if (modal) modal.classList.add('hidden');
      // Clear inputs
      document.getElementById('newGroupNameInput').value = '';
      document.getElementById('newGroupDescInput').value = '';
      document.getElementById('joinGroupIdInput').value = '';
      // Reset Icon Preview
      const preview = document.getElementById('groupIconPreview');
      if (preview) {
        preview.style.backgroundImage = '';
        preview.innerHTML = '<i data-feather="camera" class="text-discord-gray-400"></i>';
        preview.className = "w-full h-full rounded-full bg-discord-gray-700 border-2 border-dashed border-discord-gray-500 flex items-center justify-center cursor-pointer hover:border-discord-blurple overflow-hidden";
      }
      document.getElementById('newGroupIconInput').value = '';
    }

    function previewGroupIcon(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const preview = document.getElementById('groupIconPreview');
          preview.style.backgroundImage = `url(${e.target.result})`;
          preview.style.backgroundSize = 'cover';
          preview.style.backgroundPosition = 'center';
          preview.innerHTML = '';
          preview.classList.remove('border-dashed', 'border-2');
        }
        reader.readAsDataURL(file);
      }
    }

    function switchGroupModalTab(tab) {
      const createTab = document.getElementById('createGroupTab');
      const joinTab = document.getElementById('joinGroupTab');
      const createForm = document.getElementById('createGroupForm');
      const joinForm = document.getElementById('joinGroupForm');

      if (tab === 'create') {
        createTab?.classList.add('text-white', 'border-b-2', 'border-discord-blurple');
        createTab?.classList.remove('text-discord-gray-400');
        joinTab?.classList.remove('text-white', 'border-b-2', 'border-discord-blurple');
        joinTab?.classList.add('text-discord-gray-400');
        createForm?.classList.remove('hidden');
        joinForm?.classList.add('hidden');
      } else {
        joinTab?.classList.add('text-white', 'border-b-2', 'border-discord-blurple');
        joinTab?.classList.remove('text-discord-gray-400');
        createTab?.classList.remove('text-white', 'border-b-2', 'border-discord-blurple');
        createTab?.classList.add('text-discord-gray-400');
        joinForm?.classList.remove('hidden');
        createForm?.classList.add('hidden');
      }
    }

    // === Group Settings Modal Logic ===

    function openGroupSettings() {
      if (!currentGroupId) return;
      const group = groupsData.find(g => g.id === currentGroupId);
      if (!group) return;

      const modal = document.getElementById('groupSettingsModal');
      const nameInput = document.getElementById('editGroupName');
      const descInput = document.getElementById('editGroupDesc');
      const iconInput = document.getElementById('editGroupIconInput');
      const iconPreview = document.getElementById('editGroupIconPreview');
      const initialSpan = document.getElementById('editGroupIconInitial');

      if (modal && nameInput && descInput) {
        nameInput.value = group.name || '';
        descInput.value = group.description || '';

        // Reset icon input
        if (iconInput) iconInput.value = '';

        // Set icon preview
        if (group.icon) {
          iconPreview.style.backgroundImage = `url(${group.icon})`;
          iconPreview.style.backgroundSize = 'cover';
          iconPreview.style.backgroundPosition = 'center';
          if (initialSpan) initialSpan.textContent = '';
        } else {
          iconPreview.style.backgroundImage = '';
          iconPreview.style.backgroundColor = getGroupColor(group.name);
          if (initialSpan) initialSpan.textContent = getGroupInitial(group.name);
        }

        modal.classList.remove('hidden');
      }
    }

    function closeGroupSettings() {
      const modal = document.getElementById('groupSettingsModal');
      if (modal) modal.classList.add('hidden');
    }

    function previewEditGroupIcon(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const preview = document.getElementById('editGroupIconPreview');
          const initial = document.getElementById('editGroupIconInitial');
          preview.style.backgroundImage = `url(${e.target.result})`;
          preview.style.backgroundSize = 'cover';
          preview.style.backgroundPosition = 'center';
          if (initial) initial.textContent = '';
        }
        reader.readAsDataURL(file);
      }
    }

    async function saveGroupSettings() {
      if (!currentGroupId) return;

      const name = document.getElementById('editGroupName').value.trim();
      const description = document.getElementById('editGroupDesc').value.trim();
      const iconInput = document.getElementById('editGroupIconInput');
      const username = localStorage.getItem('savedUsername') || 'User';

      if (!name) return alert('Group name cannot be empty');

      let iconData = null;
      if (iconInput && iconInput.files[0]) {
        iconData = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.readAsDataURL(iconInput.files[0]);
        });
      }

      try {
        const res = await fetch('/api/groups/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username,
            groupId: currentGroupId,
            name,
            description,
            iconData
          })
        });

        const data = await res.json();
        if (data.success) {
          closeGroupSettings();
          await loadGroups(); // Reload to refresh sidebar and active view
          selectGroup(currentGroupId); // Reselect to update header info
        } else {
          alert(data.error || 'Failed to update group');
        }
      } catch (e) {
        console.error(e);
        alert('An error occurred');
      }
    }

    async function deleteGroup() {
      if (!currentGroupId) return;
      if (!confirm("Are you sure you want to delete this group? This cannot be undone.")) return;

      const username = localStorage.getItem('savedUsername') || 'User';
      try {
        const res = await fetch('/api/groups/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username,
            groupId: currentGroupId
          })
        });

        const data = await res.json();
        if (data.success) {
          closeGroupSettings();
          await loadGroups();
          // Switch to friends view or another group
          document.getElementById('sub-panel-group').classList.add('hidden');
          document.getElementById('tab-group').classList.add('hidden');
          document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
          showFriendsDashboard();
        } else {
          alert(data.error || 'Failed to delete group');
        }
      } catch (e) {
        console.error(e);
        alert('An error occurred');
      }
    }

    // === Group Management Functions ===
    let currentGroupId = null;

    async function createNewGroup() {
      const nameInput = document.getElementById('newGroupNameInput');
      const descInput = document.getElementById('newGroupDescInput');
      const iconInput = document.getElementById('newGroupIconInput');
      const name = nameInput?.value.trim();
      const description = descInput?.value.trim();

      let iconData = null;
      if (iconInput && iconInput.files[0]) {
        iconData = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.readAsDataURL(iconInput.files[0]);
        });
      }

      if (!name) {
        alert('Please enter a group name');
        return;
      }

      try {
        const username = localStorage.getItem('savedUsername') || 'User';
        const res = await fetch('/api/groups/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, name, description, iconData })
        });

        const data = await res.json();
        if (data.success && data.group) {
          closeGroupsModal();
          await loadGroups();
          selectGroup(data.group.id);
        } else {
          alert(data.error || 'Failed to create group');
        }
      } catch (error) {
        console.error('Error creating group:', error);
        alert('Failed to create group');
      }
    }

    async function joinExistingGroup() {
      const input = document.getElementById('joinGroupIdInput');
      const groupId = input?.value.trim();

      if (!groupId) {
        alert('Please enter a group ID');
        return;
      }

      try {
        const username = localStorage.getItem('savedUsername') || 'User';
        const res = await fetch('/api/groups/join', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, groupId })
        });

        const data = await res.json();
        if (data.success) {
          closeGroupsModal();
          await loadGroups();
          selectGroup(groupId);
        } else {
          alert(data.error || 'Failed to join group');
        }
      } catch (error) {
        console.error('Error joining group:', error);
        alert('Failed to join group');
      }
    }

    async function loadGroups() {
      try {
        const username = localStorage.getItem('savedUsername') || 'User';
        const res = await fetch(`/api/groups/list?username=${username}`);
        const data = await res.json();
        groupsData = data.groups || [];
        renderGroupIcons();
      } catch (error) {
        console.error('Error loading groups:', error);
        groupsData = [];
      }
    }

    function renderGroupIcons() {
      const container = document.getElementById('groupIconsContainer');
      if (!container) return;

      container.innerHTML = '';

      groupsData.forEach(group => {
        const icon = document.createElement('div');
        icon.className = 'group-icon';
        if (currentGroupId === group.id) {
          icon.classList.add('active');
        }

        if (group.icon) {
          icon.style.backgroundImage = `url(${group.icon})`;
          icon.style.backgroundSize = 'cover';
          icon.style.backgroundPosition = 'center';
          icon.textContent = '';
          icon.style.backgroundColor = 'transparent';
        } else {
          // Generate color from group name
          const color = getGroupColor(group.name);
          icon.style.backgroundColor = color;

          // Get initial
          const initial = getGroupInitial(group.name);
          icon.textContent = initial;
        }

        icon.title = group.name;
        icon.onclick = () => selectGroup(group.id);

        container.appendChild(icon);
      });
      feather.replace();
    }

    function selectGroup(groupId) {
      currentGroupId = groupId;
      const group = groupsData.find(g => g.id === groupId);
      if (!group) return;

      // Update active state in icons
      renderGroupIcons();

      // Hide all sub-panels and tabs
      document.querySelectorAll('.sub-panel-content').forEach(panel => panel.classList.add('hidden'));
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));

      // Show group sub-panel and tab
      const groupPanel = document.getElementById('sub-panel-group');
      const groupTab = document.getElementById('tab-group');

      if (groupPanel) {
        groupPanel.classList.remove('hidden');
        // Update group info
        const nameEl = document.getElementById('groupPanelName');
        const descEl = document.getElementById('groupPanelDesc');
        if (nameEl) nameEl.textContent = group.name;
        if (descEl) descEl.textContent = group.description || 'No description';
      }

      if (groupTab) {
        groupTab.classList.remove('hidden');
      }

      // Update navigation active state
      document.querySelectorAll('.sidebar-tab').forEach(tab => tab.classList.remove('active'));

      // Load group data
      loadGroupChannels(group);
      loadGroupMembers(group);
      loadGroupMessages(group, 'general');

      // Update title
      const titleEl = document.getElementById('main-content-title');
      if (titleEl) titleEl.textContent = `# ${group.name} `;

      feather.replace();
    }

    function loadGroupChannels(group) {
      const container = document.getElementById('groupChannelsList');
      if (!container) return;

      container.innerHTML = '';

      // Default channel
      const channels = group.channels || [{ id: 'general', name: 'general' }];

      channels.forEach(channel => {
        const item = document.createElement('div');
        item.className = 'channel-item active';
        item.innerHTML = `
          <span class="channel-icon">#</span>
            <span>${channel.name}</span>
        `;
        item.onclick = () => switchGroupChannel(group, channel.id);
        container.appendChild(item);
      });
    }

    function loadGroupMembers(group) {
      const container = document.getElementById('groupMembersList');
      if (!container) return;

      container.innerHTML = '';

      const members = group.members || [localStorage.getItem('savedUsername') || 'You'];

      members.forEach(member => {
        const item = document.createElement('div');
        item.className = 'flex items-center gap-2 p-1 text-sm';
        item.innerHTML = `
            <div class="w-2 h-2 rounded-full bg-green-500"></div>
            <span class="text-discord-gray-300">${member}</span>
          `;
        container.appendChild(item);
      });

      // Update member count
      document.getElementById('groupChatMemberCount').textContent = `${members.length} members`;
    }

    async function loadGroupMessages(group, channelId) {
      const container = document.getElementById('groupChatMessages');
      if (!container) return;

      container.innerHTML = '';

      // Update channel name
      document.getElementById('groupChatChannelName').textContent = channelId;

      try {
        const res = await fetch(`/api/groups/${group.id}/messages?channel=${channelId}`);
        const data = await res.json();
        const messages = data.messages || [];

        for (const msg of messages) {
          appendGroupChatMessage(msg);
        }

        container.scrollTop = container.scrollHeight;
      } catch (error) {
        console.log('No messages yet or error loading:', error);
      }
    }

    async function appendGroupChatMessage(data) {
      const container = document.getElementById('groupChatMessages');
      if (!container) return;

      const msgDiv = document.createElement('div');
      msgDiv.className = 'flex gap-3 hover:bg-black/10 p-1 rounded -ml-1'; // Added hover effect and padding

      // Fetch Avatar
      let avatarUrl = '/images/default_avatar.png';
      if (data.username) {
        try {
          // Try to use existing helper if available, otherwise fallback to fetch
          if (typeof getUserAvatarUrl === 'function') {
            avatarUrl = await getUserAvatarUrl(data.username);
          } else {
            const res = await fetch(`/api/get-user?identifier=${encodeURIComponent(data.username)}`);
            const d = await res.json();
            if (d.success && d.user && d.user.avatar) avatarUrl = d.user.avatar;
          }
        } catch (e) { }
      }

      const avatar = document.createElement('img');
      avatar.className = 'w-10 h-10 rounded-full bg-discord-blurple flex-shrink-0 object-cover';
      avatar.src = avatarUrl;
      avatar.alt = data.username;
      avatar.onerror = function () { this.src = '/images/default_avatar.png'; };

      const content = document.createElement('div');
      content.className = 'flex-1 min-w-0'; // min-w-0 for text wrapping

      const header = document.createElement('div');
      header.className = 'flex items-baseline gap-2';

      // Format timestamp
      const ts = data.timestamp ? new Date(data.timestamp * 1000) : new Date();
      const timeStr = ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      header.innerHTML = `
        <span class="font-semibold text-white hover:underline cursor-pointer">${data.username || 'Unknown'}</span>
        <span class="text-xs text-discord-gray-400">${timeStr}</span>
      `;

      const message = document.createElement('div');
      message.className = 'text-discord-gray-300 text-sm whitespace-pre-wrap break-words';
      message.textContent = data.message || '';

      content.appendChild(header);
      content.appendChild(message);
      msgDiv.appendChild(avatar);
      msgDiv.appendChild(content);
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
    }

    function switchGroupChannel(group, channelId) {
      // Update active channel
      document.querySelectorAll('#groupChannelsList .channel-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.closest('.channel-item')?.classList.add('active');

      // Load messages for this channel
      loadGroupMessages(group, channelId);
    }

    async function sendGroupChatMessage() {
      const input = document.getElementById('groupChatInput');
      const message = input?.value.trim();

      if (!message || !currentGroupId) return;

      const group = groupsData.find(g => g.id === currentGroupId);
      if (!group) return;

      const username = localStorage.getItem('savedUsername') || 'User';
      const channelId = document.getElementById('groupChatChannelName').textContent;

      const payload = {
        groupId: currentGroupId,
        channel: channelId,
        username,
        message
      };

      // Append message optimistically
      appendGroupChatMessage(payload);

      // Send to server
      try {
        if (navigator.onLine && socket) {
          socket.emit('send_group_message', payload);
        }

        await fetch('/api/groups/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (error) {
        console.error('Error sending message:', error);
      }

      input.value = '';
      input.style.height = 'auto';
    }

    function sendGroupFile(event) {
      const file = event.target.files[0];
      if (!file || !currentGroupId) return;

      const reader = new FileReader();
      const channelId = document.getElementById('groupChatChannelName')?.textContent || 'general';
      const username = localStorage.getItem('savedUsername') || 'User';

      reader.onload = async function (e) {
        const fileData = e.target.result;
        const payload = {
          groupId: currentGroupId,
          channel: channelId,
          username,
          fileName: file.name,
          fileData: fileData
        };

        // Optimistic UI update
        appendGroupChatMessage(payload);

        try {
          if (navigator.onLine && socket) {
            socket.emit('send_group_file', payload);
          }
          await fetch('/api/groups/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } catch (e) { console.error(e); }
      };
      reader.readAsDataURL(file); // base64
    }



    // Default Functions (Updated)
    window.onload = () => {
      applyHomeTabSetting(); // Apply Home tab visibility
      loadStats();
      loadUserData();
      const startup = (localStorage.getItem('startupPage') || 'home');  // Apply startup page if set
      switchTab(startup);
      switchChatRoom(currentChatRoom); // Ensure chat room is correctly set
      loadFriends();  // Load social data on entry
      loadGroups();  // Load groups and render icons
      refreshGroups();
    }

    // Settings sub-tab logic (Kept as is, still works)
    document.querySelectorAll(".settings-tab").forEach(tab => {
      tab.addEventListener("click", function (e) {
        if (e && typeof e.preventDefault === 'function') e.preventDefault();
        document.querySelectorAll(".settings-tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".settings-content").forEach(c => c.classList.add("hidden"));
        const targetId = this.getAttribute("data-target");
        const targetEl = targetId ? document.getElementById(targetId) : null;
        if (targetEl) targetEl.classList.remove("hidden");
        if (targetId === 'aboutSettings') { try { populateAboutInfo(); } catch (e_) { } }
        this.classList.add("active");

        // Update main title to match setting
        const titleEl = document.getElementById('main-content-title');
        if (titleEl) titleEl.textContent = this.textContent.trim();
      });
    });

    // Friends sub-tab logic (Updated to handle new sub-panel/main-panel split)
    document.querySelectorAll(".friends-tab").forEach(tab => {
      tab.addEventListener("click", function () {
        document.querySelectorAll(".friends-tab").forEach(t => t.classList.remove("active"));
        this.classList.add("active");

        const targetId = this.getAttribute("data-target");

        // Toggle main content panels (Col 3)
        document.querySelectorAll(".friends-content").forEach(c => c.classList.add("hidden"));
        document.getElementById(targetId).classList.remove("hidden");

        // Toggle sub-panel lists (Col 2)
        const friendLists = document.getElementById('friendListsContainer');
        const addFriend = document.getElementById('addFriendContainer');
        const groupLists = document.getElementById('groupListsContainer');

        if (targetId === 'friendsContent') {
          friendLists.classList.remove('hidden');
          addFriend.classList.remove('hidden');
          groupLists.classList.add('hidden');
        } else { // groupsContent
          friendLists.classList.add('hidden');
          addFriend.classList.add('hidden');
          groupLists.classList.remove('hidden');
        }
      });
    });

    // Page transition logic
    function goToPage(href) {
      document.body.classList.add("fade-out");
      setTimeout(() => {
        window.location.href = href;
      }, 1000);
    }

    // Fade-out transition on link clicks
    document.querySelectorAll("a").forEach(link => {
      if (
        link.hostname === window.location.hostname &&
        link.getAttribute("href") &&
        link.getAttribute("href") !== "#" &&
        !link.classList.contains("sidebar-tab")
      ) {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          const href = this.getAttribute("href");
          document.body.classList.add("fade-out");
          setTimeout(() => {
            goToPage(href);
          }, 1000);
        });
      }
    });
  </script>
  <script>
    // === Theme Editor Logic ===
    (function () {
      const overlay = document.getElementById('themeEditorOverlay');
      const modal = document.getElementById('themeEditorModal');
      const btnClose = document.getElementById('closeThemeEditorBtn');
      const btnCancel = document.getElementById('teCancelBtn');
      const btnApplyTheme = document.getElementById('teApplyThemeBtn');
      const btnApplyBg = document.getElementById('teApplyBgBtn');
      const btnSave = document.getElementById('saveThemeBtn');
      const btnDelete = document.getElementById('deleteThemeBtn');
      const savedSelect = document.getElementById('savedThemesSelect');

      // UI color inputs
      const iNavbar = document.getElementById('teNavbarBg');
      const iSidebar = document.getElementById('teSidebarBg');
      const iPanel = document.getElementById('tePanelBg');
      const iText = document.getElementById('teTextColor');
      const iAccent = document.getElementById('teAccentColor');

      // BG controls
      const solidControls = document.getElementById('teSolidControls');
      const imageControls = document.getElementById('teImageControls');
      const animatedControls = document.getElementById('teAnimatedControls');
      const radios = Array.from(document.querySelectorAll('input[name="teBgMode"]'));
      const iSolidColor = document.getElementById('teSolidColor');
      const iGradFrom = document.getElementById('teGradFrom');
      const iGradTo = document.getElementById('teGradTo');
      const iGradAngle = document.getElementById('teGradAngle');
      const iBgImage = document.getElementById('teBgImageInput');
      const btnClearBgImage = document.getElementById('teClearBgImageBtn');
      const preview = document.getElementById('tePreview');

      function getSavedThemes() {
        try { return JSON.parse(localStorage.getItem('customThemes') || '[]'); } catch { return []; }
      }

      function setSavedThemes(arr) { localStorage.setItem('customThemes', JSON.stringify(arr)); }

      function themeFromInputs() {
        const bgMode = radios.find(r => r.checked)?.value || 'gradient';

        return {
          name: '',
          ui: {
            navbarBg: iNavbar?.value || '#0b1020',
            sidebarBg: iSidebar?.value || '#111827',
            panelBg: iPanel?.value || 'rgba(255,255,255,0.7)'
          },
          textColor: iText?.value || '#ffffff',
          accentColor: iAccent?.value || '#3b82f6',
          background: {
            mode: bgMode,
            solid: iSolidColor?.value || '#0b1020',
            gradient: { from: iGradFrom?.value || '#1e293b', to: iGradTo?.value || '#0f172a', angle: Number(iGradAngle?.value || 135) },
            imageDataUrl: localStorage.getItem('bgImageDataUrl') || '',
            animated: animatedControls?.querySelector('button.active')?.dataset.anim || 'gradientShift'
          }
        };
      }

      function applyThemeVars(t) {
        document.body.classList.add('theme-custom');
        document.body.style.setProperty('--navbar-bg', t.ui.navbarBg);
        document.body.style.setProperty('--sidebar-bg', t.ui.sidebarBg);
        document.body.style.setProperty('--panel-bg', t.ui.panelBg);
        document.body.style.setProperty('--text-color', t.textColor);
        document.body.style.setProperty('--accent-color', t.accentColor);
      }

      function applyThemeBackground(bg) {
        const s = document.body.style;
        s.background = '';
        s.backgroundImage = '';
        s.backgroundSize = '';
        s.backgroundAttachment = '';

        if (bg.mode === 'solid') {
          s.background = bg.solid;

        } else if (bg.mode === 'gradient') {
          const angle = bg.gradient?.angle ?? 135;
          s.background = `linear-gradient(${angle}deg, ${bg.gradient?.from}, ${bg.gradient?.to})`;
          s.backgroundAttachment = 'fixed';
          s.backgroundSize = '400% 400%';

        } else if (bg.mode === 'image' && bg.imageDataUrl) {
          s.backgroundImage = `url(${bg.imageDataUrl})`;
          s.backgroundSize = 'cover';
          s.backgroundAttachment = 'fixed';

        } else if (bg.mode === 'animated') {
          s.background = 'linear-gradient(135deg, #1e293b, #0f172a)';
          s.backgroundSize = '400% 400%';
        }
      }

      function renderPreview() {
        if (!preview) return;
        const t = themeFromInputs();
        preview.style.background = '';  // Background
        preview.style.backgroundImage = '';

        if (t.background.mode === 'solid') {
          preview.style.background = t.background.solid;

        } else if (t.background.mode === 'gradient') {
          preview.style.background = `linear-gradient(${t.background.gradient.angle}deg, ${t.background.gradient.from}, ${t.background.gradient.to})`;

        } else if (t.background.mode === 'image' && t.background.imageDataUrl) {
          preview.style.backgroundImage = `url(${t.background.imageDataUrl})`;
          preview.style.backgroundSize = 'cover';

        } else if (t.background.mode === 'animated') {
          preview.style.background = 'linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.9))';
        }

        // Panels and navbar sample
        const bar = preview.querySelector('.absolute.top-3');
        if (bar) bar.style.background = t.ui.navbarBg;
        preview.querySelectorAll('.rounded').forEach(el => { el.style.background = t.ui.panelBg; });
      }

      function updateBgControls() {
        const val = radios.find(r => r.checked)?.value || 'gradient';
        imageControls?.classList.toggle('hidden', val !== 'image');
        animatedControls?.classList.toggle('hidden', val !== 'animated');
        renderPreview();
      }

      function open() { overlay?.classList.remove('hidden'); modal?.classList.remove('hidden'); renderPreview(); populateSavedThemes(); }
      function close() { overlay?.classList.add('hidden'); modal?.classList.add('hidden'); }

      window.openThemeEditor = function () { open(); };

      btnClose?.addEventListener('click', close);
      btnCancel?.addEventListener('click', close);
      overlay?.addEventListener('click', close);

      radios.forEach(r => r.addEventListener('change', updateBgControls));
      [iNavbar, iSidebar, iPanel, iText, iAccent, iSolidColor, iGradFrom, iGradTo, iGradAngle].forEach(el => el?.addEventListener('input', renderPreview));

      // Animated preset selection
      animatedControls?.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          animatedControls.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderPreview();
        });
      });

      // Image import
      iBgImage?.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();

        reader.onload = () => {
          try { localStorage.setItem('bgImageDataUrl', reader.result); } catch { }
          renderPreview();
        };
        reader.readAsDataURL(file);
      });

      btnClearBgImage?.addEventListener('click', () => {
        localStorage.removeItem('bgImageDataUrl');
        if (iBgImage) iBgImage.value = '';
        renderPreview();
      });

      // Apply BG instantly
      btnApplyBg?.addEventListener('click', () => {
        const t = themeFromInputs();
        localStorage.setItem('themeMode', 'custom');
        localStorage.setItem('theme', 'custom');
        document.body.classList.remove('dark');
        applyThemeVars(t);
        applyThemeBackground(t.background);
        localStorage.setItem('customThemeColor', t.accentColor);  // Back-compat flags
        localStorage.setItem('solidBg', String(t.background.mode === 'solid'));
        if (t.background.imageDataUrl) localStorage.setItem('bgImageDataUrl', t.background.imageDataUrl);
        close();
      });

      // Save/manage themes
      function populateSavedThemes() {
        if (!savedSelect) return;
        const list = getSavedThemes();
        savedSelect.innerHTML = '<option value="">Select saved theme‚Ä¶</option>' + list.map((t, i) => `<option value="${i}">${t.name || ('Untitled ' + (i + 1))}</option>`).join('');
      }
      window.populateSavedThemes = populateSavedThemes;

      btnSave?.addEventListener('click', () => {
        const t = themeFromInputs();
        const name = prompt('Theme name?', t.name || 'My Theme');
        if (name === null) return;
        t.name = (name || '').trim() || 'My Theme';
        const list = getSavedThemes();
        list.push(t);
        setSavedThemes(list);
        populateSavedThemes();
        alert('Theme saved!');
      });

      btnDelete?.addEventListener('click', () => {
        const idx = Number(savedSelect?.value ?? -1);
        if (Number.isNaN(idx) || idx < 0) return;
        const list = getSavedThemes();
        if (!list[idx]) return;
        if (!confirm(`Delete theme "${list[idx].name || 'Untitled'}"?`)) return;
        list.splice(idx, 1);
        setSavedThemes(list);
        populateSavedThemes();
      });

      savedSelect?.addEventListener('change', () => {
        const idx = Number(savedSelect.value);
        const list = getSavedThemes();
        const t = list[idx];
        if (!t) return;
        iNavbar.value = t.ui.navbarBg;
        iSidebar.value = t.ui.sidebarBg;
        iPanel.value = t.ui.panelBg;
        iText.value = t.textColor;
        iAccent.value = t.accentColor;
        (radios.find(r => r.value === (t.background.mode || 'gradient')) || radios[0]).checked = true;
        iSolidColor.value = t.background.solid || '#0b1020';
        iGradFrom.value = t.background.gradient?.from || '#1e293b';
        iGradTo.value = t.background.gradient?.to || '#0f172a';
        iGradAngle.value = String(t.background.gradient?.angle ?? 135);
        renderPreview();
      });

      // Apply full theme
      btnApplyTheme?.addEventListener('click', () => {
        const t = themeFromInputs();
        localStorage.setItem('currentCustomTheme', JSON.stringify(t));
        localStorage.setItem('themeMode', 'custom');
        localStorage.setItem('theme', 'custom');
        document.body.classList.remove('dark');
        applyThemeVars(t);
        applyThemeBackground(t.background);
        close();
      });

      // Initialize defaults
      try {
        const last = JSON.parse(localStorage.getItem('currentCustomTheme') || 'null');
        if (last) {
          iNavbar.value = last.ui.navbarBg || '#0b1020';
          iSidebar.value = last.ui.sidebarBg || '#111827';
          iPanel.value = last.ui.panelBg || 'rgba(255,255,255,0.7)';
          iText.value = last.textColor || '#ffffff';
          iAccent.value = last.accentColor || '#3b82f6';
          (radios.find(r => r.value === (last.background?.mode || 'gradient')) || radios[0]).checked = true;
          iSolidColor.value = last.background?.solid || '#0b1020';
          iGradFrom.value = last.background?.gradient?.from || '#1e293b';
          iGradTo.value = last.background?.gradient?.to || '#0f172a';
          iGradAngle.value = String(last.background?.gradient?.angle ?? 135);

        } else {
          iNavbar.value = '#0b1020';
          iSidebar.value = '#111827';
          iPanel.value = 'rgba(255,255,255,0.7)';
          iText.value = '#ffffff';
          iAccent.value = '#3b82f6';
          iSolidColor.value = '#0b1020';
          iGradFrom.value = '#1e293b';
          iGradTo.value = '#0f172a';
          iGradAngle.value = '135';
        }
      } catch { }

      populateSavedThemes();
      updateBgControls();
      renderPreview();
    })();
  </script>
  <script>
    // Offline banner + queued sends
    (function () {
      const banner = document.createElement('div');
      banner.id = 'offlineBanner';
      banner.textContent = 'You are offline. Messages will send when reconnected.';
      banner.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:#b91c1c;color:#fff;padding:8px 12px;text-align:center;z-index:40;display:none';
      document.body.appendChild(banner);

      function updateBanner() {
        const show = !navigator.onLine;
        banner.style.display = show ? 'block' : 'none';
        document.body.style.paddingBottom = show ? (banner.offsetHeight + 8) + 'px' : '';
      }
      window.addEventListener('online', updateBanner);
      window.addEventListener('offline', updateBanner);
      updateBanner();

      const pendingKey = 'pendingMessages';
      function getQueue() {
        try { return JSON.parse(localStorage.getItem(pendingKey) || '[]'); } catch { return []; }
      }
      function setQueue(arr) { localStorage.setItem(pendingKey, JSON.stringify(arr)); }

      const originalSendMessage = sendMessage;
      window.sendMessage = function () {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;
        if (!navigator.onLine) { // Only queue community messages. AI requires online access.
          if (typeof currentChatRoom !== 'undefined' && currentChatRoom === 'community') {
            const username = localStorage.getItem('savedUsername') || 'N/A';
            const q = getQueue();
            q.push({ username, message, ts: Date.now() });
            setQueue(q);
          } else { // Offline AI: render locally and inform user
            try {
              if (typeof appendAiBubble === 'function') {
                (async () => {
                  await appendAiBubble('user', message);
                  if (Array.isArray(aiConversation)) {
                    aiConversation.push({ role: 'user', content: message });
                    localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
                  }
                  await appendAiBubble('assistant', 'You are offline. AI chat requires internet.');

                  if (Array.isArray(aiConversation)) {
                    aiConversation.push({ role: 'assistant', content: 'You are offline. AI chat requires internet.' });
                    localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
                  }
                })();
              }
            } catch (e) { }
          }
          input.value = '';
          input.style.height = 'auto';
          return;
        }
        return originalSendMessage();
      }

      async function flushQueue() {
        if (!navigator.onLine) return;
        const q = getQueue();
        if (!q.length) return;

        try {
          q.forEach(item => {
            if (typeof io !== 'undefined') {
              const s = window.socket || io(window.location.origin);
              s.emit('send_message', { username: item.username, message: item.message });
            }
          });
          setQueue([]);
        } catch (e) { // keep queue on error
        }
      }
      window.addEventListener('online', flushQueue);
      setTimeout(flushQueue, 1000);
    })();
  </script>
  <script>
    // Profile Effects Functions
    function initializeProfileEffects() {
      const bannerEffectSelect = document.getElementById('bannerEffectSelect');
      const avatarEffectSelect = document.getElementById('profileEffectSelect');

      if (bannerEffectSelect) {
        bannerEffectSelect.addEventListener('change', function () {
          applyBannerEffect(this.value);
        });
      }

      if (avatarEffectSelect) {
        avatarEffectSelect.addEventListener('change', function () {
          applyAvatarEffect(this.value);
        });
      }
    }

    function applyBannerEffect(effect) {
      console.log('Applying banner effect:', effect);
      const bannerImg = document.getElementById('bannerImage');
      const settingsBanner = document.getElementById('settingsBanner');
      const bannerContainer = document.querySelector('.profile-banner');

      console.log('Banner elements found:', { bannerImg: !!bannerImg, settingsBanner: !!settingsBanner, bannerContainer: !!bannerContainer });

      // Remove all effect classes and inline styles first
      [bannerImg, settingsBanner].forEach(el => {
        if (!el) return;
        el.className = el.className.replace(/banner-effect-\w+/g, '');  // Remove old classes
        el.style.boxShadow = '';  // Remove inline styles
        el.style.border = '';
        el.style.filter = '';
      });

      // Remove overlay from container
      if (bannerContainer) {
        bannerContainer.className = bannerContainer.className.replace(/banner-effect-\w+/g, '');
        const overlay = bannerContainer.querySelector('.banner-effect-overlay');
        if (overlay) overlay.remove();
      }

      if (effect && effect !== 'none') {
        console.log('Applying effect:', effect);
        if (effect === 'glow') {
          [bannerImg, settingsBanner].forEach(el => { // Apply new effects using inline styles for reliability
            if (el) {
              el.style.setProperty('box-shadow', '0 0 20px rgba(0, 255, 255, 0.6), 0 0 40px rgba(0, 255, 255, 0.4)', 'important');
              el.style.setProperty('border', '2px solid rgba(0, 255, 255, 0.5)', 'important');
              console.log('Applied glow to:', el.id, el.style.boxShadow);
            }
          });

        } else if (effect === 'blur-overlay') {
          if (bannerContainer) {
            let overlay = bannerContainer.querySelector('.banner-effect-overlay');
            if (!overlay) {
              overlay = document.createElement('div');
              overlay.className = 'banner-effect-overlay';
              overlay.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(4px); pointer-events: none; z-index: 2; border-radius: 1rem 1rem 0 0;';
              bannerContainer.style.position = 'relative';
              bannerContainer.appendChild(overlay);
            }
          }

        } else if (effect === 'gradient-overlay') {
          if (bannerContainer) {
            let overlay = bannerContainer.querySelector('.banner-effect-overlay');
            if (!overlay) {
              overlay = document.createElement('div');
              overlay.className = 'banner-effect-overlay';
              overlay.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(255, 0, 150, 0.4) 0%, rgba(0, 255, 255, 0.4) 50%, rgba(255, 255, 0, 0.4) 100%); pointer-events: none; z-index: 2; border-radius: 1rem 1rem 0 0;';
              bannerContainer.style.position = 'relative';
              bannerContainer.appendChild(overlay);
            }
          }

        } else if (effect === 'vignette') {
          if (bannerContainer) {
            let overlay = bannerContainer.querySelector('.banner-effect-overlay');
            if (!overlay) {
              overlay = document.createElement('div');
              overlay.className = 'banner-effect-overlay';
              overlay.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse at center, transparent 30%, rgba(0, 0, 0, 0.6) 100%); pointer-events: none; z-index: 2; border-radius: 1rem 1rem 0 0;';
              bannerContainer.style.position = 'relative';
              bannerContainer.appendChild(overlay);
            }
          }

        } else if (effect === 'neon-glow') {
          [bannerImg, settingsBanner].forEach(el => {
            if (el) {
              el.style.setProperty('box-shadow', '0 0 30px rgba(255, 0, 255, 0.8), 0 0 60px rgba(0, 255, 255, 0.6)', 'important');
              el.style.setProperty('border', '3px solid rgba(255, 0, 255, 0.7)', 'important');
              console.log('Applied neon-glow to:', el.id, el.style.boxShadow);
            }
          });
        }
        console.log('Banner effect applied:', effect);
      } else {
        console.log('No banner effect (none)');
      }
    }

    function applyAvatarEffect(effect) {
      console.log('Applying avatar effect:', effect);
      const avatarImg = document.getElementById('avatarImage');
      const settingsAvatar = document.getElementById('settingsAvatar');

      console.log('Avatar elements found:', { avatarImg: !!avatarImg, settingsAvatar: !!settingsAvatar });

      // Remove all effect classes and inline styles first
      [avatarImg, settingsAvatar].forEach(el => {
        if (!el) return;
        el.className = el.className.replace(/avatar-effect-\w+/g, '');  // Remove old classes
        el.style.boxShadow = '';  // Remove inline styles
        el.style.animation = '';
        el.style.filter = '';
        el.style.border = '';
        const ring = el.parentElement?.querySelector('.avatar-effect-ring');  // Remove overlay/ring elements
        if (ring) ring.remove();
      });

      if (effect && effect !== 'none') {
        console.log('Applying avatar effect:', effect);
        if (effect === 'glow') {  // Apply new effects using inline styles for reliability
          [avatarImg, settingsAvatar].forEach(el => {
            if (el) {
              el.style.setProperty('box-shadow', '0 0 10px rgba(99, 102, 241, 0.6), 0 0 20px rgba(59, 130, 246, 0.4), 0 0 30px rgba(236, 72, 153, 0.3)', 'important');
              el.style.setProperty('animation', 'glowPulse 3s ease-in-out infinite', 'important');
              console.log('Applied glow to avatar:', el.id, el.style.boxShadow);
            }
          });

        } else if (effect === 'pulse') {
          [avatarImg, settingsAvatar].forEach(el => {
            if (el) {
              el.style.setProperty('animation', 'pulseAvatar 2s ease-in-out infinite', 'important');
              console.log('Applied pulse to avatar:', el.id);
            }
          });

        } else if (effect === 'ring') {
          [avatarImg, settingsAvatar].forEach(el => {
            if (el && el.parentElement) {
              let ring = el.parentElement.querySelector('.avatar-effect-ring');
              if (!ring) {
                ring = document.createElement('div');
                ring.className = 'avatar-effect-ring';
                ring.style.cssText = 'position: absolute; inset: -8px; border-radius: 50%; background: conic-gradient(from 0deg, rgba(96,165,250,0.6), rgba(167,139,250,0.55), rgba(244,114,182,0.5), rgba(96,165,250,0.6)); filter: blur(2px); z-index: -1; pointer-events: none; animation: ringRotate 3s linear infinite;';
                el.parentElement.style.position = 'relative';
                el.parentElement.appendChild(ring);
              }
            }
          });

        } else if (effect === 'sparkle') {
          [avatarImg, settingsAvatar].forEach(el => {
            if (el) {
              el.style.setProperty('box-shadow', '0 0 8px rgba(255, 255, 255, 0.8), 0 0 16px rgba(255, 255, 255, 0.6)', 'important');
              el.style.setProperty('filter', 'drop-shadow(0 0 4px rgba(255, 255, 255, 0.8))', 'important');
              console.log('Applied sparkle to avatar:', el.id, el.style.boxShadow);
            }
          });
        }
        console.log('Avatar effect applied:', effect);
      } else {
        console.log('No avatar effect (none)');
      }
    }
  </script>
  <!-- Groups Modal -->
  <div id="groupsModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center fade-in">
    <div
      class="bg-discord-gray-700 w-full max-w-md rounded-lg shadow-2xl overflow-hidden transform transition-all scale-100">

      <!-- Header -->
      <div class="p-6 text-center">
        <h2 class="text-2xl font-bold text-white mb-2">Create or Join a Group</h2>
        <p class="text-discord-gray-300 text-sm">Hang out with friends in a new community.</p>
        <button onclick="closeGroupsModal()" class="absolute top-4 right-4 text-discord-gray-400 hover:text-white">
          <i data-feather="x" class="w-6 h-6"></i>
        </button>
      </div>

      <!-- Tabs -->
      <div class="flex border-b border-discord-gray-900 px-6">
        <button id="createGroupTab" onclick="switchGroupModalTab('create')"
          class="flex-1 pb-3 text-white border-b-2 border-discord-blurple font-medium transition-colors">
          Create Group
        </button>
        <button id="joinGroupTab" onclick="switchGroupModalTab('join')"
          class="flex-1 pb-3 text-discord-gray-400 border-b-2 border-transparent hover:text-white font-medium transition-colors">
          Join Group
        </button>
      </div>

      <!-- Content -->
      <div class="p-6">

        <!-- Create Form -->
        <div id="createGroupForm" class="space-y-4">
          <div>
            <label class="block text-xs font-bold text-discord-gray-400 uppercase mb-2">Group Name</label>
            <input type="text" id="newGroupNameInput"
              class="w-full bg-discord-gray-900 border border-black/30 rounded p-2 text-white focus:border-discord-blurple focus:outline-none transition-colors"
              placeholder="My Awesome Server">
          </div>
          <div>
            <label class="block text-xs font-bold text-discord-gray-400 uppercase mb-2">Description
              (Optional)</label>
            <input type="text" id="newGroupDescInput"
              class="w-full bg-discord-gray-900 border border-black/30 rounded p-2 text-white focus:border-discord-blurple focus:outline-none transition-colors"
              placeholder="A place for us to chill...">
          </div>
          <div class="bg-discord-gray-800 p-3 rounded flex items-center gap-3">
            <div class="bg-discord-gray-700 p-2 rounded-full">
              <i data-feather="shield" class="w-5 h-5 text-green-400"></i>
            </div>
            <div class="text-xs text-discord-gray-300">
              By creating a server, you agree to the Community Guidelines.
            </div>
          </div>
        </div>

        <!-- Join Form -->
        <div id="joinGroupForm" class="hidden space-y-4">
          <div class="text-center mb-4">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-discord-gray-600 mb-2">
              <i data-feather="compass" class="w-8 h-8 text-white"></i>
            </div>
            <p class="text-sm text-discord-gray-300">Enter an invite ID below to join an existing group.</p>
          </div>
          <div>
            <label class="block text-xs font-bold text-discord-gray-400 uppercase mb-2">Group ID</label>
            <input type="text" id="joinGroupIdInput"
              class="w-full bg-discord-gray-900 border border-black/30 rounded p-2 text-white focus:border-discord-blurple focus:outline-none transition-colors"
              placeholder="e.g. g123456">
          </div>
        </div>

      </div>

      <!-- Footer -->
      <div class="bg-discord-gray-800 p-4 flex justify-between items-center">
        <button onclick="closeGroupsModal()" class="text-sm text-white hover:underline">Back</button>

        <button onclick="createNewGroup()" id="createGroupBtn"
          class="bg-discord-blurple hover:bg-indigo-600 text-white px-6 py-2 rounded font-medium transition-colors shadow-md">
          Create Server
        </button>
        <button onclick="joinExistingGroup()" id="joinGroupBtn"
          class="hidden bg-discord-blurple hover:bg-indigo-600 text-white px-6 py-2 rounded font-medium transition-colors shadow-md">
          Join Server
        </button>
      </div>

    </div>
  </div>

  <script>
    function showGroupsModal() {
      const modal = document.getElementById('groupsModal');
      if (modal) {
        modal.classList.remove('hidden');
        switchGroupModalTab('create');
      }
    }

    function closeGroupsModal() {
      const modal = document.getElementById('groupsModal');
      if (modal) modal.classList.add('hidden');
    }

    function switchGroupModalTab(tab) {
      // Toggle tabs
      const createTab = document.getElementById('createGroupTab');
      const joinTab = document.getElementById('joinGroupTab');
      const createForm = document.getElementById('createGroupForm');
      const joinForm = document.getElementById('joinGroupForm');
      const createBtn = document.getElementById('createGroupBtn');
      const joinBtn = document.getElementById('joinGroupBtn');

      if (tab === 'create') {
        createTab?.classList.add('text-white', 'border-discord-blurple');
        createTab?.classList.remove('text-discord-gray-400', 'border-transparent');
        joinTab?.classList.remove('text-white', 'border-discord-blurple');
        joinTab?.classList.add('text-discord-gray-400', 'border-transparent');

        createForm?.classList.remove('hidden');
        joinForm?.classList.add('hidden');

        createBtn?.classList.remove('hidden');
        joinBtn?.classList.add('hidden');
      } else {
        joinTab?.classList.add('text-white', 'border-discord-blurple');
        joinTab?.classList.remove('text-discord-gray-400', 'border-transparent');
        createTab?.classList.remove('text-white', 'border-discord-blurple');
        createTab?.classList.add('text-discord-gray-400', 'border-transparent');

        joinForm?.classList.remove('hidden');
        createForm?.classList.add('hidden');

        joinBtn?.classList.remove('hidden');
        createBtn?.classList.add('hidden');
      }
    }
  </script>
  <script src="/files/sw-register.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      feather.replace();
    });
  </script>
  <script src="/files/vendor/cropper.min.js"></script>
</body>

</html>