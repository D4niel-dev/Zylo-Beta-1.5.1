<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Zylo | Main Window</title>
  <link rel="icon" href="/images/Zylo_icon.ico" type="image/x-icon" />
  <link rel="manifest" href="/js/manifest.webmanifest" />
  <meta name="theme-color" content="#202225" />
  <script src="/files/vendor/tailwindcss.js"></script>
  <link rel="stylesheet" href="/files/style.css">
  <script src="/files/vendor/feather-icons.js"></script>
  <link href="/files/vendor/cropper.min.css" rel="stylesheet" />
  <link href="/files/vendor/cropper.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/files/vendor/emoji-mart.css" />
  <script src="/files/vendor/emoji-mart.js"></script>
  <!-- Highlight.js for code syntax highlighting -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // Discord-like palette
            'discord-gray-900': '#202225', // Server nav
            'discord-gray-800': '#2f3136', // Channel list
            'discord-gray-700': '#36393f', // Main content
            'discord-gray-600': '#40444b', // Input / Active
            'discord-gray-500': '#4f545c', // User panel
            'discord-gray-400': '#b9bbbe', // Muted text
            'discord-gray-300': '#dcddde', // Normal text
            'discord-blurple': '#5865F2',
          },
          animation: {
            ringPulse: 'ringPulse 4s infinite ease-in-out',
            fadeIn: 'fadeIn 0.5s ease-out',
            slideIn: 'slideIn 0.3s ease-out',
            pop: 'pop 0.3s ease-out'
          },
          keyframes: {
            ringPulse: {
              '0%, 100%': { boxShadow: '0 0 0 0 rgba(88,101,242,0.7)' },
              '50%': { boxShadow: '0 0 0 6px rgba(88,101,242,0)' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideIn: {
              '0%': { transform: 'translateX(-100%)' },
              '100%': { transform: 'translateX(0)' }
            },
            pop: {
              '0%': { transform: 'scale(0.9)', opacity: '0' },
              '100%': { transform: 'scale(1)', opacity: '1' }
            }
          }
        }
      }
    };
  </script>
</head>

<body class="h-[100dvh] flex overflow-hidden">

  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden" onclick="toggleSidebar()"></div>

  <nav id="primarySidebar"
    class="flex flex-shrink-0 w-[4.5rem] md:w-20 h-full flex-col items-center py-3 space-y-3 overflow-y-auto scrollbar-hide z-50 bg-discord-gray-900 transition-transform duration-300 fixed md:static inset-y-0 left-0 -translate-x-full md:translate-x-0 border-r border-discord-gray-900 shadow-xl md:shadow-none">

    <a id="homeTab" href="#" data-tab="home" onclick="navigateTo('home');" class="sidebar-tab active group"
      title="Home">
      <div class="sidebar-pill"></div>
      <div class="sidebar-icon">
        <i data-feather="home" class="w-6 h-6"></i>
      </div>
    </a>

    <div id="navDivider" class="h-0.5 w-8 bg-discord-gray-700 rounded-full"></div>

    <!-- Groups Section -->
    <div id="groupIconsContainer" class="flex flex-col items-center space-y-3 w-full">
      <!-- Group icons will be dynamically added here -->
    </div>

    <!-- Add Group Button -->
    <button id="addGroupBtn" onclick="showGroupsModal()" class="add-group-btn" title="Add a Group">
      <i data-feather="plus" class="w-6 h-6"></i>
    </button>

    <a id="messagesTab" href="#" data-tab="messages" onclick="navigateTo('messages');" class="sidebar-tab group"
      title="Messages">
      <div class="sidebar-pill"></div>
      <div class="sidebar-icon">
        <i data-feather="message-circle" class="w-6 h-6"></i>
      </div>
    </a>


    <a href="#" data-tab="moments" onclick="navigateTo('moments');" class="sidebar-tab group" title="Moments">
      <div class="sidebar-pill"></div>
      <div class="sidebar-icon">
        <i data-feather="book-open" class="w-6 h-6"></i>
      </div>
    </a>

    <a href="#" data-tab="cloud" onclick="navigateTo('cloud');" class="sidebar-tab group" title="My Cloud">
      <div class="sidebar-pill"></div>
      <div class="sidebar-icon">
        <i data-feather="cloud" class="w-6 h-6"></i>
      </div>
    </a>


  </nav>

  <aside id="subPanelContainer"
    class="fixed md:static inset-y-0 left-0 z-40 w-72 md:w-64 h-full flex flex-col pl-20 md:pl-0 transform -translate-x-full md:translate-x-0 transition-transform duration-200 ease-in-out">

    <header class="flex-shrink-0 h-12 shadow-md flex items-center justify-between px-4">
      <h2 id="subPanelTitle" class="text-white font-semibold text-sm truncate sidebar-title">Zylo</h2>
      <div class="flex items-center gap-2">
        <!-- Desktop collapse toggle -->
        <button id="sidebarCollapseBtn" onclick="toggleSidebarCollapse()"
          class="hidden md:flex text-discord-gray-400 hover:text-white p-1 rounded hover:bg-discord-gray-700 transition"
          title="Toggle sidebar">
          <i data-feather="chevron-left" class="w-4 h-4"></i>
        </button>
        <!-- Mobile close button -->
        <button onclick="toggleSidebar()" class="md:hidden text-discord-gray-400 hover:text-white">
          <i data-feather="x" class="w-5 h-5"></i>
        </button>
      </div>
    </header>

    <div
      class="flex-1 overflow-y-auto p-2 space-y-2 scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">

      <div id="sub-panel-home" class="sub-panel-content hidden">
        <h3 class="sub-panel-header">Home</h3>
        <a href="#" onclick="navigateTo('home');" class="sub-panel-item active">
          <i data-feather="home" class="w-5 h-5 mr-2"></i> Welcome
        </a>
      </div>

      <!-- Group Sub-Panel -->
      <div id="sub-panel-group" class="sub-panel-content hidden flex flex-col h-full">
        <!-- Group Info -->
        <div
          class="p-3 border-b border-discord-gray-900 group cursor-pointer hover:bg-discord-gray-600/30 transition-colors duration-200"
          onclick="openGroupSettings()">
          <div class="flex justify-between items-start">
            <h2 id="groupPanelName" class="text-white font-bold text-lg truncate flex-1">Group Name</h2>
            <button id="groupMuteBtn" class="text-discord-gray-400 hover:text-white p-1" title="Mute Server"
              onclick="event.stopPropagation(); toggleGroupMute()">
              <i data-feather="bell" class="w-4 h-4"></i>
            </button>
          </div>
          <div class="flex items-center text-discord-gray-400 text-xs">
            <span id="groupPanelDesc" class="truncate mr-1">Group description</span>
            <i data-feather="chevron-down" class="w-3 h-3"></i>
          </div>
        </div>

        <!-- Channels List -->
        <div class="flex-1 overflow-y-auto">
          <h3 class="sub-panel-header">Text Channels</h3>
          <div id="groupChannelsList" class="space-y-1">
            <!-- Channels will be added here dynamically -->
          </div>
        </div>

        <!-- Members List -->
        <div class="border-t border-discord-gray-900 p-2">
          <h3 class="sub-panel-header">Members</h3>
          <div id="groupMembersList" class="space-y-1 max-h-32 overflow-y-auto">
            <!-- Members will be added here dynamically -->
          </div>
        </div>
      </div>

      <div id="sub-panel-messages" class="sub-panel-content flex flex-col h-full">
        <!-- Sub-tabs for Messages -->
        <div class="flex border-b border-discord-gray-900 mb-2">
          <button id="btnMessagesTabCommunity" onclick="switchMessagesView('community')"
            class="flex-1 px-3 py-2 text-sm font-medium text-white bg-discord-gray-600/50 border-b-2 border-discord-blurple">
            Community
          </button>
          <button id="btnMessagesTabFriends" onclick="switchMessagesView('friends')"
            class="flex-1 px-3 py-2 text-sm font-medium text-discord-gray-400 hover:text-white">
            Friends
          </button>
        </div>

        <!-- Community View -->
        <div id="messagesViewCommunity" class="flex-1 overflow-y-auto">
          <h3 class="sub-panel-header">Text Channels</h3>
          <button id="btnRoomCommunity" class="sub-panel-item w-full text-left" onclick="switchChatRoom('community')">
            <span class="mr-2">#</span> Community
          </button>
          <button id="btnRoomAI" class="sub-panel-item w-full text-left" onclick="switchChatRoom('ai')">
            <span class="mr-2">#</span> AI Chat
          </button>

          <div id="aiControls" class="hidden text-xs space-y-2 p-2 bg-discord-gray-900/50 rounded-lg mt-2">
            <label for="aiPersonaSelect" class="text-discord-gray-400">Persona</label>
            <select id="aiPersonaSelect"
              class="w-full text-xs bg-discord-gray-700 border border-discord-gray-900 rounded px-2 py-1 text-discord-gray-300"></select>
            <label for="aiModelSelect" class="text-discord-gray-400">Model</label>
            <select id="aiModelSelect"
              class="w-full text-xs bg-discord-gray-700 border border-discord-gray-900 rounded px-2 py-1 text-discord-gray-300"></select>
            <button id="aiClearBtn"
              class="w-full px-2 py-1 rounded bg-discord-gray-600 hover:bg-discord-gray-500 text-white text-xs"
              onclick="clearAiConversation()">Clear Chat</button>
          </div>
        </div>

        <!-- Friends & Groups View -->
        <div id="messagesViewFriends" class="hidden flex-1 overflow-y-auto flex flex-col">

          <div class="flex-1 overflow-y-auto space-y-1 px-2" id="sidebarDMList">
          </div>

          <div class="p-2 border-t border-discord-gray-900 hidden">
            <button onclick="createGroup()" class="flex items-center text-xs text-discord-gray-400 hover:text-white">
              <i data-feather="plus" class="w-4 h-4 mr-1"></i> Create Group
            </button>
          </div>
        </div>
      </div>

      <!-- Remove old sub-panel-friends, now merged into sub-panel-messages -->

      <div id="sub-panel-profile" class="sub-panel-content hidden">
        <h3 class="sub-panel-header">Profile</h3>
        <a href="#" onclick="navigateTo('profile');" class="sub-panel-item">
          <i data-feather="user" class="w-5 h-5 mr-2"></i> <span>My Profile</span>
        </a>
        <a href="#" onclick="navigateTo('cloud');" class="sub-panel-item">
          <i data-feather="cloud" class="w-5 h-5 mr-2"></i> <span>My Cloud</span>
        </a>
        <a href="#" onclick="navigateTo('profile'); document.querySelector('[data-tab=\'activity\']').click();"
          class="sub-panel-item">
          <i data-feather="activity" class="w-5 h-5 mr-2"></i> <span>Activity</span>
        </a>
        <a href="#" onclick="navigateTo('profile'); document.querySelector('[data-tab=\'media\']').click();"
          class="sub-panel-item">
          <i data-feather="image" class="w-5 h-5 mr-2"></i> <span>Saved Media</span>
        </a>

        <h3 class="sub-panel-header mt-4">Quick Actions</h3>
        <button onclick="document.getElementById('profileAvatarUpload')?.click();"
          class="sub-panel-item w-full text-left">
          <i data-feather="camera" class="w-5 h-5 mr-2"></i> <span>Change Avatar</span>
        </button>
        <button onclick="document.getElementById('profileBannerUpload')?.click();"
          class="sub-panel-item w-full text-left">
          <i data-feather="image" class="w-5 h-5 mr-2"></i> <span>Change Banner</span>
        </button>
      </div>

      <div id="sub-panel-moments" class="sub-panel-content hidden">
        <h3 class="sub-panel-header">Moments</h3>
      </div>



      <div id="sub-panel-settings" class="sub-panel-content hidden">
        <h3 class="sub-panel-header">User Settings</h3>
        <button type="button" id="tabBtnGeneral" class="settings-tab sub-panel-item w-full text-left"
          data-target="generalSettings">
          <i data-feather="settings" class="w-5 h-5 mr-2"></i> <span>General</span>
        </button>
        <button type="button" id="tabBtnAppearance" class="settings-tab sub-panel-item w-full text-left"
          data-target="appearanceSettings">
          <i data-feather="layout" class="w-5 h-5 mr-2"></i> <span>Appearance</span>
        </button>
        <button type="button" id="tabBtnSounds" class="settings-tab sub-panel-item w-full text-left"
          data-target="soundSettings">
          <i data-feather="bell" class="w-5 h-5 mr-2"></i> <span>Sounds & Notif.</span>
        </button>
        <button type="button" id="tabBtnAccount" class="settings-tab sub-panel-item w-full text-left"
          data-target="accountSettings">
          <i data-feather="shield" class="w-5 h-5 mr-2"></i> <span>My Account</span>
        </button>
        <button type="button" id="tabBtnAbout" class="settings-tab sub-panel-item w-full text-left"
          data-target="aboutSettings">
          <i data-feather="help-circle" class="w-5 h-5 mr-2"></i> <span>About Us</span>
        </button>
      </div>

    </div>
    <div class="flex-shrink-0 h-14 bg-discord-gray-500/30 flex items-center justify-between px-3">
      <div
        class="flex items-center gap-2 min-w-0 cursor-pointer hover:bg-discord-gray-600/50 transition-colors rounded-lg px-2 py-1 -ml-1 flex-1"
        onclick="navigateTo('profile')" title="My Profile">
        <img id="userPanelAvatar" src="/images/default_avatar.png" alt="Avatar" class="w-8 h-8 rounded-full">
        <div class="flex flex-col min-w-0">
          <span id="userPanelUsername" class="text-white text-sm font-semibold truncate">ZyloUser</span>
          <span id="userPanelUsertag" class="text-discord-gray-400 text-xs truncate">@zylo1234</span>
        </div>
      </div>
      <div class="flex items-center">
        <button data-tab="settings" onclick="navigateTo('settings')"
          class="p-1 text-discord-gray-400 hover:text-white hover:bg-discord-gray-600/50 rounded" title="Settings">
          <i data-feather="settings" class="w-5 h-5"></i>
        </button>
        <a href="/login.html" class="p-1 text-discord-gray-400 hover:text-red-400 hover:bg-discord-gray-600/50 rounded"
          title="Logout">
          <i data-feather="log-out" class="w-5 h-5"></i>
        </a>
      </div>
    </div>
  </aside>

  <main class="flex-1 flex flex-col h-full min-w-0">

    <header class="flex-shrink-0 h-12 bg-discord-gray-700 shadow-md flex items-center justify-between px-4">
      <div class="flex items-center">
        <button id="mobileMenuBtn" class="p-1 mr-2 text-discord-gray-300 hover:text-white md:hidden"
          onclick="toggleSidebar()">
          <i id="mobileMenuIcon" data-feather="menu" class="w-6 h-6"></i>
        </button>
        <h1 id="main-content-title" class="text-white text-lg font-semibold truncate">Home</h1>
      </div>

      <!-- 6.14 Message Search UI -->
      <div class="flex items-center gap-2">
        <div id="chatSearchBar" class="hidden flex items-center bg-discord-gray-900 rounded px-2 py-1 relative">
          <input type="text" id="chatSearchInput" placeholder="Search Zylo..."
            class="bg-transparent border-none text-white text-sm focus:ring-0 focus:outline-none w-32 md:w-48 placeholder-discord-gray-400"
            onkeyup="handleSearchInput(this.value, event)">
          <button onclick="handleSearchInput(document.getElementById('chatSearchInput').value, {key:'Enter'})"
            class="text-discord-gray-400 hover:text-white">
            <i data-feather="search" class="w-4 h-4"></i>
          </button>

          <!-- Global Search Dropdown -->
          <div id="globalSearchResults"
            class="hidden absolute top-full left-0 w-64 bg-discord-gray-800 rounded-md shadow-lg border border-discord-gray-700 z-50 mt-2 max-h-60 overflow-y-auto">
            <!-- Results populated by JS -->
          </div>
        </div>
        <button onclick="toggleSearchBar()" class="text-discord-gray-300 hover:text-white p-1" title="Search Messages">
          <i data-feather="search" class="w-5 h-5"></i>
        </button>
      </div>
    </header>

    <div id="mainContent" class="flex-1 flex flex-col min-h-0 overflow-hidden">

      <section id="tab-home"
        class="tab-content h-full overflow-y-auto p-4 md:p-6 space-y-6 hidden animate-fadeIn scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">

        <div
          class="bg-gradient-to-r from-discord-blurple to-purple-500 p-6 rounded-xl shadow-md text-white text-center">
          <h1 class="text-3xl font-bold mb-2">Welcome to Zylo!</h1>
          <p class="text-sm sm:text-base">Connect. Chat. Share. All in one place!</p>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
          <div class="bg-discord-gray-800 p-4 rounded-xl shadow-lg text-center">
            <p class="text-sm text-discord-gray-400">Friends/Users</p>
            <p class="text-lg font-semibold text-white" id="stat-users">0</p>
          </div>
          <div class="bg-discord-gray-800 p-4 rounded-xl shadow-lg text-center">
            <p class="text-sm text-discord-gray-400">Messages</p>
            <p class="text-lg font-semibold text-white" id="stat-messages">0</p>
          </div>
          <div class="bg-discord-gray-800 p-4 rounded-xl shadow-lg text-center">
            <p class="text-sm text-discord-gray-400">Rooms/Groups</p>
            <p class="text-lg font-semibold text-white" id="stat-rooms">0</p>
          </div>
        </div>

        <div>
          <h2 class="text-xl font-bold mb-2 text-white">üí° Zylo Tips</h2>
          <ul class="space-y-2 text-sm text-discord-gray-300 list-disc list-inside">
            <li>Click the ‚öôÔ∏è icon in the user panel to customize your experience.</li>
            <li>Use the chat tab to connect with your team instantly.</li>
            <li>Upload files, images, or audio directly from the chat.</li>
          </ul>
        </div>

        <div>
          <h2 class="text-xl font-bold mb-2 text-white">üì¢ Announcements</h2>
          <div class="bg-discord-gray-800 p-4 rounded-xl shadow-lg">
            <div class="text-sm text-discord-gray-300 space-y-1">
              <p>üöÄ v1.2 adds Friends and Groups with room chat.</p>
              <p>‚ú® Home quick stats now update from backend.</p>
              <p>ü§ñ Optional AI chat toggle in Chats tab.</p>
            </div>
          </div>
        </div>
      </section>

      <div id="tab-messages" class="tab-content chat-area flex flex-col h-full">
        <div id="chatMessagesCommunity" class="chat-messages"></div>
        <div id="chatMessagesAI" class="chat-messages hidden"></div>

        <!-- New Messages Indicator -->
        <button id="newMessagesIndicatorCommunity"
          class="hidden absolute bottom-20 left-1/2 -translate-x-1/2 bg-discord-blurple hover:bg-discord-blurple/80 text-white text-xs font-medium px-4 py-2 rounded-full shadow-lg z-20 transition-all animate-slideIn"
          onclick="scrollToBottomCommunity()">
          ‚Üì New Messages
        </button>

        <div id="typingIndicator" class="typing-indicator"></div>

        <div class="flex-shrink-0 p-4 border-t border-discord-gray-900">
          <div class="flex items-center gap-2 bg-discord-gray-600 rounded-lg p-2 relative">
            <label class="p-2 rounded-full hover:bg-discord-gray-500/70 cursor-pointer transition"
              title="Attach a file">
              <i data-feather="plus-circle" class="w-5 h-5 text-gray-200"></i>
              <input type="file" id="fileInput" class="hidden" onchange="sendFile(event)">
            </label>
            <button class="p-2 rounded-full hover:bg-discord-gray-500/70 transition" onclick="openAppModal('menu')"
              title="Apps & Tools">
              <i data-feather="grid" class="w-5 h-5 text-gray-200"></i>
            </button>
            <!-- Reply Bar -->
            <div id="replyBar"
              class="hidden absolute bottom-full left-0 w-full bg-discord-gray-700/90 backdrop-blur p-2 mb-2 rounded-t-lg border-t border-discord-gray-600 flex justify-between items-center text-xs text-discord-gray-300">
              <span id="replyTargetText">Replying to...</span>
              <button onclick="cancelReply()" class="hover:text-white"><i data-feather="x" class="w-3 h-3"></i></button>
            </div>
            <textarea id="chatInput" placeholder="Message #community" rows="1"
              class="flex-1 bg-transparent border-none text-white resize-none focus:outline-none"
              onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendMessage();}"></textarea>
            <button class="p-2 rounded-full hover:bg-discord-gray-500/70 transition"
              onclick="toggleStickerPicker('communityStickerPicker')" title="Pick a sticker">
              <i data-feather="archive" class="w-5 h-5 text-gray-200"></i>
            </button>
            <button class="p-2 rounded-full hover:bg-discord-gray-500/70 transition"
              onclick="toggleEmojiPicker('communityEmojiPicker', 'chatInput')" title="Pick an emoji">
              <i data-feather="smile" class="w-5 h-5 text-gray-200"></i>
            </button>
            <button id="voiceMsgBtn" class="p-2 rounded-full hover:bg-discord-gray-500/70 transition voice-record-btn"
              onmousedown="startVoiceRecording('community')" onmouseup="stopVoiceRecording('community')"
              ontouchstart="startVoiceRecording('community')" ontouchend="stopVoiceRecording('community')"
              title="Hold to record voice message">
              <i data-feather="mic" class="w-5 h-5 text-gray-200"></i>
            </button>
            <button onclick="sendMessage()" class="text-discord-gray-400 hover:text-white">
              <i data-feather="send" class="w-5 h-5"></i>
            </button>
            <div id="communityEmojiPicker"
              class="hidden absolute bottom-16 right-4 bg-discord-gray-800 rounded-lg shadow-lg z-50"></div>
            <div id="communityStickerPicker"
              class="sticker-picker hidden absolute bottom-16 right-20 bg-discord-gray-800 rounded-lg shadow-lg z-50 p-3">
            </div>
          </div>
        </div>
      </div>

      <section id="tab-friends" class="tab-content hidden h-full flex flex-col animate-fadeIn overflow-hidden">

        <div id="friendsDashboard" class="flex flex-col h-full w-full">
          <header
            class="flex-shrink-0 h-12 border-b border-discord-gray-900 p-4 flex items-center gap-4 bg-discord-gray-700">
            <div class="flex items-center gap-2 pr-4 border-r border-discord-gray-600">
              <i data-feather="users" class="text-discord-gray-400"></i>
              <span class="font-bold text-white">Friends</span>
            </div>
            <div class="flex items-center gap-2 text-sm overflow-x-auto scrollbar-hide">
              <button class="friend-toolbar-btn active" onclick="filterFriends('all')">All</button>
              <button class="friend-toolbar-btn" onclick="filterFriends('online')">Online</button>
              <button class="friend-toolbar-btn" onclick="filterFriends('pending')">Pending</button>
              <button class="friend-toolbar-btn add-friend" onclick="filterFriends('add')">Add Friend</button>
            </div>
          </header>

          <div class="flex-1 overflow-y-auto p-4" id="friendsDashboardContent">
          </div>

          <div id="addFriendSection" class="hidden p-6">
            <h2 class="text-white font-bold uppercase mb-2 text-base">Add Friend</h2>
            <p class="text-discord-gray-400 text-sm mb-4">You can add friends with their username.</p>
            <div
              class="flex gap-2 max-w-2xl bg-discord-gray-900/50 p-2 rounded-lg border border-discord-gray-900 focus-within:border-discord-blurple transition">
              <input id="addFriendInputMain" type="text"
                class="bg-transparent border-none flex-1 text-white focus:ring-0 p-2"
                placeholder="Enter a username (e.g. ZyloUser)" />
              <button onclick="requestFriendMain()"
                class="bg-discord-blurple text-white px-4 py-1 rounded hover:bg-opacity-80 text-sm font-medium">Send
                Friend Request</button>
            </div>
          </div>
        </div>

        <div id="friendsChatView" class="hidden flex flex-col h-full w-full">
          <div
            class="flex-shrink-0 h-12 border-b border-discord-gray-900 flex items-center justify-between px-4 bg-discord-gray-700 shadow-sm">
            <div class="flex items-center gap-3">
              <span class="text-discord-gray-400 cursor-pointer md:hidden" onclick="showFriendsDashboard()">
                <i data-feather="arrow-left"></i>
              </span>
              <i data-feather="at-sign" class="text-discord-gray-400 w-5 h-5"></i>
              <span id="chatHeaderTitle" class="font-bold text-white">Username</span>
            </div>
            <div class="flex gap-4 text-discord-gray-400">
              <button id="friendMuteBtn" class="hover:text-white" title="Mute Notifications"
                onclick="toggleFriendMute()">
                <i data-feather="bell" class="w-5 h-5"></i>
              </button>
              <i data-feather="phone" class="w-5 h-5 hover:text-white cursor-pointer"
                onclick="startFakeCall('voice')"></i>
              <i data-feather="video" class="w-5 h-5 hover:text-white cursor-pointer"
                onclick="startFakeCall('video')"></i>
            </div>
          </div>

          <div id="friendsChatMessages"
            class="chat-messages flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin scrollbar-thumb-discord-gray-900">
          </div>

          <div class="flex-shrink-0 p-4">
            <div class="chat-input-container relative flex items-center gap-3 px-4 py-3 bg-discord-gray-600 rounded-lg">
              <label class="cursor-pointer hover:text-white text-discord-gray-400">
                <i data-feather="plus-circle" class="w-5 h-5"></i>
                <input type="file" id="friendsChatFile" class="hidden" onchange="sendFriendFile(event)">
              </label>
              <button class="p-2 rounded-full hover:bg-discord-gray-500/70 transition" onclick="openAppModal('menu')"
                title="Apps & Tools">
                <i data-feather="grid" class="w-5 h-5 text-gray-200"></i>
              </button>
              <!-- Friends Reply Bar -->
              <div id="friendsReplyBar"
                class="hidden absolute bottom-full left-0 w-full bg-discord-gray-700/90 backdrop-blur p-2 mb-2 rounded-t-lg border-t border-discord-gray-600 flex justify-between items-center text-xs text-discord-gray-300">
                <span id="friendsReplyTargetText">Replying to...</span>
                <button onclick="cancelReply()" class="hover:text-white"><i data-feather="x"
                    class="w-3 h-3"></i></button>
              </div>
              <textarea id="friendsChatInput" rows="1"
                class="flex-1 bg-transparent border-none text-white resize-none focus:outline-none"
                placeholder="Message @User"
                onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendFriendMessage();}"></textarea>
              <button class="p-2 rounded-full hover:bg-discord-gray-500/70 transition"
                onclick="toggleStickerPicker('friendsStickerPicker')" title="Pick a sticker">
                <i data-feather="archive" class="w-5 h-5 text-gray-200"></i>
              </button>
              <button class="p-2 rounded-full hover:bg-discord-gray-500/70 transition"
                onclick="toggleEmojiPicker('friendsEmojiPicker', 'friendsChatInput')" title="Pick an emoji">
                <i data-feather="smile" class="w-5 h-5 text-gray-200"></i>
              </button>
              <button onclick="sendFriendMessage()" class="text-discord-gray-400 hover:text-white transition">
                <i data-feather="send" class="w-5 h-5"></i>
              </button>
              <div id="friendsEmojiPicker"
                class="hidden absolute bottom-16 right-4 bg-discord-gray-800 rounded-lg shadow-lg z-50"></div>
              <div id="friendsStickerPicker"
                class="sticker-picker hidden absolute bottom-16 right-20 bg-discord-gray-800 rounded-lg shadow-lg z-50 p-3">
              </div>
            </div>
          </div>
        </div>
      </section>

      <div id="tab-profile"
        class="tab-content h-full overflow-y-auto scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">
        <section id="profileView" class="w-full h-full p-4 md:p-6">
          <div class="profile-card max-w-5xl mx-auto bg-discord-gray-800 rounded-2xl shadow-xl overflow-hidden z-0">

            <div class="profile-banner flex flex-col items-start relative z-10">
              <img id="bannerImage" src="/images/default_banner.png" alt="Banner" class="profile-banner-img banner-img">
              <div class="-mt-16 ml-6">
                <img id="avatarImage" src="/images/default_avatar.png" alt="Avatar"
                  class="profile-avatar avatar-img relative z-30" />
              </div>
            </div>

            <div class="pt-20 px-6 pb-6">
              <h2 id="profileUsername" class="text-2xl font-semibold text-white">ZyloUser</h2>
              <p id="profileUsertag" class="text-discord-gray-400">@zylo1234</p>
              <div class="mt-3 group flex items-center gap-2" style="max-width:70%;">
                <p id="profileBio" class="text-discord-gray-300 truncate max-w-[70%]">This user haven't said anything
                  about them self yet...</p>
                <button id="editBioBtn" title="Edit bio"
                  class="hidden group-hover:inline-flex items-center gap-1 text-discord-gray-400 hover:text-white p-1 rounded"
                  onclick="startEditBio()">
                  <i data-feather="edit-2" class="w-4 h-4"></i>
                </button>
              </div>

              <div id="profileActionButtons" class="mt-5 flex gap-3" style="display: none;">
                <button id="profileMessageBtn" class="bg-discord-blurple hover:bg-opacity-80 px-4 py-2 rounded-lg"
                  onclick="openDMFromProfile()">Message</button>
                <button id="profileAddFriendBtn"
                  class="bg-discord-gray-600 hover:bg-discord-gray-500 px-4 py-2 rounded-lg"
                  onclick="addFriendFromProfile()">Add Friend</button>
              </div>
            </div>

            <div id="profileTabs"
              class="border-t border-discord-gray-700/50 px-6 py-3 flex gap-6 text-discord-gray-400 overflow-x-auto scrollbar-hide">
              <button class="profile-tab active text-white whitespace-nowrap" data-tab="about">About Me</button>
              <button class="profile-tab whitespace-nowrap" data-tab="servers">Mutual Servers</button>

              <!-- Desktop only tabs -->
              <button class="profile-tab hidden md:block whitespace-nowrap" data-tab="friends">Mutual Friends</button>
              <button class="profile-tab hidden md:block whitespace-nowrap" data-tab="activity">Activity /
                Overview</button>
              <button class="profile-tab hidden md:block whitespace-nowrap" data-tab="media">Saved Media</button>
              <button class="profile-tab hidden md:block whitespace-nowrap" data-tab="cloud">My Cloud</button>
              <button class="profile-tab hidden md:block whitespace-nowrap" data-tab="effects"
                onclick="openProfileEffectsModal()">Profile Effects</button>

              <!-- Mobile 'More' button -->
              <button class="profile-tab md:hidden flex items-center whitespace-nowrap"
                onclick="openMobileProfileMenu()">
                More <i data-feather="chevron-down" class="ml-1 w-4 h-4"></i>
              </button>
            </div>

            <!-- Mobile Profile Menu Modal -->
            <div id="mobileProfileMenuModal"
              class="fixed inset-0 z-[60] hidden flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm"
              onclick="closeMobileProfileMenu()">
              <div
                class="bg-discord-gray-800 w-full sm:w-80 rounded-t-xl sm:rounded-xl p-2 shadow-2xl border-t sm:border border-discord-gray-700 transform transition-transform duration-200 translate-y-full sm:translate-y-0"
                id="mobileProfileMenuContent" onclick="event.stopPropagation()">
                <div class="px-4 py-2 text-xs font-bold text-discord-gray-400 uppercase tracking-wide mb-1">More Options
                </div>

                <button
                  class="w-full text-left px-4 py-3 hover:bg-discord-gray-700 rounded text-discord-gray-200 flex items-center gap-3 transition-colors"
                  onclick="selectMobileProfileTab('friends')">
                  <i data-feather="users" class="w-5 h-5 text-discord-gray-400"></i> Mutual Friends
                </button>
                <button
                  class="w-full text-left px-4 py-3 hover:bg-discord-gray-700 rounded text-discord-gray-200 flex items-center gap-3 transition-colors"
                  onclick="selectMobileProfileTab('activity')">
                  <i data-feather="activity" class="w-5 h-5 text-discord-gray-400"></i> Activity / Overview
                </button>
                <button
                  class="w-full text-left px-4 py-3 hover:bg-discord-gray-700 rounded text-discord-gray-200 flex items-center gap-3 transition-colors"
                  onclick="selectMobileProfileTab('media')">
                  <i data-feather="image" class="w-5 h-5 text-discord-gray-400"></i> Saved Media
                </button>
                <button
                  class="w-full text-left px-4 py-3 hover:bg-discord-gray-700 rounded text-discord-gray-200 flex items-center gap-3 transition-colors"
                  onclick="selectMobileProfileTab('cloud')">
                  <i data-feather="cloud" class="w-5 h-5 text-discord-gray-400"></i> My Cloud
                </button>
                <button
                  class="w-full text-left px-4 py-3 hover:bg-discord-gray-700 rounded text-discord-gray-200 flex items-center gap-3 transition-colors"
                  onclick="selectMobileProfileTab('effects'); openProfileEffectsModal()">
                  <i data-feather="zap" class="w-5 h-5 text-discord-gray-400"></i> Profile Effects
                </button>

                <div class="h-px bg-discord-gray-700 my-2"></div>
                <button class="w-full text-center px-4 py-3 hover:bg-discord-gray-700 rounded text-red-400 font-medium"
                  onclick="closeMobileProfileMenu()">Cancel</button>
              </div>
            </div>

            <div id="profileTabContent" class="p-6 text-discord-gray-300">
              <!-- About Tab -->
              <div class="tab-pane" data-tab="about">
                <div id="profileAboutContent">
                  <div class="group flex items-start gap-2">
                    <p id="profileAboutBio" class="text-discord-gray-300 whitespace-pre-wrap">Loading...</p>
                    <button id="editAboutBtn" title="Edit about"
                      class="hidden group-hover:inline-flex items-center gap-1 text-discord-gray-400 hover:text-white p-1 rounded mt-1"
                      onclick="startEditAbout()">
                      <i data-feather="edit-2" class="w-4 h-4"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Mutual Servers Tab -->
              <div class="tab-pane hidden" data-tab="servers">
                <div id="mutualServersContent">
                  <p>No mutual servers to show.</p>
                </div>
              </div>

              <!-- Mutual Friends Tab -->
              <div class="tab-pane hidden" data-tab="friends">
                <p id="mutualFriendsContent">No mutual friends to show.</p>
              </div>

              <!-- Activity Tab -->
              <div class="tab-pane hidden" data-tab="activity">
                <div class="text-center py-12 border-2 border-dashed border-discord-gray-700 rounded-xl">
                  <i data-feather="activity" class="w-12 h-12 mx-auto mb-3 text-discord-gray-600"></i>
                  <h3 class="text-lg font-bold text-discord-gray-300">Activity Overview</h3>
                  <p class="text-discord-gray-500 text-sm mt-1">Recent activity and stats will appear here.</p>
                </div>
              </div>

              <!-- Saved Media Tab -->
              <div class="tab-pane hidden" data-tab="media">
                <div class="text-center py-12 border-2 border-dashed border-discord-gray-700 rounded-xl">
                  <i data-feather="image" class="w-12 h-12 mx-auto mb-3 text-discord-gray-600"></i>
                  <h3 class="text-lg font-bold text-discord-gray-300">Saved Media</h3>
                  <p class="text-discord-gray-500 text-sm mt-1">Your saved photos and videos will be displayed here.</p>
                </div>
              </div>

              <!-- My Cloud Tab -->
              <div class="tab-pane hidden" data-tab="cloud">
                <div class="text-center py-12 bg-discord-gray-700/30 rounded-xl">
                  <i data-feather="cloud" class="w-16 h-16 mx-auto mb-4 text-discord-blurple"></i>
                  <h3 class="text-xl font-bold text-white mb-2">My Personal Cloud</h3>
                  <p class="text-discord-gray-400 mb-6 max-w-sm mx-auto">Access your secure personal storage to manage
                    files, documents, and assets.</p>
                  <button onclick="navigateTo('cloud')"
                    class="px-6 py-2 bg-discord-blurple hover:bg-opacity-80 text-white font-medium rounded-lg transition shadow-lg transform hover:scale-105">
                    Go to My Cloud
                  </button>
                </div>
              </div>
            </div>
        </section>
      </div>

      <div id="cropperModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-discord-gray-800 rounded-lg p-4 w-full max-w-md space-y-4 shadow-lg">
          <h3 class="text-lg font-semibold text-center text-white">Adjust your image</h3>
          <div class="w-full h-64 overflow-hidden rounded border border-discord-gray-600">
            <img id="cropperImage" class="max-w-full" />
          </div>
          <div class="flex justify-between items-center gap-2">
            <button onclick="rotateImage(-90)" class="bg-discord-gray-700 text-white px-3 py-1 rounded">‚ü≤
              Rotate</button>
            <input type="range" min="0.1" max="3" step="0.01" value="1" id="zoomSlider" class="w-full">
            <button onclick="rotateImage(90)" class="bg-discord-gray-700 text-white px-3 py-1 rounded">‚ü≥
              Rotate</button>
          </div>
          <div class="flex justify-end gap-2">
            <button onclick="closeCropper()"
              class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded">Cancel</button>
            <button onclick="applyCrop()"
              class="px-4 py-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded">Apply</button>
          </div>
        </div>
      </div>

      <section id="tab-cloud"
        class="tab-content h-full overflow-y-auto hidden animate-fadeIn scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">
        <div class="max-w-4xl mx-auto w-full space-y-4 p-4 md:p-6">
          <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold text-white">‚òÅÔ∏è My Cloud</h1>
            <div class="flex items-center gap-2">
              <button id="cloudViewGrid" onclick="setCloudView('grid')"
                class="p-2 rounded bg-discord-gray-700 hover:bg-discord-gray-600 text-white" title="Grid View">
                <i data-feather="grid" class="w-4 h-4"></i>
              </button>
              <button id="cloudViewList" onclick="setCloudView('list')"
                class="p-2 rounded bg-discord-gray-800 hover:bg-discord-gray-600 text-discord-gray-400"
                title="List View">
                <i data-feather="list" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
          <p class="text-discord-gray-400 text-sm">Store your personal files securely. Only you can see them.</p>

          <!-- Upload Area -->
          <div id="cloudUploadArea"
            class="border-2 border-dashed border-discord-gray-600 rounded-xl p-6 text-center hover:border-discord-blurple transition-colors cursor-pointer bg-discord-gray-800/50">
            <i data-feather="upload-cloud" class="w-12 h-12 mx-auto mb-3 text-discord-gray-500"></i>
            <p class="text-discord-gray-300 mb-2">Drag & drop files here, or click to browse</p>
            <input type="file" id="cloudFileInput" class="hidden" multiple />
            <label for="cloudFileInput"
              class="px-4 py-2 rounded bg-discord-blurple text-white cursor-pointer hover:bg-opacity-80 inline-block">
              Choose Files
            </label>
          </div>

          <!-- Uploading Progress (hidden by default) -->
          <div id="cloudUploadProgress" class="hidden p-3 bg-discord-gray-800 rounded-lg">
            <div class="flex items-center gap-3">
              <div class="animate-spin w-5 h-5 border-2 border-discord-blurple border-t-transparent rounded-full"></div>
              <span class="text-discord-gray-300 text-sm">Uploading...</span>
            </div>
          </div>

          <!-- Files Container -->
          <div id="cloudFilesContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Files will be loaded here dynamically -->
          </div>

          <!-- Empty State -->
          <div id="cloudEmptyState" class="hidden text-center py-12">
            <i data-feather="cloud-off" class="w-16 h-16 mx-auto mb-4 text-discord-gray-600"></i>
            <p class="text-discord-gray-500">No files yet. Upload your first file!</p>
          </div>
        </div>
      </section>

      <section id="tab-moments"
        class="tab-content h-full overflow-y-auto hidden animate-fadeIn scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">
        <div class="max-w-3xl mx-auto w-full space-y-4 p-4 md:p-6">
          <h1 class="text-2xl font-bold text-white">üìñ My Moments</h1>
          <p class="text-discord-gray-300">Share your moments with friends. Add photos, videos, and more!</p>

          <div class="p-4 rounded-lg bg-discord-gray-800 space-y-3">
            <div class="flex items-center gap-2">
              <input id="momentsCaption" class="zylo-input flex-1 p-2" placeholder="What's on your mind?" />
              <label class="px-3 py-2 rounded bg-discord-blurple text-white cursor-pointer">
                Attach
                <input type="file" id="momentsFile" class="hidden" />
              </label>
              <button id="momentsShareBtn" class="px-3 py-2 rounded bg-green-600 text-white">Share</button>
            </div>
            <div id="momentsPreview" class="rounded overflow-hidden"></div>
          </div>

          <div id="momentsFeed" class="space-y-4"></div>
        </div>
      </section>

      <section id="tab-cloud"
        class="tab-content h-full hidden animate-fadeIn flex flex-col p-6 space-y-6 overflow-y-auto scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-3xl font-bold text-white mb-2">‚òÅÔ∏è My Cloud</h2>
            <p class="text-discord-gray-400">Your personal file storage. Accessible from anywhere.</p>
          </div>
          <button onclick="loadCloudFiles()"
            class="p-2 rounded bg-discord-gray-700 hover:bg-discord-gray-600 text-white" title="Refresh">
            <i data-feather="refresh-cw" class="w-5 h-5"></i>
          </button>
        </div>

        <!-- Upload Area -->
        <div id="cloudUploadArea"
          class="border-2 border-dashed border-discord-gray-600 rounded-xl p-8 text-center hover:border-discord-blurple transition-colors cursor-pointer bg-discord-gray-800/50">
          <i data-feather="upload-cloud" class="w-16 h-16 mx-auto mb-4 text-discord-gray-500"></i>
          <p class="text-xl text-discord-gray-300 mb-2">Drag & drop files here</p>
          <p class="text-sm text-discord-gray-400 mb-4">or click to browse</p>
          <input type="file" id="cloudFileInput" class="hidden" multiple onchange="uploadCloudFile(this.files)" />
          <label for="cloudFileInput"
            class="px-6 py-3 rounded-full bg-discord-blurple text-white font-medium cursor-pointer hover:bg-opacity-80 inline-block transition">
            Choose Files
          </label>
        </div>
        <div id="cloudUploadProgress"
          class="hidden p-3 bg-discord-gray-800 rounded-lg text-center text-discord-blurple">Uploading...</div>

        <div class="flex-1">
          <div id="filesListContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 pb-4">
            <!-- Files loading placeholder -->
            <div class="col-span-full py-20 text-center text-discord-gray-500">
              <p>Loading files...</p>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-group" class="tab-content h-full hidden animate-fadeIn flex flex-col">
        <!-- Group Chat Header -->
        <header
          class="flex-shrink-0 h-12 border-b border-discord-gray-900 px-4 flex items-center justify-between bg-discord-gray-700 shadow-sm">
          <div class="flex items-center gap-2">
            <span class="text-discord-gray-400">#</span>
            <span id="groupChatChannelName" class="font-semibold text-white">general</span>
          </div>
          <div class="flex items-center gap-2">
            <span id="groupChatMemberCount" class="text-xs text-discord-gray-400">0 members</span>
          </div>
        </header>

        <!-- Group Messages -->
        <div id="groupChatMessages"
          class="chat-messages flex-1 overflow-y-auto p-4 space-y-2 scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">
          <!-- Messages will be added here dynamically -->
        </div>

        <!-- Group Chat Input -->
        <div class="flex-shrink-0 p-4 border-t border-discord-gray-900">
          <div class="flex items-center gap-2 bg-discord-gray-600 rounded-lg p-2 relative">
            <label class="p-2 rounded-full hover:bg-discord-gray-500/70 cursor-pointer transition"
              title="Attach a file">
              <i data-feather="plus-circle" class="w-5 h-5 text-gray-200"></i>
              <input type="file" id="groupFileInput" class="hidden" onchange="sendGroupFile(event)">
            </label>
            <button class="p-2 rounded-full hover:bg-discord-gray-500/70 transition" onclick="openAppModal('menu')"
              title="Apps & Tools">
              <i data-feather="grid" class="w-5 h-5 text-gray-200"></i>
            </button>
            <!-- Group Reply Bar -->
            <div id="groupReplyBar"
              class="hidden absolute bottom-full left-0 w-full bg-discord-gray-700/90 backdrop-blur p-2 mb-2 rounded-t-lg border-t border-discord-gray-600 flex justify-between items-center text-xs text-discord-gray-300">
              <span id="groupReplyTargetText">Replying to...</span>
              <button onclick="cancelReply()" class="hover:text-white"><i data-feather="x" class="w-3 h-3"></i></button>
            </div>
            <textarea id="groupChatInput" placeholder="Message #general" rows="1"
              class="flex-1 bg-transparent border-none text-white resize-none focus:outline-none"
              onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendGroupChatMessage();}"></textarea>
            <button class="p-2 rounded-full hover:bg-discord-gray-500/70 transition"
              onclick="toggleStickerPicker('groupStickerPicker')" title="Pick a sticker">
              <i data-feather="archive" class="w-5 h-5 text-gray-200"></i>
            </button>
            <button class="p-2 rounded-full hover:bg-discord-gray-500/70 transition"
              onclick="toggleEmojiPicker('groupEmojiPicker', 'groupChatInput')" title="Pick an emoji">
              <i data-feather="smile" class="w-5 h-5 text-gray-200"></i>
            </button>
            <button onclick="sendGroupChatMessage()" class="text-discord-gray-400 hover:text-white">
              <i data-feather="send" class="w-5 h-5"></i>
            </button>
            <div id="groupEmojiPicker"
              class="hidden absolute bottom-16 right-4 bg-discord-gray-800 rounded-lg shadow-lg z-50"></div>
            <div id="groupStickerPicker"
              class="sticker-picker hidden absolute bottom-16 right-20 bg-discord-gray-800 rounded-lg shadow-lg z-50 p-3">
            </div>
          </div>
        </div>
      </section>

      <section id="tab-settings"
        class="tab-content h-full overflow-y-auto p-4 md:p-6 hidden animate-fadeIn scrollbar-thin scrollbar-thumb-discord-gray-900 scrollbar-track-transparent">
        <div class="w-full max-w-4xl mx-auto space-y-8">

          <div id="generalSettings" class="settings-content w-full space-y-6">
            <h2 class="text-2xl font-bold text-white">General Settings</h2>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span id="labelEnableAnimations">Enable Animations</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="animationsToggle" class="sr-only peer">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-discord-blurple rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span id="labelCompactMode">Compact Mode</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="compactToggle" class="sr-only peer">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-purple-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span id="labelShowTooltips">Show Tooltips</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="tooltipToggle" class="sr-only peer">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-green-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span id="labelShowHomeTab">Show Home Tab</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="showHomeTabToggle" class="sr-only peer"
                  onchange="toggleHomeTab(this.checked)">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-discord-blurple rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <label id="labelLanguage" for="languageSelect" class="block mb-2">Language</label>
              <select id="languageSelect" class="w-full p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
                <option value="en">English</option>
                <option value="vi">Ti·∫øng Vi·ªát</option>
                <option value="es">Espa√±ol</option>
              </select>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <label id="labelStartupPage" for="startupPage" class="block mb-2">Startup Page</label>
              <select id="startupPage" class="w-full p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
                <option value="home">Home</option>
                <option value="profile">Profile</option>
                <option value="messages">Community</option>
                <option value="friends">Friends</option>
                <option value="moments">Moments</option>
                <option value="settings">Settings</option>
              </select>
            </div>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span id="labelAutoSave">Auto Save Changes</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="autoSaveToggle" class="sr-only peer">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-yellow-500 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span id="labelConfirmExit">Confirm Before Exit</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="confirmExitToggle" class="sr-only peer">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-red-500 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>



            <div id="saveSettingsBtn" class="pt-4 border-t border-discord-gray-600" style="display: none;">
              <button onclick="showSaveSettingsModal()"
                class="w-full px-4 py-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded-lg mb-3">
                <i data-feather="save" class="w-4 h-4 inline mr-2"></i>
                Save Changes
              </button>
            </div>
            <div class="pt-4 border-t border-discord-gray-600">
              <button id="btnResetAll" onclick="resetAllSettings()"
                class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Reset All
                Settings</button>
            </div>
          </div>

          <div id="appearanceSettings" class="settings-content w-full hidden space-y-6">
            <h2 class="text-2xl font-bold text-white">Appearance</h2>

            <!-- Theme Presets -->
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="font-semibold mb-2 text-white">Theme Presets</h3>
              <select id="themePresetSelect" onchange="applyThemePreset(this.value)"
                class="w-full bg-discord-gray-700 text-white p-2 rounded border border-discord-gray-600">
                <option value="">Select a preset...</option>
                <option value="light">Light Mode</option>
                <option value="dark">Dark Mode (Default)</option>
                <option value="midnight">Midnight Blue</option>
                <option value="custom">Custom Strategy</option>
              </select>
            </div>

            <!-- Moved Controls -->
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="font-semibold mb-3 text-white">Quick Settings</h3>
              <div class="flex items-center gap-3 flex-wrap mb-4">
                <span id="themeColorSwatch"
                  class="inline-flex items-center gap-2 px-2 py-1 rounded border text-xs border-discord-gray-600">
                  <span id="themeColorDot" class="w-4 h-4 rounded-full border"></span>
                  <span id="themeColorText">#ffffff</span>
                </span>
                <button onclick="setTheme('light')" class="px-3 py-1 bg-gray-200 text-gray-800 rounded">Light</button>
                <button onclick="setTheme('dark')"
                  class="px-3 py-1 bg-discord-gray-600 text-white rounded">Dark</button>
                <button onclick="setTheme('system')"
                  class="px-3 py-1 bg-discord-gray-600 text-white rounded">System</button>
                <input type="color" id="customThemeColorPicker"
                  class="h-9 w-12 p-1 rounded border bg-discord-gray-700 border-discord-gray-600"
                  title="Custom Accent Color" />
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <label class="inline-flex items-center gap-2">
                  <input type="checkbox" id="solidBgToggle" class="accent-discord-blurple">
                  <span id="labelSolidBg">Solid BG</span>
                </label>
                <div class="flex items-center gap-2">
                  <input type="file" id="bgImageInput" accept="image/*"
                    class="block w-full text-sm text-discord-gray-300 file:mr-3 file:py-1 file:px-3 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-discord-gray-600 file:text-white hover:file:bg-discord-gray-500" />
                  <button id="previewBgBtn" class="px-3 py-1 bg-green-700 rounded">Preview</button>
                  <button id="clearBgImageBtn" class="px-3 py-1 bg-discord-gray-600 rounded">Clear</button>
                </div>
              </div>
            </div>

            <!-- Custom Editor Access -->
            <div class="p-3 bg-discord-gray-800 rounded-lg flex items-center justify-between">
              <div>
                <h3 class="font-semibold text-white">Advanced Theme Editor</h3>
                <p class="text-sm text-discord-gray-400">Customize every color and background</p>
              </div>
              <button onclick="window.openThemeEditor()"
                class="px-4 py-2 bg-discord-blurple text-white rounded hover:bg-opacity-90">Open Editor</button>
            </div>

            <!-- Reset -->
            <div class="pt-4 border-t border-discord-gray-600">
              <button onclick="resetAppearanceSettings()"
                class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Reset Appearance to
                Default</button>
            </div>
          </div> <!-- Added this closing div for appearanceSettings -->


          <div id="soundSettings" class="settings-content w-full hidden space-y-6">
            <h2 class="text-2xl font-bold text-white">Sound & Notifications</h2>

            <!-- Do Not Disturb -->
            <div class="bg-discord-gray-900 p-4 rounded-lg border border-discord-gray-600 mb-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="bg-red-500/20 p-2 rounded-full text-red-500">
                    <i data-feather="bell-off" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <h3 class="text-white font-medium">Do Not Disturb</h3>
                    <p class="text-xs text-discord-gray-400">Suppress all notification sounds (messages, calls).</p>
                  </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="dndToggle" class="sr-only peer">
                  <div
                    class="w-11 h-6 bg-discord-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500">
                  </div>
                </label>
              </div>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <label for="soundVolume" class="block mb-2">Sound Effects Volume</label>
              <input type="range" id="soundVolume" min="0" max="100" value="75" class="w-full accent-discord-blurple">
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <label for="musicVolume" class="block mb-2">Music Volume</label>
              <input type="range" id="musicVolume" min="0" max="100" value="60" class="w-full accent-green-500">
            </div>
            <div class="flex items-center justify-between p-3 bg-discord-gray-800 rounded-lg">
              <span>Mute All Sounds</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="muteAll" class="sr-only peer">
                <div
                  class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-red-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                </div>
              </label>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg space-y-2">
              <div class="flex items-center gap-2">
                <input type="checkbox" id="enableSound" class="accent-discord-blurple">
                <label for="enableSound">Enable Sound Effects</label>
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="enableMusic" class="accent-discord-blurple">
                <label for="enableMusic">Enable Background Music</label>
              </div>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <label for="soundProfile" class="block mb-2">Sound Profile</label>
              <select id="soundProfile" class="w-full p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
                <option value="default">Default</option>
                <option value="soft">Soft</option>
                <option value="retro">Retro</option>
                <option value="clicky">Clicky</option>
              </select>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="font-semibold mb-2">Play on events</h3>
              <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" id="playSend" class="accent-discord-blurple" checked>
                <label for="playSend">Message sent</label>
              </div>
              <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" id="playReceive" class="accent-discord-blurple" checked>
                <label for="playReceive">Message received</label>
              </div>
              <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" id="playUi" class="accent-discord-blurple" checked>
                <label for="playUi">UI interactions</label>
              </div>
            </div>
            <div class="flex items-center gap-2 p-3 bg-discord-gray-800 rounded-lg">
              <input type="checkbox" id="duckMusic" class="accent-discord-blurple">
              <label for="duckMusic">Duck music when playing effects</label>
            </div>
            <div id="saveSoundSettingsBtn" class="pt-4 border-t border-discord-gray-600" style="display: none;">
              <button onclick="showSaveSettingsModal()"
                class="w-full px-4 py-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded-lg">
                <i data-feather="save" class="w-4 h-4 inline mr-2"></i>
                Save Sound Settings
              </button>
            </div>
          </div>

          <div id="aboutSettings" class="settings-content w-full hidden space-y-6">
            <h2 class="text-2xl font-bold text-white">About Us</h2>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <p class="text-discord-gray-300"><strong>Zylo v1.2.1</strong> ‚Äî Created by D4niel-dev</p>
              <p class="text-discord-gray-400 text-sm mt-1">¬© 2025 Zylo. All rights reserved.</p>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="text-lg font-semibold mb-2 text-white">Version Details</h3>
              <ul class="list-disc list-inside text-discord-gray-300 text-sm space-y-1">
                <li>Build: 1.2.1-stable</li>
                <li>Release Date: August 2025</li>
                <li>UI Framework: Tailwind CSS</li>
                <li>Backend: Python (Flask)</li>
                <li>Platform: Web/Desktop Hybrid</li>
              </ul>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="text-lg font-semibold mb-2 text-white">System Status</h3>
              <div id="aboutSystemStatus" class="text-discord-gray-300 text-sm">Checking backend status...</div>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="text-lg font-semibold mb-2 text-white">Quick Actions</h3>
              <div class="flex flex-col gap-2">
                <button onclick="checkForUpdates()"
                  class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow">üîÑ Check for
                  Updates</button>
                <button onclick="openChangelog()"
                  class="px-4 py-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded-lg shadow">üìú View
                  Changelog</button>
                <button onclick="openPrivacyPolicy()"
                  class="px-4 py-2 bg-discord-gray-600 hover:bg-discord-gray-500 text-white rounded-lg shadow">üîí
                  Privacy Policy</button>
              </div>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="text-lg font-semibold mb-2 text-white">Credits</h3>
              <p class="text-discord-gray-300 text-sm">Special thanks to testers, designers, and contributors who
                made
                Zylo possible.</p>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="text-lg font-semibold mb-2 text-white">Resources</h3>
              <div class="flex flex-col gap-2">
                <a href="https://github.com/D4niel-dev" target="_blank" class="text-blue-400 hover:underline">üîó My
                  GitHub</a>
                <a href="https://www.youtube.com/@d4niel-dev" target="_blank" class="text-blue-400 hover:underline">üîó
                  My
                  YouTube</a>
                <a href="mailto:zylosupp0rt@gmail.com" class="text-blue-400 hover:underline">üìß Contact Support</a>
              </div>
            </div>
            <div class="p-3 bg-discord-gray-800 rounded-lg">
              <h3 class="text-lg font-semibold mb-2 text-white">License</h3>
              <p class="text-discord-gray-300 text-sm">This project is licensed under the MIT License.</p>
            </div>
          </div>

          <div id="accountSettings" class="settings-content w-full hidden space-y-6">
            <h2 class="text-2xl font-bold text-white">My Account</h2>
            <div class="relative rounded-xl shadow-sm bg-discord-gray-800 p-4">
              <label for="settingsBannerUpload" class="banner-label block cursor-pointer">
                <img id="settingsBanner" src="/images/default_banner.png" alt="Banner"
                  class="w-full h-40 object-cover rounded-xl" />
                <span class="edit-overlay" title="Change banner"><i data-feather="edit-2"></i></span>
              </label>
              <input type="file" id="settingsBannerUpload" accept="image/*" class="hidden">
              <div class="relative -mt-10 ml-6 drop-shadow z-10">
                <label for="settingsAvatarUpload" class="avatar-label cursor-pointer">
                  <img id="settingsAvatar" src="/images/default_avatar.png" alt="Avatar"
                    class="w-30 h-30 rounded-full border-4 border-discord-gray-800 object-cover avatar-img" />
                  <span class="edit-overlay" title="Change avatar"><i data-feather="edit-2"></i></span>
                </label>
                <input type="file" id="settingsAvatarUpload" accept="image/*" class="hidden">
                <button onclick="setAsBackground('avatar')"
                  class="absolute -bottom-2 -right-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded-full p-1 text-xs"
                  title="Set as background">
                  <i data-feather="image"></i>
                </button>
              </div>
            </div>

            <div class="space-y-3 p-4 bg-discord-gray-800 rounded-lg" aria-label="Account details">
              <div class="editable-row">
                <div>
                  <div class="editable-label">Username</div>
                  <div id="currentUsername" class="editable-value"></div>
                </div>
                <button class="edit-icon" onclick="promptUsernameEdit()" title="Edit username"><i
                    data-feather="edit-2"></i></button>
              </div>
              <div class="editable-row">
                <div>
                  <div class="editable-label">Usertag</div>
                  <div id="currentUsertag" class="editable-value"></div>
                </div>
                <button class="edit-icon" onclick="promptUsertagEdit()" title="Edit usertag"><i
                    data-feather="edit-2"></i></button>
              </div>
              <div class="editable-row">
                <div>
                  <div class="editable-label">Email</div>
                  <div id="currentEmail" class="editable-value">Hidden</div>
                </div>
                <button class="edit-icon" onclick="promptEmailEdit()" title="Edit email"><i
                    data-feather="edit-2"></i></button>
              </div>
              <div class="mb-4">
                <label class="editable-label">Bio</label>
                <div id="settingsProfileBioDisplay"
                  class="p-2 bg-discord-gray-700 rounded text-discord-gray-300 truncate" style="min-height:38px;">
                  &nbsp;
                </div>
              </div>
              <div class="mb-4">
                <label class="editable-label">About me</label>
                <div id="settingsAboutMeDisplay" class="p-3 bg-discord-gray-700 rounded text-discord-gray-300"
                  style="white-space:pre-wrap; max-height:200px; overflow:auto;">&nbsp;</div>
              </div>
            </div>

            <div class="mt-4 p-4 rounded-lg bg-discord-gray-800" aria-label="Security settings">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-semibold text-white">Two-Factor Authentication (2FA)</div>
                  <div class="text-sm text-discord-gray-400">Add an extra layer of protection.</div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="twoFactorToggle" class="sr-only peer">
                  <div
                    class="w-11 h-6 bg-discord-gray-600 peer-checked:bg-purple-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                  </div>
                </label>
              </div>
            </div>

            <div class="grid sm:grid-cols-2 gap-3" aria-label="Preferences">
              <div class="editable-row">
                <div>
                  <div class="editable-label">Language</div>
                  <div class="editable-value">
                    <select id="settingsLanguage" class="p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
                      <option value="en">English</option>
                      <option value="es">Spanish</option>
                      <option value="fr">French</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="editable-row">
                <div>
                  <div class="editable-label">Show Email on Profile</div>
                  <div class="editable-value"><input type="checkbox" id="showEmail" class="accent-discord-blurple">
                  </div>
                </div>
              </div>
            </div>

            <div class="p-4 rounded-lg bg-discord-gray-800">
              <div class="font-semibold mb-2 text-white">Change Password</div>
              <div class="grid sm:grid-cols-3 gap-2">
                <input type="password" id="oldPassword" placeholder="Current password"
                  class="p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
                <input type="password" id="newPassword" placeholder="New password"
                  class="p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
                <input type="password" id="confirmPassword" placeholder="Confirm new password"
                  class="p-2 rounded-lg border-discord-gray-600 bg-discord-gray-700">
              </div>
              <button onclick="updatePassword()"
                class="mt-3 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">Change
                Password</button>
            </div>

            <div class="border-t border-discord-gray-600 pt-4">
              <button onclick="deleteAccount()"
                class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white w-full">Delete Account</button>
            </div>

            <div id="saveAccountSettingsBtn" class="pt-4 border-t border-discord-gray-600" style="display: none;">
              <button onclick="showSaveSettingsModal()"
                class="w-full px-4 py-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded-lg">
                <i data-feather="save" class="w-4 h-4 inline mr-2"></i>
                Save Account Settings
              </button>
            </div>
          </div>
        </div>
      </section>



    </div>
  </main>

  <div id="profileEffectsModal"
    class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden flex items-center justify-center px-4">
    <div
      class="bg-discord-gray-800 max-w-4xl w-full p-6 rounded-lg shadow-xl animate-fadeIn max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-white">Profile Effects</h3>
        <button onclick="closeProfileEffectsModal()" class="text-discord-gray-400 hover:text-red-500">
          <i data-feather="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <h4 class="text-lg font-semibold mb-3 text-discord-gray-200">Avatar Effects</h4>
          <p class="text-xs text-discord-gray-400 mb-2">Choose how your avatar appears across Zylo.</p>
          <div class="space-y-3">
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="none" class="mr-3" checked>
              <span class="flex-1">None</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="none"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="glow" class="mr-3">
              <span class="flex-1">Neon Glow</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="glow"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="pulse" class="mr-3">
              <span class="flex-1">Soft Pulse</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="pulse"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="ring" class="mr-3">
              <span class="flex-1">Status Ring</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="ring"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="sparkle" class="mr-3">
              <span class="flex-1">Sparkle</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="sparkle"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="vintage" class="mr-3">
              <span class="flex-1">Vintage</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="vintage"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="neon-border" class="mr-3">
              <span class="flex-1">Neon Border</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="neon-border"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="gradient-border" class="mr-3">
              <span class="flex-1">Gradient Border</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="gradient-border">
              </div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="frosted" class="mr-3">
              <span class="flex-1">Frosted Glass</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="frosted"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="holographic" class="mr-3">
              <span class="flex-1">Holographic</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="holographic"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="matrix" class="mr-3">
              <span class="flex-1">Matrix Code</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="matrix"></div>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="avatarEffect" value="cyberpunk" class="mr-3">
              <span class="flex-1">Cyberpunk</span>
              <div class="w-10 h-10 rounded-full bg-discord-gray-600 preview-avatar" data-effect="cyberpunk"></div>
            </label>
          </div>
        </div>
        <div>
          <h4 class="text-lg font-semibold mb-3 text-discord-gray-200">Banner Effects</h4>
          <p class="text-xs text-discord-gray-400 mb-2">Stylize the banner behind your profile.</p>
          <div class="space-y-3">
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="none" class="mr-3" checked>
              <span class="flex-1">None</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="blur-overlay" class="mr-3">
              <span class="flex-1">Blur Overlay</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="gradient-overlay" class="mr-3">
              <span class="flex-1">Gradient Overlay</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="vignette" class="mr-3">
              <span class="flex-1">Vignette</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="neon-glow" class="mr-3">
              <span class="flex-1">Neon Glow</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="cyber-grid" class="mr-3">
              <span class="flex-1">Cyber Grid</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="holographic-banner" class="mr-3">
              <span class="flex-1">Holographic</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="matrix-banner" class="mr-3">
              <span class="flex-1">Matrix Stream</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="retro-wave" class="mr-3">
              <span class="flex-1">Retro Wave</span>
            </label>
            <label
              class="flex items-center p-3 border border-discord-gray-700 rounded-lg cursor-pointer hover:bg-discord-gray-700">
              <input type="radio" name="bannerEffect" value="neon-city" class="mr-3">
              <span class="flex-1">Neon City</span>
            </label>
          </div>
        </div>
      </div>
      <div class="flex gap-3 justify-end">
        <button onclick="closeProfileEffectsModal()"
          class="px-4 py-2 bg-discord-gray-600 hover:bg-discord-gray-500 text-white rounded-lg">Cancel</button>
        <button onclick="applyProfileEffects()"
          class="px-4 py-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded-lg">Apply Effects</button>
      </div>
    </div>
  </div>

  <div id="saveSettingsModal"
    class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden flex items-center justify-center px-4">
    <div class="bg-discord-gray-800 max-w-md w-full p-6 rounded-lg shadow-xl animate-fadeIn">
      <div class="flex items-center mb-4">
        <div class="flex-shrink-0">
          <i data-feather="save" class="w-6 h-6 text-discord-blurple"></i>
        </div>
        <div class="ml-3">
          <h3 class="text-lg font-semibold text-white">Save Settings</h3>
        </div>
      </div>
      <p class="text-sm text-discord-gray-300 mb-6">You have unsaved changes. Do you want to save your settings before
        continuing?</p>
      <div class="flex gap-3">
        <button onclick="confirmSaveSettings()"
          class="flex-1 bg-discord-blurple hover:bg-opacity-80 text-white py-2 px-4 rounded-lg">
          <i data-feather="save" class="w-4 h-4 inline mr-2"></i> Save Changes
        </button>
        <button onclick="discardSettingsChanges()"
          class="flex-1 bg-discord-gray-600 hover:bg-discord-gray-500 text-white py-2 px-4 rounded-lg">
          <i data-feather="x" class="w-4 h-4 inline mr-2"></i> Discard
        </button>
        <button onclick="cancelSaveSettings()"
          class="flex-1 bg-discord-gray-700 hover:bg-discord-gray-600 text-discord-gray-300 py-2 px-4 rounded-lg">
          <i data-feather="arrow-left" class="w-4 h-4 inline mr-2"></i> Cancel
        </button>
      </div>
    </div>
  </div>

  <div id="themeEditorOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden"></div>
  <div id="themeEditorModal"
    class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-[210] w-[95%] max-w-4xl h-[90vh] md:h-[80vh] overflow-hidden rounded-xl shadow-2xl hidden">
    <div class="bg-discord-gray-800 text-discord-gray-300 h-full flex flex-col">
      <div class="flex items-center justify-between px-4 py-3 border-b border-discord-gray-900">
        <h3 class="text-lg font-semibold text-white">Theme Editor</h3>
        <div class="flex items-center gap-2">
          <select id="savedThemesSelect"
            class="text-sm bg-discord-gray-700 border rounded px-2 py-1 border-discord-gray-900">
            <option value="">Select saved theme‚Ä¶</option>
          </select>
          <button id="saveThemeBtn" class="px-3 py-1 rounded bg-discord-blurple text-white text-sm">Save</button>
          <button id="deleteThemeBtn" class="px-3 py-1 rounded bg-red-600 text-white text-sm">Delete</button>
          <button id="closeThemeEditorBtn" class="px-2 py-1 rounded bg-discord-gray-700">‚úñ</button>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-4 md:p-6 te-scroll-container">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- Controls -->
          <div class="space-y-6">
            <div>
              <h4 class="text-sm font-bold text-discord-gray-400 uppercase mb-3">UI Colors</h4>
              <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                  <label class="text-xs font-semibold">Navbar Background</label>
                  <input type="color" id="teNavbarBg"
                    class="w-full h-10 rounded border border-discord-gray-900 bg-discord-gray-700 p-1">
                </div>
                <div class="space-y-2">
                  <label class="text-xs font-semibold">Sidebar Background</label>
                  <input type="color" id="teSidebarBg"
                    class="w-full h-10 rounded border border-discord-gray-900 bg-discord-gray-700 p-1">
                </div>
                <div class="space-y-2">
                  <label class="text-xs font-semibold">Panel Background</label>
                  <input type="color" id="tePanelBg"
                    class="w-full h-10 rounded border border-discord-gray-900 bg-discord-gray-700 p-1">
                </div>
                <div class="space-y-2">
                  <label class="text-xs font-semibold">Text Color</label>
                  <input type="color" id="teTextColor"
                    class="w-full h-10 rounded border border-discord-gray-900 bg-discord-gray-700 p-1">
                </div>
                <div class="space-y-2">
                  <label class="text-xs font-semibold">Accent Color</label>
                  <input type="color" id="teAccentColor"
                    class="w-full h-10 rounded border border-discord-gray-900 bg-discord-gray-700 p-1">
                </div>
                <div class="space-y-2">
                  <label class="text-xs font-semibold">Main Background</label>
                  <input type="color" id="teMainBg"
                    class="w-full h-10 rounded border border-discord-gray-900 bg-discord-gray-700 p-1">
                </div>
              </div>
            </div>

            <div>
              <h4 class="text-sm font-bold text-discord-gray-400 uppercase mb-3">Background Style</h4>
              <div class="flex gap-4 mb-4">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="teBgMode" value="solid" class="accent-discord-blurple"> Solid
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="teBgMode" value="gradient" checked class="accent-discord-blurple">
                  Gradient
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="teBgMode" value="image" class="accent-discord-blurple"> Image
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="teBgMode" value="animated" class="accent-discord-blurple"> Animated
                </label>
              </div>

              <!-- Solid Controls -->
              <div id="teSolidControls" class="hidden space-y-2">
                <label class="text-xs font-semibold">Background Color</label>
                <input type="color" id="teSolidColor"
                  class="w-full h-10 rounded border border-discord-gray-900 bg-discord-gray-700 p-1">
              </div>

              <!-- Gradient Controls -->
              <div id="teGradientControls" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                  <div class="space-y-2">
                    <label class="text-xs font-semibold">From</label>
                    <input type="color" id="teGradFrom" value="#1e293b"
                      class="w-full h-10 rounded border border-discord-gray-900 bg-discord-gray-700 p-1">
                  </div>
                  <div class="space-y-2">
                    <label class="text-xs font-semibold">To</label>
                    <input type="color" id="teGradTo" value="#0f172a"
                      class="w-full h-10 rounded border border-discord-gray-900 bg-discord-gray-700 p-1">
                  </div>
                </div>
                <div class="space-y-2">
                  <label class="text-xs font-semibold">Angle (deg)</label>
                  <input type="range" id="teGradAngle" min="0" max="360" value="135"
                    class="w-full accent-discord-blurple">
                </div>
              </div>

              <!-- Image Controls -->
              <div id="teImageControls" class="hidden space-y-4">
                <div class="flex items-center gap-3">
                  <input type="file" id="teBgImageInput" class="hidden" accept="image/*">
                  <button onclick="document.getElementById('teBgImageInput').click()"
                    class="flex-1 py-2 rounded bg-discord-gray-700 hover:bg-discord-gray-600 text-sm font-medium">Choose
                    Image</button>
                  <button id="teClearBgImageBtn"
                    class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-sm font-medium">Clear</button>
                </div>
              </div>

              <!-- Animated Controls -->
              <div id="teAnimatedControls" class="hidden space-y-3">
                <p class="text-xs text-discord-gray-400">Choose an animation preset:</p>
                <div class="flex flex-wrap gap-2">
                  <button data-anim="gradientShift"
                    class="px-3 py-1 rounded bg-discord-gray-700 hover:bg-discord-gray-600 text-xs active">Shift</button>
                  <button data-anim="floatingBubbles"
                    class="px-3 py-1 rounded bg-discord-gray-700 hover:bg-discord-gray-600 text-xs">Bubbles</button>
                  <button data-anim="starfield"
                    class="px-3 py-1 rounded bg-discord-gray-700 hover:bg-discord-gray-600 text-xs">Stars</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Preview -->
          <div class="flex flex-col">
            <h4 class="text-sm font-bold text-discord-gray-400 uppercase mb-3">Preview</h4>
            <div id="tePreview"
              class="flex-1 rounded-xl overflow-hidden border border-discord-gray-900 shadow-inner relative min-h-[300px]"
              style="background: linear-gradient(135deg, #1e293b, #0f172a);">
              <!-- Mock UI -->
              <div class="absolute top-3 left-3 right-3 h-6 rounded bg-discord-gray-900/50 backdrop-blur-sm"></div>
              <div class="absolute top-11 left-3 bottom-3 w-10 rounded bg-discord-gray-900/40 backdrop-blur-sm"></div>
              <div class="absolute top-11 left-15 right-3 bottom-3 p-3 space-y-2">
                <div class="h-4 w-3/4 rounded bg-discord-gray-600/50"></div>
                <div class="h-4 w-1/2 rounded bg-discord-gray-600/30"></div>
                <div class="h-20 w-full rounded bg-discord-gray-600/20 mt-4"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="p-4 bg-discord-gray-900 flex justify-between items-center gap-3">
        <div>
          <button id="teResetBtn"
            class="px-4 py-2 rounded-lg bg-red-600/20 hover:bg-red-600/40 text-red-500 text-sm font-medium transition border border-red-600/30">Reset
            to Default</button>
        </div>
        <div class="flex gap-3">
          <button id="teCancelBtn"
            class="px-6 py-2 rounded-lg bg-discord-gray-700 hover:bg-discord-gray-600 font-medium transition text-sm">Cancel</button>
          <button id="teApplyBgBtn"
            class="px-6 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-medium transition text-sm">Apply
            Background</button>
          <button id="teApplyThemeBtn"
            class="px-6 py-2 rounded-lg bg-discord-blurple hover:bg-opacity-80 text-white font-medium transition text-sm">Apply
            Full Theme</button>
        </div>
      </div>
    </div>
  </div>

  <div id="userViewModalOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[220] hidden"
    onclick="closeUserViewModal()"></div>
  <div id="userViewModal"
    class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-[230] w-[90%] max-w-sm rounded-xl overflow-hidden shadow-2xl hidden animate-pop">
    <div class="bg-discord-gray-800 text-discord-gray-300 flex flex-col">
      <div class="h-24 bg-discord-blurple relative">
        <img id="uvBanner" src="/images/default_banner.png" class="w-full h-full object-cover">
        <button onclick="closeUserViewModal()"
          class="absolute top-2 right-2 p-1 rounded-full bg-black/20 hover:bg-black/40 text-white transition">
          <i data-feather="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="px-4 pb-4 relative">
        <div class="relative -mt-12 mb-3">
          <img id="uvAvatar" src="/images/default_avatar.png"
            class="w-20 h-20 rounded-full border-4 border-discord-gray-800 bg-discord-gray-800 object-cover shadow-lg">
          <div id="uvStatus"
            class="absolute bottom-1 right-1 w-5 h-5 rounded-full border-4 border-discord-gray-800 bg-gray-500"></div>
        </div>
        <div class="space-y-1">
          <h3 id="uvUsername" class="text-xl font-bold text-white">Username</h3>
          <p id="uvUsertag" class="text-discord-gray-400 text-sm font-medium">@usertag</p>
        </div>
        <div class="mt-4 pt-4 border-t border-discord-gray-700">
          <h4 class="text-xs font-bold text-discord-gray-400 uppercase mb-2">About Me</h4>
          <p id="uvBio" class="text-sm text-discord-gray-200 line-clamp-3 italic">No bio shared.</p>
        </div>
        <div class="mt-4 flex gap-2">
          <button id="uvMessageBtn"
            class="flex-1 py-2 rounded bg-discord-blurple hover:bg-opacity-90 text-white text-sm font-bold transition">Message</button>
          <button id="uvProfileBtn" class="px-3 py-2 rounded bg-discord-gray-700 hover:bg-discord-gray-600 transition"
            title="View Full Profile">
            <i data-feather="user" class="w-4 h-4"></i>
          </button>
          <button id="uvQRBtn" onclick="showQRCode()"
            class="px-3 py-2 rounded bg-discord-gray-700 hover:bg-discord-gray-600 transition"
            title="Share via QR Code">
            <i data-feather="maximize" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Code Modal for Profile Sharing -->
  <div id="qrCodeModal"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[240] hidden flex items-center justify-center px-4">
    <div class="bg-discord-gray-800 text-discord-gray-300 w-full max-w-xs p-6 rounded-xl shadow-2xl text-center">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-white">Share Profile</h3>
        <button onclick="closeQRModal()" class="text-discord-gray-400 hover:text-red-500">
          <i data-feather="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div id="qrCodeContainer" class="bg-white p-4 rounded-lg mb-4 flex items-center justify-center">
        <!-- QR code will be generated here -->
        <div class="w-48 h-48 flex items-center justify-center text-gray-400">
          <i data-feather="loader" class="w-8 h-8 animate-spin"></i>
        </div>
      </div>
      <p id="qrCodeUsername" class="text-sm text-discord-gray-400 mb-3">@username</p>
      <p class="text-xs text-discord-gray-500">Scan this QR code to view profile</p>
      <button onclick="copyProfileLink()"
        class="mt-3 w-full py-2 bg-discord-blurple hover:bg-opacity-90 text-white rounded-lg text-sm font-medium transition">
        <i data-feather="copy" class="w-4 h-4 inline mr-2"></i>Copy Link
      </button>
    </div>
  </div>

  <div id="groupsModal"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center px-4">
    <div class="bg-discord-gray-800 text-discord-gray-300 w-full max-w-md p-6 rounded-xl shadow-2xl flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-white">Add a Group</h3>
        <button onclick="closeGroupsModal()" class="text-discord-gray-400 hover:text-red-500">
          <i data-feather="x" class="w-6 h-6"></i>
        </button>
      </div>

      <!-- Tabs -->
      <div class="flex border-b border-discord-gray-700 mb-4">
        <button id="createGroupTab" onclick="switchGroupModalTab('create')"
          class="flex-1 px-4 py-2 text-white border-b-2 border-discord-blurple font-medium">
          Create Group
        </button>
        <button id="joinGroupTab" onclick="switchGroupModalTab('join')"
          class="flex-1 px-4 py-2 text-discord-gray-400 hover:text-white font-medium">
          Join Group
        </button>
      </div>

      <!-- Create Group Form -->
      <div id="createGroupForm" class="space-y-4">
        <div class="flex flex-col items-center justify-center mb-4">
          <div class="relative w-24 h-24">
            <div id="groupIconPreview"
              class="w-full h-full rounded-full bg-discord-gray-700 border-2 border-dashed border-discord-gray-500 flex items-center justify-center cursor-pointer hover:border-discord-blurple overflow-hidden"
              onclick="document.getElementById('newGroupIconInput').click()">
              <i data-feather="camera" class="text-discord-gray-400"></i>
            </div>
            <input type="file" id="newGroupIconInput" class="hidden" accept="image/*"
              onchange="previewGroupIcon(event)">
          </div>
          <p class="text-xs text-discord-gray-400 mt-2">Upload Icon</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-discord-gray-300 mb-2">Group Name</label>
          <input type="text" id="newGroupNameInput" placeholder="My Awesome Group"
            class="w-full p-3 rounded-lg bg-discord-gray-700 border border-discord-gray-600 text-white focus:border-discord-blurple focus:outline-none">
        </div>
        <div>
          <label class="block text-sm font-medium text-discord-gray-300 mb-2">Description (Optional)</label>
          <textarea id="newGroupDescInput" placeholder="What's your group about?" rows="3"
            class="w-full p-3 rounded-lg bg-discord-gray-700 border border-discord-gray-600 text-white focus:border-discord-blurple focus:outline-none resize-none"></textarea>
        </div>
        <button onclick="createNewGroup()"
          class="w-full bg-discord-blurple hover:bg-opacity-80 text-white font-medium py-3 rounded-lg transition">
          Create Group
        </button>
      </div>

      <!-- Join Group Form -->
      <div id="joinGroupForm" class="hidden space-y-4">
        <div>
          <label class="block text-sm font-medium text-discord-gray-300 mb-2">Group ID or Invite Code</label>
          <input type="text" id="joinGroupIdInput" placeholder="Enter group ID..."
            class="w-full p-3 rounded-lg bg-discord-gray-700 border border-discord-gray-600 text-white focus:border-discord-blurple focus:outline-none">
        </div>
        <button onclick="joinExistingGroup()"
          class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-lg transition">
          Join Group
        </button>
      </div>
    </div>
  </div>

  <!-- Group Settings Modal -->
  <div id="groupSettingsModal"
    class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50 animate-fadeIn">
    <div class="bg-discord-gray-800 w-full max-w-2xl rounded-lg shadow-2xl flex flex-col h-[600px] overflow-hidden">
      <!-- Sidebar / Tabs -->
      <div class="flex h-full">
        <div class="w-48 bg-discord-gray-900 p-4 space-y-1">
          <div class="text-xs font-bold text-discord-gray-400 uppercase px-2 mb-2">Server Settings</div>
          <button onclick="switchSettingsTab('overview')" id="tabBtn-overview"
            class="settings-tab-btn active">Overview</button>
          <button onclick="switchSettingsTab('channels')" id="tabBtn-channels"
            class="settings-tab-btn">Channels</button>
          <button onclick="switchSettingsTab('invites')" id="tabBtn-invites" class="settings-tab-btn">Invites</button>
          <div class="mt-4 pt-4 border-t border-discord-gray-800">
            <button onclick="deleteGroup()"
              class="w-full text-left px-2 py-1.5 rounded text-red-500 hover:bg-red-500/10 transition text-sm font-medium">Delete
              Server</button>
          </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col bg-discord-gray-700">
          <div class="flex justify-between items-center p-4 border-b border-discord-gray-900">
            <h3 id="settingsTabTitle" class="text-white font-bold">Server Overview</h3>
            <button onclick="closeGroupSettings()" class="text-discord-gray-400 hover:text-white transition">
              <i data-feather="x" class="w-6 h-6"></i>
            </button>
          </div>

          <div class="flex-1 overflow-y-auto p-6">
            <!-- Overview Section -->
            <div id="settings-overview" class="settings-section space-y-6">
              <div class="flex items-center gap-4">
                <div class="relative w-24 h-24 group cursor-pointer"
                  onclick="document.getElementById('editGroupIconInput').click()">
                  <div id="editGroupIconPreview"
                    class="w-full h-full rounded-full bg-discord-gray-600 flex items-center justify-center overflow-hidden border-2 border-transparent hover:border-discord-blurple transition">
                    <span class="text-white text-2xl font-bold" id="editGroupIconInitial">G</span>
                  </div>
                  <div
                    class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 rounded-full transition">
                    <span class="text-white text-[10px] font-bold">CHANGE ICON</span>
                  </div>
                  <input type="file" id="editGroupIconInput" class="hidden" accept="image/*"
                    onchange="previewEditGroupIcon(event)">
                </div>
                <div class="flex-1">
                  <p class="text-xs text-discord-gray-400 mb-2">We recommend an image of at least 512x512 for the
                    server.</p>
                </div>
              </div>

              <div>
                <label class="block text-xs font-bold text-discord-gray-400 uppercase mb-2">Server Name</label>
                <input type="text" id="editGroupName"
                  class="w-full bg-discord-gray-900 border-none rounded p-2 text-white focus:ring-1 focus:ring-discord-blurple">
              </div>

              <div>
                <label class="block text-xs font-bold text-discord-gray-400 uppercase mb-2">Description</label>
                <textarea id="editGroupDesc" rows="3"
                  class="w-full bg-discord-gray-900 border-none rounded p-2 text-white focus:ring-1 focus:ring-discord-blurple resize-none"></textarea>
              </div>
            </div>

            <!-- Channels Section -->
            <div id="settings-channels" class="settings-section hidden space-y-4">
              <div class="flex justify-between items-center">
                <h4 class="text-sm font-bold text-white uppercase">Server Channels</h4>
                <button onclick="showCreateChannelInput()"
                  class="text-xs bg-discord-blurple hover:bg-opacity-80 text-white px-2 py-1 rounded transition">Create
                  Channel</button>
              </div>

              <div id="createChannelInputArea" class="hidden p-3 bg-discord-gray-900 rounded-lg space-y-3">
                <input type="text" id="newChannelName" placeholder="new-channel"
                  class="w-full bg-discord-gray-700 border-none rounded text-sm p-2 text-white">
                <div class="flex gap-2">
                  <button onclick="confirmCreateChannel('text')"
                    class="flex-1 bg-discord-blurple py-1.5 rounded text-xs text-white"># Text</button>
                  <button onclick="confirmCreateChannel('voice')"
                    class="flex-1 bg-discord-gray-600 py-1.5 rounded text-xs text-white">üîä Voice</button>
                  <button onclick="hideCreateChannelInput()"
                    class="px-3 bg-discord-gray-800 rounded text-xs text-white">Cancel</button>
                </div>
              </div>

              <div id="settingsChannelList" class="space-y-1">
                <!-- Channels here -->
              </div>
            </div>

            <!-- Invites Section -->
            <div id="settings-invites" class="settings-section hidden space-y-6">
              <div class="p-4 bg-discord-gray-900 rounded-lg border border-discord-gray-600/30">
                <label class="block text-xs font-bold text-discord-gray-400 uppercase mb-2">Invite Code</label>
                <div class="flex gap-2">
                  <input type="text" id="inviteCodeInput" readonly
                    class="flex-1 bg-discord-gray-700 border-none rounded p-2 text-white font-mono text-sm">
                  <button onclick="copyInviteCode()"
                    class="bg-discord-blurple hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium transition">Copy</button>
                </div>
                <p class="text-[11px] text-discord-gray-400 mt-2">Share this code with your friends to let them join
                  your server!</p>
              </div>
            </div>
          </div>

          <!-- Save Footer -->
          <div id="settingsModalFooter" class="p-4 bg-discord-gray-900 flex justify-end">
            <button onclick="saveGroupSettings()"
              class="bg-discord-blurple hover:bg-opacity-90 text-white px-8 py-2 rounded font-medium shadow-lg transition">Save
              Changes</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/files/vendor/socket.io.min.js"></script>
  <script src="/js/app-extras.js"></script>
  <script>

    // Chat Functions (Socket.IO, etc. - Kept as is)
    const baseUrl = window.location.origin;
    const socket = navigator.onLine ? io(baseUrl) : { emit: function () { }, on: function () { }, off: function () { } };
    window.socket = socket;
    if (navigator.onLine) {
      socket.on('connect', () => {
        const u = localStorage.getItem('savedUsername');
        if (u) socket.emit('join_user', { username: u });
      });
    }
    const chatInput = document.getElementById("chatInput");
    const chatMessagesCommunity = document.getElementById("chatMessagesCommunity");
    const chatMessagesAI = document.getElementById("chatMessagesAI");
    const aiControls = document.getElementById("aiControls");
    const aiModelSelect = document.getElementById("aiModelSelect");
    const aiPersonaSelect = document.getElementById("aiPersonaSelect");
    let currentChatRoom = localStorage.getItem('chatRoom') || 'community';
    let aiConversation = [];
    const username = localStorage.getItem("savedUsername") || "N/A";
    const email = localStorage.getItem("savedEmail") || "N/A";
    const typingIndicator = document.getElementById("typingIndicator");
    const activeTypers = new Set();
    const avatarCache = new Map();

    // Function to get avatar URL (Kept as is)
    async function getUserAvatarUrl(username) {
      if (!username || username === 'N/A') return '/images/default_avatar.png';
      if (avatarCache.has(username)) {
        return avatarCache.get(username);
      }
      try {
        if (navigator.onLine) {
          const res = await fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`);
          if (res.ok) {
            const data = await res.json();
            if (data.success && data.user && data.user.avatar) {
              const avatarUrl = data.user.avatar;
              avatarCache.set(username, avatarUrl);
              return avatarUrl;
            }
          }
        }
      } catch (e) {
        console.log('Failed to fetch avatar for', username, e);
      }
      const fallbackUrl = `/uploads/${username}/avatar.png`;
      avatarCache.set(username, fallbackUrl);
      return fallbackUrl;
    }

    // Friends & Groups state (Kept as is)
    let friendsState = { friends: [], incoming: [], outgoing: [] };
    let groupsData = [];
    let currentGroupId = null;
    let activeChannelId = 'general';

    // Chat input listeners (Kept as is)
    chatInput.addEventListener("input", () => {
      if (navigator.onLine && currentChatRoom === 'community') {
        socket.emit("typing", { username });
      }
    });
    chatInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        if (event.shiftKey) {
          event.preventDefault();
          const start = this.selectionStart;
          const end = this.selectionEnd;
          const value = this.value;
          this.value = value.substring(0, start) + "\n" + value.substring(end);
          this.selectionStart = this.selectionEnd = start + 1;
        } else {
          event.preventDefault();
          sendMessage();
        }
      }
    });
    chatInput.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = (this.scrollHeight > 150 ? 150 : this.scrollHeight) + "px"; // Add max-height
    });

    // Register user for DM rooms
    if (navigator.onLine && username && username !== 'N/A') {
      try { socket.emit('register_user', { username }); } catch { }
    }

    // Global Markdown Parser (extracted for reuse)
    window.parseDiscordMarkdown = function (text) {
      if (!text) return '';
      // 1. Escape HTML first to prevent XSS (critical)
      let parsed = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // Headers (H1-H3)
      parsed = parsed.replace(/^#\s+(.+)$/gm, '<h1 class="text-3xl font-bold text-white mb-2 border-b border-gray-700 pb-1">$1</h1>');
      parsed = parsed.replace(/^##\s+(.+)$/gm, '<h2 class="text-2xl font-bold text-white mb-2">$1</h2>');
      parsed = parsed.replace(/^###\s+(.+)$/gm, '<h3 class="text-xl font-bold text-white mb-1">$1</h3>');

      // 2. Code blocks with Syntax Highlighting
      if (typeof hljs !== 'undefined') {
        parsed = parsed.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
          const validLang = lang && hljs.getLanguage(lang) ? lang : 'plaintext';
          try {
            const highlighted = hljs.highlight(code, { language: validLang }).value;
            return `<pre><code class="hljs language-${validLang} rounded p-2 text-sm my-2 block overflow-x-auto">${highlighted}</code></pre>`;
          } catch (e) {
            return `<pre><code class="bg-discord-gray-900 rounded p-2 text-sm my-2 block overflow-x-auto">${code}</code></pre>`;
          }
        });
      } else {
        parsed = parsed.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="bg-discord-gray-900 rounded p-2 text-sm my-2 block overflow-x-auto">$2</code></pre>');
      }

      // Fallback for ```code``` (no newline)
      parsed = parsed.replace(/```([^`]+)```/g, '<code class="block bg-discord-gray-900 rounded p-2 text-sm font-mono my-1 whitespace-pre-wrap">$1</code>');

      // 3. Inline code `code`
      parsed = parsed.replace(/`([^`]+)`/g, '<code class="bg-discord-gray-900 text-discord-gray-100 rounded px-1.5 py-0.5 text-sm font-mono">$1</code>');

      // Bold **text**
      parsed = parsed.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      // Italic *text*
      parsed = parsed.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      // Strikethrough ~~text~~
      parsed = parsed.replace(/~~([^~]+)~~/g, '<del class="opacity-60">$1</del>');
      // Spoiler ||text||
      parsed = parsed.replace(/\|\|([^|]+)\|\|/g, '<span class="spoiler bg-discord-gray-400 text-discord-gray-400 hover:bg-transparent hover:text-white rounded px-1 cursor-pointer transition-all" onclick="this.classList.toggle(\'revealed\')">$1</span>');

      return parsed;
    };

    // === NEW MESSAGE RENDERING FUNCTION ===
    // This helper creates the new Discord-style message layout
    async function createDiscordMessage(data) {
      const msgWrapper = document.createElement("div");
      // Add message ID for deduplication
      if (data.id) msgWrapper.setAttribute('data-msg-id', data.id);
      // Important: Add timestamp for finding message during updates
      if (data.timestamp || data.ts) msgWrapper.setAttribute('data-timestamp', data.timestamp || data.ts);

      msgWrapper.classList.add("flex", "flex-col", "p-2", "rounded", "hover:bg-discord-gray-600/20", "leading-snug", "group", "relative");

      const messageRow = document.createElement("div");
      messageRow.className = "flex items-start gap-3 relative w-full";

      // Actions (Reply / Edit)
      const actions = document.createElement("div");
      actions.className = "absolute right-4 -top-4 hidden group-hover:flex bg-discord-gray-900 rounded border border-discord-gray-800 shadow-sm z-20 scale-90 p-0.5";

      const replyBtn = document.createElement("button");
      replyBtn.className = "p-1 px-2 hover:bg-discord-gray-700 text-discord-gray-400 hover:text-white rounded-l transition";
      replyBtn.title = "Reply";
      replyBtn.onclick = () => startReply(data.id || Date.now(), data.username || data.from, data.message || '');
      replyBtn.innerHTML = '<i data-feather="corner-up-left" class="w-4 h-4"></i>';

      const editBtn = document.createElement("button");
      editBtn.className = "p-1 px-2 hover:bg-discord-gray-700 text-discord-gray-400 hover:text-white rounded-r transition";
      editBtn.title = "Edit";
      editBtn.innerHTML = '<i data-feather="edit-2" class="w-4 h-4"></i>';

      // Only allow editing own messages
      const currentUser = localStorage.getItem('savedUsername') || 'User';
      const msgAuthor = data.username || data.from;
      const isOwnMessage = (currentUser === msgAuthor);

      if (!isOwnMessage) {
        editBtn.classList.add('opacity-30', 'cursor-not-allowed');
        editBtn.title = "Can only edit your own messages";
        editBtn.onclick = null;
      } else {
        editBtn.onclick = async () => {
          const newT = prompt("Edit message:", data.message);
          if (newT && newT !== data.message) {
            // Optimistic UI update - target the message body specifically
            const bodyEl = msgWrapper.querySelector('.msg-body-text');
            if (bodyEl) {
              bodyEl.textContent = newT;
              // Add edited indicator
              const editedSpan = document.createElement('span');
              editedSpan.className = 'text-discord-gray-400 text-xs ml-1 italic';
              editedSpan.textContent = '(edited)';
              bodyEl.appendChild(editedSpan);
            }

            // Call backend API to persist the edit
            try {
              const payload = {
                groupId: currentGroupId,
                channel: activeChannelId || 'general',
                username: currentUser,
                timestamp: data.timestamp || data.ts,
                newMessage: newT
              };

              // Only call API for group messages (if in group context)
              if (currentGroupId) {
                const res = await fetch('/api/groups/message/edit', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
                const result = await res.json();
                if (!result.success) {
                  console.error('Edit failed:', result.error);
                  alert("Edit failed: " + result.error);
                }
              }
            } catch (error) {
              console.error('Error editing message:', error);
            }
          }
        };
      }

      actions.appendChild(replyBtn);

      // Discord-style Quick Reactions - inline emoji buttons
      const quickReactions = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ'];
      quickReactions.forEach(emoji => {
        const emojiBtn = document.createElement("button");
        emojiBtn.className = "p-1 hover:bg-discord-gray-700 text-discord-gray-400 hover:text-white transition text-sm hover:scale-110";
        emojiBtn.textContent = emoji;
        emojiBtn.title = `React with ${emoji}`;
        emojiBtn.onclick = (e) => {
          e.stopPropagation();
          addReactionToMessage(msgWrapper, emoji, data);
        };
        actions.appendChild(emojiBtn);
      });

      // More reactions button (shows full picker)
      const moreReactBtn = document.createElement("button");
      moreReactBtn.className = "p-1 px-2 hover:bg-discord-gray-700 text-discord-gray-400 hover:text-white transition relative";
      moreReactBtn.title = "More Reactions";
      moreReactBtn.innerHTML = '<i data-feather="plus" class="w-3 h-3"></i>';

      // Full reaction picker popup - fixed positioning
      const reactionPicker = document.createElement("div");
      reactionPicker.className = "reaction-picker hidden";
      reactionPicker.style.cssText = "position: absolute; bottom: 100%; right: 0; margin-bottom: 4px; background: #2f3136; border-radius: 8px; border: 1px solid #202225; padding: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 100; min-width: 200px;";

      const pickerGrid = document.createElement("div");
      pickerGrid.style.cssText = "display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px;";

      const emojis = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò°', 'üéâ', 'üî•', 'üëÄ', 'üíØ', '‚úÖ', '‚ùå'];
      emojis.forEach(emoji => {
        const btn = document.createElement("button");
        btn.className = "reaction-emoji";
        btn.style.cssText = "font-size: 20px; padding: 4px; border-radius: 4px; background: transparent; border: none; cursor: pointer; transition: transform 0.1s, background 0.1s;";
        btn.textContent = emoji;
        btn.dataset.emoji = emoji;
        btn.onmouseover = () => { btn.style.background = '#40444b'; btn.style.transform = 'scale(1.2)'; };
        btn.onmouseout = () => { btn.style.background = 'transparent'; btn.style.transform = 'scale(1)'; };
        btn.onclick = (e) => {
          e.stopPropagation();
          addReactionToMessage(msgWrapper, emoji, data);
          reactionPicker.classList.add('hidden');
        };
        pickerGrid.appendChild(btn);
      });

      reactionPicker.appendChild(pickerGrid);

      moreReactBtn.onclick = (e) => {
        e.stopPropagation();
        // Close all other pickers first
        document.querySelectorAll('.reaction-picker-open').forEach(p => p.classList.add('hidden'));
        reactionPicker.classList.toggle('hidden');
        if (!reactionPicker.classList.contains('hidden')) {
          reactionPicker.classList.add('reaction-picker-open');
        }
      };

      moreReactBtn.appendChild(reactionPicker);
      actions.appendChild(moreReactBtn);
      actions.appendChild(editBtn);

      // Delete Button (only for own messages)
      if (isOwnMessage) {
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "p-1 px-2 hover:bg-red-500/20 text-discord-gray-400 hover:text-red-400 transition";
        deleteBtn.title = "Delete Message";
        deleteBtn.innerHTML = '<i data-feather="trash-2" class="w-4 h-4"></i>';
        deleteBtn.onclick = async () => {
          if (confirm('Are you sure you want to delete this message?')) {
            // Optimistic removal
            msgWrapper.remove();

            // Send to backend
            try {
              if (currentGroupId) {
                await fetch('/api/groups/message/delete', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    groupId: currentGroupId,
                    channel: activeChannelId || 'general',
                    timestamp: data.timestamp,
                    username: username
                  })
                });
              }
            } catch (err) {
              console.error('Failed to delete message:', err);
              // Ideally revert UI change here if needed
            }
          }
        };
        actions.appendChild(deleteBtn);
      }
      messageRow.appendChild(actions);



      // Render Reply Context (Discord-style with message preview)
      // Render Reply Context (Discord-style with spine)
      if (data.replyTo) {
        const replyContainer = document.createElement("div");
        replyContainer.className = "flex items-center mb-0.5 cursor-pointer opacity-80 hover:opacity-100";

        replyContainer.onclick = (e) => {
          e.stopPropagation();
          const targetId = data.replyTo.id;
          if (targetId) {
            const original = document.querySelector(`[data-msg-id="${targetId}"]`);
            if (original) {
              original.scrollIntoView({ behavior: 'smooth', block: 'center' });
              original.classList.add('bg-discord-blurple/30', 'transition-all');
              setTimeout(() => original.classList.remove('bg-discord-blurple/30'), 1500);
            }
          }
        };

        // Spine (Curved Line)
        const spine = document.createElement("div");
        spine.className = "w-8 h-3 border-l-2 border-t-2 border-discord-gray-600 rounded-tl-md ml-4 mt-2 mr-2 flex-shrink-0";
        replyContainer.appendChild(spine);

        const replyContent = document.createElement("div");
        replyContent.className = "flex items-center gap-1 text-xs text-discord-gray-300 overflow-hidden";

        const rAvatar = document.createElement("img");
        rAvatar.src = "/images/default_avatar.png";
        rAvatar.className = "w-4 h-4 rounded-full reply-avatar object-cover flex-shrink-0";
        replyContent.appendChild(rAvatar);

        const rUser = document.createElement("span");
        rUser.className = "font-semibold hover:underline bg-transparent text-discord-gray-200";
        rUser.textContent = "@" + (data.replyTo.username || "User");
        replyContent.appendChild(rUser);

        const rText = document.createElement("span");
        rText.className = "text-discord-gray-400 truncate max-w-[300px] hover:text-white transition-colors";
        const rTxt = data.replyTo.content || data.replyTo.message || '';
        rText.textContent = rTxt;
        replyContent.appendChild(rText);

        replyContainer.appendChild(replyContent);

        if (data.replyTo.username) {
          getUserAvatarUrl(data.replyTo.username).then(url => {
            rAvatar.src = url;
          });
        }

        msgWrapper.appendChild(replyContainer); // Append first
      }

      const avatar = document.createElement("img");
      const fallbackAvatar = '/images/default_avatar.png';
      const avatarUrl = await getUserAvatarUrl(data.username || data.from);
      avatar.src = avatarUrl;
      avatar.alt = `${data.username || data.from}'s avatar`;
      avatar.className = "w-10 h-10 rounded-full object-cover cursor-pointer"; // Added cursor-pointer
      avatar.onerror = function () { this.onerror = null; this.src = fallbackAvatar; };
      const tUname = data.username || data.from;
      avatar.onclick = () => showUserProfile(tUname);
      messageRow.appendChild(avatar);

      const contentWrapper = document.createElement("div");

      const header = document.createElement("div");
      header.className = "flex items-baseline gap-2";
      const userSpan = document.createElement("span");

      // Role-based color styling
      const roleColorMap = {
        'admin': 'text-red-500',
        'mod': 'text-purple-500',
        'moderator': 'text-purple-500',
        'vip': 'text-yellow-400',
        'user': 'text-white'
      };

      // Try to get cached role or default to white
      let roleColor = 'text-white';
      let roleTitle = '';
      try {
        const cachedUser = avatarCache.get(tUname + '_role');
        if (cachedUser) {
          roleColor = roleColorMap[cachedUser.toLowerCase()] || 'text-white';
          roleTitle = cachedUser;
        } else {
          // Async fetch role (non-blocking)
          fetch(`/api/get-user?identifier=${encodeURIComponent(tUname)}`)
            .then(r => r.json())
            .then(d => {
              if (d.success && d.user && d.user.role) {
                avatarCache.set(tUname + '_role', d.user.role);
                const color = roleColorMap[d.user.role.toLowerCase()] || 'text-white';
                userSpan.className = `${color} font-semibold cursor-pointer hover:underline`;
                if (d.user.role !== 'user') {
                  userSpan.title = d.user.role.charAt(0).toUpperCase() + d.user.role.slice(1);
                }
              }
            })
            .catch(() => { });
        }
      } catch { }

      userSpan.className = `${roleColor} font-semibold cursor-pointer hover:underline`;
      if (roleTitle && roleTitle !== 'user') {
        userSpan.title = roleTitle.charAt(0).toUpperCase() + roleTitle.slice(1);
      }
      userSpan.textContent = tUname;
      userSpan.onclick = () => showUserProfile(tUname);
      const timeSpan = document.createElement("span");
      timeSpan.className = "text-discord-gray-400 text-xs";
      timeSpan.textContent = new Date(data.ts ? data.ts * 1000 : Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      header.appendChild(userSpan);
      header.appendChild(timeSpan);

      // Status Indicator (Sent/Read)
      const statusSpan = document.createElement("span");
      statusSpan.className = "ml-1 text-xs select-none";
      // Logic: If readBy > 1 (meaning someone else than author read it), show blue double check.
      // Else show single gray check.
      const readBy = data.readBy || [];
      const isRead = readBy.length > 1; // Assuming author is always in readBy once sent/viewed? Or just check length.

      if (isRead) {
        statusSpan.innerHTML = '<span class="text-blue-400" title="Read">‚úì‚úì</span>';
      } else {
        statusSpan.innerHTML = '<span class="text-discord-gray-500" title="Sent">‚úì</span>';
      }
      header.appendChild(statusSpan);

      contentWrapper.appendChild(header);

      // Body (text OR file)
      if (data.fileData && data.fileName) {
        const ext = data.fileName.split(".").pop().toLowerCase();
        const imageExts = ["png", "jpg", "jpeg", "gif", "webp", "svg"];
        const videoExts = ["mp4", "webm", "ogg", "mov", "m4v"];
        const audioExts = ["mp3", "wav", "ogg", "m4a", "aac", "flac", "webm"];

        let body;
        if (imageExts.includes(ext)) {
          body = document.createElement("img");
          body.src = data.fileData;
          body.alt = data.fileName;
          body.className = "max-w-xs rounded shadow-md cursor-pointer mt-1";
        } else if (videoExts.includes(ext)) {
          body = document.createElement("video");
          body.controls = true;
          body.src = data.fileData;
          body.className = "max-w-xs rounded mt-1";
        } else if (audioExts.includes(ext) || data.type === 'voice') {
          // Voice message with styled player
          body = document.createElement("div");
          body.className = "voice-message-player flex items-center gap-2 bg-discord-gray-700/50 rounded-lg p-2 mt-1 max-w-xs";

          const playBtn = document.createElement("button");
          playBtn.className = "w-10 h-10 rounded-full bg-discord-blurple hover:bg-discord-blurple/80 flex items-center justify-center text-white transition";
          playBtn.innerHTML = '<i data-feather="play" class="w-5 h-5"></i>';

          const audioEl = document.createElement("audio");
          audioEl.src = data.fileData;
          audioEl.preload = "metadata";

          const waveform = document.createElement("div");
          waveform.className = "flex-1 flex items-center gap-0.5 h-8";
          // Create waveform bars (decorative)
          for (let i = 0; i < 20; i++) {
            const bar = document.createElement("div");
            bar.className = "w-1 bg-discord-gray-400 rounded-full transition-all";
            bar.style.height = `${Math.random() * 20 + 8}px`;
            waveform.appendChild(bar);
          }

          const durationSpan = document.createElement("span");
          durationSpan.className = "text-xs text-discord-gray-300 min-w-[32px]";
          durationSpan.textContent = data.duration ? `0:${String(data.duration).padStart(2, '0')}` : "0:00";

          let isPlaying = false;
          playBtn.onclick = () => {
            if (isPlaying) {
              audioEl.pause();
              playBtn.innerHTML = '<i data-feather="play" class="w-5 h-5"></i>';
            } else {
              audioEl.play();
              playBtn.innerHTML = '<i data-feather="pause" class="w-5 h-5"></i>';
            }
            isPlaying = !isPlaying;
            feather.replace();
          };

          audioEl.onended = () => {
            isPlaying = false;
            playBtn.innerHTML = '<i data-feather="play" class="w-5 h-5"></i>';
            feather.replace();
          };

          body.appendChild(playBtn);
          body.appendChild(waveform);
          body.appendChild(durationSpan);
        } else {
          body = document.createElement("a");
          body.href = data.fileData;
          body.download = data.fileName;
          body.textContent = `üìé ${data.fileName}`;
          body.className = "text-blue-400 hover:underline mt-1 block";
        }
        contentWrapper.appendChild(body);
      } else if (data.sticker_src) {
        // Modern sticker handling (saved with src)
        const body = document.createElement("div");
        body.className = "sticker-message mt-1";
        const img = document.createElement("img");
        img.src = data.sticker_src;
        img.alt = "Sticker";
        img.className = "sticker-img w-32 h-32 object-contain";
        body.appendChild(img);
        contentWrapper.appendChild(body);
      } else if (data.message && data.message.match(/^\[sticker:(.+)\]$/)) {
        // Fallback for legacy messages (saved as text)
        const stickerId = data.message.match(/^\[sticker:(.+)\]$/)[1];
        let src = '';
        // Try to find in global AVAILABLE_STICKERS if defined
        if (typeof AVAILABLE_STICKERS !== 'undefined') {
          const s = AVAILABLE_STICKERS.find(x => x.id === stickerId);
          if (s) src = s.src;
        }

        if (src) {
          const body = document.createElement("div");
          body.className = "sticker-message mt-1";
          const img = document.createElement("img");
          img.src = src;
          img.alt = "Sticker";
          img.className = "sticker-img w-32 h-32 object-contain";
          body.appendChild(img);
          contentWrapper.appendChild(body);
        } else {
          // If we really can't find it, show text
          const body = document.createElement("div");
          body.className = "text-white italic opacity-50";
          body.textContent = `[Sticker: ${stickerId}]`;
        }
      } else if (data.message) {
        const body = document.createElement("div");
        body.className = "text-white msg-body-text whitespace-pre-wrap";

        // Discord-style markdown parsing with Syntax Highlighting
        function parseMarkdown(text) {
          // 1. Escape HTML first to prevent XSS (critical)
          let parsed = text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');


          // Headers (H1-H3) - Support for big text
          parsed = parsed.replace(/^#\s+(.+)$/gm, '<h1 class="text-3xl font-bold text-white mb-2 border-b border-gray-700 pb-1">$1</h1>');
          parsed = parsed.replace(/^##\s+(.+)$/gm, '<h2 class="text-2xl font-bold text-white mb-2">$1</h2>');
          parsed = parsed.replace(/^###\s+(.+)$/gm, '<h3 class="text-xl font-bold text-white mb-1">$1</h3>');

          // 2. Code blocks with Syntax Highlighting
          parsed = parsed.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
            const validLang = lang && hljs.getLanguage(lang) ? lang : 'plaintext';
            try {
              const highlighted = hljs.highlight(code, { language: validLang }).value;
              return `<pre><code class="hljs language-${validLang} rounded p-2 text-sm my-2 block overflow-x-auto">${highlighted}</code></pre>`;
            } catch (e) {
              return `<pre><code class="bg-discord-gray-900 rounded p-2 text-sm my-2 block overflow-x-auto">${code}</code></pre>`;
            }
          });

          // Fallback for ```code``` (no newline)
          parsed = parsed.replace(/```([^`]+)```/g, '<code class="block bg-discord-gray-900 rounded p-2 text-sm font-mono my-1 whitespace-pre-wrap">$1</code>');

          // 3. Inline code `code`
          parsed = parsed.replace(/`([^`]+)`/g, '<code class="bg-discord-gray-900 text-discord-gray-100 rounded px-1.5 py-0.5 text-sm font-mono">$1</code>');


          // Bold **text**
          parsed = parsed.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

          // Italic *text*
          parsed = parsed.replace(/\*([^*]+)\*/g, '<em>$1</em>');

          // Strikethrough ~~text~~
          parsed = parsed.replace(/~~([^~]+)~~/g, '<del class="opacity-60">$1</del>');

          // Spoiler ||text||
          parsed = parsed.replace(/\|\|([^|]+)\|\|/g, '<span class="spoiler bg-discord-gray-400 text-discord-gray-400 hover:bg-transparent hover:text-white rounded px-1 cursor-pointer transition-all" onclick="this.classList.toggle(\'revealed\')">$1</span>');

          return parsed;
        }

        // URL detection regex
        const urlRegex = /(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/gi;
        let message = data.message;
        const urls = message.match(urlRegex) || [];

        // Parse markdown first
        message = parseMarkdown(message);

        // Then make URLs clickable (after markdown to avoid breaking links)
        if (urls.length > 0) {
          urls.forEach(url => {
            const escapedUrl = url.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            message = message.replace(
              escapedUrl,
              `<a href="${url}" target="_blank" class="text-blue-400 hover:underline">${escapedUrl}</a>`
            );
          });
        }

        body.innerHTML = message;

        // Add (edited) indicator if message was edited - now clickable!
        if (data.edited) {
          const editedSpan = document.createElement("span");
          editedSpan.className = "text-discord-gray-400 text-xs ml-1 italic cursor-pointer hover:underline hover:text-white transition-colors select-none";
          editedSpan.textContent = "(edited)";
          editedSpan.title = "View edit history";
          editedSpan.onclick = (e) => {
            e.stopPropagation();
            showEditHistory(data.history || [], data.message, data.editedAt);
          };
          body.appendChild(editedSpan);
        }

        contentWrapper.appendChild(body);

        // Create embed cards for URLs
        for (const url of urls.slice(0, 3)) { // Max 3 embeds per message
          const embedCard = document.createElement("div");
          embedCard.className = "link-embed mt-2 p-3 bg-discord-gray-900/60 border-l-4 border-discord-blurple rounded max-w-md";
          embedCard.innerHTML = `
            <div class="link-embed-loading text-xs text-discord-gray-400">
              <i class="animate-pulse">Loading preview...</i>
            </div>
          `;
          contentWrapper.appendChild(embedCard);

          // Async fetch preview data
          try {
            const hostname = new URL(url).hostname;
            fetch(`/api/link-preview?url=${encodeURIComponent(url)}`)
              .then(r => r.json())
              .then(preview => {
                if (preview.success) {
                  embedCard.innerHTML = `
                    <div class="flex gap-3">
                      <div class="flex-1 min-w-0">
                        <div class="text-xs text-discord-gray-400 mb-1">${preview.site_name || hostname}</div>
                        <a href="${url}" target="_blank" class="text-blue-400 hover:underline font-medium text-sm block truncate">
                          ${preview.title || url}
                        </a>
                        ${preview.description ? `<p class="text-xs text-discord-gray-300 mt-1 line-clamp-2">${preview.description.substring(0, 100)}...</p>` : ''}
                      </div>
                      ${preview.image ? `<img src="${preview.image}" class="w-16 h-16 rounded object-cover flex-shrink-0" onerror="this.style.display='none'">` : ''}
                    </div>
                  `;
                } else {
                  // Fallback - simple link card
                  embedCard.innerHTML = `
                    <a href="${url}" target="_blank" class="text-blue-400 hover:underline text-sm">
                      üîó ${hostname}
                    </a>
                  `;
                }
              })
              .catch(() => {
                // Fallback on error
                const hostname = new URL(url).hostname;
                embedCard.innerHTML = `
                  <a href="${url}" target="_blank" class="text-blue-400 hover:underline text-sm">
                    üîó ${hostname}
                  </a>
                `;
              });
          } catch { }
        }
      }


      // Reactions display area (below message content)
      if (data.reactions && Object.keys(data.reactions).length > 0) {
        const reactionsContainer = document.createElement("div");
        reactionsContainer.className = "reactions-container flex flex-wrap gap-1 mt-1";

        const username = localStorage.getItem('savedUsername') || 'User';
        for (const [emoji, users] of Object.entries(data.reactions)) {
          const hasUserReacted = users.includes(username);
          const reactionBadge = document.createElement("button");
          reactionBadge.className = `flex items-center gap-1 px-2 py-0.5 rounded text-sm border transition ${hasUserReacted ? 'bg-discord-blurple/20 border-discord-blurple text-white' : 'bg-discord-gray-800/50 hover:bg-discord-gray-700 border-discord-gray-600 text-discord-gray-300'}`;
          reactionBadge.innerHTML = `<span>${emoji}</span><span class="text-xs">${users.length}</span>`;
          reactionBadge.title = users.join(', ');
          reactionBadge.onclick = () => addReactionToMessage(msgWrapper, emoji, data);
          reactionsContainer.appendChild(reactionBadge);
        }
        contentWrapper.appendChild(reactionsContainer);
      }

      messageRow.appendChild(contentWrapper);
      msgWrapper.appendChild(messageRow);
      return msgWrapper;
    }

    // === USER PROFILE VIEW MODAL LOGIC ===
    async function showUserProfile(targetUsername) {
      if (!targetUsername || targetUsername === 'N/A') return;
      const overlay = document.getElementById('userViewModalOverlay');
      const modal = document.getElementById('userViewModal');

      // Initial Loading State
      document.getElementById('uvUsername').textContent = targetUsername;
      document.getElementById('uvUsertag').textContent = 'Loading...';
      document.getElementById('uvAvatar').src = '/images/default_avatar.png';
      document.getElementById('uvBanner').src = '/images/default_banner.png';
      document.getElementById('uvBio').textContent = 'Searching for user bio...';

      overlay.classList.remove('hidden');
      modal.classList.remove('hidden');
      feather.replace();

      if (targetUsername === 'AI') {
        document.getElementById('uvUsername').textContent = 'Zylo AI';
        document.getElementById('uvUsertag').textContent = '@AI';
        document.getElementById('uvAvatar').src = '/images/Zylo_icon.ico';
        document.getElementById('uvBio').textContent = 'Your friendly AI assistant within Zylo. I am here to help you brainstorm, answer questions, and explore ideas.';
        document.getElementById('uvMessageBtn').classList.add('hidden');
        document.getElementById('uvProfileBtn').classList.add('hidden');
        return;
      } else {
        document.getElementById('uvMessageBtn').classList.remove('hidden');
        document.getElementById('uvProfileBtn').classList.remove('hidden');
      }

      try {
        const res = await fetch(`/api/get-user?identifier=${encodeURIComponent(targetUsername)}`);
        const data = await res.json();
        if (data.success && data.user) {
          const u = data.user;
          document.getElementById('uvUsername').textContent = u.username;
          document.getElementById('uvUsertag').textContent = (u.usertag || '@user0000');
          if (u.avatar) document.getElementById('uvAvatar').src = u.avatar;
          if (u.banner) document.getElementById('uvBanner').src = u.banner;
          document.getElementById('uvBio').textContent = u.about || u.aboutMe || 'No bio shared.';

          // Set Up Message Button
          const msgBtn = document.getElementById('uvMessageBtn');
          msgBtn.onclick = () => {
            closeUserViewModal();
            openDMFromProfile(u.username);
          };

          // Set Up Profile Card Button
          const profBtn = document.getElementById('uvProfileBtn');
          profBtn.onclick = () => {
            closeUserViewModal();
            // If it's the current user, go to profile. If not, just viewing them is enough
            if (u.username === localStorage.getItem('username')) {
              switchTab('profile');
            }
          };
        } else {
          document.getElementById('uvBio').textContent = 'User details are currently unavailable.';
        }
      } catch (error) {
        console.error('Failed to load user profile modal:', error);
        document.getElementById('uvBio').textContent = 'Error loading user data.';
      }
    }

    function closeUserViewModal() {
      document.getElementById('userViewModalOverlay').classList.add('hidden');
      document.getElementById('userViewModal').classList.add('hidden');
    }

    async function appendCommunityMessage(data) {
      const msgElement = await createDiscordMessage(data);
      chatMessagesCommunity.appendChild(msgElement);
      chatMessagesCommunity.scrollTop = chatMessagesCommunity.scrollHeight;
      feather.replace();
      // Apply syntax highlighting to code blocks
      if (typeof hljs !== 'undefined') {
        msgElement.querySelectorAll('pre code.hljs').forEach(block => {
          hljs.highlightElement(block);
        });
      }
    }

    async function appendAiBubble(role, content) {
      const isOwn = role === 'user';
      const data = {
        username: isOwn ? username : 'AI',
        message: content,
        from: isOwn ? username : 'AI'
      };

      const msgElement = await createDiscordMessage(data);

      // AI-specific: Use AI avatar
      if (!isOwn) {
        msgElement.querySelector('img').src = '/images/Zylo_icon.ico';

        // Add feedback actions
        const actions = document.createElement('div');
        actions.className = 'mt-1 flex gap-2 opacity-70 text-xs';
        const like = document.createElement('button');
        like.textContent = 'üëç';
        like.className = 'hover:opacity-100';
        like.onclick = async () => { /* ... feedback logic ... */ like.textContent = '‚úÖ'; };
        const dislike = document.createElement('button');
        dislike.textContent = 'üëé';
        dislike.className = 'hover:opacity-100';
        dislike.onclick = async () => { /* ... feedback logic ... */ dislike.textContent = '‚úÖ'; };
        actions.appendChild(like);
        actions.appendChild(dislike);
        msgElement.querySelector('div').appendChild(actions);
      }

      chatMessagesAI.appendChild(msgElement);
      chatMessagesAI.scrollTop = chatMessagesAI.scrollHeight;
      // Apply syntax highlighting to code blocks in AI chat
      if (typeof hljs !== 'undefined') {
        msgElement.querySelectorAll('pre code.hljs').forEach(block => {
          hljs.highlightElement(block);
        });
      }
    }

    // Reply Context
    let replyContext = null; // { id, username, content }

    function startReply(id, username, content) {
      replyContext = { id, username, content };

      // Determine which bar and input to use
      let barId = 'replyBar';
      let textId = 'replyTargetText';
      let inputId = 'chatInput';

      const showHome = document.getElementById('tab-home')?.classList.contains('hidden') === false;
      const showFriends = document.getElementById('tab-friends')?.classList.contains('hidden') === false;
      const showGroup = document.getElementById('tab-group')?.classList.contains('hidden') === false;
      const showCloud = document.getElementById('tab-cloud')?.classList.contains('hidden') === false;

      // If in tab-messages, check if AI or Community
      if (!document.getElementById('tab-messages')?.classList.contains('hidden')) {
        if (!chatMessagesAI.classList.contains('hidden')) {
          // AI chat doesn't really have a reply bar yet, but we'll use community's for now
        }
      } else if (showFriends) {
        barId = 'friendsReplyBar';
        textId = 'friendsReplyTargetText';
        inputId = 'friendsChatInput';
      } else if (showGroup) {
        barId = 'groupReplyBar';
        textId = 'groupReplyTargetText';
        inputId = 'groupChatInput';
      }

      const bar = document.getElementById(barId);
      const text = document.getElementById(textId);
      const input = document.getElementById(inputId);

      if (bar && text) {
        bar.classList.remove('hidden');
        text.textContent = `Replying to ${username}`;
      }
      if (input) {
        input.focus();
        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function cancelReply() {
      replyContext = null;
      ['replyBar', 'friendsReplyBar', 'groupReplyBar'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
    }

    // Add reaction to a message
    async function addReactionToMessage(msgWrapper, emoji, data) {
      const username = localStorage.getItem('savedUsername') || 'User';

      // Find or create reactions container
      let reactionsContainer = msgWrapper.querySelector('.reactions-container');
      if (!reactionsContainer) {
        reactionsContainer = document.createElement("div");
        reactionsContainer.className = "reactions-container flex flex-wrap gap-1 mt-1 ml-12";
        msgWrapper.appendChild(reactionsContainer);
      }

      // Initialize reactions if not present
      if (!data.reactions) data.reactions = {};
      if (!data.reactions[emoji]) data.reactions[emoji] = [];

      // Toggle reaction (add if not present, remove if present)
      const userIndex = data.reactions[emoji].indexOf(username);
      if (userIndex === -1) {
        data.reactions[emoji].push(username);
      } else {
        data.reactions[emoji].splice(userIndex, 1);
        if (data.reactions[emoji].length === 0) {
          delete data.reactions[emoji];
        }
      }

      // Re-render reactions
      reactionsContainer.innerHTML = '';
      for (const [reactionEmoji, users] of Object.entries(data.reactions)) {
        if (users.length === 0) continue;
        const hasUserReacted = users.includes(username);
        const reactionBadge = document.createElement("button");
        reactionBadge.className = `flex items-center gap-1 px-1.5 py-0.5 rounded-full text-xs border transition ${hasUserReacted ? 'bg-discord-blurple/30 border-discord-blurple' : 'bg-discord-gray-700/50 hover:bg-discord-gray-600 border-discord-gray-600'}`;
        reactionBadge.innerHTML = `<span>${reactionEmoji}</span><span class="text-discord-gray-300">${users.length}</span>`;
        reactionBadge.title = users.join(', ');
        reactionBadge.onclick = () => addReactionToMessage(msgWrapper, reactionEmoji, data);
        reactionsContainer.appendChild(reactionBadge);
      }

      // Sync to backend (for group messages)
      if (currentGroupId && data.timestamp) {
        try {
          await fetch('/api/groups/message/react', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              groupId: currentGroupId,
              channel: activeChannelId || 'general',
              timestamp: data.timestamp,
              username,
              emoji,
              action: userIndex === -1 ? 'add' : 'remove'
            })
          });
        } catch (e) { console.error('Reaction sync failed:', e); }
      }
    }

    // Rate Limiting State (6.9)
    const rateLimit = {
      count: 5,
      window: 10000, // 10 seconds
      history: []
    };

    // sendMessage function
    async function sendMessage() {
      // Security: Rate Limiting Check
      const now = Date.now();
      rateLimit.history = rateLimit.history.filter(ts => now - ts < rateLimit.window);
      if (rateLimit.history.length >= rateLimit.count) {
        const resetTime = Math.ceil((rateLimit.history[0] + rateLimit.window - now) / 1000);
        // Using a temporary notification instead of alert for better UX
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50 animate-bounce';
        notification.textContent = `Slow down! Please wait ${resetTime} seconds.`;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 2000);
        return;
      }
      rateLimit.history.push(now);

      const message = chatInput.value.trim();
      if (!message) return;

      if (currentChatRoom === 'community') {
        const tempId = generateUUID();
        const payload = {
          id: tempId,
          username,
          message,
          replyTo: replyContext ? { id: replyContext.id, username: replyContext.username, content: replyContext.content } : null,
          ts: Date.now() / 1000
        };

        // Optimistic Render
        if (chatMessagesCommunity) {
          createDiscordMessage(payload).then(el => {
            el.setAttribute('data-msg-id', tempId);
            chatMessagesCommunity.appendChild(el);
            chatMessagesCommunity.scrollTop = chatMessagesCommunity.scrollHeight;
          });
        }

        chatInput.value = "";
        chatInput.style.height = "auto";
        cancelReply();

        // Send to backend via REST (more robust + ID support)
        try {
          await fetch('/api/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } catch (e) {
          console.error('Failed to send message:', e);
        }
        return;
      }
      // AI chat path
      const model = aiModelSelect?.value || '';
      const persona = aiPersonaSelect?.value || localStorage.getItem('ai_persona') || 'helper';
      const payload = {
        model,
        persona,
        username,
        messages: [...aiConversation, { role: 'user', content: message }]
      };
      await appendAiBubble('user', message);
      aiConversation.push({ role: 'user', content: message });
      localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
      chatInput.value = "";
      chatInput.style.height = "auto";
      try {
        const res = await fetch('/api/ai/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        const reply = data.reply || data.response || 'Sorry, no reply available.';
        await appendAiBubble('assistant', reply);
        aiConversation.push({ role: 'assistant', content: reply });
        localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
      } catch (e) {
        await appendAiBubble('assistant', 'There was an error contacting the AI.');
      }
    }

    // openEmojiPicker (Kept as is)
    function toggleEmojiPicker(pickerId, inputId) {
      const picker = document.getElementById(pickerId);
      const input = document.getElementById(inputId);
      if (!picker || !input) return;

      if (picker.classList.contains("hidden")) {
        // Close all other pickers
        document.querySelectorAll('[id$="EmojiPicker"]').forEach(p => p.classList.add("hidden"));

        picker.classList.remove("hidden");
        picker.innerHTML = "";
        const pickerInstance = new EmojiMart.Picker({
          onEmojiSelect: (emoji) => {
            input.value += emoji.native;
            input.focus();
          },
          theme: "dark",
        });
        picker.appendChild(pickerInstance);
      } else {
        picker.classList.add("hidden");
      }
    }

    // sendFile (Kept as is)
    function sendFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Security: 10MB File Size Limit
      const MAX_SIZE = 10 * 1024 * 1024; // 10MB
      if (file.size > MAX_SIZE) {
        alert("File is too large! Maximum file size is 10MB.");
        event.target.value = ""; // Clear input
        return;
      }
      const reader = new FileReader();
      reader.onload = function (e) {
        const fileData = e.target.result;
        socket.emit("send_file", {
          username,
          fileName: file.name,
          fileType: file.type,
          fileData: fileData
        });
      };
      reader.readAsDataURL(file); // encodes file as base64
    }

    // === Voice Message Recording ===
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let recordingStartTime = null;

    async function startVoiceRecording(context) {
      if (isRecording) return;

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        isRecording = true;
        recordingStartTime = Date.now();

        // Visual feedback - add recording class
        const btn = event.target.closest('.voice-record-btn');
        if (btn) {
          btn.classList.add('recording');
          btn.style.backgroundColor = '#ef4444';
          btn.style.animation = 'pulse 1s infinite';
        }

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            audioChunks.push(e.data);
          }
        };

        mediaRecorder.onstop = async () => {
          const duration = Math.floor((Date.now() - recordingStartTime) / 1000);

          // Only send if recording was longer than 0.5 seconds
          if (duration >= 1) {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.onload = () => {
              const base64Audio = reader.result;
              sendVoiceMessage(base64Audio, duration, context);
            };
            reader.readAsDataURL(audioBlob);
          }

          // Stop all tracks
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
      } catch (err) {
        console.error('Microphone access denied:', err);
        alert('Please allow microphone access to record voice messages.');
      }
    }

    function stopVoiceRecording(context) {
      if (!isRecording || !mediaRecorder) return;

      isRecording = false;
      mediaRecorder.stop();

      // Remove visual feedback
      document.querySelectorAll('.voice-record-btn').forEach(btn => {
        btn.classList.remove('recording');
        btn.style.backgroundColor = '';
        btn.style.animation = '';
      });
    }

    async function sendVoiceMessage(audioData, duration, context) {
      const currentUser = localStorage.getItem('savedUsername') || 'User';

      const payload = {
        username: currentUser,
        type: 'voice',
        fileData: audioData,
        fileName: `voice_${Date.now()}.webm`,
        fileType: 'audio/webm',
        duration: duration,
        timestamp: Math.floor(Date.now() / 1000)
      };

      if (context === 'community') {
        socket.emit("send_file", payload);
      } else if (context === 'group' && currentGroupId) {
        payload.groupId = currentGroupId;
        payload.channel = activeChannelId || 'general';

        // Optimistic UI update
        await appendGroupMessage(payload);

        // Send to server
        try {
          await fetch('/api/groups/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } catch (e) { console.error('Voice message send failed:', e); }
      }
    }

    // Typing indicator logic (Kept as is)
    socket.on("typing", (data) => {
      activeTypers.add(data.username);
      updateTypingIndicator();
      clearTimeout(typingIndicator[data.username]);
      typingIndicator[data.username] = setTimeout(() => {
        activeTypers.delete(data.username);
        updateTypingIndicator();
      }, 2500);
    });

    // Socket message receivers (use NEW rendering function)
    socket.on("receive_message", async (data) => {
      await appendCommunityMessage(data);
    });

    socket.on("receive_file", async (data) => {
      // This is now handled by createDiscordMessage, which appendCommunityMessage uses
      await appendCommunityMessage(data);
    });

    // updateTypingIndicator
    function updateTypingIndicator() {
      // Main chat indicator
      if (activeTypers.size === 0) {
        typingIndicator.classList.add("hidden");
        typingIndicator.textContent = "";
      } else {
        const typers = Array.from(activeTypers);
        typingIndicator.classList.remove("hidden");
        if (typers.length === 1) {
          typingIndicator.textContent = `${typers[0]} is typing...`;
        } else if (typers.length === 2) {
          typingIndicator.textContent = `${typers[0]} and ${typers[1]} are typing...`;
        } else {
          typingIndicator.textContent = "Many people are typing...";
        }
      }

      // Sidebar DM indicators logic
      // clear all sidebar typing indicators first
      document.querySelectorAll('.sidebar-typing-indicator').forEach(el => el.remove());

      if (activeTypers.size > 0) {
        activeTypers.forEach(username => {
          // Find sidebar item for this user - simplified text match
          // We look for elements that might be user list items
          const sidebarItems = document.querySelectorAll('#directMessagesList > div, #friendsList > div');
          sidebarItems.forEach(item => {
            if (item.textContent.includes(username)) {
              // Avoid duplicating if already added (though we cleared above)
              if (!item.querySelector('.sidebar-typing-indicator')) {
                const indicator = document.createElement("span");
                indicator.className = "sidebar-typing-indicator text-xs text-discord-gray-400 italic ml-2 animate-pulse";
                indicator.textContent = "typing...";
                // Append to the name container usually
                const nameContainer = item.querySelector('span.font-medium') || item;
                nameContainer.appendChild(indicator);
              }
            }
          });
        });
      }
    }

    // Fetch old messages (Kept as is)
    if (navigator.onLine) {
      fetch("/api/messages")
        .then((res) => res.json())
        .then(async (msgs) => {
          for (const msg of msgs) {
            await appendCommunityMessage(msg);
          }
        })
        .catch(() => { });
    }

    // switchChatRoom (Updated to handle new sub-panel UI)
    function switchChatRoom(room) {
      currentChatRoom = room;
      localStorage.setItem('chatRoom', room);
      const btnCommunity = document.getElementById('btnRoomCommunity');
      const btnAI = document.getElementById('btnRoomAI');
      const title = document.getElementById('main-content-title');

      // Ensure we're showing tab-messages, not tab-friends
      const tabMessages = document.getElementById('tab-messages');
      const tabFriends = document.getElementById('tab-friends');
      if (tabMessages && tabFriends) {
        tabMessages.classList.remove('hidden');
        tabFriends.classList.add('hidden');
      }

      if (room === 'community') {
        chatMessagesCommunity.classList.remove('hidden');
        chatMessagesAI.classList.add('hidden');
        aiControls.classList.add('hidden');
        btnCommunity.classList.add('active');
        btnAI.classList.remove('active');
        if (title) title.textContent = '# Community';
      } else {
        chatMessagesCommunity.classList.add('hidden');
        chatMessagesAI.classList.remove('hidden');
        aiControls.classList.remove('hidden');
        btnAI.classList.add('active');
        btnCommunity.classList.remove('active');
        if (title) title.textContent = 'ü§ñ AI Chat';
        restoreAiConversation();
      }
    }

    // AI functions (restore, clear, load) (Kept as is)
    function restoreAiConversation() {
      try {
        aiConversation = JSON.parse(localStorage.getItem('ai_conversation') || '[]');
      } catch { aiConversation = []; }
      chatMessagesAI.innerHTML = '';
      (async () => {
        for (const msg of aiConversation) {
          await appendAiBubble(msg.role, msg.content);
        }
      })();
    }

    function clearAiConversation() {
      aiConversation = [];
      localStorage.removeItem('ai_conversation');
      chatMessagesAI.innerHTML = '';
    }

    async function loadAiModels() {
      try {
        const res = await fetch('/api/ai/models');
        const data = await res.json();
        const models = data.models || [];
        aiModelSelect.innerHTML = '';
        models.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m;
          opt.textContent = m;
          aiModelSelect.appendChild(opt);
        });
        const saved = localStorage.getItem('ai_model');
        if (saved && models.includes(saved)) {
          aiModelSelect.value = saved;
        }
        aiModelSelect.addEventListener('change', () => {
          localStorage.setItem('ai_model', aiModelSelect.value);
        });
      } catch { }
    }

    async function loadAiPersonas() {
      try {
        const res = await fetch('/api/ai/personas');
        const data = await res.json();
        const personas = (data.personas || []).map(p => ({ key: p.key, name: p.name }));
        aiPersonaSelect.innerHTML = '';
        personas.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.key;
          opt.textContent = p.name;
          aiPersonaSelect.appendChild(opt);
        });
        const saved = localStorage.getItem('ai_persona');
        if (saved) aiPersonaSelect.value = saved;
        aiPersonaSelect.addEventListener('change', () => {
          localStorage.setItem('ai_persona', aiPersonaSelect.value);
        });
      } catch { }
    }

    // Friends UI logic
    let currentFriendFilter = 'all';
    let activeFriendChat = null; // Can be a username (DM) or Group Object

    async function loadFriends() {
      const u = localStorage.getItem('username');
      if (!u) return;
      try {
        const resFriends = await fetch(`/api/friends?username=${encodeURIComponent(u)}`);
        const dataFriends = await resFriends.json();

        friendsState = {
          friends: dataFriends.friends || [],
          incoming: dataFriends.incoming || [],
          outgoing: dataFriends.outgoing || []
        };

        renderSidebarList(); // Update Friend List
        renderFriendsDashboard(); // Update Main View
      } catch (e) { console.error(e); }
    }

    // Helper: Generate consistent color for group avatar based on name
    function getGroupColor(groupName) {
      let hash = 0;
      for (let i = 0; i < groupName.length; i++) {
        hash = groupName.charCodeAt(i) + ((hash << 5) - hash);
      }
      const hue = Math.abs(hash % 360);
      return `hsl(${hue}, 60%, 50%)`;
    }

    // Helper: Get first letter of group name
    function getGroupInitial(groupName) {
      return (groupName || 'G')[0].toUpperCase();
    }

    function renderSidebarList() {
      const container = document.getElementById('sidebarDMList');
      if (!container) return;
      container.innerHTML = '';

      // Discord-like: "Friends" item at the top
      const friendsHeading = document.createElement('button');
      friendsHeading.className = `group-item w-full ${!activeFriendChat ? 'active' : ''}`;
      friendsHeading.innerHTML = `
        <div class="sidebar-icon-mini">
           <i data-feather="users" class="w-4 h-4"></i>
        </div>
        <div class="group-info">
          <span class="group-name">Friends</span>
        </div>
      `;
      friendsHeading.onclick = () => showFriendsDashboard();
      container.appendChild(friendsHeading);

      // Render DMs Section
      if (friendsState.friends.length > 0) {
        const dmsHeader = document.createElement('div');
        dmsHeader.className = 'dm-list-section mt-4';
        dmsHeader.textContent = 'Direct Messages';
        container.appendChild(dmsHeader);

        friendsState.friends.forEach(f => {
          const item = document.createElement('button');
          item.className = `group-item w-full ${activeFriendChat === f ? 'active' : ''}`;

          let avatar = avatarCache.get(f) || '/images/default_avatar.png';

          item.innerHTML = `
            <div class="dm-avatar-wrapper">
              <img src="${avatar}" alt="${f}'s avatar" class="rounded-full w-8 h-8 object-cover">
              <span class="status-indicator w-3 h-3 rounded-full border-2 border-discord-gray-800 bg-gray-500 absolute bottom-0 right-0" data-user-status="${f}"></span>
            </div>
            <div class="group-info">
              <span class="group-name text-sm opacity-80">${f}</span>
            </div>
          `;

          if (!avatarCache.has(f)) {
            getUserAvatarUrl(f).then(url => {
              const img = item.querySelector('img');
              if (img) img.src = url;
            });
          }

          item.onclick = () => openDM(f);
          container.appendChild(item);
        });
      }
      feather.replace();
    }

    function renderGroupSidebar() {
      const container = document.getElementById('groupIconsContainer');
      if (!container) return;
      container.innerHTML = '';

      groupsData.forEach(g => {
        const item = document.createElement('div');
        item.className = 'group-icon-wrapper group relative flex items-center justify-center cursor-pointer my-2';

        const isActive = currentGroupId === g.id;
        const pillHeight = isActive ? 'h-10' : 'h-2';
        const pillOpacity = isActive ? 'opacity-100' : 'opacity-0 group-hover:opacity-100';

        const color = getGroupColor(g.name);
        const initial = getGroupInitial(g.name);

        let iconStyle = '';
        if (g.icon) {
          iconStyle = `background-image: url(${g.icon}); background-size: cover; background-position: center;`;
        } else if (!isActive) {
          iconStyle = `background-color: ${color};`;
        }

        item.onclick = () => selectGroup(g.id);

        item.innerHTML = `
                <div class="absolute -left-2 w-1 bg-white rounded-r-full transition-all duration-200 ${pillHeight} ${pillOpacity}"></div>
                <div class="sidebar-icon w-12 h-12 flex items-center justify-center bg-discord-gray-700 hover:bg-discord-blurple text-white font-semibold transition-all duration-200 ${isActive ? 'rounded-2xl bg-discord-blurple' : 'rounded-[24px] hover:rounded-2xl'}" style="${iconStyle}">
                   ${g.icon ? '' : initial}
                </div>
                <!-- Tooltip -->
                <div class="absolute left-full ml-4 px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-50 transition-opacity">
                   ${g.name}
                </div>
             `;
        container.appendChild(item);
      });
      feather.replace();
    }

    function showGroupsModal() {
      document.getElementById('groupsModal').classList.remove('hidden');
    }

    function closeGroupsModal() {
      document.getElementById('groupsModal').classList.add('hidden');
    }

    function switchGroupModalTab(tab) {
      const createTab = document.getElementById('createGroupTab');
      const joinTab = document.getElementById('joinGroupTab');
      const createForm = document.getElementById('createGroupForm');
      const joinForm = document.getElementById('joinGroupForm');

      if (tab === 'create') {
        createTab.classList.add('border-b-2', 'border-discord-blurple', 'text-white');
        createTab.classList.remove('text-discord-gray-400');
        joinTab.classList.remove('border-b-2', 'border-discord-blurple', 'text-white');
        joinTab.classList.add('text-discord-gray-400');

        createForm.classList.remove('hidden');
        joinForm.classList.add('hidden');
      } else {
        joinTab.classList.add('border-b-2', 'border-discord-blurple', 'text-white');
        joinTab.classList.remove('text-discord-gray-400');
        createTab.classList.remove('border-b-2', 'border-discord-blurple', 'text-white');
        createTab.classList.add('text-discord-gray-400');

        joinForm.classList.remove('hidden');
        createForm.classList.add('hidden');
      }
    }


    function filterFriends(filter) {
      currentFriendFilter = filter;

      // Update toolbar buttons
      document.querySelectorAll('.friend-toolbar-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-discord-gray-600/50', 'text-white');
        if (btn.textContent.toLowerCase().includes(filter) || (filter === 'add' && btn.classList.contains('add-friend'))) {
          btn.classList.add('active');
        }
      });

      renderFriendsDashboard();
    }

    function renderFriendsDashboard() {
      const container = document.getElementById('friendsDashboardContent');
      const addSection = document.getElementById('addFriendSection');
      if (!container) return;

      container.innerHTML = '';

      if (currentFriendFilter === 'add') {
        container.classList.add('hidden');
        addSection.classList.remove('hidden');
        return;
      }

      container.classList.remove('hidden');
      addSection.classList.add('hidden');

      // Helper to create row
      const createRow = (username, subtext, actions) => {
        const div = document.createElement('div');
        div.className = 'friend-row group';

        getUserAvatarUrl(username).then(url => {
          const img = div.querySelector('.row-avatar');
          if (img) img.src = url;
        });

        div.innerHTML = `
              <div class="flex items-center gap-3" onclick="openDM('${username}')">
                  <img src="/images/default_avatar.png" class="row-avatar w-10 h-10 rounded-full bg-discord-gray-700">
                  <div>
                      <div class="font-semibold text-white">${username}</div>
                      <div class="text-xs text-discord-gray-400">${subtext}</div>
                  </div>
              </div>
              <div class="flex items-center gap-2">
                  ${actions}
              </div>
          `;
        return div;
      };

      // Render based on filter
      if (currentFriendFilter === 'all' || currentFriendFilter === 'online') {
        // Note: We don't have real presence yet, assuming all friends are "Offline" visually for now or just listing them
        friendsState.friends.forEach(f => {
          const actions = `
                  <button class="action-icon-btn" onclick="openDM('${f}')" title="Message"><i data-feather="message-circle" class="w-4 h-4"></i></button>
                  <button class="action-icon-btn danger" onclick="removeFriend('${f}')" title="Remove"><i data-feather="trash-2" class="w-4 h-4"></i></button>
              `;
          container.appendChild(createRow(f, "Friend", actions));
        });
        if (friendsState.friends.length === 0) container.innerHTML = `<div class="text-center mt-10 text-discord-gray-400">No friends found. Wumpus is lonely.</div>`;
      }

      if (currentFriendFilter === 'pending') {
        const headerIn = document.createElement('h3');
        headerIn.className = "uppercase text-xs font-bold text-discord-gray-400 mb-2 mt-4";
        headerIn.textContent = `Incoming - ${friendsState.incoming.length}`;
        container.appendChild(headerIn);

        friendsState.incoming.forEach(f => {
          const actions = `
                  <button class="action-icon-btn success" onclick="acceptFriend('${f}')"><i data-feather="check" class="w-4 h-4"></i></button>
                  <button class="action-icon-btn danger" onclick="declineFriend('${f}')"><i data-feather="x" class="w-4 h-4"></i></button>
              `;
          container.appendChild(createRow(f, "Incoming Friend Request", actions));
        });

        const headerOut = document.createElement('h3');
        headerOut.className = "uppercase text-xs font-bold text-discord-gray-400 mb-2 mt-4";
        headerOut.textContent = `Outgoing - ${friendsState.outgoing.length}`;
        container.appendChild(headerOut);

        friendsState.outgoing.forEach(f => {
          const actions = `
                  <button class="action-icon-btn danger" onclick="cancelFriendRequest('${f}')"><i data-feather="x" class="w-4 h-4"></i></button>
              `;
          container.appendChild(createRow(f, "Outgoing Friend Request", actions));
        });
      }

      feather.replace();
    }

    async function requestFriend() {
      const input = document.getElementById('addFriendInput');
      const to = (input?.value || '').trim();
      const from = localStorage.getItem('username');
      if (!to || !from) return;

      try {
        const res = await fetch('/api/friends/request', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ from, to }) });
        await res.json();
        input.value = '';
        loadFriends();
      } catch { }
    }

    function requestFriendMain() {
      const input = document.getElementById('addFriendInputMain');
      const to = input.value.trim();
      if (to) {
        // Call your existing API
        const from = localStorage.getItem('username');
        fetch('/api/friends/request', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ from, to }) })
          .then(r => r.json()).then(d => {
            if (d.success) { alert('Request sent!'); input.value = ''; loadFriends(); }
            else alert(d.error || 'Failed');
          });
      }
    }

    async function acceptFriend(from) {
      const username = localStorage.getItem('username');
      if (!username) return;
      await fetch('/api/friends/accept', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, from }) });
      loadFriends();
    }

    async function declineFriend(from) {
      const username = localStorage.getItem('username');
      if (!username) return;
      await fetch('/api/friends/decline', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, from }) });
      loadFriends();
    }

    async function cancelFriendRequest(target) {
      const username = localStorage.getItem('username');
      if (!username) return;
      await fetch('/api/friends/cancel', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, to: target }) });
      loadFriends();
    }

    async function removeFriend(friend) {
      const username = localStorage.getItem('username');
      if (!username) return;
      await fetch('/api/friends/remove', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, friend }) });
      loadFriends();
    }

    // ---- Groups UI logic ----
    async function openGroupChat(group) {
      activeFriendChat = group; // Object
      renderSidebarList();

      document.getElementById('friendsDashboard').classList.add('hidden');
      const view = document.getElementById('friendsChatView');
      view.classList.remove('hidden');

      document.getElementById('chatHeaderTitle').textContent = group.name;

      const msgsContainer = document.getElementById('friendsChatMessages');
      msgsContainer.innerHTML = '';

      if (navigator.onLine) socket.emit('join_group', { groupId: group.id, username: localStorage.getItem('username') });

      try {
        const res = await fetch(`/api/groups/${group.id}/messages`);
        const msgs = await res.json();
        for (const m of msgs) {
          const el = await createDiscordMessage(m);
          msgsContainer.appendChild(el);
        }
        msgsContainer.scrollTop = msgsContainer.scrollHeight;
        feather.replace();
      } catch (e) { }
    }



    async function appendGroupMessage(data) {
      const msgElement = await createDiscordMessage(data);
      const container = document.getElementById('groupChatMessages');
      if (container) {
        container.appendChild(msgElement);
        container.scrollTop = container.scrollHeight;
        feather.replace();
      }
    }

    async function refreshGroups() {
      return loadGroups();
    }

    // (createNewGroup, joinExistingGroup, sendGroupMessage, sendGroupFile)
    async function createNewGroup() {
      const owner = localStorage.getItem('username');
      const nameInput = document.getElementById('newGroupNameInput');
      const descInput = document.getElementById('newGroupDescInput');
      let name = nameInput?.value?.trim();

      if (!name) { alert("Please enter a group name."); return; }

      const description = descInput?.value?.trim() || "";

      if (!owner) return;
      try {
        const res = await fetch('/api/groups/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ owner, name, description }) });
        const data = await res.json();
        if (res.ok && data.success) {
          closeGroupsModal();
          refreshGroups();
          if (nameInput) nameInput.value = '';
          if (descInput) descInput.value = '';
        } else {
          alert(data.error || "Failed to create group.");
        }
      } catch { }
    }

    async function joinExistingGroup() {
      const groupIdInput = document.getElementById('joinGroupIdInput');
      const groupId = groupIdInput?.value?.trim();
      const username = localStorage.getItem('username');

      if (!username || !groupId) return;

      try {
        const res = await fetch('/api/groups/join', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, groupId }) });
        const data = await res.json();

        if (data.success) {
          closeGroupsModal();
          refreshGroups();
          // Optionally auto-switch
          // const g = (groupsState.list || []).find(x => x.id === groupId);
          // if (g) setActiveGroup(g);
          if (groupIdInput) groupIdInput.value = '';
        } else {
          alert(data.error || "Failed to join group.");
        }
      } catch { }
    }
    function sendGroupChatMessage() {
      const input = document.getElementById('groupChatInput');
      const message = (input?.value || '').trim();
      if (!message || !groupsState.activeId) return;
      const payload = {
        groupId: groupsState.activeId,
        username: localStorage.getItem('username'),
        message,
        replyTo: replyContext ? { id: replyContext.id, username: replyContext.username, content: replyContext.content } : null
      };
      if (navigator.onLine) socket.emit('send_group_message', payload);
      else (async () => { await appendGroupMessage(payload); })();
      input.value = ''; input.style.height = 'auto';
      cancelReply();
    }

    function sendGroupFile(event) {
      const file = event.target.files?.[0];
      if (!file || !groupsState.activeId) return;

      // Security: 10MB File Size Limit
      const MAX_SIZE = 10 * 1024 * 1024; // 10MB
      if (file.size > MAX_SIZE) {
        alert("File is too large! Maximum file size is 10MB.");
        event.target.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const payload = { groupId: groupsState.activeId, username: localStorage.getItem('username'), fileName: file.name, fileType: file.type, fileData: e.target.result };
        if (navigator.onLine) {
          socket.emit('send_group_file', payload);
        } else {  // Don't render optimistically when online - socket will handle it
          (async () => { await appendGroupMessage(payload); })(); // Only render optimistically when offline
        }
        event.target.value = '';
      };
      reader.readAsDataURL(file);
    }

    // Socket listeners for group messages (use new render function)
    if (typeof io !== 'undefined') {
      socket.on('receive_group_message', async (data) => {
        if (data.groupId === groupsState.activeId) await appendGroupMessage(data);
      });
      socket.on('receive_group_file', async (data) => {
        if (data.groupId === groupsState.activeId) await appendGroupMessage(data);
      });
    }

    // Centralized Navigation Logic
    // Centralized Navigation Logic
    // Centralized Navigation Logic
    window.navigateTo = function (viewName) {
      // Legacy fix: map 'chats' to 'messages'
      if (viewName === 'chats') viewName = 'messages';

      // 1. Update localStorage
      localStorage.setItem('lastView', viewName);

      // 2. Hide all tab contents (Force display:none to avoid class conflicts)
      const tabs = document.querySelectorAll('.tab-content');
      tabs.forEach(t => {
        t.classList.add('hidden');
        t.style.display = 'none';
        t.classList.remove('animate-fadeIn');
      });

      // 3. Show target tab
      // Special handling: 'friends' view is actually displayed via the 'friends' tab, 
      // but shares the 'messages' sub-panel.
      let targetId = `tab-${viewName}`;

      const target = document.getElementById(targetId);
      if (target) {
        target.classList.remove('hidden');
        target.style.display = ''; // Allow CSS classes (flex/block) to take over

        // Slight delay for animation if needed
        setTimeout(() => target.classList.add('animate-fadeIn'), 10);

        // Update Header Title
        const titleEl = document.getElementById('main-content-title');
        if (titleEl) {
          switch (viewName) {
            case 'home': titleEl.textContent = 'Home'; break;
            case 'profile': titleEl.textContent = 'My Profile'; break;
            case 'settings': titleEl.textContent = 'User Settings'; break;
            case 'moments': titleEl.textContent = 'Moments'; break;
            case 'cloud': titleEl.textContent = 'My Cloud'; break;
            case 'messages':
              // Only reset if it doesn't look like a specific channel/DM
              if (!titleEl.textContent.trim().startsWith('#') && !titleEl.textContent.trim().startsWith('@')) {
                titleEl.textContent = 'Messages';
              }
              // Ensure community view is active in sidebar
              switchMessagesView('community');
              break;
            case 'friends':
              titleEl.textContent = 'Friends';
              // Ensure friends view is active in sidebar
              switchMessagesView('friends');
              break;
            default: break;
          }
        }
      }

      // 4. Update Sidebar Active State
      document.querySelectorAll('.sidebar-tab').forEach(b => {
        b.classList.remove('active');
        if (b.getAttribute('data-tab') === viewName) {
          b.classList.add('active');
        }
      });

      // 5. Update Sub-panels
      document.querySelectorAll('.sub-panel-content').forEach(p => p.classList.add('hidden'));

      // Map 'friends' to 'messages' sub-panel because they share the same sidebar area
      let subPanelName = viewName;
      if (viewName === 'friends') subPanelName = 'messages';

      const subPanel = document.getElementById(`sub-panel-${subPanelName}`);
      if (subPanel) subPanel.classList.remove('hidden');
    };

    // Helper to toggle between Community and Friends views in the Messages sub-panel
    // Helper to toggle between Community and Friends views in the Messages sub-panel
    window.switchMessagesView = function (view) {
      const btnCommunity = document.getElementById('btnMessagesTabCommunity');
      const btnFriends = document.getElementById('btnMessagesTabFriends');
      const viewCommunity = document.getElementById('messagesViewCommunity');
      const viewFriends = document.getElementById('messagesViewFriends');

      if (view === 'community') {
        // UI State
        btnCommunity?.classList.add('text-white', 'border-b-2', 'border-discord-blurple', 'bg-discord-gray-600/50');
        btnCommunity?.classList.remove('text-discord-gray-400');
        btnFriends?.classList.remove('text-white', 'border-b-2', 'border-discord-blurple', 'bg-discord-gray-600/50');
        btnFriends?.classList.add('text-discord-gray-400');

        // Visibility
        viewCommunity?.classList.remove('hidden');
        viewFriends?.classList.add('hidden');

        // Switch main view if needed
        const messagesTab = document.getElementById('tab-messages');
        if (messagesTab && (messagesTab.style.display === 'none' || messagesTab.classList.contains('hidden'))) {
          // Avoid loop: navigateTo('messages') calls this function, but it unhides the tab first.
          window.navigateTo('messages');
        }

      } else { // friends
        // UI State
        btnFriends?.classList.add('text-white', 'border-b-2', 'border-discord-blurple', 'bg-discord-gray-600/50');
        btnFriends?.classList.remove('text-discord-gray-400');
        btnCommunity?.classList.remove('text-white', 'border-b-2', 'border-discord-blurple', 'bg-discord-gray-600/50');
        btnCommunity?.classList.add('text-discord-gray-400');

        // Visibility
        viewFriends?.classList.remove('hidden');
        viewCommunity?.classList.add('hidden');

        // Switch main view if needed
        const friendsTab = document.getElementById('tab-friends');
        if (friendsTab && (friendsTab.style.display === 'none' || friendsTab.classList.contains('hidden'))) {
          window.navigateTo('friends');
        }
      }
    };

    // Backward compatibility for old inline calls if any missed
    window.switchTab = window.navigateTo;

    window.addEventListener("DOMContentLoaded", async () => {
      // Initialize Navigation
      const savedPage = localStorage.getItem('startupPage') || localStorage.getItem('lastView') || 'home';
      navigateTo(savedPage);


      const username = localStorage.getItem("username");
      if (!username) {
        document.getElementById("profileUsername").textContent = "N/A";
        document.getElementById("profileUsertag").textContent = "N/A";
        return;
      }

      try {
        if (!navigator.onLine) throw new Error('offline');
        const res = await fetch(`/api/get-user?identifier=${username}`);
        const data = await res.json();

        if (data.success) {
          const updated = data.user || {};

          document.getElementById("profileUsername").textContent = updated.username;
          document.getElementById("profileUsertag").textContent = updated.usertag;
          const el_aboutMe = document.getElementById("aboutMe"); if (el_aboutMe) el_aboutMe.value = updated.aboutMe || "";
          document.getElementById("avatarImage").src = updated.avatar || "/images/default_avatar.png";
          document.getElementById("bannerImage").src = updated.banner || "/images/default_banner.png";

          // Update settings avatar and banner too
          const settingsAvatar = document.getElementById("settingsAvatar");
          const settingsBanner = document.getElementById("settingsBanner");
          if (settingsAvatar) settingsAvatar.src = updated.avatar || "/images/default_avatar.png";
          if (settingsBanner) settingsBanner.src = updated.banner || "/images/default_banner.png";
        } else {
          console.error("User not found");
        }
      } catch (err) {
        const cached = {  // Offline fallback: populate from localStorage if available
          username: localStorage.getItem('username'),
          usertag: localStorage.getItem('usertag'),
          aboutMe: localStorage.getItem('aboutMe') || '',
          avatar: localStorage.getItem('avatar') || '/images/default_avatar.png',
          banner: localStorage.getItem('banner') || '/images/default_banner.png',
          level: parseInt(localStorage.getItem('level') || '0', 10),
          gold: parseInt(localStorage.getItem('gold') || '0', 10),
          rank: localStorage.getItem('rank') || 'Unranked'
        };
        document.getElementById("profileUsername").textContent = cached.username || 'N/A';
        document.getElementById("profileUsertag").textContent = cached.usertag || 'N/A';
        const el_aboutMe = document.getElementById("aboutMe"); if (el_aboutMe) el_aboutMe.value = cached.aboutMe;
        document.getElementById("avatarImage").src = cached.avatar;
        document.getElementById("bannerImage").src = cached.banner;
        document.getElementById("statLevel").textContent = cached.level;
        document.getElementById("statGold").textContent = cached.gold;
        document.getElementById("statRank").textContent = cached.rank;
      }
    });

    async function sendFriendMessage() {
      const input = document.getElementById('friendsChatInput');
      const text = input.value.trim();
      if (!text || !activeFriendChat) return;
      const me = localStorage.getItem('savedUsername') || 'User';

      const payload = {
        from: me,
        to: activeFriendChat,
        message: text,
        ts: Date.now() / 1000,
        replyTo: replyContext ? { id: replyContext.id, username: replyContext.username, content: replyContext.content } : null
      };

      // DM Logic
      if (typeof activeFriendChat === 'string') {
        // Optimistic UI - Show message immediately (sender's view)
        const el = await createDiscordMessage({ ...payload, username: me });
        const msgsContainer = document.getElementById('friendsChatMessages');
        if (msgsContainer) {
          msgsContainer.appendChild(el);
          msgsContainer.scrollTop = msgsContainer.scrollHeight;
          feather.replace();
        }

        if (navigator.onLine) {
          socket.emit('send_dm', payload);
        } else {
          // Always attempt API for persistence when offline
          fetch('/api/dm/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).catch(() => { });
        }
      } else {
        // Group Logic
        const groupPayload = {
          groupId: activeFriendChat.id,
          username: me,
          message: text,
          ts: Date.now() / 1000,
          replyTo: replyContext ? { id: replyContext.id, username: replyContext.username, content: replyContext.content } : null
        };
        if (navigator.onLine) socket.emit('send_group_message', groupPayload);
      }

      input.value = '';
      cancelReply();
    }

    function sendFriendFile(event) {
      const file = event.target.files?.[0];
      if (!file || !activeFriendChat) return;

      // Security: 10MB File Size Limit
      const MAX_SIZE = 10 * 1024 * 1024; // 10MB
      if (file.size > MAX_SIZE) {
        alert("File is too large! Maximum file size is 10MB.");
        event.target.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        // Determine payload based on chat type (DM or Group) - similar to sendFriendMessage logic
        const me = localStorage.getItem('savedUsername') || 'User';

        if (typeof activeFriendChat === 'string') {
          // DM
          const payload = { from: me, to: activeFriendChat, fileName: file.name, fileType: file.type, fileData: e.target.result, ts: Date.now() / 1000 };
          if (navigator.onLine) {
            socket.emit('send_file', payload); // Note: server likely expects 'send_file' or 'send_dm_file'? 
            // Wait, backend socket logic for DM file? 
            // Checking 'send_file' in app.py would be wise, but assuming 'send_file' works for DM or 'send_dm' with fileData?
            // Existing sendFile uses 'send_file'. Let's reuse that or check.
            // Actually, sendFile (global) uses 'send_file'. sendGroupFile uses 'send_group_file'.
            // Let's assume 'send_file' is for DMs? 
            // But wait, sendFriendMessage uses 'send_dm' for text.
            // Let's check backend if possible, or assume 'send_file' handles username/to?
            // The 'sendFile' function (line 2750) emits 'send_file' with { username, fileName, fileType, fileData }. It doesn't seem to have 'to'. 
            // It seems 'sendFile' is for PUBLIC chat or Community?
            // If I want DM file, I might need 'send_dm' with check for fileData?
            // Looking at sendFriendMessage (line 3705): socket.emit('send_dm', payload). payload = {from, to, message...}
            // If I attach fileData to 'send_dm', maybe backend handles it?

            // Let's try emitting 'send_dm' with fileData added.
            socket.emit('send_dm', { ...payload, message: 'Sent a file' }); // Fallback message
          } else {
            // Offline
            // (async () => { await createDiscordMessage({...payload, message: file.name, username: me }); })(); 
          }
        } else {
          // Group via Friends view (unlikely but possible if activeFriendChat is object)
          const payload = { groupId: activeFriendChat.id, username: me, fileName: file.name, fileType: file.type, fileData: e.target.result };
          if (navigator.onLine) socket.emit('send_group_file', payload);
        }
        event.target.value = '';
      };
      reader.readAsDataURL(file);
    }

    async function openDM(peerUsername) {
      activeFriendChat = peerUsername;
      renderSidebarList(); // Update active highlight

      // Switch View to the Friends Chat
      document.getElementById('friendsDashboard').classList.add('hidden');
      document.getElementById('addFriendSection').classList.add('hidden');
      const view = document.getElementById('friendsChatView');
      if (view) view.classList.remove('hidden');

      // Ensure we are on the Friends tab in Col 3
      const tabFriends = document.getElementById('tab-friends');
      const tabMessages = document.getElementById('tab-messages');
      if (tabFriends && tabMessages) {
        tabMessages.classList.add('hidden');
        tabFriends.classList.remove('hidden');
      }

      // Ensure Col 2 shows the Friends sub-panel
      switchMessagesView('friends');

      // Update Header
      document.getElementById('chatHeaderTitle').textContent = peerUsername;
      const input = document.getElementById('friendsChatInput');
      if (input) input.placeholder = `Message @${peerUsername}`;

      // Clear & Load Messages
      const msgsContainer = document.getElementById('friendsChatMessages');
      if (!msgsContainer) return;
      msgsContainer.innerHTML = '<div class="text-center p-4 text-discord-gray-400">Loading history...</div>';

      const me = localStorage.getItem('savedUsername') || 'User';
      try {
        const res = await fetch(`/api/dm/history?userA=${encodeURIComponent(me)}&userB=${encodeURIComponent(peerUsername)}`);
        const result = await res.json();
        const msgs = result.success ? result.messages : (Array.isArray(result) ? result : []); // Fallback for backward compatibility

        msgsContainer.innerHTML = '';
        if (msgs.length === 0) {
          msgsContainer.innerHTML = '<div class="text-center p-4 text-discord-gray-400">No messages yet. Start the conversation!</div>';
        }

        for (const m of msgs) {
          const el = await createDiscordMessage({ ...m, username: m.from });
          msgsContainer.appendChild(el);
        }
        msgsContainer.scrollTop = msgsContainer.scrollHeight;
        feather.replace();
      } catch (e) {
        console.error("DM Load Error:", e);
        msgsContainer.innerHTML = '<div class="text-center p-4 text-discord-gray-400">Could not load history.</div>';
      }
    }

    const processedMessageIds = new Set();

    if (typeof io !== 'undefined') {
      socket.on('receive_dm', async (data) => {
        const me = localStorage.getItem('savedUsername') || '';
        const { from, to } = data || {};

        // If we are currently chatting with this person (as the recipient or the sender)
        if (activeFriendChat && typeof activeFriendChat === 'string') {
          if ((from === me && to === activeFriendChat) || (to === me && from === activeFriendChat)) {
            // Deduplication Check (Memory + DOM)
            if (data.id) {
              if (processedMessageIds.has(data.id) || document.querySelector(`[data-msg-id="${data.id}"]`)) return;
              processedMessageIds.add(data.id);
              // Clean up set occasionally (optional, but good practice to prevent excessive growth)
              if (processedMessageIds.size > 1000) {
                const it = processedMessageIds.values();
                processedMessageIds.delete(it.next().value);
              }
            }

            const el = await createDiscordMessage({ ...data, username: from });
            const msgsContainer = document.getElementById('friendsChatMessages');
            if (msgsContainer) {
              msgsContainer.appendChild(el);
              msgsContainer.scrollTop = msgsContainer.scrollHeight;
              feather.replace();
            }
          }
        }
      });
    }

    // Profile Functions (Kept as is, selectors still valid)
    // (loadStats, cropper logic, loadUserData, profile tab switching, etc... all kept as is)
    async function loadStats() {
      const baseUrl = window.location.origin;
      try {
        if (!navigator.onLine) throw new Error('offline');
        const res = await fetch(`${baseUrl}/api/stats`);
        const data = await res.json();
        document.getElementById("stat-users").textContent = data.users;
        document.getElementById("stat-messages").textContent = data.messages;
        document.getElementById("stat-rooms").textContent = data.rooms;
      } catch (err) { // Populate with cached or default values when offline
        document.getElementById("stat-users").textContent = localStorage.getItem('stat-users') || '0';
        document.getElementById("stat-messages").textContent = localStorage.getItem('stat-messages') || '0';
        document.getElementById("stat-rooms").textContent = localStorage.getItem('stat-rooms') || '1';
      }
    }

    let cropper = null;
    let currentTarget = null;

    function openCropper(event, targetType) {
      const file = event.target.files[0];
      if (!file) return;

      currentTarget = targetType;

      const reader = new FileReader();
      reader.onload = function (e) {
        const img = document.getElementById('cropperImage');
        img.src = e.target.result;
        document.getElementById('cropperModal').classList.remove('hidden');

        if (cropper) cropper.destroy();

        cropper = new Cropper(img, {
          aspectRatio: targetType === 'avatar' ? 1 : 16 / 5,
          viewMode: 1,
          dragMode: 'move',
          responsive: true,
        });

        const zoomSlider = document.getElementById('zoomSlider');
        if (zoomSlider) {
          zoomSlider.oninput = (ev) => {
            try {
              const level = parseFloat(ev.target.value || '1');
              if (cropper) cropper.zoomTo(level);
            } catch { }
          };
        }
      };
      reader.readAsDataURL(file);

      // reset file input so selecting the same file twice still triggers change
      event.target.value = "";
    }

    function rotateImage(deg) {
      if (cropper) cropper.rotate(deg);
    }

    function closeCropper() {
      cropper?.destroy();
      cropper = null;
      document.getElementById('cropperModal').classList.add('hidden');
      const z = document.getElementById('zoomSlider');  // also clear zoom slider back to default
      if (z) z.value = '1';
    }

    function applyCrop() {
      const canvas = cropper.getCroppedCanvas({
        width: currentTarget === 'avatar' ? 200 : 800,
        height: currentTarget === 'avatar' ? 200 : 250
      });

      const imageUrl = canvas.toDataURL('image/png');

      if (currentTarget === 'avatar') {
        document.getElementById('avatarImage').src = imageUrl;
        localStorage.setItem('avatar', imageUrl);
        const settingsAvatar = document.getElementById('settingsAvatar'); // Update settings avatar too
        if (settingsAvatar) settingsAvatar.src = imageUrl;
      } else if (currentTarget === 'banner') {
        document.getElementById('bannerImage').src = imageUrl;
        localStorage.setItem('banner', imageUrl);
        const settingsBanner = document.getElementById('settingsBanner'); // Update settings banner too
        if (settingsBanner) settingsBanner.src = imageUrl;
      }

      // Ask user if they want to use this image as background
      if (confirm(`Would you like to use this ${currentTarget} as your background image?`)) {
        localStorage.setItem('bgImageDataUrl', imageUrl);
        localStorage.setItem('themeMode', 'custom');  // Set theme mode to custom to show the background
        applyBackground();
        applyThemeMode('custom');
        alert('Background updated! You can change this anytime in Settings > Appearance.');
      }

      closeCropper();
      document.getElementById("saveProfileBtn").classList.remove("hidden");
      checkProfileChanges();
    }

    async function loadUserData() {
      const username = localStorage.getItem("username");
      if (!username) return;
      try {
        const res = await fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`);
        const data = await res.json();
        if (!data.success) { console.error("Failed to load user:", data.error); return; }
        const user = data.user || {};

        // Update Profile Tab
        document.getElementById("profileUsername").textContent = user.username || "N/A";
        document.getElementById("profileUsertag").textContent = user.usertag || "N/A";
        document.getElementById("avatarImage").src = user.avatar || "/images/default_avatar.png";
        document.getElementById("bannerImage").src = user.banner || "/images/default_banner.png";

        // Update User Panel
        document.getElementById("userPanelUsername").textContent = user.username || "N/A";
        document.getElementById("userPanelUsertag").textContent = user.usertag || "N/A";
        document.getElementById("userPanelAvatar").src = user.avatar || "/images/default_avatar.png";

        // Update Settings Tab
        const settingsAvatar = document.getElementById("settingsAvatar");
        const settingsBanner = document.getElementById("settingsBanner");
        if (settingsAvatar) settingsAvatar.src = user.avatar || "/images/default_avatar.png";
        if (settingsBanner) settingsBanner.src = user.banner || "/images/default_banner.png";

        const shortBioText = (user.about && String(user.about).trim()) || "";
        const aboutText = (user.aboutMe && String(user.aboutMe).trim()) || "This user haven't said anything about them self yet...";
        const profileBio = document.getElementById("profileBio");
        const profileAboutBio = document.getElementById("profileAboutBio");
        if (profileBio) profileBio.textContent = shortBioText || aboutText;
        if (profileAboutBio) profileAboutBio.textContent = aboutText;

        if (user.settings) {
          const avatarEffect = user.settings.profileEffect || 'none';
          const bannerEffect = user.settings.bannerEffect || 'none';
          setTimeout(() => {
            applyAvatarEffect(avatarEffect);
            applyBannerEffect(bannerEffect);
          }, 100);
        }
        checkProfileViewingUser();
        loadProfileAboutTab();
      } catch (err) {
        console.error("Error fetching user data", err);
      }
    }

    // Public function to view a profile in the main tab
    function viewUserProfile(username) {
      if (!username) return;
      switchTab('profile');
      loadUserData(username);

      // Auto-switch to About tab
      setTimeout(() => {
        const firstTab = document.querySelector('#profileTabs .profile-tab');
        if (firstTab) firstTab.click();
      }, 100);
    }

    // Check if viewing another user's profile and if they're a friend
    async function checkProfileViewingUser() {
      const currentUsername = localStorage.getItem("username");
      const profileUsername = document.getElementById("profileUsername")?.textContent;

      if (!profileUsername || profileUsername === "N/A" || profileUsername === currentUsername) {
        const actionButtons = document.getElementById("profileActionButtons"); // Own profile - hide buttons
        if (actionButtons) actionButtons.style.display = "none";
        return;
      }

      // Check if they're friends
      try {
        const res = await fetch(`/api/friends?username=${encodeURIComponent(currentUsername)}`);
        const data = await res.json();
        if (data.success) {
          const isFriend = (data.friends || []).includes(profileUsername);
          const actionButtons = document.getElementById("profileActionButtons");
          const messageBtn = document.getElementById("profileMessageBtn");
          const addFriendBtn = document.getElementById("profileAddFriendBtn");

          if (actionButtons) {
            if (isFriend) { // Show only message button
              if (messageBtn) messageBtn.style.display = "block";
              if (addFriendBtn) addFriendBtn.style.display = "none";
              actionButtons.style.display = "flex";
            } else { // Show add friend button
              if (messageBtn) messageBtn.style.display = "none";
              if (addFriendBtn) addFriendBtn.style.display = "block";
              actionButtons.style.display = "flex";
            }
          }
        }
      } catch (e) {
        console.error("Error checking friends:", e);
      }
    }

    function openDMFromProfile() {
      const profileUsername = document.getElementById("profileUsername")?.textContent;
      if (profileUsername) {
        switchTab('messages'); // The tab ID is 'messages'
        switchMessagesView('friends'); // Move to friends sub-panel
        openDM(profileUsername); // Open the specific DM
      }
    }

    async function addFriendFromProfile() {
      const currentUsername = localStorage.getItem("username");
      const profileUsername = document.getElementById("profileUsername")?.textContent;

      if (!currentUsername || !profileUsername) return;

      try {
        const res = await fetch('/api/friends/request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ from: currentUsername, to: profileUsername })
        });
        const data = await res.json();
        if (data.success) {
          alert('Friend request sent!');
          checkProfileViewingUser();
        } else {
          alert(data.error || 'Failed to send friend request');
        }
      } catch (e) {
        alert('Failed to send friend request');
      }
    }

    document.querySelectorAll("#profileTabs .profile-tab").forEach(btn => {
      btn.addEventListener("click", (e) => {
        if (btn.dataset.tab === 'effects') return; // Don't handle click if it's the effects button (handled by onclick)

        e.preventDefault();
        document.querySelectorAll("#profileTabs .profile-tab").forEach(b => b.classList.remove("active", "text-white"));
        btn.classList.add("active", "text-white");
        const tab = btn.dataset.tab;
        document.querySelectorAll("#profileTabContent .tab-pane").forEach(p => {
          p.classList.toggle("hidden", p.dataset.tab !== tab);
        });

        // Load tab-specific content
        if (tab === 'about') {
          loadProfileAboutTab();
        } else if (tab === 'friends') {
          loadMutualFriendsTab();
        } else if (tab === 'servers') {
          loadMutualServersTab();
        }
      });
    });

    function loadProfileAboutTab() {
      const username = localStorage.getItem("username");
      const profileUsername = document.getElementById("profileUsername")?.textContent;
      const targetUsername = profileUsername || username;

      if (!targetUsername) return;

      fetch(`/api/get-user?identifier=${encodeURIComponent(targetUsername)}`)
        .then(r => r.json())
        .then(data => {
          if (data.success && data.user) {
            const user = data.user;
            const profileAboutBio = document.getElementById("profileAboutBio");
            if (profileAboutBio) {
              profileAboutBio.textContent =
                (user.aboutMe && user.aboutMe.trim()) ||
                "This user haven't said anything about them self...";
            }
          }
        })
        .catch(() => { });
    }

    async function loadMutualFriendsTab() {
      const currentUsername = localStorage.getItem("username");
      const profileUsername = document.getElementById("profileUsername")?.textContent;

      if (!currentUsername || !profileUsername || currentUsername === profileUsername) {
        document.getElementById("mutualFriendsContent").textContent = "No mutual friends to show.";
        return;
      }

      try {
        const [currentRes, profileRes] = await Promise.all([
          fetch(`/api/friends?username=${encodeURIComponent(currentUsername)}`),
          fetch(`/api/friends?username=${encodeURIComponent(profileUsername)}`)
        ]);

        const currentData = await currentRes.json();
        const profileData = await profileRes.json();

        const currentFriends = new Set(currentData.friends || []);
        const profileFriends = new Set(profileData.friends || []);

        const mutual = [...currentFriends].filter(f => profileFriends.has(f));
        const container = document.getElementById("mutualFriendsContent");
        container.innerHTML = '';

        if (mutual.length === 0) {
          container.textContent = "No mutual friends to show.";
          return;
        }

        mutual.forEach(f => {
          const div = document.createElement('div');
          div.className = 'flex items-center gap-3 p-2 bg-discord-gray-900 rounded mb-2';
          div.innerHTML = `
            <img src="/images/default_avatar.png" class="w-8 h-8 rounded-full bg-discord-gray-700 row-avatar" data-username="${f}">
            <span class="text-white font-medium">${f}</span>
          `;
          // Async load avatar
          getUserAvatarUrl(f).then(url => {
            const img = div.querySelector('.row-avatar');
            if (img) img.src = url;
          });
          container.appendChild(div);
        });

      } catch (e) {
        document.getElementById("mutualFriendsContent").textContent = "Failed to load mutual friends.";
      }
    }

    async function loadMutualServersTab() {
      const currentUsername = localStorage.getItem("username");
      const profileUsername = document.getElementById("profileUsername")?.textContent;
      const container = document.getElementById("mutualServersContent");

      if (!container) return;

      // If viewing own profile, show all their servers
      if (!profileUsername || currentUsername === profileUsername) {
        container.innerHTML = '<div class="text-center py-8 text-discord-gray-400"><p>Viewing your own profile.</p></div>';
        try {
          const res = await fetch(`/api/groups/list?username=${encodeURIComponent(currentUsername)}`);
          const data = await res.json();
          const groups = data.groups || [];

          if (groups.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-discord-gray-400"><p>You are not a member of any servers.</p></div>';
            return;
          }

          container.innerHTML = '<h4 class="text-xs font-bold text-discord-gray-400 uppercase mb-3">Your Servers</h4>';
          groups.forEach(g => {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-3 p-2 bg-discord-gray-900 rounded mb-2 cursor-pointer hover:bg-discord-gray-800 transition';
            div.onclick = () => selectGroup(g.id);
            div.innerHTML = `
              <div class="w-10 h-10 rounded-full bg-discord-gray-700 flex items-center justify-center overflow-hidden">
                ${g.icon ? `<img src="${g.icon}" class="w-full h-full object-cover">` : `<span class="text-white font-bold">${(g.name || 'G')[0].toUpperCase()}</span>`}
              </div>
              <div>
                <span class="text-white font-medium">${g.name}</span>
                <p class="text-xs text-discord-gray-400">${(g.members || []).length} members</p>
              </div>
            `;
            container.appendChild(div);
          });
        } catch (e) {
          container.innerHTML = '<div class="text-center py-8 text-discord-gray-400"><p>Failed to load servers.</p></div>';
        }
        return;
      }

      // Viewing another user's profile - find mutual servers
      container.innerHTML = '<div class="text-center py-4 text-discord-gray-400"><i class="animate-pulse">Loading...</i></div>';

      try {
        const [currentRes, profileRes] = await Promise.all([
          fetch(`/api/groups/list?username=${encodeURIComponent(currentUsername)}`),
          fetch(`/api/groups/list?username=${encodeURIComponent(profileUsername)}`)
        ]);

        const currentData = await currentRes.json();
        const profileData = await profileRes.json();

        const currentGroups = currentData.groups || [];
        const profileGroups = profileData.groups || [];

        // Find mutual groups by ID
        const profileGroupIds = new Set(profileGroups.map(g => g.id));
        const mutualGroups = currentGroups.filter(g => profileGroupIds.has(g.id));

        container.innerHTML = '';

        if (mutualGroups.length === 0) {
          container.innerHTML = '<div class="text-center py-8 text-discord-gray-400"><i data-feather="server" class="w-12 h-12 mx-auto mb-3 opacity-20"></i><p>No mutual servers with this user.</p></div>';
          feather.replace();
          return;
        }

        const header = document.createElement('h4');
        header.className = 'text-xs font-bold text-discord-gray-400 uppercase mb-3';
        header.textContent = `${mutualGroups.length} Mutual Server${mutualGroups.length > 1 ? 's' : ''}`;
        container.appendChild(header);

        mutualGroups.forEach(g => {
          const div = document.createElement('div');
          div.className = 'flex items-center gap-3 p-2 bg-discord-gray-900 rounded mb-2 cursor-pointer hover:bg-discord-gray-800 transition';
          div.onclick = () => selectGroup(g.id);
          div.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-discord-gray-700 flex items-center justify-center overflow-hidden">
              ${g.icon ? `<img src="${g.icon}" class="w-full h-full object-cover">` : `<span class="text-white font-bold">${(g.name || 'G')[0].toUpperCase()}</span>`}
            </div>
            <div>
              <span class="text-white font-medium">${g.name}</span>
              <p class="text-xs text-discord-gray-400">${(g.members || []).length} members</p>
            </div>
          `;
          container.appendChild(div);
        });

      } catch (e) {
        container.innerHTML = '<div class="text-center py-8 text-discord-gray-400"><p>Failed to load mutual servers.</p></div>';
        console.error('Mutual servers error:', e);
      }
    }


    function openProfileEffectsModal() {
      const modal = document.getElementById('profileEffectsModal');
      if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');

        // Load current effects
        const username = localStorage.getItem("username");
        fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`)
          .then(r => r.json())
          .then(data => {
            if (data.success && data.user && data.user.settings) {
              const settings = data.user.settings;
              const avatarEffect = settings.profileEffect || 'none';
              const bannerEffect = settings.bannerEffect || 'none';

              document.querySelector(`input[name="avatarEffect"][value="${avatarEffect}"]`).checked = true;
              document.querySelector(`input[name="bannerEffect"][value="${bannerEffect}"]`).checked = true;
            }
          })
          .catch(() => { });

        feather.replace();
      }
    }

    function closeProfileEffectsModal() {
      const modal = document.getElementById('profileEffectsModal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }
    }

    async function applyProfileEffects() {
      const avatarEffect = document.querySelector('input[name="avatarEffect"]:checked')?.value || 'none';
      const bannerEffect = document.querySelector('input[name="bannerEffect"]:checked')?.value || 'none';
      const username = localStorage.getItem("username");

      if (!username) return;

      try {
        const res = await fetch('/api/update-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username,
            settings: {
              profileEffect: avatarEffect,
              bannerEffect: bannerEffect
            }
          })
        });

        const data = await res.json();
        if (data.success) {
          alert('Profile effects applied successfully!');
          closeProfileEffectsModal();
          setTimeout(() => { // Apply effects immediately to DOM
            applyAvatarEffect(avatarEffect);
            applyBannerEffect(bannerEffect);
          }, 100);
          loadUserData(); // Reload user data to ensure sync
        } else {
          alert(data.error || 'Failed to apply effects');
        }
      } catch (e) {
        alert('Failed to apply effects');
      }
    }

    function startEditBio() {
      const el = document.getElementById('profileBio');
      if (!el) return;
      const current = (el.tagName.toLowerCase() === 'input' || el.tagName.toLowerCase() === 'textarea') ? el.value : el.textContent.trim();
      const input = document.createElement('input');  // Replace the <p> with an <input> (same id so saveProfileChanges reads it)
      input.id = 'profileBio';
      input.type = 'text';
      input.className = 'w-full border px-3 py-2 rounded-md bg-gray-900 text-white';
      input.value = current === PLACEHOLDER_BIO ? '' : current;
      el.replaceWith(input);
      showInlineEditControls('bio');  // show save/cancel controls
      input.focus();
    }

    function startEditAbout() {
      const el = document.getElementById('profileAboutBio');
      if (!el) return;
      const current = el.tagName.toLowerCase() === 'textarea' ? el.value : el.textContent.trim();
      const ta = document.createElement('textarea');  // Replace the <p> with a <textarea id="aboutMe"> so existing code reads it
      ta.id = 'aboutMe'; // reuse aboutMe id so saveProfileChanges/readers pick it
      ta.rows = 6;
      ta.className = 'w-full border px-3 py-2 rounded-md bg-gray-900 text-white';
      ta.value = current === PLACEHOLDER_ABOUT ? '' : current;
      el.replaceWith(ta);
      showInlineEditControls('about');
      ta.focus();
    }

    function showInlineEditControls(kind) {
      // Remove existing controls first
      const existing = document.getElementById(`inlineEditControls_${kind}`);
      if (existing) existing.remove();

      const container = document.createElement('div');
      container.className = 'inline-edit-controls mt-2 flex gap-2';
      container.id = `inlineEditControls_${kind}`;

      const save = document.createElement('button');
      save.className = 'px-3 py-1 bg-blue-600 rounded text-white';
      save.textContent = 'Save';
      save.onclick = async () => {
        try {
          const result = await saveProfileChanges();
          await new Promise(res => setTimeout(res, 120)); // allow DOM update
          hideInlineEditControls('bio', result);
          hideInlineEditControls('about', result);
          if (result?.success && typeof showToast !== 'undefined') {
            showToast('Profile updated');
          }
        } catch (e) {
          console.error('Save failed', e);
          alert('Failed to save profile');
        }
      };

      const cancel = document.createElement('button');
      cancel.className = 'px-3 py-1 bg-gray-600 rounded text-white';
      cancel.textContent = 'Cancel';
      cancel.onclick = () => cancelInlineEdit(kind);

      container.append(save, cancel);

      // Insert controls under the correct element
      let el;
      if (kind === 'bio') {
        el = document.getElementById('profileBio');
      } else {
        el = document.getElementById('aboutMe') || document.getElementById('profileAboutBio');
      }

      if (el) {
        el.insertAdjacentElement('afterend', container);
      } else {
        console.warn(`Cannot show inline edit controls, element not found for kind: ${kind}`);
      }
    }

    const PLACEHOLDER_BIO = "This user haven't said anything about them self yet...";
    const PLACEHOLDER_ABOUT = "This user haven't said anything about them self yet...";

    function hideInlineEditControls(kind, result) {
      const controls = document.getElementById(`inlineEditControls_${kind}`);
      if (controls) controls.remove();

      if (kind === 'bio') {
        const el = document.getElementById('profileBio');
        if (!el) return;

        const val = (result?.bio != null) ? result.bio.trim() : PLACEHOLDER_BIO;

        const p = document.createElement('p');
        p.id = 'profileBio';
        p.className = 'text-gray-300 truncate';
        p.textContent = val;
        el.replaceWith(p);

      } else if (kind === 'about') {
        const el = document.getElementById('aboutMe') || document.getElementById('profileAboutBio');
        if (!el) return;

        const val = (result?.about != null) ? result.about.trim() : PLACEHOLDER_ABOUT;

        const p = document.createElement('p');
        p.id = 'profileAboutBio';
        p.className = 'text-gray-300 whitespace-pre-wrap';
        p.textContent = val;
        el.replaceWith(p);
      }

      try { feather.replace(); } catch { }
    }

    function cancelInlineEdit(kind) {
      if (kind === 'bio') {
        const display = document.getElementById('settingsProfileBioDisplay');
        const val = display?.textContent?.trim() || PLACEHOLDER_BIO;
        const el = document.getElementById('profileBio');
        if (el) {
          const p = document.createElement('p');
          p.id = 'profileBio';
          p.className = 'text-gray-300 truncate';
          p.textContent = val;
          el.replaceWith(p);
        }
      } else {
        const display = document.getElementById('settingsAboutMeDisplay');
        const val = display?.textContent?.trim() || PLACEHOLDER_ABOUT;
        const el = document.getElementById('aboutMe') || document.getElementById('profileAboutBio');
        if (el) {
          const p = document.createElement('p');
          p.id = 'profileAboutBio';
          p.className = 'text-gray-300 whitespace-pre-wrap';
          p.textContent = val;
          el.replaceWith(p);
        }
      }

      hideInlineEditControls(kind);
    }

    /// Optional Status Functions
    function toRoman(num) {
      const roman = ["", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X"];
      return roman[num] || num;
    }

    function getSubTier(levelInRange, rangeSize, maxTier) {
      const tierSize = rangeSize / maxTier;
      let tier = Math.ceil(levelInRange / tierSize);
      if (tier < 1) tier = 1;
      if (tier > maxTier) tier = maxTier;
      return tier;
    }

    function getRank(level) {
      if (level <= 25) return `Stone ${toRoman(getSubTier(level, 25, 5))}`;
      if (level <= 55) return `Metal ${toRoman(getSubTier(level - 25, 30, 5))}`;
      if (level <= 80) return `Gold ${toRoman(getSubTier(level - 55, 25, 5))}`;
      if (level <= 110) return `Mithril ${toRoman(getSubTier(level - 80, 30, 7))}`;
      if (level <= 150) return `Black Mithril ${toRoman(getSubTier(level - 110, 40, 10))}`;

      // Master tier logic
      let masterLevel = level - 150;
      if (masterLevel <= 100) {
        return `Master ${toRoman(getSubTier(masterLevel, 100, 5))}`;
      } else if (masterLevel <= 200) {
        return `Grand Master ${toRoman(getSubTier(masterLevel - 100, 100, 5))}`;
      } else {
        return level >= 450 ? "Master Slayer" : `Grand Master ${toRoman(5)}`; // Level 450 special rank
      }
    }

    function getRankColor(rank) {
      const lowered = String(rank || '').toLowerCase();
      if (lowered.startsWith("stone")) return "#808080"; // gray
      if (lowered.startsWith("metal")) return "#a8a9ad"; // silver
      if (lowered.startsWith("gold")) return "#FFD700"; // gold yellow
      if (lowered.startsWith("mithril") && !lowered.startsWith("black")) return "#87CEFA"; // light blue
      if (lowered.startsWith("black mithril")) return "#4682B4"; // dark light blue
      if (lowered.startsWith("grand master")) return "#4B0082"; // dark purple
      if (lowered.startsWith("master slayer")) return "#FF4500"; // Bright orange-red
      if (lowered.startsWith("master")) return "#800080"; // purple
      return "#ffffff"; // default white
    }

    // Removed hidden stat hotkey handler
    const saveBtn = document.getElementById("saveProfileBtn");
    let initialProfileData = {};

    async function saveProfileChanges() {
      const username = localStorage.getItem("username");
      if (!username) return alert("No username found in local storage!");

      try {
        // Fetch current user data
        const resUser = await fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`);
        const userData = await resUser.json();
        if (!userData.success) return alert("User not found!");

        const usertag = userData.user?.usertag || '';
        const rawTag = String(usertag).replace(/^@+/, '');

        const readText = (el) => {
          if (!el) return "";
          const tag = el.tagName?.toLowerCase();
          if (tag === "input" || tag === "textarea") return (el.value || "").trim();
          return (el.textContent || "").trim();
        };

        // Short bio
        const shortBioInput = document.getElementById("settingsProfileBio") ||
          (document.getElementById("profileBio")?.tagName === 'INPUT' ? document.getElementById("profileBio") : null);
        const shortBioDisplay = document.getElementById("settingsProfileBioDisplay") || document.getElementById("profileBio");

        let shortBioRaw = (shortBioInput?.value || shortBioDisplay?.textContent || "").trim();
        if (shortBioRaw === PLACEHOLDER_BIO || shortBioRaw === PLACEHOLDER_ABOUT) shortBioRaw = "";
        const shortBio = shortBioRaw;

        // Long bio
        const aboutInput = document.getElementById("settingsAboutMe") || document.getElementById("aboutMe");
        const aboutDisplay = document.getElementById("settingsAboutMeDisplay") || document.getElementById("profileAboutBio");

        let aboutMeValue = (aboutInput?.tagName === 'TEXTAREA' || aboutInput?.tagName === 'INPUT' ? aboutInput.value : aboutDisplay?.textContent || "").trim();
        if (aboutMeValue === PLACEHOLDER_ABOUT) aboutMeValue = "";

        console.log('Saving profile - shortBio:', shortBio, 'aboutMe:', aboutMeValue);

        // Build payload
        const currentServer = userData.user || {};
        const payload = {
          username,
          usertag: rawTag ? '@' + rawTag : '',
          avatar: document.getElementById("avatarImage")?.src || currentServer.avatar || '',
          banner: document.getElementById("bannerImage")?.src || currentServer.banner || '',
          about: shortBio,
          aboutMe: aboutMeValue
        };
        console.log('Sending update request:', payload);

        // Send update
        const res = await fetch(`/api/update-profile`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`Failed to save profile: ${res.statusText}`);
        const data = await res.json();

        if (!data.success) throw new Error(data.message || 'Failed to save profile');

        const updated = data.user || {};

        const returnedShort = (typeof data.user?.about !== 'undefined' && data.user.about?.trim() !== '')
          ? data.user.about.trim()
          : shortBio;

        const returnedLong = (typeof data.user?.aboutMe !== 'undefined' && data.user.aboutMe?.trim() !== '')
          ? data.user.aboutMe.trim()
          : aboutMeValue;

        // Update UI
        document.getElementById("profileUsername").textContent = updated.username || payload.username;
        const showTag = (updated.usertag || payload.usertag || '').replace(/^@+/, '');
        document.getElementById("profileUsertag").textContent = showTag ? '@' + showTag : '';
        document.getElementById("avatarImage").src = updated.avatar || payload.avatar;
        document.getElementById("bannerImage").src = updated.banner || payload.banner;

        const profileBio = document.getElementById("profileBio");
        if (profileBio) profileBio.textContent = returnedShort || PLACEHOLDER_BIO;

        const profileAboutBio = document.getElementById("profileAboutBio");
        if (profileAboutBio) profileAboutBio.textContent = returnedLong || PLACEHOLDER_ABOUT;

        // Sync settings inputs
        const inShort = document.getElementById("settingsProfileBio");
        const inLong = document.getElementById("settingsAboutMe");
        if (inShort) inShort.value = returnedShort;
        if (inLong) inLong.value = returnedLong;

        const dispShort = document.getElementById("settingsProfileBioDisplay");
        const dispLong = document.getElementById("settingsAboutMeDisplay");
        if (dispShort) dispShort.textContent = returnedShort || PLACEHOLDER_BIO;
        if (dispLong) dispLong.textContent = returnedLong || PLACEHOLDER_ABOUT;

        const editorAbout = document.getElementById("aboutMe");
        if (editorAbout) {
          if (editorAbout.tagName.toLowerCase() === "textarea" || editorAbout.tagName.toLowerCase() === "input") {
            editorAbout.value = returnedLong;
          } else {
            editorAbout.textContent = returnedLong;
          }
        }

        captureInitialProfileData?.();
        const sp = document.getElementById("saveProfileBtn");
        if (sp) sp.classList.add("hidden");

        return { success: true, bio: returnedShort, about: returnedLong };

      } catch (err) {
        console.error("Error saving profile:", err);
        alert("An error occurred while saving profile. Check console.");
        throw err;
      }
    }

    function captureInitialProfileData() {
      initialProfileData = {
        aboutMe: document.getElementById("aboutMe")?.value.trim(),
        banner: document.getElementById("bannerImage").src,
        avatar: document.getElementById("avatarImage").src
      };
    }
    captureInitialProfileData();

    function checkProfileChanges() {
      const currentData = {
        aboutMe: document.getElementById("aboutMe")?.value.trim(),
        banner: document.getElementById("bannerImage").src,
        avatar: document.getElementById("avatarImage").src
      };
      const hasChanges = JSON.stringify(currentData) !== JSON.stringify(initialProfileData);
      saveBtn.classList.toggle("hidden", !hasChanges);
    }

    // Watch for changes
    const elAbout = document.getElementById("aboutMe");
    if (elAbout) elAbout.addEventListener("input", checkProfileChanges);

    const elProfileBanner = document.getElementById("profileBannerUpload");
    if (elProfileBanner) elProfileBanner.addEventListener("change", (e) => openCropper(e, "banner"));

    const elProfileAvatar = document.getElementById("profileAvatarUpload");
    if (elProfileAvatar) elProfileAvatar.addEventListener("change", (e) => openCropper(e, "avatar"));

    const elSettingsBanner = document.getElementById("settingsBannerUpload");
    if (elSettingsBanner) elSettingsBanner.addEventListener("change", (e) => openCropper(e, "banner"));

    const elSettingsAvatar = document.getElementById("settingsAvatarUpload");
    if (elSettingsAvatar) elSettingsAvatar.addEventListener("change", (e) => openCropper(e, "avatar"));

    function promptUsernameEdit() {
      const current = localStorage.getItem('username') || '';
      const next = prompt('Enter new username', current || '');
      if (!next || next === current) return;
      const curEl = document.getElementById('currentUsername');
      if (curEl) curEl.textContent = next;
      updateUsername(next);
    }
    function promptUsertagEdit() {
      const current = (localStorage.getItem('usertag') || '').replace('@', '');
      const next = prompt('Enter new 4-digit usertag', current || '');
      if (!next) return;
      updateUsertag(next);
    }
    function promptEmailEdit() {
      const current = localStorage.getItem('savedEmail') || '';
      const next = prompt('Enter new email', current || '');
      if (!next) return;
      updateEmail(next);
    }

    // Account settings quick view
    (function hydrateAccountSettings() {
      const username = localStorage.getItem('username');
      if (!username) return;

      // Load from API to get latest data
      fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`)
        .then(r => r.json())
        .then(data => {
          if (data.success && data.user) {
            const user = data.user;
            const uEl = document.getElementById('currentUsername');
            if (uEl) uEl.textContent = user.username || '';
            const tEl = document.getElementById('currentUsertag');
            if (tEl) tEl.textContent = user.usertag || '';
            const eEl = document.getElementById('currentEmail');
            if (eEl) eEl.textContent = user.email || 'Hidden';
            const sa = document.getElementById('settingsAvatar');
            if (sa) sa.src = user.avatar || '/images/default_avatar.png';
            const sb = document.getElementById('settingsBanner');
            if (sb) sb.src = user.banner || '/images/default_banner.png';
            const pe = document.getElementById('profileEmail');
            if (pe) pe.textContent = user.email || 'Hidden';
            const lang = localStorage.getItem('language') || 'en';
            const sl = document.getElementById('settingsLanguage');
            if (sl) sl.value = lang;
            const pl = document.getElementById('profileLanguage');
            if (pl) pl.value = lang;
            const aboutMe = document.getElementById('settingsAboutMe');
            if (aboutMe) aboutMe.value = user.aboutMe || '';
            // also prefill short bio input
            const shortBio = document.getElementById('settingsProfileBio');
            if (shortBio) shortBio.value = user.about || '';

            // Track account settings changes
            trackAccountSettingsChanges();
          }
        })
        .catch(() => { });

      try { feather.replace(); } catch { }
    })();

    let accountSettingsChanged = false;
    let originalAccountSettings = {};

    function trackAccountSettingsChanges() {
      const username = localStorage.getItem('username');
      if (!username) return;

      // Store original values
      originalAccountSettings = {
        username: document.getElementById('currentUsername')?.textContent || '',
        usertag: document.getElementById('currentUsertag')?.textContent || '',
        email: document.getElementById('currentEmail')?.textContent || '',
        avatar: document.getElementById('settingsAvatar')?.src || '',
        banner: document.getElementById('settingsBanner')?.src || '',
        aboutMe: document.getElementById('settingsAboutMe')?.value || ''
      };

      // Watch for changes in avatar/banner uploads and about me
      const settingsAvatarUpload = document.getElementById('settingsAvatarUpload');
      const settingsBannerUpload = document.getElementById('settingsBannerUpload');
      const settingsAboutMe = document.getElementById('settingsAboutMe');

      if (settingsAvatarUpload) {
        settingsAvatarUpload.addEventListener('change', () => {
          accountSettingsChanged = true;
          updateAccountSaveButton();
        });
      }

      if (settingsBannerUpload) {
        settingsBannerUpload.addEventListener('change', () => {
          accountSettingsChanged = true;
          updateAccountSaveButton();
        });
      }

      if (settingsAboutMe) {
        settingsAboutMe.addEventListener('input', () => {
          accountSettingsChanged = true;
          updateAccountSaveButton();
        });
      }
    }

    function updateAccountSaveButton() {
      const saveBtn = document.getElementById('saveAccountSettingsBtn');
      if (saveBtn) {
        saveBtn.style.display = accountSettingsChanged ? 'block' : 'none';
      }
    }

    // Update account settings save function - hook into existing confirmSaveSettings
    if (typeof window.confirmSaveSettings === 'function') {
      const originalConfirmSaveSettings = window.confirmSaveSettings;
      window.confirmSaveSettings = function () {
        originalConfirmSaveSettings();
        if (accountSettingsChanged) {  // Also save account settings if changed
          saveAccountSettings();
        }
      };
    } else {
      window.confirmSaveSettings = function () {
        if (accountSettingsChanged) { // Also save account settings if changed
          saveAccountSettings();
        }
      };
    }

    async function saveAccountSettings() {
      const username = localStorage.getItem('username');
      if (!username) return;

      const avatar = document.getElementById('settingsAvatar')?.src || '';
      const banner = document.getElementById('settingsBanner')?.src || '';
      const shortBio = (document.getElementById('settingsProfileBio')?.value || '').trim();
      const aboutMe = (document.getElementById('settingsAboutMe')?.value || '').trim();

      // Convert data URLs to base64 if needed
      let avatarData = avatar;
      let bannerData = banner;

      if (avatar.startsWith('data:')) {
        avatarData = avatar;
      } else if (avatar.startsWith('/uploads/')) {
        avatarData = avatar;
      }

      if (banner.startsWith('data:')) {
        bannerData = banner;
      } else if (banner.startsWith('/uploads/')) {
        bannerData = banner;
      }

      try {
        const res = await fetch('/api/update-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username,
            avatar: avatarData,
            banner: bannerData,
            about: shortBio,   // send short bio as 'about'
            aboutMe: aboutMe   // send long about as 'aboutMe'
          })
        });

        const data = await res.json();
        if (data.success) {
          accountSettingsChanged = false;
          updateAccountSaveButton();

          const updated = data.user || {};
          const displayedShort = (updated.about && String(updated.about).trim()) || shortBio || "This user haven't said anything about them self...";
          const displayedLong = (updated.aboutMe && String(updated.aboutMe).trim()) || aboutMe || "This user haven't said anything about them self...";

          const elShort = document.getElementById('profileBio');
          const elLong = document.getElementById('profileAboutBio');

          if (elShort) elShort.textContent = displayedShort;
          if (elLong) elLong.textContent = displayedLong;

          // Also update inputs (keep UI in sync)
          const inShort = document.getElementById('settingsProfileBio');
          const inLong = document.getElementById('settingsAboutMe');
          if (inShort) inShort.value = displayedShort === "This user haven't said anything about them self..." ? '' : displayedShort;
          if (inLong) inLong.value = displayedLong === "This user haven't said anything about them self..." ? '' : displayedLong;

          // Refresh any cached user data if you have a loader
          if (typeof loadUserData === 'function') loadUserData();

          // Reload account settings UI
          hydrateAccountSettings();
        }
      } catch (e) {
        console.error('Failed to save account settings:', e);
      }
    }

    // Files Functions
    const files = [
      { name: "Zylo_v1.5.7", sizeMB: 94.1, filename: "Zylo_v1.5.7.zip" },
      { name: "Zylo_v1.6.1", sizeMB: 92.1, filename: "Zylo_v1.6.1.zip" },
      { name: "Zylo_v1.6.2", sizeMB: 88.1, filename: "Zylo_v1.6.2.zip" }
    ];

    let estimatedTimes = {};

    function estimateTimes() {
      const speedMbps = parseFloat(document.getElementById('speed').value);
      if (!speedMbps || speedMbps <= 0) {
        alert("Please enter a valid internet speed.");
        return;
      }

      files.forEach(file => {
        const estimatedSeconds = (file.sizeMB * 8) / speedMbps;
        estimatedTimes[file.filename] = estimatedSeconds;
        const timeDisplay = document.getElementById(`time-${file.filename}`);
        if (timeDisplay) {
          timeDisplay.innerText = `‚è±Ô∏è Estimated time : ${estimatedSeconds.toFixed(1)} seconds`;
        }
      });
    }

    function startDownload(filename) {
      const progressBar = document.getElementById(`progress-${filename}`);
      const estimatedTime = estimatedTimes[filename] || 5;
      let progress = 0;
      const interval = 100;
      const increment = 100 / ((estimatedTime * 1000) / interval);

      progressBar.style.width = '0%';
      progressBar.classList.remove('bg-green-500');
      const timer = setInterval(() => {
        progress += increment;
        if (progress >= 100) {
          progress = 100;
          clearInterval(timer);
          progressBar.classList.add('bg-green-500');
        }
        progressBar.style.width = `${progress}%`;
      }, interval);

      // Trigger actual download
      const a = document.createElement('a');
      a.href = `/files/${filename}`;
      a.download = filename;
      a.click();
    }

    function renderDownloads() {
      const container = document.getElementById('downloads');
      if (!container) return;
      container.innerHTML = '';
      renderFilesReworked('downloads');
    }

    function renderFilesReworked(containerId = 'filesListContainer') {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';

      if (files.length === 0) {
        container.innerHTML = `
          <div class="col-span-full py-12 text-center text-discord-gray-500">
            <i data-feather="folder" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
            <p>No files found.</p>
          </div>
        `;
        feather.replace();
        return;
      }

      files.forEach(file => {
        const card = document.createElement('div');
        card.className = 'bg-discord-gray-800 rounded-lg p-4 border border-discord-gray-900 hover:border-discord-blurple transition-all group relative overflow-hidden';

        card.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="p-3 rounded-lg bg-discord-gray-900 text-discord-blurple group-hover:bg-discord-blurple group-hover:text-white transition-colors">
              <i data-feather="package" class="w-6 h-6"></i>
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="text-white font-semibold truncate" title="${file.name}">${file.name}</h3>
              <p class="text-discord-gray-400 text-xs">${file.sizeMB} MB ‚Ä¢ zip</p>
            </div>
          </div>
          <div class="mt-4 flex gap-2">
            <button onclick="startDownload('${file.filename}')" class="flex-1 py-1.5 rounded bg-discord-gray-700 hover:bg-discord-gray-600 text-white text-xs font-medium transition">
              Download
            </button>
            <button class="p-1.5 rounded bg-discord-gray-700 hover:bg-red-500/20 hover:text-red-500 text-discord-gray-400 transition" title="Info">
              <i data-feather="info" class="w-4 h-4"></i>
            </button>
          </div>
        `;
        container.appendChild(card);
      });
      feather.replace();
    }

    window.refreshFilesList = () => renderFilesReworked('filesListContainer');

    renderDownloads();

    /// Settings Functions (Kept as is)
    let settingsChanged = false;
    let pendingSettingsChanges = {};
    let originalSettings = {};

    // Initialize original settings
    function initializeOriginalSettings() {

      // General settings
      settingsMap.forEach(({ key }) => {
        const el = document.getElementById(key.replace('Toggle', '').replace('Select', ''));
        if (el) {
          originalSettings[key] = el.type === 'checkbox' ? el.checked : el.value;
        }
      });

      // Sound settings
      soundSettingsMap.forEach(({ key }) => {
        const el = document.getElementById(key);
        if (el) {
          originalSettings[key] = el.type === 'checkbox' ? el.checked : el.value;
        }
      });
    }

    // Check if settings have changed
    function checkSettingsChanges() {
      let hasChanges = false;
      pendingSettingsChanges = {};

      // Check general settings
      settingsMap.forEach(({ key }) => {
        const el = document.getElementById(key.replace('Toggle', '').replace('Select', ''));
        if (el) {
          const currentValue = el.type === 'checkbox' ? el.checked : el.value;
          const originalValue = originalSettings[key];

          if (currentValue !== originalValue) {
            hasChanges = true;
            pendingSettingsChanges[key] = currentValue;
          }
        }
      });

      // Check sound settings
      soundSettingsMap.forEach(({ key }) => {
        const el = document.getElementById(key);
        if (el) {
          const currentValue = el.type === 'checkbox' ? el.checked : el.value;
          const originalValue = originalSettings[key];

          if (currentValue !== originalValue) {
            hasChanges = true;
            pendingSettingsChanges[key] = currentValue;
          }
        }
      });

      settingsChanged = hasChanges;
      updateSaveButtonVisibility();
    }

    // Update save button visibility
    function updateSaveButtonVisibility() {
      const generalSaveBtn = document.getElementById('saveSettingsBtn');
      const soundSaveBtn = document.getElementById('saveSoundSettingsBtn');
      const accountSaveBtn = document.getElementById('saveAccountSettingsBtn');

      if (generalSaveBtn) {
        generalSaveBtn.style.display = settingsChanged ? 'block' : 'none';
      }
      if (soundSaveBtn) {
        soundSaveBtn.style.display = settingsChanged ? 'block' : 'none';
      }
      if (accountSaveBtn) {
        accountSaveBtn.style.display = settingsChanged ? 'block' : 'none';
      }
    }

    // Show save confirmation modal
    function showSaveSettingsModal() {
      const modal = document.getElementById('saveSettingsModal');
      if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
      }
    }

    // Hide save confirmation modal
    function hideSaveSettingsModal() {
      const modal = document.getElementById('saveSettingsModal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }
    }

    // Confirm save settings
    window.confirmSaveSettings = function () {
      saveAllSettings();
      hideSaveSettingsModal();
    };

    // Discard settings changes
    window.discardSettingsChanges = function () {
      // Revert to original settings
      settingsMap.forEach(({ key }) => {
        const el = document.getElementById(key.replace('Toggle', '').replace('Select', ''));
        if (el) {
          const originalValue = originalSettings[key];
          if (el.type === 'checkbox') {
            el.checked = originalValue;
          } else {
            el.value = originalValue;
          }
        }
      });

      settingsChanged = false;
      pendingSettingsChanges = {};
      updateSaveButtonVisibility();
      hideSaveSettingsModal();
    };

    // Cancel save settings
    window.cancelSaveSettings = function () {
      hideSaveSettingsModal();
    };

    // Save all settings
    async function saveAllSettings() { // Save general settings
      const saveBtn = document.getElementById('saveSettingsBtn');
      if (saveBtn) {
        saveBtn.innerHTML = '<button class="w-full px-4 py-2 bg-discord-blurple text-white rounded-lg opacity-50 cursor-not-allowed">Saving...</button>';
      }

      // Save general settings
      settingsMap.forEach(({ key }) => {
        const el = document.getElementById(key.replace('Toggle', '').replace('Select', ''));
        if (el) {
          const value = el.type === 'checkbox' ? el.checked : el.value;
          localStorage.setItem(key, value);
          originalSettings[key] = value;
        }
      });

      // Save sound settings
      soundSettingsMap.forEach(({ key }) => {
        const el = document.getElementById(key);
        if (el) {
          const value = el.type === 'checkbox' ? el.checked : el.value;
          localStorage.setItem(key, value);
          originalSettings[key] = value;
        }
      });

      // Persist General to backend
      persistSettings(pendingSettingsChanges);

      // Persist Account Settings
      if (typeof persistAccountSettings === 'function') {
        await persistAccountSettings();
      }

      settingsChanged = false;
      pendingSettingsChanges = {};

      const modal = document.getElementById('saveSettingsModal');
      modal.classList.add('hidden');

      // Refresh save buttons
      updateSaveButtonVisibility();

      // Also hide account/sound save buttons if any
      const acctBtn = document.getElementById('saveAccountSettingsBtn');
      if (acctBtn) acctBtn.style.display = 'none';
      const soundBtn = document.getElementById('saveSoundSettingsBtn');
      if (soundBtn) soundBtn.style.display = 'none';

      // Show success message
      showSettingsSaveSuccess();
    }

    // Show save success message
    function showSettingsSaveSuccess() { // Create temporary success message
      const successMsg = document.createElement('div');
      successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fadeIn';
      successMsg.innerHTML = '<i data-feather="check-circle" class="w-4 h-4 inline mr-2"></i>Settings saved successfully!';
      document.body.appendChild(successMsg);

      // Replace feather icons
      feather.replace();

      // Remove after 3 seconds
      setTimeout(() => {
        successMsg.remove();
      }, 3000);
    }

    /// General Settings
    function persistSettings(partial) {
      const username = localStorage.getItem('username');
      if (!username) return;
      fetch('/api/update-settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, settings: partial })
      }).catch(() => { });
    }

    async function hydrateSettingsFromBackend() {
      const username = localStorage.getItem('username');
      if (!username) return;
      try {
        const resp = await fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`);
        const data = await resp.json();
        if (!data?.success) return;
        const settings = data.user?.settings || {};
        Object.entries(settings).forEach(([k, v]) => { // Merge backend settings into localStorage without overwriting user's local changes for this session
          if (localStorage.getItem(k) == null) {
            localStorage.setItem(k, typeof v === 'boolean' ? String(v) : String(v));
          }
        });
      } catch { }
    }

    const settingsMap = [
      { id: "animationsToggle", key: "enableAnimations" },
      { id: "compactToggle", key: "compactMode" },
      { id: "tooltipToggle", key: "showTooltips" },
      { id: "languageSelect", key: "language" },
      { id: "startupPage", key: "startupPage" },
      { id: "autoSaveToggle", key: "autoSave" },
      { id: "confirmExitToggle", key: "confirmBeforeExit" }
    ];

    // Socket.IO Logic Extension
    function initSocket() {
      if (typeof socket === 'undefined' || !socket) {
        console.warn("Socket not initialized yet");
        return;
      }

      // Join default community room
      socket.emit('join', { room: 'community' });

      // Listeners
      socket.on('message', (data) => {
        const container = document.getElementById('chatMessagesCommunity');
        if (container && data.room === 'community') {
          // Deduplication check
          if (data.id && document.querySelector(`[data-msg-id="${data.id}"]`)) {
            console.log('Duplicate message ignored:', data.id);
            return;
          }

          // Check if user is near bottom (within 150px)
          const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 150;

          createDiscordMessage(data).then(el => {
            if (data.id) el.setAttribute('data-msg-id', data.id);
            container.appendChild(el);

            if (isNearBottom) {
              container.scrollTop = container.scrollHeight;
            } else {
              showNewMessagesIndicator('community');
            }
          });
        }
      });

      socket.on('group_message', (data) => {
        if (typeof currentGroupId !== 'undefined' && currentGroupId === data.groupId) {
          const currentChannel = document.getElementById('groupChatChannelName')?.textContent || 'general';
          if (data.channel === currentChannel) {
            const container = document.getElementById('groupChatMessages');
            if (container) {
              createDiscordMessage(data.message).then(el => {
                container.appendChild(el);
                container.scrollTop = container.scrollHeight;
              });
            }
          }
        }
      });

      socket.on('receive_dm', (data) => {
        if (typeof activeFriendChat !== 'undefined' && activeFriendChat && (data.from === activeFriendChat || data.to === activeFriendChat)) {
          const container = document.getElementById('friendsChatMessages');
          if (container) {
            createDiscordMessage({ ...data, username: data.from }).then(el => {
              container.appendChild(el);
              container.scrollTop = container.scrollHeight;
            });
          }
        }
      });

      // User status tracking
      socket.on('user_status_change', (data) => {
        updateUserStatusIndicator(data.username, data.status);
      });

      // Register current user's status on connect
      const currentUser = localStorage.getItem('savedUsername');
      if (currentUser) {
        socket.emit('register_status', { username: currentUser });
      }

      // 6.1 WebSocket Connection Management
      let wasDisconnected = false;

      socket.on('disconnect', () => {
        console.log('Socket disconnected');
        wasDisconnected = true;
        showConnectionStatus('disconnected');
      });

      socket.on('connect', () => {
        if (wasDisconnected) {
          console.log('Socket reconnected');
          showConnectionStatus('connected');
          // Rejoin active rooms
          socket.emit('join', { room: 'community' });
          const user = localStorage.getItem('savedUsername');
          if (user) {
            socket.emit('register_status', { username: user });
            socket.emit('join_user', { username: user });
          }
        }
      });

      console.log("Socket listeners attached.");
    }

    // Connection status indicator (6.1)
    function showConnectionStatus(status) {
      let indicator = document.getElementById('connectionStatus');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'connectionStatus';
        indicator.className = 'fixed bottom-4 right-4 px-3 py-1 rounded-full text-xs font-medium z-50 transition-all shadow-lg';
        document.body.appendChild(indicator);
      }
      if (status === 'disconnected') {
        indicator.className = 'fixed bottom-4 right-4 px-3 py-1 rounded-full text-xs font-medium z-50 transition-all shadow-lg bg-red-500 text-white';
        indicator.textContent = '‚ö† Disconnected';
        indicator.style.display = 'block';
      } else {
        indicator.className = 'fixed bottom-4 right-4 px-3 py-1 rounded-full text-xs font-medium z-50 transition-all shadow-lg bg-green-500 text-white';
        indicator.textContent = '‚óè Connected';
        indicator.style.display = 'block';
        setTimeout(() => {
          if (indicator) indicator.style.display = 'none';
        }, 3000);
      }
    }

    // Update status indicator for a user in friends list / DM list
    function updateUserStatusIndicator(username, status) {
      const statusDot = document.querySelector(`[data-user-status="${username}"]`);
      if (statusDot) {
        if (status === 'online') {
          statusDot.classList.remove('bg-gray-500');
          statusDot.classList.add('bg-green-500');
        } else {
          statusDot.classList.remove('bg-green-500');
          statusDot.classList.add('bg-gray-500');
        }
      }
    }

    // 6.14 Message Search Logic
    function toggleSearchBar() {
      const searchBar = document.getElementById('chatSearchBar');
      if (searchBar) {
        searchBar.classList.toggle('hidden');
        if (!searchBar.classList.contains('hidden')) {
          document.getElementById('chatSearchInput')?.focus();
        }
      }
    }

    function searchMessages(query) {
      // Determine active container
      let container = document.getElementById('chatMessagesCommunity');
      if (currentChatRoom === 'friends') container = document.getElementById('friendsChatMessages');
      else if (currentChatRoom === 'group') container = document.getElementById('groupChatMessages');

      if (!container) return;

      const messages = container.querySelectorAll('[data-msg-id]');

      // Clear previous highlights
      container.querySelectorAll('.search-highlight').forEach(el => {
        el.classList.remove('search-highlight', 'bg-yellow-500/30');
      });

      if (!query || !query.trim()) return;

      const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'); // Escape special chars
      let found = 0;

      messages.forEach(msg => {
        // Search in message text and username
        const textEl = msg.querySelector('.text-discord-gray-100') || msg.querySelector('.msg-body-text') || msg.querySelector('p');
        const userEl = msg.querySelector('.font-bold') || msg.querySelector('.username') || msg.querySelector('[class*="font-semibold"]');

        const contentMatch = textEl && regex.test(textEl.textContent);
        const userMatch = userEl && regex.test(userEl.textContent);

        if (contentMatch || userMatch) {
          msg.classList.add('search-highlight', 'bg-yellow-500/30', 'transition-colors', 'duration-500');
          found++;
          if (found === 1) {
            msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      });

      if (found === 0) {
        // Only show error if no global results either
        const dropdown = document.getElementById('globalSearchResults');
        const hasGlobal = dropdown && !dropdown.classList.contains('hidden');

        if (!hasGlobal) {
          const searchInput = document.getElementById('chatSearchInput');
          if (searchInput) {
            searchInput.classList.add('border-red-500');
            setTimeout(() => searchInput.classList.remove('border-red-500'), 1000);
          }
        }
      }
    }

    function handleSearchInput(query, event) {
      // Always update dropdown for global search (Friends/Groups)
      updateGlobalSearch(query);

      // Determine if we should highlight messages
      // If Enter is pressed, definitely search messages
      if (event && event.key === 'Enter') {
        searchMessages(query);
      } else {
        // Optional: live highlight? Maybe skip for performance unless user wants it
        // searchMessages(query); 
      }
    }

    // Navigation Registry
    const globalNavItems = [
      { name: 'Home', action: () => navigateTo('home'), icon: 'home', keywords: ['home', 'welcome'] },
      { name: 'Friends', action: () => { navigateTo('friends'); if (typeof showFriendsDashboard === 'function') showFriendsDashboard(); }, icon: 'users', keywords: ['friends', 'list'] },
      { name: 'My Profile', action: () => navigateTo('profile'), icon: 'user', keywords: ['profile', 'me'] },
      { name: 'My Cloud', action: () => navigateTo('cloud'), icon: 'cloud', keywords: ['cloud', 'files'] },
      { name: 'Moments', action: () => navigateTo('moments'), icon: 'film', keywords: ['moments', 'shorts'] },
      { name: 'Settings > General', action: () => { navigateTo('settings'); openSettingsSection('generalSettings'); }, icon: 'settings', keywords: ['settings', 'general'] },
      { name: 'Settings > Appearance', action: () => { navigateTo('settings'); openSettingsSection('appearanceSettings'); }, icon: 'monitor', keywords: ['theme', 'dark', 'light'] },
      { name: 'Settings > Sound', action: () => { navigateTo('settings'); openSettingsSection('soundSettings'); }, icon: 'volume-2', keywords: ['sound', 'audio', 'volume'] },
      { name: 'Settings > Account', action: () => { navigateTo('settings'); openSettingsSection('accountSettings'); }, icon: 'shield', keywords: ['account', 'email', 'security'] },
      { name: 'Settings > About', action: () => { navigateTo('settings'); openSettingsSection('aboutSettings'); }, icon: 'info', keywords: ['about', 'version'] },
    ];

    function openSettingsSection(sectionId) {
      document.querySelectorAll('.settings-content').forEach(el => el.classList.add('hidden'));
      const target = document.getElementById(sectionId);
      if (target) target.classList.remove('hidden');
    }

    function updateGlobalSearch(query) {
      const dropdown = document.getElementById('globalSearchResults');
      if (!dropdown) return;

      if (!query || query.trim() === '') {
        dropdown.classList.add('hidden');
        dropdown.innerHTML = '';
        return;
      }

      const q = query.toLowerCase();
      const matches = [];

      // 1. Search Nav
      globalNavItems.forEach(item => {
        if (item.name.toLowerCase().includes(q) || item.keywords.some(k => k.includes(q))) {
          matches.push({ type: 'nav', data: item });
        }
      });

      // Search Friends
      if (typeof friendsState !== 'undefined' && friendsState.friends) {
        friendsState.friends.forEach(f => {
          const name = (typeof f === 'string') ? f : f.username;
          if (name.toLowerCase().includes(q)) {
            matches.push({ type: 'user', name: name });
          }
        });
      }

      // Search Groups
      if (typeof groupsData !== 'undefined' && Array.isArray(groupsData)) {
        groupsData.forEach(g => {
          if (g && g.name && g.name.toLowerCase().includes(q)) {
            matches.push({ type: 'group', name: g.name, id: g.id });
          }
        });
      }

      // Render dropdown
      dropdown.innerHTML = '';
      if (matches.length > 0) {
        dropdown.classList.remove('hidden');
        matches.forEach(m => {
          const div = document.createElement('div');
          div.className = "p-2 hover:bg-discord-gray-700 cursor-pointer flex items-center gap-2 text-sm text-gray-200 border-b border-discord-gray-700/50 last:border-0";

          if (m.type === 'nav') {
            div.innerHTML = `<i data-feather="${m.data.icon}" class="w-4 h-4 text-discord-blurple"></i> <span class="font-medium">${m.data.name}</span> <span class="text-xs text-gray-400 ml-auto">Jump to</span>`;
            div.onclick = () => {
              m.data.action();
              dropdown.classList.add('hidden');
              document.getElementById('chatSearchInput').value = '';
            };
          } else if (m.type === 'user') {
            div.innerHTML = `<i data-feather="user" class="w-4 h-4 text-green-400"></i> <span>${m.name}</span> <span class="text-xs text-gray-500 ml-auto">Friend</span>`;
            div.onclick = () => {
              if (typeof openDM !== 'undefined') openDM(m.name);
              dropdown.classList.add('hidden');
              document.getElementById('chatSearchInput').value = '';
            };
          } else {
            div.innerHTML = `<i data-feather="hash" class="w-4 h-4 text-gray-400"></i> <span>${m.name}</span> <span class="text-xs text-gray-500 ml-auto">Group</span>`;
            div.onclick = () => {
              if (typeof selectGroup !== 'undefined') selectGroup(m.id);
              dropdown.classList.add('hidden');
              document.getElementById('chatSearchInput').value = '';
            };
          }
          dropdown.appendChild(div);
        });
        if (typeof feather !== 'undefined') feather.replace();
      } else {
        dropdown.classList.add('hidden');
      }
    }

    // Fetch initial online users from API and set indicators
    async function fetchOnlineUsers() {
      try {
        const res = await fetch('/api/users/online');
        const data = await res.json();
        if (data.success && Array.isArray(data.online)) {
          data.online.forEach(username => {
            updateUserStatusIndicator(username, 'online');
          });
        }
      } catch (e) {
        console.error('Failed to fetch online users:', e);
      }
    }

    // Sidebar Toggle with Persistence (Updated for Mobile Drawers)
    function toggleSidebar() {
      const primary = document.getElementById('primarySidebar');
      const secondary = document.getElementById('subPanelContainer');
      const overlay = document.getElementById('overlay');

      if (!primary) return;

      const isClosed = primary.classList.contains('-translate-x-full');

      if (isClosed) {
        // Open Sidebars
        primary.classList.remove('-translate-x-full');
        if (secondary) secondary.classList.remove('-translate-x-full');
        overlay?.classList.remove('hidden');
        localStorage.setItem('sidebarState', 'open');
      } else {
        // Close Sidebars
        primary.classList.add('-translate-x-full');
        if (secondary) secondary.classList.add('-translate-x-full');
        overlay?.classList.add('hidden');
        localStorage.setItem('sidebarState', 'closed');
      }
    }

    function restoreSidebarState() {
      const panel = document.getElementById('subPanelContainer');
      const overlay = document.getElementById('overlay');
      if (!panel) return;

      const savedState = localStorage.getItem('sidebarState');
      const isMobile = window.innerWidth < 768;

      // Default: mobile = closed, desktop = open (unless explicitly saved otherwise)
      let shouldBeOpen = !isMobile;
      if (savedState === 'open') shouldBeOpen = true;
      if (savedState === 'closed') shouldBeOpen = false;

      if (shouldBeOpen) {
        panel.classList.remove('-translate-x-full');
        if (isMobile) overlay?.classList.remove('hidden');
      } else {
        panel.classList.add('-translate-x-full');
        overlay?.classList.add('hidden');
      }
    }

    // New Messages Indicator Helpers
    function showNewMessagesIndicator(chatType) {
      const indicatorId = chatType === 'community' ? 'newMessagesIndicatorCommunity' : 'newMessagesIndicatorGroup';
      const indicator = document.getElementById(indicatorId);
      if (indicator) indicator.classList.remove('hidden');
    }

    function scrollToBottomCommunity() {
      const container = document.getElementById('chatMessagesCommunity');
      const indicator = document.getElementById('newMessagesIndicatorCommunity');
      if (container) container.scrollTop = container.scrollHeight;
      if (indicator) indicator.classList.add('hidden');
    }

    // Hide indicator when user manually scrolls to bottom
    document.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('chatMessagesCommunity');
      const indicator = document.getElementById('newMessagesIndicatorCommunity');
      if (container && indicator) {
        container.addEventListener('scroll', () => {
          const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 150;
          if (isNearBottom) indicator.classList.add('hidden');
        });
      }
    });

    window.addEventListener("DOMContentLoaded", async () => {
      // Restore sidebar state first
      restoreSidebarState();
      // Delay slightly to ensure socket global is ready if it depends on script order
      setTimeout(initSocket, 500);
      // Fetch initial online users after socket init
      setTimeout(fetchOnlineUsers, 600);
      await hydrateSettingsFromBackend();
      settingsMap.forEach(({ id, key }) => {
        const el = document.getElementById(id);
        const savedValue = localStorage.getItem(key);
        if (el) {
          if (el.type === "checkbox") el.checked = savedValue === "true";
          else if (savedValue) el.value = savedValue;
        }
      });
      applyGeneralSettings();

      // Initialize settings change tracking
      initializeOriginalSettings();
      checkSettingsChanges();
    });

    settingsMap.forEach(({ id, key }) => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("change", function () {
          const value = this.type === "checkbox" ? this.checked : this.value;
          localStorage.setItem(key, value);
          applyGeneralSettings();

          // Track changes for save confirmation
          checkSettingsChanges();

          // Auto-save for some settings (optional)
          if (['enableAnimations', 'compactMode', 'showTooltips'].includes(key)) {
            persistSettings({ [key]: value });
          }
        });
      }
    });

    function applyGeneralSettings() { // Animations and compact mode
      const animationsEnabled = (localStorage.getItem("enableAnimations") ?? 'true') !== "false";
      document.body.classList.toggle("no-animations", !animationsEnabled);
      document.body.classList.toggle("compact", localStorage.getItem("compactMode") === "true");

      // Tooltips
      const showTips = (localStorage.getItem("showTooltips") ?? 'true') === "true";
      if (!showTips) {
        document.querySelectorAll("[title]").forEach(el => el.removeAttribute("title"));
      }

      // Confirm before exit
      const wantConfirm = localStorage.getItem("confirmBeforeExit") === "true";
      window.onbeforeunload = wantConfirm ? (e) => { e.preventDefault(); e.returnValue = ''; } : null;

      // Language runtime micro i18n for settings labels only
      applySettingsLocale();
    }

    function applySettingsLocale() {
      const lang = localStorage.getItem('language') || 'en';
      const dict = {
        en: {
          settingsTitle: '‚öôÔ∏è Settings', general: 'General', sounds: 'Sounds', account: 'Account', about: 'About Us',
          enableAnimations: 'Enable Animations', compactMode: 'Compact Mode', showTooltips: 'Show Tooltips', language: 'Language',
          startupPage: 'Startup Page', autoSave: 'Auto Save Changes', confirmExit: 'Confirm Before Exit', appearance: 'Appearance',
          solidBg: 'Solid BG', resetAll: 'Reset All Settings'
        },
        es: {
          settingsTitle: '‚öôÔ∏è Ajustes', general: 'General', sounds: 'Sonidos', account: 'Cuenta', about: 'Acerca de',
          enableAnimations: 'Habilitar animaciones', compactMode: 'Modo compacto', showTooltips: 'Mostrar consejos', language: 'Idioma',
          startupPage: 'P√°gina de inicio', autoSave: 'Guardar autom√°ticamente', confirmExit: 'Confirmar antes de salir', appearance: 'Apariencia',
          solidBg: 'Fondo s√≥lido', resetAll: 'Restablecer todos los ajustes'
        },
        vi: {
          settingsTitle: '‚öôÔ∏è C√†i ƒë·∫∑t', general: 'Chung', sounds: '√Çm thanh', account: 'T√†i kho·∫£n', about: 'Gi·ªõi thi·ªáu',
          enableAnimations: 'B·∫≠t hi·ªáu ·ª©ng', compactMode: 'Ch·∫ø ƒë·ªô g·ªçn', showTooltips: 'Hi·ªÉn th·ªã g·ª£i √Ω', language: 'Ng√¥n ng·ªØ',
          startupPage: 'Trang kh·ªüi ƒë·ªông', autoSave: 'T·ª± ƒë·ªông l∆∞u', confirmExit: 'X√°c nh·∫≠n tr∆∞·ªõc khi tho√°t', appearance: 'Giao di·ªán',
          solidBg: 'N·ªÅn ƒë·ªìng m√†u', resetAll: 'ƒê·∫∑t l·∫°i t·∫•t c·∫£ c√†i ƒë·∫∑t'
        }
      }[lang] || {};

      const byId = (id) => document.getElementById(id);
      if (byId('settingsTitle') && dict.settingsTitle) byId('settingsTitle').textContent = dict.settingsTitle;
      if (byId('tabBtnGeneral')?.querySelector('span') && dict.general) byId('tabBtnGeneral').querySelector('span').textContent = dict.general;
      if (byId('tabBtnAppearance')?.querySelector('span') && dict.appearance) byId('tabBtnAppearance').querySelector('span').textContent = dict.appearance;
      if (byId('tabBtnSounds')?.querySelector('span') && dict.sounds) byId('tabBtnSounds').querySelector('span').textContent = dict.sounds;
      if (byId('tabBtnAccount')?.querySelector('span') && dict.account) byId('tabBtnAccount').querySelector('span').textContent = dict.account;
      if (byId('tabBtnAbout')?.querySelector('span') && dict.about) byId('tabBtnAbout').querySelector('span').textContent = dict.about;
      if (byId('labelEnableAnimations') && dict.enableAnimations) byId('labelEnableAnimations').textContent = dict.enableAnimations;
      if (byId('labelCompactMode') && dict.compactMode) byId('labelCompactMode').textContent = dict.compactMode;
      if (byId('labelShowTooltips') && dict.showTooltips) byId('labelShowTooltips').textContent = dict.showTooltips;
      if (byId('labelLanguage') && dict.language) byId('labelLanguage').textContent = dict.language;
      if (byId('labelStartupPage') && dict.startupPage) byId('labelStartupPage').textContent = dict.startupPage;
      if (byId('labelAutoSave') && dict.autoSave) byId('labelAutoSave').textContent = dict.autoSave;
      if (byId('labelConfirmExit') && dict.confirmExit) byId('labelConfirmExit').textContent = dict.confirmExit;
      if (byId('titleAppearance') && dict.appearance) byId('titleAppearance').textContent = dict.appearance;
      if (byId('labelSolidBg') && dict.solidBg) byId('labelSolidBg').textContent = dict.solidBg;
      if (byId('btnResetAll') && dict.resetAll) byId('btnResetAll').textContent = dict.resetAll;
    }

    function resetAllSettings() {
      if (confirm("Are you sure you want to reset all settings?\nThis action can not be undo.")) {
        settingsMap.forEach(({ key }) => localStorage.removeItem(key));
        location.reload();
      }
    }

    if (localStorage.getItem("confirmBeforeExit") === "true") {
      window.addEventListener("beforeunload", function (e) {
        e.preventDefault();
        e.returnValue = '';
      });
    }

    // Sound settings change tracking
    const soundSettingsMap = [
      { id: "soundVolume", key: "soundVolume" },
      { id: "musicVolume", key: "musicVolume" },
      { id: "muteAll", key: "muteAll" },
      { id: "enableSound", key: "enableSound" },
      { id: "enableMusic", key: "enableMusic" },
      { id: "soundProfile", key: "soundProfile" },
      { id: "duckMusic", key: "duckMusic" },
      { id: "playSend", key: "playSend" },
      { id: "playReceive", key: "playReceive" },
      { id: "playUi", key: "playUi" }
    ];

    // Add sound settings to change tracking
    soundSettingsMap.forEach(({ id, key }) => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("change", function () {
          const value = this.type === "checkbox" ? this.checked : this.value;
          localStorage.setItem(key, value);
          checkSettingsChanges();
        });
      }
    });

    // Event listeners for changes
    document.getElementById("animationsToggle").addEventListener("change", function () {
      localStorage.setItem("enableAnimations", this.checked);
      applyGeneralSettings();
      persistSettings({ enableAnimations: this.checked });
    });

    document.getElementById("compactToggle").addEventListener("change", function () {
      localStorage.setItem("compactMode", this.checked);
      applyGeneralSettings();
      persistSettings({ compactMode: this.checked });
    });

    document.getElementById("tooltipToggle").addEventListener("change", function () {
      localStorage.setItem("showTooltips", this.checked);
      applyGeneralSettings();
      persistSettings({ showTooltips: this.checked });
    });

    document.getElementById("languageSelect").addEventListener("change", function () {
      localStorage.setItem("language", this.value);
      applySettingsLocale();
      persistSettings({ language: this.value });
    });

    // Startup Page Setting
    const startupPageSelect = document.getElementById("startupPage");
    if (startupPageSelect) {
      const savedStartup = localStorage.getItem("startupPage");
      if (savedStartup) startupPageSelect.value = savedStartup;

      startupPageSelect.addEventListener("change", function () {
        localStorage.setItem("startupPage", this.value);
      });
    }

    // Sound settings
    (function initSoundSettings() {
      const soundControls = [
        { id: 'soundVolume', key: 'soundVolume' },
        { id: 'musicVolume', key: 'musicVolume' },
        { id: 'muteAll', key: 'muteAll', checkbox: true },
        { id: 'enableSound', key: 'enableSound', checkbox: true },
        { id: 'enableMusic', key: 'enableMusic', checkbox: true },
        { id: 'soundProfile', key: 'soundProfile' },
        { id: 'duckMusic', key: 'duckMusic', checkbox: true },
        { id: 'playSend', key: 'playSend', checkbox: true },
        { id: 'playReceive', key: 'playReceive', checkbox: true },
        { id: 'playUi', key: 'playUi', checkbox: true },
      ];

      soundControls.forEach(({ id, key, checkbox }) => {
        const el = document.getElementById(id);
        if (!el) return;
        const saved = localStorage.getItem(key);
        if (saved != null) {
          if (checkbox) el.checked = saved === 'true';
          else el.value = saved;
        }
        el.addEventListener('change', function () {
          const value = checkbox ? this.checked : this.value;
          localStorage.setItem(key, value);
          persistSettings({ [key]: value });
        });
      });
    })();

    /// Account Settings
    async function updateUsername(newUsername) {
      if (!newUsername) {
        const el = document.getElementById("changeUsername");
        newUsername = (el ? el.value : '').trim();
      }

      const current = localStorage.getItem('username');
      if (!newUsername) return alert("Please enter a username.");
      if (!current) return alert("You are not logged in.");

      try {
        const res = await fetch('/api/update-username', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: current, newUsername })
        });

        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        localStorage.setItem('username', data.username);

        const saved = localStorage.getItem('savedUsername');
        if (saved === current) localStorage.setItem('savedUsername', data.username);
        document.getElementById('profileUsername').textContent = data.username;

        const curU = document.getElementById('currentUsername'); if (curU) curU.textContent = data.username;
        alert('Username updated.');
      } catch (e) {
        alert('Failed to update username: ' + (e.message || 'Unknown error'));
      }
    }

    async function updateUsertag(newTag) {
      if (!newTag) {
        const el = document.getElementById("changeUsertag");
        newTag = (el ? el.value : '').trim();
      }

      const username = localStorage.getItem('username');
      if (!newTag) return alert("Please enter a usertag.");
      if (!/^\d{4}$/.test(newTag)) return alert("Usertag must be exactly 4 digits.");

      try {
        const res = await fetch('/api/update-usertag', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, newUsertag: newTag })
        });

        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        document.getElementById('profileUsertag').textContent = data.usertag;

        const curT = document.getElementById('currentUsertag'); if (curT) curT.textContent = data.usertag;
        localStorage.setItem('usertag', data.usertag);
        alert('Usertag updated.');
      } catch (e) {
        alert('Failed to update usertag: ' + (e.message || 'Unknown error'));
      }
    }

    async function updateEmail(newEmail) {
      if (!newEmail) {
        const el = document.getElementById("changeEmail");
        newEmail = (el ? el.value : '').trim();
      }

      const username = localStorage.getItem('username');
      if (!newEmail) return alert("Please enter a new email.");

      try {
        const res = await fetch('/api/update-email', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, newEmail })
        });

        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        localStorage.setItem('savedEmail', data.email);

        const curE = document.getElementById('currentEmail'); if (curE) curE.textContent = data.email;
        const pe = document.getElementById('profileEmail'); if (pe) pe.textContent = data.email;
        alert('Email updated.');
      } catch (e) {
        alert('Failed to update email: ' + (e.message || 'Unknown error'));
      }
    }

    async function updatePassword() {
      const oldPass = document.getElementById("oldPassword").value;
      const newPass = document.getElementById("newPassword").value;
      const confirmPass = document.getElementById("confirmPassword").value;
      const username = localStorage.getItem('username');
      if (!oldPass || !newPass || !confirmPass) return alert("Fill out all password fields.");
      if (newPass !== confirmPass) return alert("New passwords do not match.");

      try {
        const res = await fetch('/api/update-password', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, oldPassword: oldPass, newPassword: newPass })
        });

        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        alert('Password updated successfully.');

        document.getElementById("oldPassword").value = '';
        document.getElementById("newPassword").value = '';
        document.getElementById("confirmPassword").value = '';
      } catch (e) {
        alert('Failed to update password: ' + (e.message || 'Unknown error'));
      }
    }

    // Two-factor authentication toggle
    document.getElementById("twoFactorToggle").addEventListener("change", function () {
      localStorage.setItem("twoFactorEnabled", this.checked);
      const username = localStorage.getItem('username');

      if (username) {
        fetch('/api/update-settings', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, settings: { twoFactorEnabled: this.checked } })
        }).catch(() => { });
      }
      alert(`Two-Factor Authentication ${this.checked ? 'enabled' : 'disabled'}.`);
    });

    // Privacy toggles (defensive binding)
    const showEmailEl = document.getElementById("showEmail");
    if (showEmailEl) {
      showEmailEl.addEventListener("change", function () {
        localStorage.setItem("showEmail", this.checked);
        const username = localStorage.getItem('username');
        if (username) fetch('/api/update-settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, settings: { showEmail: this.checked } }) }).catch(() => { });
      });
    }

    const shareActivityEl = document.getElementById("shareActivity");
    if (shareActivityEl) {
      shareActivityEl.addEventListener("change", function () {
        localStorage.setItem("shareActivity", this.checked);
        const username = localStorage.getItem('username');
        if (username) fetch('/api/update-settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, settings: { shareActivity: this.checked } }) }).catch(() => { });
      });
    }

    async function deleteAccount() {
      if (!confirm("Are you sure you want to delete your account?\nThis action cannot be undone.")) return;
      const username = localStorage.getItem('username');
      try {
        const res = await fetch('/api/delete-account', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });

        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        localStorage.clear(); // Clear local data and go to login
        window.location.href = '/login.html';
      } catch (e) {
        alert('Failed to delete account: ' + (e.message || 'Unknown error'));
      }
    }

    /// About Settings
    function populateAboutInfo() {
      const statusEl = document.getElementById('aboutSystemStatus');
      if (!statusEl) return;
      statusEl.textContent = 'Checking backend status...';

      try {
        fetch('/api/stats', { cache: 'no-store' })
          .then(r => r.json())
          .then(data => {
            if (data && typeof data.users !== 'undefined') {
              statusEl.textContent = `Backend OK ‚Ä¢ Users: ${data.users} ‚Ä¢ Messages: ${data.messages} ‚Ä¢ Rooms: ${data.rooms}`;
            } else {
              statusEl.textContent = 'Backend reachable, unexpected response.';
            }
          })
          .catch(() => {
            statusEl.textContent = 'Backend unreachable. You may be offline.';
          });
      } catch {
        statusEl.textContent = 'Backend unreachable. You may be offline.';
      }
    }

    function checkForUpdates() {
      alert("üîÑ Checking for updates...\nNo updates available.");
    }

    function openChangelog() {
      alert("üìú Changelog:\n- Improved settings UI\n- Fixed minor bugs");
    }

    function openPrivacyPolicy() {
      alert("üîí Privacy Policy:\nYour data is stored securely and never shared.");
    }

    /// === Sidebar + Navbar Functions ===
    function toggleSidebar() {
      // This function NOW toggles Column 2 on mobile
      const subPanel = document.getElementById("subPanelContainer");
      const overlay = document.getElementById("overlay");
      const isOpening = subPanel.classList.contains("-translate-x-full");

      if (isOpening) {
        subPanel.classList.remove("-translate-x-full");
        overlay.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
      } else {
        subPanel.classList.add("-translate-x-full");
        overlay.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      }
    }

    // Theme/Appearance functions (Kept as is)
    document.addEventListener("DOMContentLoaded", () => {
      const themeColorDot = document.getElementById('themeColorDot');
      const themeColorText = document.getElementById('themeColorText');
      const colorPicker = document.getElementById('customThemeColorPicker');
      const solidBgToggle = document.getElementById('solidBgToggle');
      const bgInput = document.getElementById('bgImageInput');
      const clearBgBtn = document.getElementById('clearBgImageBtn');
      const previewBgBtn = document.getElementById('previewBgBtn');

      const savedTheme = localStorage.getItem('theme');
      let themeMode = localStorage.getItem('themeMode');
      if (!themeMode) { // Back-compat with existing 'theme' storage
        themeMode = (savedTheme === 'dark' || savedTheme === 'light') ? savedTheme : 'light';
        localStorage.setItem('themeMode', themeMode);
      }

      const media = window.matchMedia('(prefers-color-scheme: dark)');
      function systemPrefersDark() { return media.matches; }

      function updateThemeButtons(activeMode) {
        document.querySelectorAll('[data-theme-btn]').forEach(btn => {
          if (btn.dataset.themeBtn === activeMode) {
            btn.classList.add('ring-2', 'ring-blue-500');
          } else {
            btn.classList.remove('ring-2', 'ring-blue-500');
          }
        });
      }

      function getCustomColor() {
        return localStorage.getItem('customThemeColor') || '#0b1020';
      }

      function setSwatch(hex) {
        if (!themeColorDot || !themeColorText) return;
        themeColorDot.style.backgroundColor = hex;
        themeColorText.textContent = hex.toUpperCase();
      }

      function clearInlineBackground() {
        const b = document.body.style;
        b.background = '';
        b.backgroundImage = '';
        b.backgroundSize = '';
        b.backgroundAttachment = '';
        // Clear custom theme vars
        b.removeProperty('--navbar-bg');
        b.removeProperty('--sidebar-bg');
        b.removeProperty('--panel-bg');
        b.removeProperty('--text-color');
        b.removeProperty('--accent-color');
        b.removeProperty('--main-bg');
        document.body.classList.remove('theme-custom');
      }

      function applyBackground() {
        const img = localStorage.getItem('bgImageDataUrl');
        const solid = localStorage.getItem('solidBg') === 'true';
        const color = getCustomColor();
        clearInlineBackground();

        if (img) {
          document.body.style.backgroundImage = `url(${img})`;
          document.body.style.backgroundSize = 'cover';
          document.body.style.backgroundAttachment = 'fixed';
        } else if (solid) {
          document.body.style.background = color;
        }

        if (solidBgToggle) solidBgToggle.checked = solid;
        if (colorPicker) colorPicker.value = color;
        setSwatch(color);
      }

      function applyThemeMode(mode) {
        // CRITICAL FIX: Always clear dark class AND inline styles first to prevent theme conflicts
        document.body.classList.remove('dark');
        document.documentElement.classList.remove('dark');
        document.body.classList.remove('theme-custom'); // Ensure custom class is gone
        clearInlineBackground();

        // Persist chosen mode
        localStorage.setItem('themeMode', mode);

        // Remove listener to avoid duplicates
        media.removeEventListener?.('change', handleSystemChange);

        if (mode === 'dark') {
          document.body.classList.add('dark');
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');

        } else if (mode === 'light') {
          // Already cleared above, just set storage
          localStorage.setItem('theme', 'light');

        } else if (mode === 'system') {
          const isDark = systemPrefersDark();
          if (isDark) {
            document.body.classList.add('dark');
            document.documentElement.classList.add('dark');
          }
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
          media.addEventListener?.('change', handleSystemChange);

        } else if (mode === 'custom') {
          // Custom mode uses light base with custom colors
          localStorage.setItem('theme', 'custom');
          applyBackground();
        }

        updateThemeButtons(mode);

        // Toggle color picker visibility for custom mode
        if (colorPicker) {
          colorPicker.classList.toggle('hidden', mode !== 'custom');
        }
      }

      function handleSystemChange() {
        const storedMode = localStorage.getItem('themeMode');
        if (storedMode === 'system') {
          const isDark = systemPrefersDark();

          // CRITICAL FIX: Clear first to prevent conflicts
          document.body.classList.remove('dark');
          document.documentElement.classList.remove('dark');

          // Apply if needed
          if (isDark) {
            document.body.classList.add('dark');
            document.documentElement.classList.add('dark');
          }

          localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
      }

      // Expose to buttons
      window.setTheme = function (mode) {
        if (mode === 'custom' && typeof openThemeEditor === 'function') {
          openThemeEditor();
        } else {
          applyThemeMode(mode);
        }
      };

      // Wire controls
      colorPicker?.addEventListener('input', (e) => {
        const hex = e.target.value;
        localStorage.setItem('customThemeColor', hex);
        setSwatch(hex);
        if ((localStorage.getItem('themeMode') || 'light') === 'custom') {
          applyBackground();
        }
      });

      solidBgToggle?.addEventListener('change', (e) => {
        localStorage.setItem('solidBg', e.target.checked);
        if ((localStorage.getItem('themeMode') || 'light') === 'custom') {
          applyBackground();
        }
      });

      bgInput?.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        // Show loading state
        const originalValue = e.target.value;
        e.target.disabled = true;
        e.target.value = '';

        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            try {
              const maxDim = 1920;
              let { width, height } = img;
              if (width > maxDim || height > maxDim) {
                const scale = Math.min(maxDim / width, maxDim / height);
                width = Math.round(width * scale);
                height = Math.round(height * scale);
              }

              const canvas = document.createElement('canvas');
              canvas.width = width; canvas.height = height;

              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
              localStorage.setItem('bgImageDataUrl', dataUrl);

              // Automatically switch to custom theme mode to show the background
              localStorage.setItem('themeMode', 'custom');
              applyThemeMode('custom');
              applyBackground();

              // Show success message
              alert('Background image imported successfully! Your theme has been switched to Custom mode to show the image.');

            } catch (error) {
              console.error('Error processing image:', error);
              alert('Error processing the image. Please try again.');
            } finally {
              e.target.disabled = false;  // Re-enable the input
            }
          };

          img.onerror = () => {
            alert('Error loading the image. Please try a different file.');
            e.target.disabled = false;
          };
          img.src = reader.result;
        };

        reader.onerror = () => {
          alert('Error reading the file. Please try again.');
          e.target.disabled = false;
        };
        reader.readAsDataURL(file);
      });

      clearBgBtn?.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear the background image?')) {
          localStorage.removeItem('bgImageDataUrl');
          if ((localStorage.getItem('themeMode') || 'light') === 'custom') {
            applyBackground();
          }

          if (bgInput) bgInput.value = ''; // Clear the file input
          alert('Background image cleared!');
        }
      });

      previewBgBtn?.addEventListener('click', () => {
        const bgImage = localStorage.getItem('bgImageDataUrl');
        if (!bgImage) {
          alert('No background image found. Please import an image first.');
          return;
        }

        // Temporarily switch to custom mode to show the background
        const currentMode = localStorage.getItem('themeMode') || 'light';
        localStorage.setItem('themeMode', 'custom');
        applyThemeMode('custom');
        applyBackground();

        // Show preview message
        alert('Previewing background image! Click OK to keep it or go back to your previous theme.');

        // Ask if user wants to keep it
        if (confirm('Do you want to keep this background image?')) {
          alert('Background image applied! You can change this anytime in Settings > Appearance.'); // Keep the custom theme
        } else {
          localStorage.setItem('themeMode', currentMode); // Revert to previous theme
          applyThemeMode(currentMode);
          if (currentMode !== 'custom') {
            clearInlineBackground();
          }
        }
      });

      // Initial hydrate
      setSwatch(getCustomColor());
      applyThemeMode(themeMode);

      try { // If a full custom theme exists, apply its variables and background
        const customStr = localStorage.getItem('currentCustomTheme');
        if (customStr && (localStorage.getItem('themeMode') || 'light') === 'custom') {
          const t = JSON.parse(customStr);
          document.body.classList.add('theme-custom');
          const s = document.body.style;

          if (t && t.ui) {
            s.setProperty('--navbar-bg', t.ui.navbarBg || '');
            s.setProperty('--sidebar-bg', t.ui.sidebarBg || '');
            s.setProperty('--panel-bg', t.ui.panelBg || '');
          }

          if (t) {
            s.setProperty('--text-color', t.textColor || '');
            s.setProperty('--accent-color', t.accentColor || '');
          }

          // Apply background according to saved theme
          s.background = '';
          s.backgroundImage = '';
          s.backgroundSize = '';
          s.backgroundAttachment = '';
          const bg = t?.background || {};

          if (bg.mode === 'solid') {
            s.background = bg.solid || '';
          } else if (bg.mode === 'gradient') {
            const a = (bg.gradient?.angle ?? 135);
            s.background = `linear-gradient(${a}deg, ${bg.gradient?.from || '#1e293b'}, ${bg.gradient?.to || '#0f172a'})`;
            s.backgroundAttachment = 'fixed';
            s.backgroundSize = '400% 400%';

          } else if (bg.mode === 'image' && bg.imageDataUrl) {
            s.backgroundImage = `url(${bg.imageDataUrl})`;
            s.backgroundSize = 'cover';
            s.backgroundAttachment = 'fixed';

          } else if (bg.mode === 'animated') {
            s.background = 'linear-gradient(135deg, #1e293b, #0f172a)';
            s.backgroundSize = '400% 400%';
          }
        }
      } catch { }

      // Initialize chat room + models/personas
      loadAiModels();
      loadAiPersonas();
      switchChatRoom(currentChatRoom);

      // Initialize profile effects
      initializeProfileEffects();

      // Initialize profile effects
      initializeProfileEffects();

      // Moments: wiring share and feed
      const momentsFile = document.getElementById('momentsFile');
      const momentsCaption = document.getElementById('momentsCaption');
      const momentsPreview = document.getElementById('momentsPreview');
      const momentsFeed = document.getElementById('momentsFeed');
      const momentsShareBtn = document.getElementById('momentsShareBtn');

      function renderMomentsPreview(file) {
        momentsPreview.innerHTML = '';
        if (!file) return;
        const url = URL.createObjectURL(file);
        const type = (file.type || '').toLowerCase();

        if (type.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = url; img.className = 'max-h-72 rounded';
          momentsPreview.appendChild(img);

        } else if (type.startsWith('video/')) {
          const video = document.createElement('video');
          video.controls = true; video.src = url; video.className = 'w-full max-h-72 rounded';
          momentsPreview.appendChild(video);

        } else if (type.startsWith('audio/')) {
          const audio = document.createElement('audio');
          audio.controls = true; audio.src = url; audio.className = 'w-full';
          momentsPreview.appendChild(audio);

        } else {
          const a = document.createElement('div');
          a.textContent = `üìé ${file.name}`;
          momentsPreview.appendChild(a);
        }
      }

      momentsFile?.addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        renderMomentsPreview(f);
      });

      async function loadMomentsFeed() {
        const currentUser = localStorage.getItem('username') || localStorage.getItem('savedUsername') || '';
        try {
          const res = await fetch('/api/explore/posts');
          const data = await res.json();
          const posts = data.posts || [];
          momentsFeed.innerHTML = '';

          for (const p of posts) {
            const card = document.createElement('div');
            card.className = 'moment-card bg-discord-gray-800/80 border border-discord-gray-700 rounded-xl p-4 transition-all hover:border-discord-gray-600';
            card.dataset.postId = p.id || '';

            // Header with Avatar + Username + Time
            const header = document.createElement('div');
            header.className = 'flex items-center gap-3 mb-3';
            const avatar = document.createElement('img');
            avatar.className = 'w-10 h-10 rounded-full object-cover cursor-pointer';
            avatar.src = await getUserAvatarUrl(p.username) || '/images/default_avatar.png';
            avatar.onerror = function () { this.src = '/images/default_avatar.png'; };
            avatar.onclick = () => showUserProfile(p.username);
            const userInfo = document.createElement('div');
            userInfo.className = 'flex flex-col';
            const username = document.createElement('span');
            username.className = 'text-white font-semibold text-sm cursor-pointer hover:underline';
            username.textContent = p.username || 'Anonymous';
            username.onclick = () => showUserProfile(p.username);
            const timestamp = document.createElement('span');
            timestamp.className = 'text-discord-gray-400 text-xs';
            timestamp.textContent = new Date((p.createdAt || 0) * 1000).toLocaleString();
            userInfo.appendChild(username);
            userInfo.appendChild(timestamp);
            header.appendChild(avatar);
            header.appendChild(userInfo);
            card.appendChild(header);

            // Caption
            if (p.caption) {
              const caption = document.createElement('p');
              caption.className = 'text-discord-gray-200 mb-3 text-sm';
              caption.textContent = p.caption;
              card.appendChild(caption);
            }

            // Media content
            const ext = (p.fileName || '').split('.').pop().toLowerCase();
            const mediaWrap = document.createElement('div');
            mediaWrap.className = 'rounded-lg overflow-hidden mb-3';

            if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg'].includes(ext)) {
              const img = document.createElement('img');
              img.src = p.url; img.className = 'w-full rounded-lg';
              img.alt = p.fileName || 'Moment image';
              mediaWrap.appendChild(img);
            } else if (['mp4', 'webm', 'ogg', 'mov', 'm4v'].includes(ext)) {
              const video = document.createElement('video');
              video.controls = true; video.src = p.url; video.className = 'w-full rounded-lg';
              mediaWrap.appendChild(video);
            } else if (['mp3', 'wav', 'ogg', 'm4a', 'aac', 'flac'].includes(ext)) {
              const audio = document.createElement('audio');
              audio.controls = true; audio.src = p.url; audio.className = 'w-full';
              mediaWrap.appendChild(audio);
            } else if (p.url) {
              const a = document.createElement('a');
              a.href = p.url; a.download = p.fileName || 'download';
              a.textContent = `üìé ${p.fileName || 'file'}`;
              a.className = 'text-discord-blurple hover:underline';
              mediaWrap.appendChild(a);
            }
            if (mediaWrap.children.length > 0) card.appendChild(mediaWrap);

            // Footer with reactions and comments
            const footer = document.createElement('div');
            footer.className = 'flex items-center gap-4 pt-3 border-t border-discord-gray-700';

            const reactions = p.reactions || [];
            const userReacted = reactions.includes(currentUser);

            // Like/React button
            const reactBtn = document.createElement('button');
            reactBtn.className = `flex items-center gap-1.5 text-sm transition-colors ${userReacted ? 'text-red-500' : 'text-discord-gray-400 hover:text-red-400'}`;
            reactBtn.innerHTML = `<svg class="w-5 h-5" fill="${userReacted ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg><span>${reactions.length}</span>`;
            reactBtn.onclick = async () => {
              try {
                const res = await fetch('/api/moments/react', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ postId: p.id, username: currentUser })
                });
                if (res.ok) await loadMomentsFeed();
              } catch (e) { console.error('React failed:', e); }
            };
            footer.appendChild(reactBtn);

            // Comment button
            const comments = p.comments || [];
            const commentBtn = document.createElement('button');
            commentBtn.className = 'flex items-center gap-1.5 text-sm text-discord-gray-400 hover:text-discord-blurple transition-colors';
            commentBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg><span>${comments.length}</span>`;
            commentBtn.onclick = () => {
              const commentsSection = card.querySelector('.comments-section');
              if (commentsSection) commentsSection.classList.toggle('hidden');
            };
            footer.appendChild(commentBtn);
            card.appendChild(footer);

            // Comments section (hidden by default)
            const commentsSection = document.createElement('div');
            commentsSection.className = 'comments-section hidden mt-3 pt-3 border-t border-discord-gray-700 space-y-2';

            // Existing comments
            comments.forEach(c => {
              const commentDiv = document.createElement('div');
              commentDiv.className = 'flex gap-2 text-sm';
              commentDiv.innerHTML = `<span class="text-discord-blurple font-medium">${c.username}:</span><span class="text-discord-gray-300">${c.text}</span>`;
              commentsSection.appendChild(commentDiv);
            });

            // Add comment input
            const commentInputDiv = document.createElement('div');
            commentInputDiv.className = 'flex gap-2 mt-2';
            const commentInput = document.createElement('input');
            commentInput.type = 'text';
            commentInput.placeholder = 'Write a comment...';
            commentInput.className = 'flex-1 bg-discord-gray-700 text-white text-sm rounded px-3 py-1.5 border border-discord-gray-600 focus:border-discord-blurple focus:outline-none';
            const sendCommentBtn = document.createElement('button');
            sendCommentBtn.className = 'px-3 py-1.5 bg-discord-blurple text-white text-sm rounded hover:bg-opacity-80';
            sendCommentBtn.textContent = 'Send';
            sendCommentBtn.onclick = async () => {
              const text = commentInput.value.trim();
              if (!text) return;
              try {
                const res = await fetch('/api/moments/comment', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ postId: p.id, username: currentUser, comment: text })
                });
                if (res.ok) {
                  commentInput.value = '';
                  await loadMomentsFeed();
                }
              } catch (e) { console.error('Comment failed:', e); }
            };
            commentInputDiv.appendChild(commentInput);
            commentInputDiv.appendChild(sendCommentBtn);
            commentsSection.appendChild(commentInputDiv);
            card.appendChild(commentsSection);

            momentsFeed.appendChild(card);
          }
        } catch (e) { console.error('Failed to load moments:', e); }
      }

      async function shareMoment() {
        const f = momentsFile?.files?.[0];
        if (!f) { alert('Attach a file first.'); return; }
        const caption = momentsCaption?.value || '';
        const username = localStorage.getItem('username') || localStorage.getItem('savedUsername') || 'Anonymous';
        const reader = new FileReader();

        reader.onload = async (e) => {
          try {
            const fileData = e.target.result;
            const res = await fetch('/api/explore/posts', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, caption, fileName: f.name, fileData })
            });

            const data = await res.json();
            if (!res.ok || !data.success) throw new Error(data.error || 'Failed to share');
            if (momentsCaption) momentsCaption.value = '';
            if (momentsFile) momentsFile.value = '';
            momentsPreview.innerHTML = '';
            await loadMomentsFeed();
          } catch (err) { alert('Failed to share moment.'); }
        };
        reader.readAsDataURL(f);
      }

      momentsShareBtn?.addEventListener('click', shareMoment);
      loadMomentsFeed();

      // ============ Cloud Storage (My Cloud) ============
      let cloudViewMode = localStorage.getItem('cloudViewMode') || 'grid';

      function formatFileSize(bytes) {
        if (!bytes || bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }

      function setCloudView(mode) {
        cloudViewMode = mode;
        localStorage.setItem('cloudViewMode', mode);
        const gridBtn = document.getElementById('cloudViewGrid');
        const listBtn = document.getElementById('cloudViewList');
        const container = document.getElementById('cloudFilesContainer');

        if (mode === 'grid') {
          gridBtn?.classList.add('bg-discord-gray-700', 'text-white');
          gridBtn?.classList.remove('bg-discord-gray-800', 'text-discord-gray-400');
          listBtn?.classList.remove('bg-discord-gray-700', 'text-white');
          listBtn?.classList.add('bg-discord-gray-800', 'text-discord-gray-400');
          container?.classList.remove('grid-cols-1');
          container?.classList.add('grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4');
        } else {
          listBtn?.classList.add('bg-discord-gray-700', 'text-white');
          listBtn?.classList.remove('bg-discord-gray-800', 'text-discord-gray-400');
          gridBtn?.classList.remove('bg-discord-gray-700', 'text-white');
          gridBtn?.classList.add('bg-discord-gray-800', 'text-discord-gray-400');
          container?.classList.add('grid-cols-1');
          container?.classList.remove('grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4');
        }
        loadCloudFiles();
      }

      async function loadCloudFiles() {
        const username = localStorage.getItem('username') || localStorage.getItem('savedUsername');
        if (!username) return;

        const container = document.getElementById('cloudFilesContainer');
        const emptyState = document.getElementById('cloudEmptyState');
        if (!container) return;

        try {
          const res = await fetch(`/api/cloud/files?username=${encodeURIComponent(username)}`);
          const data = await res.json();
          const files = data.files || [];

          container.innerHTML = '';

          if (files.length === 0) {
            emptyState?.classList.remove('hidden');
            return;
          }
          emptyState?.classList.add('hidden');

          files.forEach(f => {
            const card = document.createElement('div');
            const isImage = ['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg'].includes((f.fileName || '').split('.').pop().toLowerCase());
            const isVideo = ['mp4', 'webm', 'ogg', 'mov'].includes((f.fileName || '').split('.').pop().toLowerCase());

            if (cloudViewMode === 'grid') {
              card.className = 'cloud-file-card bg-discord-gray-800/80 border border-discord-gray-700 rounded-lg overflow-hidden group hover:border-discord-gray-600 transition-all';

              let preview = '';
              if (isImage) {
                preview = `<img src="${f.url}" alt="${f.fileName}" class="w-full h-32 object-cover" />`;
              } else if (isVideo) {
                preview = `<video src="${f.url}" class="w-full h-32 object-cover" muted></video>`;
              } else {
                preview = `<div class="w-full h-32 flex items-center justify-center bg-discord-gray-700"><i data-feather="file" class="w-12 h-12 text-discord-gray-500"></i></div>`;
              }

              card.innerHTML = `
                ${preview}
                <div class="p-3">
                  <p class="text-white text-sm font-medium truncate" title="${f.fileName}">${f.fileName}</p>
                  <p class="text-discord-gray-400 text-xs mt-1">${formatFileSize(f.size)} ‚Ä¢ ${new Date((f.createdAt || 0) * 1000).toLocaleDateString()}</p>
                  <div class="flex gap-2 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <a href="${f.url}" download="${f.fileName}" class="flex-1 text-center py-1 rounded bg-discord-blurple text-white text-xs hover:bg-opacity-80">Download</a>
                    <button onclick="deleteCloudFile('${f.id}')" class="p-1 rounded bg-discord-gray-700 hover:bg-red-500/20 text-discord-gray-400 hover:text-red-500"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                  </div>
                </div>
              `;
            } else {
              // List view
              card.className = 'cloud-file-card bg-discord-gray-800/80 border border-discord-gray-700 rounded-lg p-3 flex items-center gap-3 group hover:border-discord-gray-600 transition-all';

              let iconHtml = '<i data-feather="file" class="w-8 h-8 text-discord-gray-500"></i>';
              if (isImage) iconHtml = `<img src="${f.url}" class="w-10 h-10 rounded object-cover" />`;
              else if (isVideo) iconHtml = '<i data-feather="film" class="w-8 h-8 text-discord-gray-500"></i>';

              card.innerHTML = `
                <div class="shrink-0">${iconHtml}</div>
                <div class="flex-1 min-w-0">
                  <p class="text-white text-sm font-medium truncate">${f.fileName}</p>
                  <p class="text-discord-gray-400 text-xs">${formatFileSize(f.size)} ‚Ä¢ ${new Date((f.createdAt || 0) * 1000).toLocaleDateString()}</p>
                </div>
                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
                  <a href="${f.url}" download="${f.fileName}" class="p-2 rounded bg-discord-blurple text-white text-xs hover:bg-opacity-80"><i data-feather="download" class="w-4 h-4"></i></a>
                  <button onclick="deleteCloudFile('${f.id}')" class="p-2 rounded bg-discord-gray-700 hover:bg-red-500/20 text-discord-gray-400 hover:text-red-500"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                </div>
              `;
            }
            container.appendChild(card);
          });
          feather.replace();
        } catch (e) { console.error('Failed to load cloud files:', e); }
      }

      async function uploadToCloud(file) {
        const username = localStorage.getItem('username') || localStorage.getItem('savedUsername');
        if (!username || !file) return;

        const progress = document.getElementById('cloudUploadProgress');
        progress?.classList.remove('hidden');

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const res = await fetch('/api/cloud/upload', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                username,
                fileName: file.name,
                fileType: file.type,
                fileData: e.target.result
              })
            });
            const data = await res.json();
            if (data.success) {
              await loadCloudFiles();
            } else {
              alert('Upload failed: ' + (data.error || 'Unknown error'));
            }
          } catch (err) {
            console.error('Upload failed:', err);
            alert('Upload failed.');
          } finally {
            progress?.classList.add('hidden');
          }
        };
        reader.readAsDataURL(file);
      }

      window.deleteCloudFile = async function (fileId) {
        if (!confirm('Delete this file?')) return;
        const username = localStorage.getItem('username') || localStorage.getItem('savedUsername');
        if (!username) return;

        try {
          const res = await fetch('/api/cloud/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, fileId })
          });
          if (res.ok) await loadCloudFiles();
        } catch (e) { console.error('Delete failed:', e); }
      };

      // Cloud file input handler
      const cloudFileInput = document.getElementById('cloudFileInput');
      cloudFileInput?.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files && files.length > 0) {
          Array.from(files).forEach(f => uploadToCloud(f));
          cloudFileInput.value = '';
        }
      });

      // Drag and drop handler
      const cloudUploadArea = document.getElementById('cloudUploadArea');
      cloudUploadArea?.addEventListener('dragover', (e) => {
        e.preventDefault();
        cloudUploadArea.classList.add('border-discord-blurple');
      });
      cloudUploadArea?.addEventListener('dragleave', () => {
        cloudUploadArea.classList.remove('border-discord-blurple');
      });
      cloudUploadArea?.addEventListener('drop', (e) => {
        e.preventDefault();
        cloudUploadArea.classList.remove('border-discord-blurple');
        const files = e.dataTransfer?.files;
        if (files && files.length > 0) {
          Array.from(files).forEach(f => uploadToCloud(f));
        }
      });

      // Initialize cloud view
      setCloudView(cloudViewMode);


      // Apply startup page if set
      const startup = (localStorage.getItem('startupPage') || 'home');
      switchTab(startup);
      loadFriends();  // Load social data on entry
      loadFriends();  // Load social data on entry
      loadGroups();
    });

    // === Tab Switching Logic ===
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));  // 1. Hide all main content tabs
      const selectedMainTab = document.getElementById(`tab-${tabName}`);  // 2. Show the selected main content tab
      if (selectedMainTab) selectedMainTab.classList.remove('hidden');

      // 3. Update active state on Col 1 (Server Nav)
      document.querySelectorAll('.sidebar-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll(`[data-tab="${tabName}"]`).forEach(tab => tab.classList.add('active')); // 4. Hide all sub-panels in Col 2
      document.querySelectorAll('.sub-panel-content').forEach(panel => panel.classList.add('hidden'));
      const selectedSubPanel = document.getElementById(`sub-panel-${tabName}`); // 5. Show the correct sub-panel for the tab
      if (selectedSubPanel) selectedSubPanel.classList.remove('hidden');

      // 6. Update main header title
      const titleEl = document.getElementById('main-content-title');
      const subPanelTitleEl = document.getElementById('subPanelTitle');
      if (titleEl) {
        if (tabName === 'home') titleEl.textContent = 'Home';
        if (tabName === 'messages') {
          titleEl.textContent = '# Community'; // Default to community
          if (subPanelTitleEl) subPanelTitleEl.textContent = 'Messages';
        }
        if (tabName === 'profile') {
          titleEl.textContent = 'Profile';
          if (subPanelTitleEl) subPanelTitleEl.textContent = 'Profile';
        }
        if (tabName === 'moments') {
          titleEl.textContent = 'Moments';
          if (subPanelTitleEl) subPanelTitleEl.textContent = 'Moments';
        }
        if (tabName === 'cloud') {
          titleEl.textContent = 'My Cloud';
          if (subPanelTitleEl) subPanelTitleEl.textContent = 'My Cloud';
          // Cloud functionality moved to Settings > Files
        }
        if (tabName === 'apps') {
          titleEl.textContent = 'Apps & Tools';
          if (subPanelTitleEl) subPanelTitleEl.textContent = 'Apps & Tools';
        }
        if (tabName === 'settings') {
          titleEl.textContent = 'Settings';
          if (subPanelTitleEl) subPanelTitleEl.textContent = 'Settings';
        }
      }

      // 7. Handle special tab logic
      if (tabName === 'friends') {
        document.querySelector("#btnMessagesTabFriends")?.click(); // Default to showing friends list (Col 2) and DM view (Col 3)
      }
      if (tabName === 'settings') {
        document.querySelector("#tabBtnGeneral").click(); // Default to showing general settings
      }

      // 8. On mobile, close the sub-panel after clicking a nav icon
      if (window.innerWidth < 768) {
        const sidebar = document.getElementById("mobileSidebar");
        if (sidebar && !sidebar.classList.contains("-translate-x-full")) {
          toggleSidebar();
        }
      }
    }

    // === Messages View Switching ===
    function switchMessagesView(view) {
      const communityView = document.getElementById('messagesViewCommunity');
      const friendsView = document.getElementById('messagesViewFriends');
      const btnCommunity = document.getElementById('btnMessagesTabCommunity');
      const btnFriends = document.getElementById('btnMessagesTabFriends');

      if (view === 'community') {
        communityView?.classList.remove('hidden');
        friendsView?.classList.add('hidden');
        btnCommunity?.classList.add('text-white', 'bg-discord-gray-600/50', 'border-b-2', 'border-discord-blurple');
        btnCommunity?.classList.remove('text-discord-gray-400');
        btnFriends?.classList.remove('text-white', 'bg-discord-gray-600/50', 'border-b-2', 'border-discord-blurple');
        btnFriends?.classList.add('text-discord-gray-400');
      } else if (view === 'friends') {
        communityView?.classList.add('hidden');
        friendsView?.classList.remove('hidden');
        btnFriends?.classList.add('text-white', 'bg-discord-gray-600/50', 'border-b-2', 'border-discord-blurple');
        btnFriends?.classList.remove('text-discord-gray-400');
        btnCommunity?.classList.remove('text-white', 'bg-discord-gray-600/50', 'border-b-2', 'border-discord-blurple');
        btnCommunity?.classList.add('text-discord-gray-400');
      }
    }

    // === Home Tab Toggle ===
    function toggleHomeTab(show) {
      const homeTab = document.getElementById('homeTab');
      const messagesTab = document.getElementById('messagesTab');
      const navDivider = document.getElementById('navDivider');
      const nav = homeTab?.parentElement;

      if (homeTab && messagesTab && navDivider && nav) {
        if (show) {
          // Show Home tab at the beginning, Messages after divider
          homeTab.style.display = 'flex';
          nav.insertBefore(homeTab, navDivider);
          // Ensure Messages is after divider
          nav.insertBefore(messagesTab, navDivider.nextSibling);
        } else {
          // Hide Home tab, move Messages before divider (first position)
          homeTab.style.display = 'none';
          nav.insertBefore(messagesTab, navDivider);
        }
      }
      localStorage.setItem('showHomeTab', show ? 'true' : 'false');
    }

    // Apply Home tab visibility on page load
    function applyHomeTabSetting() {
      // Default to true if not set
      const showHome = localStorage.getItem('showHomeTab') !== 'false';
      toggleHomeTab(showHome);
      // Update checkbox state
      const checkbox = document.getElementById('showHomeTabToggle');
      if (checkbox) checkbox.checked = showHome;
    }

    function showFriendsDashboard() {
      // 1. Ensure we are on the Messages tab (which hosts the Friends sub-panel and Dashboard)
      switchTab('messages');
      switchMessagesView('friends');

      // 2. Hide chat view, show dashboard
      const dashboard = document.getElementById('friendsDashboard');
      const chatView = document.getElementById('friendsChatView');
      if (dashboard) dashboard.classList.remove('hidden');
      if (chatView) chatView.classList.add('hidden');

      // 3. Clear active DM state
      activeFriendChat = null;
      renderSidebarList();
      renderFriendsDashboard();

      // 4. Update title
      const titleEl = document.getElementById('main-content-title');
      if (titleEl) titleEl.textContent = 'Friends';

      // 5. Ensure tab-friends is visible in Col 3
      const tabFriends = document.getElementById('tab-friends');
      const tabMessages = document.getElementById('tab-messages');
      const tabGroup = document.getElementById('tab-group');
      if (tabFriends) tabFriends.classList.remove('hidden');
      if (tabMessages) tabMessages.classList.add('hidden');
      if (tabGroup) tabGroup.classList.add('hidden');
    }

    // === Show Messages Tab (back from Friends) ===
    function showMessagesTab() {
      const tabFriends = document.getElementById('tab-friends');
      const tabMessages = document.getElementById('tab-messages');

      if (tabFriends && tabMessages) {
        tabFriends.classList.add('hidden');
        tabMessages.classList.remove('hidden');
      }

      // Update title
      const titleEl = document.getElementById('main-content-title');
      if (titleEl) titleEl.textContent = '# Community';
    }

    // === Groups Modal Functions ===
    function showGroupsModal() {
      const modal = document.getElementById('groupsModal');
      if (modal) {
        modal.classList.remove('hidden');
        // Reset to create tab
        switchGroupModalTab('create');
      }
      feather.replace();
    }

    function closeGroupsModal() {
      const modal = document.getElementById('groupsModal');
      if (modal) modal.classList.add('hidden');
      // Clear inputs
      document.getElementById('newGroupNameInput').value = '';
      document.getElementById('newGroupDescInput').value = '';
      document.getElementById('joinGroupIdInput').value = '';
      // Reset Icon Preview
      const preview = document.getElementById('groupIconPreview');
      if (preview) {
        preview.style.backgroundImage = '';
        preview.innerHTML = '<i data-feather="camera" class="text-discord-gray-400"></i>';
        preview.className = "w-full h-full rounded-full bg-discord-gray-700 border-2 border-dashed border-discord-gray-500 flex items-center justify-center cursor-pointer hover:border-discord-blurple overflow-hidden";
      }
      document.getElementById('newGroupIconInput').value = '';
    }

    function previewGroupIcon(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const preview = document.getElementById('groupIconPreview');
          preview.style.backgroundImage = `url(${e.target.result})`;
          preview.style.backgroundSize = 'cover';
          preview.style.backgroundPosition = 'center';
          preview.innerHTML = '';
          preview.classList.remove('border-dashed', 'border-2');
        }
        reader.readAsDataURL(file);
      }
    }

    function switchGroupModalTab(tab) {
      const createTab = document.getElementById('createGroupTab');
      const joinTab = document.getElementById('joinGroupTab');
      const createForm = document.getElementById('createGroupForm');
      const joinForm = document.getElementById('joinGroupForm');

      if (tab === 'create') {
        createTab?.classList.add('text-white', 'border-b-2', 'border-discord-blurple');
        createTab?.classList.remove('text-discord-gray-400');
        joinTab?.classList.remove('text-white', 'border-b-2', 'border-discord-blurple');
        joinTab?.classList.add('text-discord-gray-400');
        createForm?.classList.remove('hidden');
        joinForm?.classList.add('hidden');
      } else {
        joinTab?.classList.add('text-white', 'border-b-2', 'border-discord-blurple');
        joinTab?.classList.remove('text-discord-gray-400');
        createTab?.classList.remove('text-white', 'border-b-2', 'border-discord-blurple');
        createTab?.classList.add('text-discord-gray-400');
        joinForm?.classList.remove('hidden');
        createForm?.classList.add('hidden');
      }
    }

    // === Group Settings Modal Logic ===

    function openGroupSettings() {
      if (!currentGroupId) return;
      const group = groupsData.find(g => g.id === currentGroupId);
      if (!group) return;

      const modal = document.getElementById('groupSettingsModal');
      const nameInput = document.getElementById('editGroupName');
      const descInput = document.getElementById('editGroupDesc');
      const iconInput = document.getElementById('editGroupIconInput');
      const iconPreview = document.getElementById('editGroupIconPreview');
      const initialSpan = document.getElementById('editGroupIconInitial');
      const inviteInput = document.getElementById('inviteCodeInput');

      if (modal && nameInput && descInput) {
        nameInput.value = group.name || '';
        descInput.value = group.description || '';
        if (inviteInput) inviteInput.value = group.id;

        // Reset icon input
        if (iconInput) iconInput.value = '';

        // Set icon preview
        if (group.icon) {
          iconPreview.style.backgroundImage = `url(${group.icon})`;
          iconPreview.style.backgroundSize = 'cover';
          iconPreview.style.backgroundPosition = 'center';
          if (initialSpan) initialSpan.textContent = '';
        } else {
          iconPreview.style.backgroundImage = '';
          iconPreview.style.backgroundColor = getGroupColor(group.name);
          if (initialSpan) initialSpan.textContent = getGroupInitial(group.name);
        }

        switchSettingsTab('overview');
        renderSettingsChannels(group);
        modal.classList.remove('hidden');
      }
    }

    function switchSettingsTab(tab) {
      document.querySelectorAll('.settings-section').forEach(s => s.classList.add('hidden'));
      document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active'));

      const section = document.getElementById(`settings-${tab}`);
      const btn = document.getElementById(`tabBtn-${tab}`);
      const title = document.getElementById('settingsTabTitle');
      const footer = document.getElementById('settingsModalFooter');

      if (section) section.classList.remove('hidden');
      if (btn) btn.classList.add('active');
      if (title) {
        if (tab === 'overview') title.textContent = 'Server Overview';
        if (tab === 'channels') title.textContent = 'Channel Management';
        if (tab === 'invites') title.textContent = 'Invites';
      }

      // Hide save button on non-overview tabs for now unless needed
      if (footer) {
        if (tab === 'overview') footer.classList.remove('hidden');
        else footer.classList.add('hidden');
      }
    }

    function renderSettingsChannels(group) {
      const container = document.getElementById('settingsChannelList');
      if (!container) return;
      container.innerHTML = '';

      const channels = group.channels || [];
      channels.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-2 rounded hover:bg-discord-gray-600 transition group';
        const isVoice = ch.type === 'voice';
        const icon = isVoice ? 'volume-2' : 'hash';

        div.innerHTML = `
          <div class="flex items-center gap-2">
            <i data-feather="${icon}" class="w-4 h-4 text-discord-gray-400"></i>
            <span class="text-white text-sm">${ch.name}</span>
          </div>
          ${ch.id !== 'general' ? `
            <button onclick="deleteChannel('${group.id}', '${ch.id}')" class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-500 transition">
              <i data-feather="trash-2" class="w-4 h-4"></i>
            </button>
          ` : ''}
        `;
        container.appendChild(div);
      });
      feather.replace();
    }

    function showCreateChannelInput() {
      document.getElementById('createChannelInputArea').classList.remove('hidden');
    }
    function hideCreateChannelInput() {
      document.getElementById('createChannelInputArea').classList.add('hidden');
    }

    async function confirmCreateChannel(type) {
      const name = document.getElementById('newChannelName').value.trim();
      const username = localStorage.getItem('savedUsername');
      if (!name || !currentGroupId) return;

      try {
        const res = await fetch('/api/groups/channels/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ groupId: currentGroupId, username, channelName: name, type })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('newChannelName').value = '';
          hideCreateChannelInput();
          await loadGroups();
          const updated = groupsData.find(g => g.id === currentGroupId);
          if (updated) renderSettingsChannels(updated);
        } else {
          alert(data.error);
        }
      } catch (e) { }
    }

    async function deleteChannel(groupId, channelId) {
      if (!confirm('Are you sure you want to delete this channel?')) return;
      const username = localStorage.getItem('savedUsername');
      try {
        const res = await fetch('/api/groups/channels/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ groupId, username, channelId })
        });
        const data = await res.json();
        if (data.success) {
          await loadGroups();
          const updated = groupsData.find(g => g.id === groupId);
          if (updated) renderSettingsChannels(updated);
        }
      } catch (e) { }
    }

    function copyInviteCode() {
      const input = document.getElementById('inviteCodeInput');
      if (input) {
        input.select();
        document.execCommand('copy');
        alert('Invite code copied to clipboard!');
      }
    }

    function closeGroupSettings() {
      const modal = document.getElementById('groupSettingsModal');
      if (modal) modal.classList.add('hidden');
    }

    function previewEditGroupIcon(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const preview = document.getElementById('editGroupIconPreview');
          const initial = document.getElementById('editGroupIconInitial');
          preview.style.backgroundImage = `url(${e.target.result})`;
          preview.style.backgroundSize = 'cover';
          preview.style.backgroundPosition = 'center';
          if (initial) initial.textContent = '';
        }
        reader.readAsDataURL(file);
      }
    }

    async function saveGroupSettings() {
      if (!currentGroupId) return;

      const name = document.getElementById('editGroupName').value.trim();
      const description = document.getElementById('editGroupDesc').value.trim();
      const iconInput = document.getElementById('editGroupIconInput');
      const username = localStorage.getItem('savedUsername') || 'User';

      if (!name) return alert('Group name cannot be empty');

      let iconData = null;
      if (iconInput && iconInput.files[0]) {
        iconData = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.readAsDataURL(iconInput.files[0]);
        });
      }

      try {
        const res = await fetch('/api/groups/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username,
            groupId: currentGroupId,
            name,
            description,
            iconData
          })
        });

        const data = await res.json();
        if (data.success) {
          closeGroupSettings();
          await loadGroups(); // Reload to refresh sidebar and active view
          selectGroup(currentGroupId); // Reselect to update header info
        } else {
          alert(data.error || 'Failed to update group');
        }
      } catch (e) {
        console.error(e);
        alert('An error occurred');
      }
    }

    async function deleteGroup() {
      if (!currentGroupId) return;
      if (!confirm("Are you sure you want to delete this group? This cannot be undone.")) return;

      const username = localStorage.getItem('savedUsername') || 'User';
      try {
        const res = await fetch('/api/groups/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username,
            groupId: currentGroupId
          })
        });

        const data = await res.json();
        if (data.success) {
          closeGroupSettings();
          await loadGroups();
          // Switch to friends view or another group
          document.getElementById('sub-panel-group').classList.add('hidden');
          document.getElementById('tab-group').classList.add('hidden');
          document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
          showFriendsDashboard();
        } else {
          alert(data.error || 'Failed to delete group');
        }
      } catch (e) {
        console.error(e);
        alert('An error occurred');
      }
    }

    // === Group Management Functions ==
    async function createNewGroup() {
      const nameInput = document.getElementById('newGroupNameInput');
      const descInput = document.getElementById('newGroupDescInput');
      const iconInput = document.getElementById('newGroupIconInput');
      const name = nameInput?.value.trim();
      const description = descInput?.value.trim();

      let iconData = null;
      if (iconInput && iconInput.files[0]) {
        iconData = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.readAsDataURL(iconInput.files[0]);
        });
      }

      if (!name) {
        alert('Please enter a group name');
        return;
      }

      try {
        const username = localStorage.getItem('savedUsername') || 'User';
        const res = await fetch('/api/groups/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, name, description, iconData })
        });

        const data = await res.json();
        if (data.success && data.group) {
          closeGroupsModal();
          await loadGroups();
          selectGroup(data.group.id);
        } else {
          alert(data.error || 'Failed to create group');
        }
      } catch (error) {
        console.error('Error creating group:', error);
        alert('Failed to create group');
      }
    }

    async function joinExistingGroup() {
      const input = document.getElementById('joinGroupIdInput');
      const groupId = input?.value.trim();

      if (!groupId) {
        alert('Please enter a group ID');
        return;
      }

      try {
        const username = localStorage.getItem('savedUsername') || 'User';
        const res = await fetch('/api/groups/join', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, groupId })
        });

        const data = await res.json();
        if (data.success) {
          closeGroupsModal();
          await loadGroups();
          selectGroup(groupId);
        } else {
          alert(data.error || 'Failed to join group');
        }
      } catch (error) {
        console.error('Error joining group:', error);
        alert('Failed to join group');
      }
    }

    async function loadGroups() {
      try {
        const username = localStorage.getItem('savedUsername') || 'User';
        const res = await fetch(`/api/groups/list?username=${username}`);
        const data = await res.json();
        groupsData = data.groups || [];
        renderGroupSidebar();
      } catch (error) {
        console.error('Error loading groups:', error);
        groupsData = [];
      }
    }



    function selectGroup(groupId) {
      // Leave previous group room if connected
      if (typeof socket !== 'undefined' && socket && currentGroupId && currentGroupId !== groupId) {
        socket.emit('leave', { room: currentGroupId });
      }

      currentGroupId = groupId;
      const group = groupsData.find(g => g.id === groupId);
      if (!group) return;

      // Sync activeId if groupsState exists (legacy safety)
      if (typeof groupsState !== 'undefined') groupsState.activeId = groupId;

      // Update sidebar list
      renderGroupSidebar();

      // Show group panel and tab
      document.querySelectorAll('.sub-panel-content').forEach(p => p.classList.add('hidden'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));

      const gPanel = document.getElementById('sub-panel-group');
      const gTab = document.getElementById('tab-group');
      if (gPanel) gPanel.classList.remove('hidden');
      if (gTab) {
        gTab.classList.remove('hidden');
        gTab.style.display = ''; // Force remove inline display:none from navigateTo()
      }

      // Update basic info
      const nameEl = document.getElementById('groupPanelName');
      const descEl = document.getElementById('groupPanelDesc');
      if (nameEl) nameEl.textContent = group.name;
      if (descEl) descEl.textContent = group.description || 'No description';

      const titleEl = document.getElementById('main-content-title');
      if (titleEl) titleEl.textContent = `# ${group.name}`;

      // Handle Socket join
      if (typeof socket !== 'undefined' && socket) {
        socket.emit('join', { room: group.id });
      }

      // Load specific group data
      // Load initial channel
      activeChannelId = 'general';
      loadGroupChannels(group, activeChannelId);
      loadGroupMembers(group);
      loadGroupMessages(group, activeChannelId);

      feather.replace();
    }

    function loadGroupChannels(group, activeChannelId = 'general') {
      const container = document.getElementById('groupChannelsList');
      if (!container) return;

      container.innerHTML = '';

      // Default channel
      const channels = group.channels || [{ id: 'general', name: 'general' }];

      channels.forEach(channel => {
        const item = document.createElement('div');
        item.className = `channel-item ${channel.id === activeChannelId ? 'active' : ''}`;
        item.innerHTML = `
          <span class="channel-icon">#</span>
          <span>${channel.name}</span>
        `;
        item.onclick = (e) => {
          // Switch and handle active state
          switchGroupChannel(group, channel.id);
        };
        container.appendChild(item);
      });
    }

    function loadGroupMembers(group) {
      const container = document.getElementById('groupMembersList');
      if (!container) return;

      container.innerHTML = '';

      const members = group.members || [localStorage.getItem('savedUsername') || 'You'];

      members.forEach(member => {
        const item = document.createElement('div');
        item.className = 'flex items-center gap-2 p-1 text-sm';
        item.innerHTML = `
            <div class="w-2 h-2 rounded-full bg-green-500"></div>
            <span class="text-discord-gray-300">${member}</span>
          `;
        container.appendChild(item);
      });

      // Update member count
      document.getElementById('groupChatMemberCount').textContent = `${members.length} members`;
    }

    async function loadGroupMessages(group, channelId) {
      activeChannelId = channelId;
      const container = document.getElementById('groupChatMessages');
      if (!container) return;

      container.innerHTML = '';

      // Update channel name and placeholder
      const channel = (group.channels || []).find(c => c.id === channelId) || { name: channelId };
      const displayTitle = channel.name;

      const titleEl = document.getElementById('groupChatChannelName');
      if (titleEl) titleEl.textContent = displayTitle;

      const input = document.getElementById('groupChatInput');
      if (input) input.placeholder = `Message #${displayTitle}`;

      try {
        const res = await fetch(`/api/groups/${group.id}/messages?channel=${channelId}`);
        const data = await res.json();
        const messages = data.messages || [];

        for (const msg of messages) {
          await appendGroupMessage(msg);
        }

        container.scrollTop = container.scrollHeight;

        // Mark messages as read
        if (window.markChannelRead) {
          window.markChannelRead(group.id, channelId);
        }
      } catch (error) {
        console.log('No messages yet or error loading:', error);
      }
    }



    function switchGroupChannel(group, channelId) {
      // Re-render channel list to update active states
      loadGroupChannels(group, channelId);

      // Load messages for this channel - CRITICAL FIX
      loadGroupMessages(group, channelId);
    }

    async function sendGroupChatMessage() {
      const input = document.getElementById('groupChatInput');
      const message = input?.value.trim();

      if (!message || !currentGroupId) return;

      const group = groupsData.find(g => g.id === currentGroupId);
      if (!group) return;

      const username = localStorage.getItem('savedUsername') || 'User';
      const channelId = activeChannelId || 'general';

      const payload = {
        groupId: currentGroupId,
        channel: channelId,
        from: username,
        username,
        message: message,
        timestamp: Math.floor(Date.now() / 1000),
        replyTo: replyContext ? { id: replyContext.id, username: replyContext.username, content: replyContext.content } : null
      };

      // Append message optimistically
      await appendGroupMessage(payload);
      cancelReply();

      // Send to server (HTTP only - no socket emit to avoid duplicates)
      try {
        await fetch('/api/groups/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (error) {
        console.error('Error sending message:', error);
      }

      input.value = '';
      input.style.height = 'auto';
    }

    function sendGroupFile(event) {
      const file = event.target.files[0];
      if (!file || !currentGroupId) return;

      const reader = new FileReader();
      const channelId = activeChannelId || 'general';
      const username = localStorage.getItem('savedUsername') || 'User';

      reader.onload = async function (e) {
        const fileData = e.target.result;
        const payload = {
          groupId: currentGroupId,
          channel: channelId,
          username,
          fileName: file.name,
          fileData: fileData
        };

        // Optimistic UI update
        await appendGroupMessage(payload);

        // Send to server (HTTP only - no socket emit to avoid duplicates)
        try {
          await fetch('/api/groups/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } catch (e) { console.error(e); }
      };
      reader.readAsDataURL(file); // base64
    }



    // Default Functions (Updated)
    window.onload = () => {
      applyHomeTabSetting(); // Apply Home tab visibility
      loadStats();
      loadUserData();
      const startup = (localStorage.getItem('startupPage') || 'home');  // Apply startup page if set
      switchTab(startup);
      switchChatRoom(currentChatRoom); // Ensure chat room is correctly set
      loadFriends();  // Load social data on entry
      loadGroups();  // Load groups and render icons
      refreshGroups();
    }

    // Settings sub-tab logic (Kept as is, still works)
    document.querySelectorAll(".settings-tab").forEach(tab => {
      tab.addEventListener("click", function (e) {
        if (e && typeof e.preventDefault === 'function') e.preventDefault();
        document.querySelectorAll(".settings-tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".settings-content").forEach(c => c.classList.add("hidden"));
        const targetId = this.getAttribute("data-target");
        const targetEl = targetId ? document.getElementById(targetId) : null;
        if (targetEl) targetEl.classList.remove("hidden");
        if (targetId === 'aboutSettings') { try { populateAboutInfo(); } catch (e_) { } }
        if (targetId === 'filesSettings') { try { renderFilesReworked('filesListContainer'); } catch (e_) { } }
        this.classList.add("active");

        // Update main title to match setting
        const titleEl = document.getElementById('main-content-title');
        if (titleEl) titleEl.textContent = this.textContent.trim();
      });
    });

    // Friends sub-tab logic (Updated to handle new sub-panel/main-panel split)
    document.querySelectorAll(".friends-tab").forEach(tab => {
      tab.addEventListener("click", function () {
        document.querySelectorAll(".friends-tab").forEach(t => t.classList.remove("active"));
        this.classList.add("active");

        const targetId = this.getAttribute("data-target");

        // Toggle main content panels (Col 3)
        document.querySelectorAll(".friends-content").forEach(c => c.classList.add("hidden"));
        document.getElementById(targetId).classList.remove("hidden");

        // Toggle sub-panel lists (Col 2)
        const friendLists = document.getElementById('friendListsContainer');
        const addFriend = document.getElementById('addFriendContainer');
        const groupLists = document.getElementById('groupListsContainer');

        if (targetId === 'friendsContent') {
          friendLists.classList.remove('hidden');
          addFriend.classList.remove('hidden');
          groupLists.classList.add('hidden');
        } else { // groupsContent
          friendLists.classList.add('hidden');
          addFriend.classList.add('hidden');
          groupLists.classList.remove('hidden');
        }
      });
    });

    // Page transition logic
    function goToPage(href) {
      document.body.classList.add("fade-out");
      setTimeout(() => {
        window.location.href = href;
      }, 1000);
    }

    // Fade-out transition on link clicks
    document.querySelectorAll("a").forEach(link => {
      if (
        link.hostname === window.location.hostname &&
        link.getAttribute("href") &&
        link.getAttribute("href") !== "#" &&
        !link.classList.contains("sidebar-tab")
      ) {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          const href = this.getAttribute("href");
          document.body.classList.add("fade-out");
          setTimeout(() => {
            goToPage(href);
          }, 1000);
        });
      }
    });
  </script>
  <script>
    // === Theme Editor Logic ===
    (function () {
      const overlay = document.getElementById('themeEditorOverlay');
      const modal = document.getElementById('themeEditorModal');
      const btnClose = document.getElementById('closeThemeEditorBtn');
      const btnCancel = document.getElementById('teCancelBtn');
      const btnApplyTheme = document.getElementById('teApplyThemeBtn');
      const btnApplyBg = document.getElementById('teApplyBgBtn');
      const btnSave = document.getElementById('saveThemeBtn');
      const btnDelete = document.getElementById('deleteThemeBtn');
      const savedSelect = document.getElementById('savedThemesSelect');

      // UI color inputs
      const iNavbar = document.getElementById('teNavbarBg');
      const iSidebar = document.getElementById('teSidebarBg');
      const iPanel = document.getElementById('tePanelBg');
      const iText = document.getElementById('teTextColor');
      const iAccent = document.getElementById('teAccentColor');
      const iMainBg = document.getElementById('teMainBg');

      // BG controls
      const solidControls = document.getElementById('teSolidControls');
      const imageControls = document.getElementById('teImageControls');
      const animatedControls = document.getElementById('teAnimatedControls');
      const radios = Array.from(document.querySelectorAll('input[name="teBgMode"]'));
      const iSolidColor = document.getElementById('teSolidColor');
      const iGradFrom = document.getElementById('teGradFrom');
      const iGradTo = document.getElementById('teGradTo');
      const iGradAngle = document.getElementById('teGradAngle');
      const iBgImage = document.getElementById('teBgImageInput');
      const btnClearBgImage = document.getElementById('teClearBgImageBtn');
      const preview = document.getElementById('tePreview');

      function getSavedThemes() {
        try { return JSON.parse(localStorage.getItem('customThemes') || '[]'); } catch { return []; }
      }

      function setSavedThemes(arr) { localStorage.setItem('customThemes', JSON.stringify(arr)); }

      function themeFromInputs() {
        const bgMode = radios.find(r => r.checked)?.value || 'gradient';

        return {
          name: '',
          ui: {
            navbarBg: iNavbar?.value || '#0b1020',
            sidebarBg: iSidebar?.value || '#111827',
            panelBg: iPanel?.value || 'rgba(255,255,255,0.7)',
            mainBg: iMainBg?.value || '#0f172a'
          },
          textColor: iText?.value || '#ffffff',
          accentColor: iAccent?.value || '#3b82f6',
          background: {
            mode: bgMode,
            solid: iSolidColor?.value || '#0b1020',
            gradient: { from: iGradFrom?.value || '#1e293b', to: iGradTo?.value || '#0f172a', angle: Number(iGradAngle?.value || 135) },
            imageDataUrl: localStorage.getItem('bgImageDataUrl') || '',
            animated: animatedControls?.querySelector('button.active')?.dataset.anim || 'gradientShift'
          }
        };
      }

      function applyThemeVars(t) {
        document.body.classList.add('theme-custom');
        document.body.style.setProperty('--navbar-bg', t.ui.navbarBg);
        document.body.style.setProperty('--sidebar-bg', t.ui.sidebarBg);
        document.body.style.setProperty('--panel-bg', t.ui.panelBg);
        document.body.style.setProperty('--text-color', t.textColor);
        document.body.style.setProperty('--accent-color', t.accentColor);
        document.body.style.setProperty('--main-bg', t.ui.mainBg || '#0f172a');
      }

      function applyThemeBackground(bg) {
        const s = document.body.style;
        s.background = '';
        s.backgroundImage = '';
        s.backgroundSize = '';
        s.backgroundAttachment = '';

        if (bg.mode === 'solid') {
          s.background = bg.solid;

        } else if (bg.mode === 'gradient') {
          const angle = bg.gradient?.angle ?? 135;
          s.background = `linear-gradient(${angle}deg, ${bg.gradient?.from}, ${bg.gradient?.to})`;
          s.backgroundAttachment = 'fixed';
          s.backgroundSize = '400% 400%';

        } else if (bg.mode === 'image' && bg.imageDataUrl) {
          s.backgroundImage = `url(${bg.imageDataUrl})`;
          s.backgroundSize = 'cover';
          s.backgroundAttachment = 'fixed';

        } else if (bg.mode === 'animated') {
          s.background = 'linear-gradient(135deg, #1e293b, #0f172a)';
          s.backgroundSize = '400% 400%';
        }
      }

      function renderPreview() {
        if (!preview) return;
        const t = themeFromInputs();
        preview.style.background = '';  // Background
        preview.style.backgroundImage = '';

        if (t.background.mode === 'solid') {
          preview.style.background = t.background.solid;

        } else if (t.background.mode === 'gradient') {
          preview.style.background = `linear-gradient(${t.background.gradient.angle}deg, ${t.background.gradient.from}, ${t.background.gradient.to})`;

        } else if (t.background.mode === 'image' && t.background.imageDataUrl) {
          preview.style.backgroundImage = `url(${t.background.imageDataUrl})`;
          preview.style.backgroundSize = 'cover';

        } else if (t.background.mode === 'animated') {
          preview.style.background = 'linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.9))';
        }

        // Panels and navbar sample
        const bar = preview.querySelector('.absolute.top-3');
        if (bar) bar.style.background = t.ui.navbarBg;

        // Mock main background area
        const mockArea = preview.querySelector('.absolute.top-11.left-15');
        if (mockArea) mockArea.style.background = t.ui.mainBg || '#0f172a';

        preview.querySelectorAll('.rounded').forEach(el => { el.style.background = t.ui.panelBg; });
      }

      function updateBgControls() {
        const val = radios.find(r => r.checked)?.value || 'gradient';
        imageControls?.classList.toggle('hidden', val !== 'image');
        animatedControls?.classList.toggle('hidden', val !== 'animated');
        renderPreview();
      }

      function open() { overlay?.classList.remove('hidden'); modal?.classList.remove('hidden'); renderPreview(); populateSavedThemes(); }
      function close() { overlay?.classList.add('hidden'); modal?.classList.add('hidden'); }

      window.openThemeEditor = function () { open(); };

      btnClose?.addEventListener('click', close);
      btnCancel?.addEventListener('click', close);
      overlay?.addEventListener('click', close);

      radios.forEach(r => r.addEventListener('change', updateBgControls));
      [iNavbar, iSidebar, iPanel, iText, iAccent, iMainBg, iSolidColor, iGradFrom, iGradTo, iGradAngle].forEach(el => el?.addEventListener('input', renderPreview));

      const btnReset = document.getElementById('teResetBtn');

      const PRESETS = {
        midnight: {
          name: 'Midnight',
          ui: { navbarBg: '#050505', sidebarBg: '#080808', panelBg: 'rgba(0,0,0,0.6)', mainBg: '#020617' },
          textColor: '#e2e8f0', accentColor: '#22d3ee',
          background: { mode: 'gradient', gradient: { from: '#020617', to: '#000000', angle: 135 } }
        }
      };

      btnReset?.addEventListener('click', () => {
        if (!confirm('Revert all settings to Zylo default?')) return;
        iNavbar.value = '#0b1020';
        iSidebar.value = '#111827';
        iPanel.value = 'rgba(255,255,255,0.7)';
        iText.value = '#ffffff';
        iAccent.value = '#3b82f6';
        iMainBg.value = '#0f172a';

        const gradRadio = radios.find(r => r.value === 'gradient');
        if (gradRadio) gradRadio.checked = true;

        iGradFrom.value = '#1e293b';
        iGradTo.value = '#0f172a';
        iGradAngle.value = '135';

        // Actually apply these defaults immediately
        const t = themeFromInputs();
        applyThemeVars(t);
        applyThemeBackground(t.background);
        renderPreview();

        // Clear saved custom theme to avoid persistence
        localStorage.removeItem('currentCustomTheme');
      });

      // Animated preset selection
      animatedControls?.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          animatedControls.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderPreview();
        });
      });

      // Image import
      iBgImage?.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();

        reader.onload = () => {
          try { localStorage.setItem('bgImageDataUrl', reader.result); } catch { }
          renderPreview();
        };
        reader.readAsDataURL(file);
      });

      btnClearBgImage?.addEventListener('click', () => {
        localStorage.removeItem('bgImageDataUrl');
        if (iBgImage) iBgImage.value = '';
        renderPreview();
      });

      // Apply BG instantly
      btnApplyBg?.addEventListener('click', () => {
        const t = themeFromInputs();
        localStorage.setItem('themeMode', 'custom');
        localStorage.setItem('theme', 'custom');
        document.body.classList.remove('dark');
        applyThemeVars(t);
        applyThemeBackground(t.background);
        localStorage.setItem('customThemeColor', t.accentColor);  // Back-compat flags
        localStorage.setItem('solidBg', String(t.background.mode === 'solid'));
        if (t.background.imageDataUrl) localStorage.setItem('bgImageDataUrl', t.background.imageDataUrl);
        close();
      });

      // Save/manage themes
      function populateSavedThemes() {
        if (!savedSelect) return;
        const list = getSavedThemes();
        let html = '<option value="">Select theme‚Ä¶</option>';
        html += '<optgroup label="Presets">';
        html += `<option value="preset_midnight">Midnight</option>`;
        html += '</optgroup>';
        html += '<optgroup label="Your Themes">';
        html += list.map((t, i) => `<option value="${i}">${t.name || ('Untitled ' + (i + 1))}</option>`).join('');
        html += '</optgroup>';
        savedSelect.innerHTML = html;
      }
      window.populateSavedThemes = populateSavedThemes;

      btnSave?.addEventListener('click', () => {
        const t = themeFromInputs();
        const name = prompt('Theme name?', t.name || 'My Theme');
        if (name === null) return;
        t.name = (name || '').trim() || 'My Theme';
        const list = getSavedThemes();
        list.push(t);
        setSavedThemes(list);
        populateSavedThemes();
        alert('Theme saved!');
      });

      btnDelete?.addEventListener('click', () => {
        const idx = Number(savedSelect?.value ?? -1);
        if (Number.isNaN(idx) || idx < 0) return;
        const list = getSavedThemes();
        if (!list[idx]) return;
        if (!confirm(`Delete theme "${list[idx].name || 'Untitled'}"?`)) return;
        list.splice(idx, 1);
        setSavedThemes(list);
        populateSavedThemes();
      });

      savedSelect?.addEventListener('change', () => {
        const val = savedSelect.value;
        if (!val) return;

        let t;
        if (val === 'preset_midnight') {
          t = PRESETS.midnight;
        } else {
          const idx = Number(val);
          const list = getSavedThemes();
          t = list[idx];
        }

        if (!t) return;
        iNavbar.value = t.ui.navbarBg;
        iSidebar.value = t.ui.sidebarBg;
        iPanel.value = t.ui.panelBg;
        iText.value = t.textColor;
        iAccent.value = t.accentColor;
        if (iMainBg) iMainBg.value = t.ui.mainBg || '#0f172a';
        (radios.find(r => r.value === (t.background.mode || 'gradient')) || radios[0]).checked = true;
        iSolidColor.value = t.background.solid || '#0b1020';
        iGradFrom.value = t.background.gradient?.from || '#1e293b';
        iGradTo.value = t.background.gradient?.to || '#0f172a';
        iGradAngle.value = String(t.background.gradient?.angle ?? 135);
        renderPreview();
      });

      // Apply full theme
      btnApplyTheme?.addEventListener('click', () => {
        const t = themeFromInputs();
        localStorage.setItem('currentCustomTheme', JSON.stringify(t));
        localStorage.setItem('themeMode', 'custom');
        localStorage.setItem('theme', 'custom');
        document.body.classList.remove('dark');
        applyThemeVars(t);
        applyThemeBackground(t.background);
        close();
      });

      // Initialize defaults
      try {
        const last = JSON.parse(localStorage.getItem('currentCustomTheme') || 'null');
        if (last) {
          iNavbar.value = last.ui.navbarBg || '#0b1020';
          iSidebar.value = last.ui.sidebarBg || '#111827';
          iPanel.value = last.ui.panelBg || 'rgba(255,255,255,0.7)';
          iText.value = last.textColor || '#ffffff';
          iAccent.value = last.accentColor || '#3b82f6';
          if (iMainBg) iMainBg.value = last.ui?.mainBg || '#0f172a';
          (radios.find(r => r.value === (last.background?.mode || 'gradient')) || radios[0]).checked = true;
          iSolidColor.value = last.background?.solid || '#0b1020';
          iGradFrom.value = last.background?.gradient?.from || '#1e293b';
          iGradTo.value = last.background?.gradient?.to || '#0f172a';
          iGradAngle.value = String(last.background?.gradient?.angle ?? 135);

        } else {
          iNavbar.value = '#0b1020';
          iSidebar.value = '#111827';
          iPanel.value = 'rgba(255,255,255,0.7)';
          iText.value = '#ffffff';
          iAccent.value = '#3b82f6';
          iSolidColor.value = '#0b1020';
          iGradFrom.value = '#1e293b';
          iGradTo.value = '#0f172a';
          iGradAngle.value = '135';
        }
      } catch { }

      populateSavedThemes();
      updateBgControls();
      renderPreview();
    })();
  </script>
  <script>
    // Offline banner + queued sends
    (function () {
      const banner = document.createElement('div');
      banner.id = 'offlineBanner';
      banner.textContent = 'You are offline. Messages will send when reconnected.';
      banner.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:#b91c1c;color:#fff;padding:8px 12px;text-align:center;z-index:40;display:none';
      document.body.appendChild(banner);

      function updateBanner() {
        const show = !navigator.onLine;
        banner.style.display = show ? 'block' : 'none';
        document.body.style.paddingBottom = show ? (banner.offsetHeight + 8) + 'px' : '';
      }
      window.addEventListener('online', updateBanner);
      window.addEventListener('offline', updateBanner);
      updateBanner();

      const pendingKey = 'pendingMessages';
      function getQueue() {
        try { return JSON.parse(localStorage.getItem(pendingKey) || '[]'); } catch { return []; }
      }
      function setQueue(arr) { localStorage.setItem(pendingKey, JSON.stringify(arr)); }

      const originalSendMessage = sendMessage;
      window.sendMessage = function () {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;
        if (!navigator.onLine) { // Only queue community messages. AI requires online access.
          if (typeof currentChatRoom !== 'undefined' && currentChatRoom === 'community') {
            const username = localStorage.getItem('savedUsername') || 'N/A';
            const q = getQueue();
            q.push({ username, message, ts: Date.now() });
            setQueue(q);
          } else { // Offline AI: render locally and inform user
            try {
              if (typeof appendAiBubble === 'function') {
                (async () => {
                  await appendAiBubble('user', message);
                  if (Array.isArray(aiConversation)) {
                    aiConversation.push({ role: 'user', content: message });
                    localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
                  }
                  await appendAiBubble('assistant', 'You are offline. AI chat requires internet.');

                  if (Array.isArray(aiConversation)) {
                    aiConversation.push({ role: 'assistant', content: 'You are offline. AI chat requires internet.' });
                    localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
                  }
                })();
              }
            } catch (e) { }
          }
          input.value = '';
          input.style.height = 'auto';
          return;
        }
        return originalSendMessage();
      }

      async function flushQueue() {
        if (!navigator.onLine) return;
        const q = getQueue();
        if (!q.length) return;

        try {
          q.forEach(item => {
            if (typeof io !== 'undefined') {
              const s = window.socket || io(window.location.origin);
              s.emit('send_message', { username: item.username, message: item.message });
            }
          });
          setQueue([]);
        } catch (e) { // keep queue on error
        }
      }
      window.addEventListener('online', flushQueue);
      setTimeout(flushQueue, 1000);
    })();
  </script>
  <script>
    // Profile Effects Functions
    function initializeProfileEffects() {
      const bannerEffectSelect = document.getElementById('bannerEffectSelect');
      const avatarEffectSelect = document.getElementById('profileEffectSelect');

      if (bannerEffectSelect) {
        bannerEffectSelect.addEventListener('change', function () {
          applyBannerEffect(this.value);
        });
      }

      if (avatarEffectSelect) {
        avatarEffectSelect.addEventListener('change', function () {
          applyAvatarEffect(this.value);
        });
      }
    }

    function applyBannerEffect(effect) {
      console.log('Applying banner effect:', effect);
      const bannerImg = document.getElementById('bannerImage');
      const settingsBanner = document.getElementById('settingsBanner');
      const bannerContainer = document.querySelector('.profile-banner');

      console.log('Banner elements found:', { bannerImg: !!bannerImg, settingsBanner: !!settingsBanner, bannerContainer: !!bannerContainer });

      // Remove all effect classes and inline styles first
      [bannerImg, settingsBanner].forEach(el => {
        if (!el) return;
        el.className = el.className.replace(/banner-effect-\w+/g, '');  // Remove old classes
        el.style.boxShadow = '';  // Remove inline styles
        el.style.border = '';
        el.style.filter = '';
      });

      // Remove overlay from container
      if (bannerContainer) {
        bannerContainer.className = bannerContainer.className.replace(/banner-effect-\w+/g, '');
        const overlay = bannerContainer.querySelector('.banner-effect-overlay');
        if (overlay) overlay.remove();
      }

      if (effect && effect !== 'none') {
        console.log('Applying effect:', effect);
        if (effect === 'glow') {
          [bannerImg, settingsBanner].forEach(el => { // Apply new effects using inline styles for reliability
            if (el) {
              el.style.setProperty('box-shadow', '0 0 20px rgba(0, 255, 255, 0.6), 0 0 40px rgba(0, 255, 255, 0.4)', 'important');
              el.style.setProperty('border', '2px solid rgba(0, 255, 255, 0.5)', 'important');
              console.log('Applied glow to:', el.id, el.style.boxShadow);
            }
          });

        } else if (effect === 'blur-overlay') {
          if (bannerContainer) {
            let overlay = bannerContainer.querySelector('.banner-effect-overlay');
            if (!overlay) {
              overlay = document.createElement('div');
              overlay.className = 'banner-effect-overlay';
              overlay.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(4px); pointer-events: none; z-index: 2; border-radius: 1rem 1rem 0 0;';
              bannerContainer.style.position = 'relative';
              bannerContainer.appendChild(overlay);
            }
          }

        } else if (effect === 'gradient-overlay') {
          if (bannerContainer) {
            let overlay = bannerContainer.querySelector('.banner-effect-overlay');
            if (!overlay) {
              overlay = document.createElement('div');
              overlay.className = 'banner-effect-overlay';
              overlay.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(255, 0, 150, 0.4) 0%, rgba(0, 255, 255, 0.4) 50%, rgba(255, 255, 0, 0.4) 100%); pointer-events: none; z-index: 2; border-radius: 1rem 1rem 0 0;';
              bannerContainer.style.position = 'relative';
              bannerContainer.appendChild(overlay);
            }
          }

        } else if (effect === 'vignette') {
          if (bannerContainer) {
            let overlay = bannerContainer.querySelector('.banner-effect-overlay');
            if (!overlay) {
              overlay = document.createElement('div');
              overlay.className = 'banner-effect-overlay';
              overlay.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse at center, transparent 30%, rgba(0, 0, 0, 0.6) 100%); pointer-events: none; z-index: 2; border-radius: 1rem 1rem 0 0;';
              bannerContainer.style.position = 'relative';
              bannerContainer.appendChild(overlay);
            }
          }

        } else if (effect === 'neon-glow') {
          [bannerImg, settingsBanner].forEach(el => {
            if (el) {
              el.style.setProperty('box-shadow', '0 0 30px rgba(255, 0, 255, 0.8), 0 0 60px rgba(0, 255, 255, 0.6)', 'important');
              el.style.setProperty('border', '3px solid rgba(255, 0, 255, 0.7)', 'important');
              console.log('Applied neon-glow to:', el.id, el.style.boxShadow);
            }
          });
        }
        console.log('Banner effect applied:', effect);
      } else {
        console.log('No banner effect (none)');
      }
    }

    function applyAvatarEffect(effect) {
      console.log('Applying avatar effect:', effect);
      const avatarImg = document.getElementById('avatarImage');
      const settingsAvatar = document.getElementById('settingsAvatar');

      console.log('Avatar elements found:', { avatarImg: !!avatarImg, settingsAvatar: !!settingsAvatar });

      // Remove all effect classes and inline styles first
      [avatarImg, settingsAvatar].forEach(el => {
        if (!el) return;
        el.className = el.className.replace(/avatar-effect-\w+/g, '');  // Remove old classes
        el.style.boxShadow = '';  // Remove inline styles
        el.style.animation = '';
        el.style.filter = '';
        el.style.border = '';
        const ring = el.parentElement?.querySelector('.avatar-effect-ring');  // Remove overlay/ring elements
        if (ring) ring.remove();
      });

      if (effect && effect !== 'none') {
        console.log('Applying avatar effect:', effect);
        if (effect === 'glow') {  // Apply new effects using inline styles for reliability
          [avatarImg, settingsAvatar].forEach(el => {
            if (el) {
              el.style.setProperty('box-shadow', '0 0 10px rgba(99, 102, 241, 0.6), 0 0 20px rgba(59, 130, 246, 0.4), 0 0 30px rgba(236, 72, 153, 0.3)', 'important');
              el.style.setProperty('animation', 'glowPulse 3s ease-in-out infinite', 'important');
              console.log('Applied glow to avatar:', el.id, el.style.boxShadow);
            }
          });

        } else if (effect === 'pulse') {
          [avatarImg, settingsAvatar].forEach(el => {
            if (el) {
              el.style.setProperty('animation', 'pulseAvatar 2s ease-in-out infinite', 'important');
              console.log('Applied pulse to avatar:', el.id);
            }
          });

        } else if (effect === 'ring') {
          [avatarImg, settingsAvatar].forEach(el => {
            if (el && el.parentElement) {
              let ring = el.parentElement.querySelector('.avatar-effect-ring');
              if (!ring) {
                ring = document.createElement('div');
                ring.className = 'avatar-effect-ring';
                ring.style.cssText = 'position: absolute; inset: -8px; border-radius: 50%; background: conic-gradient(from 0deg, rgba(96,165,250,0.6), rgba(167,139,250,0.55), rgba(244,114,182,0.5), rgba(96,165,250,0.6)); filter: blur(2px); z-index: -1; pointer-events: none; animation: ringRotate 3s linear infinite;';
                el.parentElement.style.position = 'relative';
                el.parentElement.appendChild(ring);
              }
            }
          });

        } else if (effect === 'sparkle') {
          [avatarImg, settingsAvatar].forEach(el => {
            if (el) {
              el.style.setProperty('box-shadow', '0 0 8px rgba(255, 255, 255, 0.8), 0 0 16px rgba(255, 255, 255, 0.6)', 'important');
              el.style.setProperty('filter', 'drop-shadow(0 0 4px rgba(255, 255, 255, 0.8))', 'important');
              console.log('Applied sparkle to avatar:', el.id, el.style.boxShadow);
            }
          });
        }
        console.log('Avatar effect applied:', effect);
      } else {
        console.log('No avatar effect (none)');
      }
    }
  </script>
  <!-- Groups Modal -->
  <div id="groupsModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center fade-in">
    <div
      class="bg-discord-gray-700 w-full max-w-md rounded-lg shadow-2xl overflow-hidden transform transition-all scale-100">

      <!-- Header -->
      <div class="p-6 text-center">
        <h2 class="text-2xl font-bold text-white mb-2">Create or Join a Group</h2>
        <p class="text-discord-gray-300 text-sm">Hang out with friends in a new community.</p>
        <button onclick="closeGroupsModal()" class="absolute top-4 right-4 text-discord-gray-400 hover:text-white">
          <i data-feather="x" class="w-6 h-6"></i>
        </button>
      </div>

      <!-- Tabs -->
      <div class="flex border-b border-discord-gray-900 px-6">
        <button id="createGroupTab" onclick="switchGroupModalTab('create')"
          class="flex-1 pb-3 text-white border-b-2 border-discord-blurple font-medium transition-colors">
          Create Group
        </button>
        <button id="joinGroupTab" onclick="switchGroupModalTab('join')"
          class="flex-1 pb-3 text-discord-gray-400 border-b-2 border-transparent hover:text-white font-medium transition-colors">
          Join Group
        </button>
      </div>

      <!-- Content -->
      <div class="p-6">

        <!-- Create Form -->
        <div id="createGroupForm" class="space-y-4">
          <div>
            <label class="block text-xs font-bold text-discord-gray-400 uppercase mb-2">Group Name</label>
            <input type="text" id="newGroupNameInput"
              class="w-full bg-discord-gray-900 border border-black/30 rounded p-2 text-white focus:border-discord-blurple focus:outline-none transition-colors"
              placeholder="My Awesome Server">
          </div>
          <div>
            <label class="block text-xs font-bold text-discord-gray-400 uppercase mb-2">Description
              (Optional)</label>
            <input type="text" id="newGroupDescInput"
              class="w-full bg-discord-gray-900 border border-black/30 rounded p-2 text-white focus:border-discord-blurple focus:outline-none transition-colors"
              placeholder="A place for us to chill...">
          </div>
          <div class="bg-discord-gray-800 p-3 rounded flex items-center gap-3">
            <div class="bg-discord-gray-700 p-2 rounded-full">
              <i data-feather="shield" class="w-5 h-5 text-green-400"></i>
            </div>
            <div class="text-xs text-discord-gray-300">
              By creating a server, you agree to the Community Guidelines.
            </div>
          </div>
        </div>

        <!-- Join Form -->
        <div id="joinGroupForm" class="hidden space-y-4">
          <div class="text-center mb-4">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-discord-gray-600 mb-2">
              <i data-feather="compass" class="w-8 h-8 text-white"></i>
            </div>
            <p class="text-sm text-discord-gray-300">Enter an invite ID below to join an existing group.</p>
          </div>
          <div>
            <label class="block text-xs font-bold text-discord-gray-400 uppercase mb-2">Group ID</label>
            <input type="text" id="joinGroupIdInput"
              class="w-full bg-discord-gray-900 border border-black/30 rounded p-2 text-white focus:border-discord-blurple focus:outline-none transition-colors"
              placeholder="e.g. g123456">
          </div>
        </div>

      </div>

      <!-- Footer -->
      <div class="bg-discord-gray-800 p-4 flex justify-between items-center">
        <button onclick="closeGroupsModal()" class="text-sm text-white hover:underline">Back</button>

        <button onclick="createNewGroup()" id="createGroupBtn"
          class="bg-discord-blurple hover:bg-indigo-600 text-white px-6 py-2 rounded font-medium transition-colors shadow-md">
          Create Server
        </button>
        <button onclick="joinExistingGroup()" id="joinGroupBtn"
          class="hidden bg-discord-blurple hover:bg-indigo-600 text-white px-6 py-2 rounded font-medium transition-colors shadow-md">
          Join Server
        </button>
      </div>

    </div>
  </div>

  <script>
    function showGroupsModal() {
      const modal = document.getElementById('groupsModal');
      if (modal) {
        modal.classList.remove('hidden');
        switchGroupModalTab('create');
      }
    }

    function closeGroupsModal() {
      const modal = document.getElementById('groupsModal');
      if (modal) modal.classList.add('hidden');
    }

    function switchGroupModalTab(tab) {
      // Toggle tabs
      const createTab = document.getElementById('createGroupTab');
      const joinTab = document.getElementById('joinGroupTab');
      const createForm = document.getElementById('createGroupForm');
      const joinForm = document.getElementById('joinGroupForm');
      const createBtn = document.getElementById('createGroupBtn');
      const joinBtn = document.getElementById('joinGroupBtn');

      if (tab === 'create') {
        createTab?.classList.add('text-white', 'border-discord-blurple');
        createTab?.classList.remove('text-discord-gray-400', 'border-transparent');
        joinTab?.classList.remove('text-white', 'border-discord-blurple');
        joinTab?.classList.add('text-discord-gray-400', 'border-transparent');

        createForm?.classList.remove('hidden');
        joinForm?.classList.add('hidden');

        createBtn?.classList.remove('hidden');
        joinBtn?.classList.add('hidden');
      } else {
        joinTab?.classList.add('text-white', 'border-discord-blurple');
        joinTab?.classList.remove('text-discord-gray-400', 'border-transparent');
        createTab?.classList.remove('text-white', 'border-discord-blurple');
        createTab?.classList.add('text-discord-gray-400', 'border-transparent');

        joinForm?.classList.remove('hidden');
        createForm?.classList.add('hidden');

        joinBtn?.classList.remove('hidden');
        createBtn?.classList.add('hidden');
      }
    }
  </script>

  <!-- Call Animation Styles -->
  <style>
    @keyframes pulse-ring {
      0% {
        transform: translate(-50%, -50%) scale(0.6);
        opacity: 0.8;
      }

      100% {
        transform: translate(-50%, -50%) scale(2.2);
        opacity: 0;
      }
    }

    .pulse-avatar::before,
    .pulse-avatar::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      z-index: -1;
      animation: pulse-ring 2s infinite;
    }

    .pulse-avatar::after {
      animation-delay: 1s;
    }
  </style>

  <script>
    let callTimerInterval = null;

    async function startFakeCall(type) {
      const modal = document.getElementById('callModal');
      const avatarEl = document.getElementById('callAvatar');
      const nameEl = document.getElementById('callName');
      const statusEl = document.getElementById('callStatus');
      const typeIcon = document.getElementById('callTypeIcon');

      const currentName = document.getElementById('chatHeaderTitle').textContent;

      let avatarSrc = '/images/default_avatar.png';
      // Fix: Fetch real avatar
      if (typeof getUserAvatarUrl === 'function') {
        try {
          avatarSrc = await getUserAvatarUrl(currentName);
        } catch (e) { }
      } else {
        try {
          const res = await fetch(`/api/get-user?identifier=${encodeURIComponent(currentName)}`);
          const d = await res.json();
          if (d.success && d.user && d.user.avatar) avatarSrc = d.user.avatar;
        } catch (e) { }
      }

      if (modal) {
        modal.classList.remove('hidden');
        if (nameEl) nameEl.textContent = currentName;
        if (avatarEl) avatarEl.src = avatarSrc;
        if (statusEl) statusEl.textContent = type === 'video' ? 'Video Calling...' : 'Calling...';

        // Update Icon
        if (typeIcon) {
          typeIcon.innerHTML = type === 'video' ? '<i data-feather="video" class="w-6 h-6"></i>' : '<i data-feather="phone" class="w-6 h-6"></i>';
          feather.replace();
        }

        // Play sound (if available) - simulate using a loop
        // We'll just assume SoundEngine exists and play 'send' once for now to mimic start
        if (window.SoundEngine) window.SoundEngine.play('send');
      }
    }

    function endFakeCall() {
      const modal = document.getElementById('callModal');
      if (modal) modal.classList.add('hidden');
      if (window.SoundEngine) window.SoundEngine.play('logout'); // End sound
    }
  </script>

  <!-- Call UI Modal (Zalo Style) -->
  <div id="callModal"
    class="fixed inset-0 bg-gray-900/90 z-[60] hidden flex flex-col items-center justify-between py-12 fade-in backdrop-blur-sm">

    <!-- Header info -->
    <div class="flex flex-col items-center gap-4 mt-8">
      <div class="relative w-32 h-32">
        <div class="pulse-avatar w-32 h-32 rounded-full absolute inset-0"></div>
        <img id="callAvatar" src="/images/default_avatar.png"
          class="w-32 h-32 rounded-full object-cover border-4 border-white/20 relative z-10 shadow-2xl">
      </div>
      <div class="text-center mt-4">
        <h2 id="callName" class="text-3xl font-bold text-white mb-1">User</h2>
        <p id="callStatus" class="text-discord-gray-300 animate-pulse">Calling...</p>
      </div>
    </div>

    <!-- Center Status / Type -->
    <div id="callTypeIcon" class="p-4 rounded-full bg-white/10 text-white backdrop-blur">
      <!-- Icon inserted by JS -->
    </div>

    <!-- Footer Controls -->
    <div class="flex items-center gap-8 mb-8">
      <button class="p-4 rounded-full bg-gray-600 text-white hover:bg-gray-500 transition shadow-lg">
        <i data-feather="mic-off" class="w-6 h-6"></i>
      </button>

      <button onclick="endFakeCall()"
        class="p-5 rounded-full bg-red-500 text-white hover:bg-red-600 transition shadow-xl transform hover:scale-105">
        <i data-feather="phone-off" class="w-8 h-8 fill-current"></i>
      </button>

      <button class="p-4 rounded-full bg-gray-600 text-white hover:bg-gray-500 transition shadow-lg">
        <i data-feather="volume-2" class="w-6 h-6"></i>
      </button>
    </div>
  </div>

  <style>
    .sticker-picker {
      width: 280px;
      max-height: 320px;
      overflow-y: auto;
    }

    .sticker-picker-header {
      font-size: 12px;
      font-weight: 600;
      color: #b9bbbe;
      text-transform: uppercase;
      padding-bottom: 8px;
      border-bottom: 1px solid #40444b;
      margin-bottom: 8px;
    }

    .sticker-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .sticker-item {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.15s ease, background-color 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #40444b;
    }

    .sticker-item:hover {
      transform: scale(1.1);
      background-color: #5865f2;
    }

    .sticker-item img {
      width: 64px;
      height: 64px;
      object-fit: contain;
    }

    .sticker-message {
      max-width: 200px;
      margin: 4px 0;
    }

    .sticker-message img {
      width: 120px;
      height: 120px;
      object-fit: contain;
      border-radius: 8px;
      background: transparent;
    }

    /* Code Block Syntax Highlighting Styles */
    .code-block-wrapper {
      position: relative;
      margin: 8px 0;
    }

    .code-block-wrapper .hljs-pre {
      margin: 0;
      background: #282c34;
      border-radius: 8px;
      padding: 12px 16px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.5;
    }

    .code-block-wrapper .hljs-pre code {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      background: transparent;
      padding: 0;
    }

    .code-lang-label {
      position: absolute;
      top: 4px;
      left: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      color: #7d8590;
      background: #21262d;
      padding: 2px 6px;
      border-radius: 4px;
      z-index: 1;
    }

    .copy-code-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #373e47;
      border: none;
      border-radius: 4px;
      padding: 6px;
      cursor: pointer;
      color: #8b949e;
      opacity: 0;
      transition: opacity 0.2s, background 0.2s, color 0.2s;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .code-block-wrapper:hover .copy-code-btn {
      opacity: 1;
    }

    .copy-code-btn:hover {
      background: #484f58;
      color: #fff;
    }

    .copy-code-btn.copied {
      background: #238636;
      color: #fff;
    }

    /* Collapsible Secondary Sidebar Styles */
    #subPanelContainer {
      transition: width 0.2s ease-in-out, min-width 0.2s ease-in-out;
    }

    #subPanelContainer.collapsed {
      width: 56px !important;
      min-width: 56px !important;
      overflow: hidden;
    }

    #subPanelContainer.collapsed .sub-panel-content:not(#sub-panel-settings, #sub-panel-profile) {
      display: none !important;
    }

    /* Hide sidebar title when collapsed */
    #subPanelContainer.collapsed>header .sidebar-title {
      display: none;
    }

    /* Hide sub-panel headers (like "User Settings", "Profile", etc.) when collapsed */
    #subPanelContainer.collapsed .sub-panel-header {
      display: none;
    }

    /* Sub-panel items (any link/button with .sub-panel-item): Hide text, show only icons */
    #subPanelContainer.collapsed .sub-panel-item {
      font-size: 0 !important;
      justify-content: center;
      padding: 12px 0;
      display: flex;
      align-items: center;
    }

    /* Sub-panel item icons - ensure visible and centered */
    #subPanelContainer.collapsed .sub-panel-item i,
    #subPanelContainer.collapsed .sub-panel-item svg {
      font-size: 1.25rem;
      width: 20px;
      height: 20px;
      margin: 0 !important;
      display: inline-block;
      visibility: visible;
    }

    /* Hide text spans in sub-panel items */
    #subPanelContainer.collapsed .sub-panel-item span {
      display: none !important;
    }

    /* Settings tabs: Hide text, show only icons (separate class) */
    #subPanelContainer.collapsed .settings-tab {
      font-size: 0 !important;
      justify-content: center;
      padding: 12px 0;
      display: flex;
      align-items: center;
    }

    /* Settings tab icons - ensure visible and centered */
    #subPanelContainer.collapsed .settings-tab i,
    #subPanelContainer.collapsed .settings-tab svg {
      font-size: 1.25rem;
      width: 20px;
      height: 20px;
      margin: 0 !important;
      display: inline-block;
      visibility: visible;
    }

    /* Hide text spans in settings tabs */
    #subPanelContainer.collapsed .settings-tab span {
      display: none !important;
    }

    /* User Panel Footer - when sidebar is collapsed */
    /* The footer is: div.flex-shrink-0.h-14.bg-discord-gray-500/30.flex.items-center.justify-between.px-3 */
    /* It has 2 children: 1) avatar+name div (flex-1), 2) icons div */

    /* Hide the avatar and username section when collapsed */
    #subPanelContainer.collapsed .flex-shrink-0.h-14>div.flex-1 {
      display: none !important;
    }

    /* Make the footer center its content when collapsed */
    #subPanelContainer.collapsed .flex-shrink-0.h-14 {
      justify-content: center !important;
      padding: 8px 0 !important;
    }

    /* Center the icon buttons container when collapsed */
    #subPanelContainer.collapsed .flex-shrink-0.h-14>div.flex.items-center:not(.flex-1) {
      display: flex !important;
      justify-content: center !important;
      width: 100% !important;
      margin: 0 !important;
    }

    /* Hide logout button when collapsed */
    #subPanelContainer.collapsed .flex-shrink-0.h-14 a[href="/login.html"] {
      display: none !important;
    }

    /* Reduce padding on footer buttons when collapsed */
    #subPanelContainer.collapsed .flex-shrink-0.h-14 button {
      padding: 2px !important;
    }

    /* Rotate chevron when collapsed */
    #subPanelContainer.collapsed #sidebarCollapseBtn i {
      transform: rotate(180deg);
    }

    #sidebarCollapseBtn i {
      transition: transform 0.2s ease-in-out;
    }
  </style>

  <!-- Robust Auto-Fix & Cleanup Script -->
  <script>
    (function () {
      // 1. Remove any "ghost" text nodes that might have leaked into body/head
      // This defends against browser caching of the malformed HTML state
      function cleanGhostText() {
        const patterns = ['Rotate chevron', 'subPanelContainer', 'margin-right: 0'];
        [document.body, document.head].forEach(root => {
          if (!root) return;
          Array.from(root.childNodes).forEach(node => {
            if (node.nodeType === 3) { // Text node
              const text = node.textContent;
              if (patterns.some(p => text.includes(p))) {
                node.remove();
              }
            }
          });
        });
      }

      // Run cleanup immediately and on load
      cleanGhostText();
      document.addEventListener('DOMContentLoaded', cleanGhostText);

      // 2. One-time Sidebar Reset to ensure clean state
      if (!sessionStorage.getItem('fix_sidebar_v2')) {
        localStorage.removeItem('sidebarCollapsed');
        sessionStorage.setItem('fix_sidebar_v2', 'true');
        document.addEventListener('DOMContentLoaded', () => {
          const sidebar = document.getElementById('subPanelContainer');
          if (sidebar) sidebar.classList.remove('collapsed');
        });
      }

      // 3. Force Icon Refresh to ensure settings icons etc are visible
      document.addEventListener('DOMContentLoaded', () => {
        // Force re-render of feather icons if they exist
        if (window.feather) {
          setTimeout(() => window.feather.replace(), 100);
          setTimeout(() => window.feather.replace(), 500); // Double tap for safety
        }
      });
    })();
  </script>

  <!-- Code Block Copy Function -->
  <script>
    function copyCodeBlock(blockId) {
      const codeEl = document.getElementById(blockId);
      if (!codeEl) return;

      const code = codeEl.textContent;
      navigator.clipboard.writeText(code).then(() => {
        // Find the copy button in the parent wrapper
        const wrapper = codeEl.closest('.code-block-wrapper');
        const btn = wrapper?.querySelector('.copy-code-btn');
        if (btn) {
          btn.classList.add('copied');
          btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
          setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
          }, 2000);
        }
      }).catch(err => {
        console.error('Failed to copy code:', err);
      });
    }
  </script>

  <!-- Collapsible Sidebar Function -->
  <script>
    function toggleSidebarCollapse() {
      const sidebar = document.getElementById('subPanelContainer');
      if (!sidebar) return;

      const isCollapsed = sidebar.classList.toggle('collapsed');
      localStorage.setItem('sidebarCollapsed', isCollapsed ? 'true' : 'false');

      // Update button icon
      const btn = document.getElementById('sidebarCollapseBtn');
      if (btn) {
        feather.replace();
      }
    }

    // Initialize sidebar state on page load
    document.addEventListener('DOMContentLoaded', () => {
      const savedState = localStorage.getItem('sidebarCollapsed');
      if (savedState === 'true') {
        const sidebar = document.getElementById('subPanelContainer');
        if (sidebar) {
          sidebar.classList.add('collapsed');
        }
      }
    });
  </script>

  <!-- Sticker Picker JavaScript -->
  <script>
    // Available stickers
    const AVAILABLE_STICKERS = [
      { id: 'bear_crying', name: 'Bear Crying', src: '/files/stickers/bear_crying.png' },
      { id: 'bear_laughing', name: 'Bear Laughing', src: '/files/stickers/bear_laughing.png' },
      { id: 'bear_like', name: 'Bear Like', src: '/files/stickers/bear_like.png' },
      { id: 'boy_crying', name: 'Boy Crying', src: '/files/stickers/boy_crying.png' },
      { id: 'boy_excited', name: 'Boy Excited', src: '/files/stickers/boy_excited.png' },
      { id: 'cat_celebrate', name: 'Cat Celebrate', src: '/files/stickers/cat_celebrate.png' },
      { id: 'cat_laughing', name: 'Cat Laughing', src: '/files/stickers/cat_laughing.png' },
      { id: 'crying', name: 'Crying', src: '/files/stickers/crying.png' },
      { id: 'girl_crying', name: 'Girl Crying', src: '/files/stickers/girl_crying.png' },
      { id: 'girl_excited', name: 'Girl Excited', src: '/files/stickers/girl_excited.png' },
      { id: 'girl_happy', name: 'Girl Happy', src: '/files/stickers/girl_happy.png' },
      { id: 'good_job', name: 'Good Job', src: '/files/stickers/good_job.png' },
      { id: 'great_job', name: 'Great Job', src: '/files/stickers/great_job.png' },
      { id: 'hand_heart', name: 'Hand Heart', src: '/files/stickers/hand_heart.png' },
      { id: 'happy', name: 'Happy', src: '/files/stickers/happy.png' },
      { id: 'happy_cat', name: 'Happy Cat', src: '/files/stickers/happy_cat.png' },
      { id: 'heart', name: 'Heart', src: '/files/stickers/heart.png' },
      { id: 'heart_bubble', name: 'Heart Bubble', src: '/files/stickers/heart_bubble.png' },
      { id: 'heart_smile', name: 'Heart Smile', src: '/files/stickers/heart_smile.png' },
      { id: 'kola_like', name: 'Kola Like', src: '/files/stickers/kola_like.png' },
      { id: 'laugh', name: 'Laugh', src: '/files/stickers/laugh.png' },
      { id: 'star', name: 'Star', src: '/files/stickers/star.png' },
      { id: 'star_happy', name: 'Star Happy', src: '/files/stickers/star_happy.png' },
      { id: 'thumbs_up', name: 'Thumbs Up', src: '/files/stickers/thumbs_up.png' }
    ];

    // --- Account Settings Logic ---
    let pendingAvatar = null;
    let pendingBanner = null;
    let pendingUsertag = null;

    // Prompt functions for edit buttons
    function promptUsernameEdit() {
      alert("Changing username is not supported yet.");
    }

    function promptEmailEdit() {
      alert("Changing email is not supported yet.");
    }

    function promptUsertagEdit() {
      const current = document.getElementById('currentUsertag').innerText;
      const newVal = prompt("Enter new Usertag (e.g. @CoolUser):", current);
      if (newVal !== null && newVal !== current) {
        document.getElementById('currentUsertag').innerText = newVal;
        pendingUsertag = newVal;
        settingsChanged = true;
        updateSaveButtonVisibility();
      }
    }

    // Avatar/Banner Upload Listeners
    document.addEventListener('DOMContentLoaded', () => {
      const avatarInput = document.getElementById('settingsAvatarUpload');
      const bannerInput = document.getElementById('settingsBannerUpload');

      if (avatarInput) {
        avatarInput.addEventListener('change', function (e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (evt) {
            document.getElementById('settingsAvatar').src = evt.target.result;
            pendingAvatar = evt.target.result; // Data URL
            settingsChanged = true;
            updateSaveButtonVisibility();
          };
          reader.readAsDataURL(file);
        });
      }

      if (bannerInput) {
        bannerInput.addEventListener('change', function (e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (evt) {
            document.getElementById('settingsBanner').src = evt.target.result;
            pendingBanner = evt.target.result; // Data URL
            settingsChanged = true;
            updateSaveButtonVisibility();
          };
          reader.readAsDataURL(file);
        });
      }
    });

    // Helper to persist account settings
    async function persistAccountSettings() {
      const username = localStorage.getItem('username');
      if (!username) return;

      const payload = {
        username: username,
      };

      let hasChanges = false;

      if (pendingAvatar) {
        payload.avatar = pendingAvatar;
        hasChanges = true;
      }
      if (pendingBanner) {
        payload.banner = pendingBanner;
        hasChanges = true;
      }
      if (pendingUsertag) {
        payload.usertag = pendingUsertag;
        hasChanges = true;
      }

      if (!hasChanges) return;

      try {
        const res = await fetch('/api/update-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
          // Update local storage if needed
          if (data.user.avatar) localStorage.setItem('avatar', data.user.avatar);
          if (data.user.banner) localStorage.setItem('banner', data.user.banner);
          if (data.user.usertag) localStorage.setItem('usertag', data.user.usertag);

          // Clear pending
          pendingAvatar = null;
          pendingBanner = null;
          pendingUsertag = null;

          // Refresh profile UI if function exists
          if (typeof loadUserProfile === 'function') loadUserProfile();
        } else {
          console.error("Failed to update profile:", data.error);
          alert("Failed to update profile: " + data.error);
        }
      } catch (err) {
        console.error("Error saving profile:", err);
        alert("Error saving profile settings.");
      }
    }

    // Current active sticker picker (to track which input to send to)
    let activeStickerPickerId = null;

    // Initialize sticker pickers with content
    function initStickerPickers() {
      const pickerIds = ['communityStickerPicker', 'friendsStickerPicker', 'groupStickerPicker'];

      pickerIds.forEach(pickerId => {
        const picker = document.getElementById(pickerId);
        if (!picker) return;

        // Build sticker picker HTML
        let html = '<div class="sticker-picker-header">Stickers</div>';
        html += '<div class="sticker-grid">';

        AVAILABLE_STICKERS.forEach(sticker => {
          html += `
            <div class="sticker-item" onclick="sendSticker('${sticker.id}', '${sticker.src}')" title="${sticker.name}">
              <img src="${sticker.src}" alt="${sticker.name}" loading="lazy">
            </div>
          `;
        });

        html += '</div>';
        picker.innerHTML = html;
      });
    }

    // Toggle sticker picker visibility
    function toggleStickerPicker(pickerId) {
      const picker = document.getElementById(pickerId);
      if (!picker) return;

      // Close all other pickers first
      const allPickers = document.querySelectorAll('.sticker-picker');
      allPickers.forEach(p => {
        if (p.id !== pickerId) p.classList.add('hidden');
      });

      // Close emoji pickers too
      const emojiPickers = document.querySelectorAll('[id$="EmojiPicker"]');
      emojiPickers.forEach(p => p.classList.add('hidden'));

      // Toggle this picker
      picker.classList.toggle('hidden');
      activeStickerPickerId = picker.classList.contains('hidden') ? null : pickerId;
    }

    // Send a sticker message
    function sendSticker(stickerId, stickerSrc) {
      // Determine which chat we're in based on active picker
      let chatType = 'community';
      if (activeStickerPickerId === 'friendsStickerPicker') {
        chatType = 'friends';
      } else if (activeStickerPickerId === 'groupStickerPicker') {
        chatType = 'group';
      }

      // Close the picker
      if (activeStickerPickerId) {
        document.getElementById(activeStickerPickerId)?.classList.add('hidden');
        activeStickerPickerId = null;
      }

      // Send sticker based on chat type
      if (chatType === 'friends') {
        sendFriendSticker(stickerId, stickerSrc);
      } else if (chatType === 'group') {
        sendGroupSticker(stickerId, stickerSrc);
      } else {
        sendCommunitySticker(stickerId, stickerSrc);
      }
    }

    // Helper for unique IDs
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Send sticker to community chat
    async function sendCommunitySticker(stickerId, stickerSrc) {
      const username = localStorage.getItem('username') || 'Anonymous';
      const tempId = generateUUID();

      const payload = {
        id: tempId,
        username,
        message: `[sticker:${stickerId}]`,
        type: 'sticker',
        sticker_src: stickerSrc,
        room: 'community',
        ts: Date.now() / 1000
      };

      // Optimistic Render
      const container = document.getElementById('chatMessagesCommunity');
      if (container) {
        const el = await createDiscordMessage(payload);
        el.setAttribute('data-msg-id', tempId);
        container.appendChild(el);
        container.scrollTop = container.scrollHeight;
      }

      // Send to backend
      try {
        await fetch('/api/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error('Failed to send sticker:', err);
      }
    }

    // Send sticker to friend DM
    async function sendFriendSticker(stickerId, stickerSrc) {
      if (!activeFriendChat) return;

      const username = localStorage.getItem('username') || 'Anonymous';

      const payload = {
        from: username,
        to: activeFriendChat,
        message: `[sticker:${stickerId}]`,
        type: 'sticker',
        sticker_src: stickerSrc,
        ts: Date.now() / 1000
      };

      // Optimistic Render
      const container = document.getElementById('friendsChatMessages');
      if (container) {
        const el = await createDiscordMessage({ ...payload, username: username });
        container.appendChild(el);
        container.scrollTop = container.scrollHeight;
      }

      // Send to backend
      try {
        await fetch('/api/dm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error('Failed to send friend sticker:', err);
      }
    }

    // Send sticker to group chat
    async function sendGroupSticker(stickerId, stickerSrc) {
      const channelName = document.getElementById('groupChatChannelName')?.textContent || 'general';
      if (!currentGroupId) return;

      const username = localStorage.getItem('username') || 'Anonymous';

      const payload = {
        groupId: currentGroupId,
        channel: channelName,
        username,
        message: `[sticker:${stickerId}]`,
        type: 'sticker',
        sticker_src: stickerSrc,
        ts: Date.now() / 1000
      };

      // Optimistic Render
      const container = document.getElementById('groupChatMessages');
      if (container) {
        const el = await createDiscordMessage(payload);
        container.appendChild(el);
        container.scrollTop = container.scrollHeight;
      }

      // Send to backend
      try {
        await fetch('/api/groups/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error('Failed to send group sticker:', err);
      }
    }

    // Close sticker picker when clicking outside
    document.addEventListener('click', function (e) {
      const pickers = document.querySelectorAll('.sticker-picker');
      const stickerBtns = document.querySelectorAll('[onclick*="toggleStickerPicker"]');

      let clickedInsidePicker = false;
      pickers.forEach(p => {
        if (p.contains(e.target)) clickedInsidePicker = true;
      });
      stickerBtns.forEach(btn => {
        if (btn.contains(e.target)) clickedInsidePicker = true;
      });

      if (!clickedInsidePicker) {
        pickers.forEach(p => p.classList.add('hidden'));
        activeStickerPickerId = null;
      }
    });

    // Initialize sticker pickers on DOM ready
    document.addEventListener('DOMContentLoaded', initStickerPickers);
  </script>

  <!-- QR Code Library (qrcode.js from CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- QR Code Functions -->
  <script>
    let currentQRUsername = null;
    let qrCodeInstance = null;

    function showQRCode() {
      const username = document.getElementById('uvUsername')?.textContent;
      if (!username || username === 'N/A') return;

      currentQRUsername = username;
      const modal = document.getElementById('qrCodeModal');
      const container = document.getElementById('qrCodeContainer');
      const usernameEl = document.getElementById('qrCodeUsername');

      // Update username display
      usernameEl.textContent = `@${username}`;

      // Clear previous QR
      container.innerHTML = '';

      // Generate QR code with profile link
      const profileLink = `zylo://u/${username}`;

      try {
        qrCodeInstance = new QRCode(container, {
          text: profileLink,
          width: 192,
          height: 192,
          colorDark: '#1a1a2e',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });
      } catch (e) {
        // Fallback if library not loaded
        container.innerHTML = `
          <div class="w-48 h-48 flex items-center justify-center bg-gray-100 text-gray-500 text-center p-4 rounded">
            <div>
              <div class="text-2xl mb-2">üîó</div>
              <div class="text-sm">${profileLink}</div>
            </div>
          </div>
        `;
      }

      modal.classList.remove('hidden');
      feather.replace();
    }

    function closeQRModal() {
      const modal = document.getElementById('qrCodeModal');
      modal.classList.add('hidden');
      qrCodeInstance = null;
    }

    function copyProfileLink() {
      if (!currentQRUsername) return;
      const link = `zylo://u/${currentQRUsername}`;

      navigator.clipboard.writeText(link).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i data-feather="check" class="w-4 h-4 inline mr-2"></i>Copied!';
        btn.classList.add('bg-green-600');
        btn.classList.remove('bg-discord-blurple');
        feather.replace();

        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove('bg-green-600');
          btn.classList.add('bg-discord-blurple');
          feather.replace();
        }, 2000);
      }).catch(() => {
        alert('Failed to copy link');
      });
    }

    // Close QR modal on click outside
    document.getElementById('qrCodeModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'qrCodeModal') closeQRModal();
    });
  </script>

  <!-- Apps Modal -->
  <div id="appsModal"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center px-4">
    <div class="bg-discord-gray-800 text-discord-gray-300 w-full max-w-md p-6 rounded-xl shadow-2xl">
      <div class="flex items-center justify-between mb-4">
        <h3 id="appModalTitle" class="text-lg font-semibold text-white">App</h3>
        <button onclick="closeAppModal()" class="text-discord-gray-400 hover:text-red-500">
          <i data-feather="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div id="appModalContent" class="min-h-[200px]">
        <!-- App content rendered here -->
      </div>
    </div>
  </div>

  <script>
    // Apps Modal Functions
    let currentApp = null;

    function openAppModal(appName) {
      currentApp = appName;
      const modal = document.getElementById('appsModal');
      const title = document.getElementById('appModalTitle');
      const content = document.getElementById('appModalContent');

      const apps = {
        menu: {
          title: 'üì± Apps & Tools',
          render: () => `
            <div class="grid grid-cols-2 gap-3 p-2">
              <button onclick="openAppModal('calculator')" class="p-4 rounded-xl bg-discord-gray-700 hover:bg-discord-gray-600 transition text-center group">
                <div class="text-3xl mb-2">üßÆ</div>
                <div class="text-sm font-medium text-gray-300 group-hover:text-white">Calculator</div>
              </button>
              <button onclick="openAppModal('calendar')" class="p-4 rounded-xl bg-discord-gray-700 hover:bg-discord-gray-600 transition text-center group">
                <div class="text-3xl mb-2">üìÖ</div>
                <div class="text-sm font-medium text-gray-300 group-hover:text-white">Calendar</div>
              </button>
              <button onclick="openAppModal('speedtest')" class="p-4 rounded-xl bg-discord-gray-700 hover:bg-discord-gray-600 transition text-center group">
                <div class="text-3xl mb-2">‚ö°</div>
                <div class="text-sm font-medium text-gray-300 group-hover:text-white">Speed Test</div>
              </button>
              <button onclick="openAppModal('notes')" class="p-4 rounded-xl bg-discord-gray-700 hover:bg-discord-gray-600 transition text-center group">
                <div class="text-3xl mb-2">üìù</div>
                <div class="text-sm font-medium text-gray-300 group-hover:text-white">Notes</div>
              </button>
              <button onclick="openAppModal('timer')" class="p-4 rounded-xl bg-discord-gray-700 hover:bg-discord-gray-600 transition text-center group">
                <div class="text-3xl mb-2">‚è±Ô∏è</div>
                <div class="text-sm font-medium text-gray-300 group-hover:text-white">Timer</div>
              </button>
              <button onclick="openAppModal('colorpicker')" class="p-4 rounded-xl bg-discord-gray-700 hover:bg-discord-gray-600 transition text-center group">
                <div class="text-3xl mb-2">üé®</div>
                <div class="text-sm font-medium text-gray-300 group-hover:text-white">Colors</div>
              </button>
            </div>
          `
        },
        calculator: {
          title: 'üßÆ Calculator',
          render: () => `
            <div class="bg-discord-gray-700 p-4 rounded-lg">
              <input type="text" id="calcDisplay" class="w-full bg-discord-gray-900 text-white text-2xl text-right p-3 rounded mb-3" readonly value="0">
              <div class="grid grid-cols-4 gap-2">
                ${['7', '8', '9', '/', '4', '5', '6', '*', '1', '2', '3', '-', 'C', '0', '=', '+'].map(b =>
            `<button onclick="calcPress('${b}')" class="p-3 rounded ${b.match(/[0-9.]/) ? 'bg-discord-gray-600' : 'bg-discord-blurple'} hover:opacity-80 text-white font-bold">${b}</button>`
          ).join('')}
              </div>
            </div>
          `
        },
        calendar: {
          title: 'üìÖ Calendar',
          render: () => {
            const now = new Date();
            const month = now.toLocaleString('default', { month: 'long' });
            const year = now.getFullYear();
            const today = now.getDate();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

            let days = '';
            for (let i = 0; i < firstDay; i++) days += '<div></div>';
            for (let d = 1; d <= daysInMonth; d++) {
              const isToday = d === today ? 'bg-discord-blurple text-white' : 'bg-discord-gray-700 hover:bg-discord-gray-600';
              days += `<div class="p-2 text-center rounded ${isToday} cursor-pointer">${d}</div>`;
            }

            return `
              <div class="text-center mb-4">
                <div class="text-xl font-bold text-white">${month} ${year}</div>
              </div>
              <div class="grid grid-cols-7 gap-1 text-xs text-center">
                <div class="text-discord-gray-400 font-bold">Sun</div>
                <div class="text-discord-gray-400 font-bold">Mon</div>
                <div class="text-discord-gray-400 font-bold">Tue</div>
                <div class="text-discord-gray-400 font-bold">Wed</div>
                <div class="text-discord-gray-400 font-bold">Thu</div>
                <div class="text-discord-gray-400 font-bold">Fri</div>
                <div class="text-discord-gray-400 font-bold">Sat</div>
                ${days}
              </div>
            `;
          }
        },
        speedtest: {
          title: '‚ö° Speed Test',
          render: () => `
            <div class="text-center">
              <div id="speedResult" class="text-6xl font-bold text-white mb-2">--</div>
              <div class="text-discord-gray-400 mb-4">Mbps (Download)</div>
              <button onclick="runSpeedTest()" class="px-6 py-3 bg-discord-blurple hover:bg-opacity-80 text-white rounded-lg font-medium">
                Run Test
              </button>
              <p class="text-xs text-discord-gray-500 mt-4">Note: Simulated test for demo</p>
            </div>
          `
        },
        notes: {
          title: 'üìù Quick Notes',
          render: () => `
            <textarea id="quickNotes" class="w-full h-48 bg-discord-gray-700 text-white p-3 rounded-lg resize-none" placeholder="Type your notes here...">${localStorage.getItem('quickNotes') || ''}</textarea>
            <button onclick="saveNotes()" class="mt-2 w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">Save Notes</button>
          `
        },
        timer: {
          title: '‚è±Ô∏è Timer',
          render: () => `
            <div class="text-center">
              <div id="timerDisplay" class="text-6xl font-mono font-bold text-white mb-4">00:00</div>
              <div class="flex gap-2 justify-center mb-4">
                <input type="number" id="timerMinutes" class="w-20 bg-discord-gray-700 text-white p-2 rounded text-center" placeholder="Min" value="5">
                <span class="text-2xl text-white">:</span>
                <input type="number" id="timerSeconds" class="w-20 bg-discord-gray-700 text-white p-2 rounded text-center" placeholder="Sec" value="00">
              </div>
              <div class="flex gap-2 justify-center">
                <button onclick="startTimer()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">Start</button>
                <button onclick="stopTimer()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Stop</button>
                <button onclick="resetTimer()" class="px-4 py-2 bg-discord-gray-600 hover:bg-discord-gray-500 text-white rounded-lg">Reset</button>
              </div>
            </div>
          `
        },
        colorpicker: {
          title: 'üé® Color Picker',
          render: () => `
            <div class="space-y-4">
              <div id="colorPreview" class="w-full h-24 rounded-lg bg-discord-blurple border-2 border-discord-gray-600"></div>
              <input type="color" id="colorInput" class="w-full h-12 rounded cursor-pointer" value="#5865f2" onchange="updateColorPreview()">
              <input type="text" id="colorHex" class="w-full bg-discord-gray-700 text-white p-2 rounded text-center font-mono" value="#5865f2" onchange="updateFromHex()">
              <button onclick="copyColor()" class="w-full py-2 bg-discord-blurple hover:bg-opacity-80 text-white rounded-lg">Copy Hex Code</button>
            </div>
          `
        }
      };

      const app = apps[appName];
      if (!app) return;

      title.textContent = app.title;
      content.innerHTML = app.render();
      modal.classList.remove('hidden');
      feather.replace();
    }

    function closeAppModal() {
      document.getElementById('appsModal').classList.add('hidden');
      currentApp = null;
    }

    // Calculator functions
    let calcValue = '0';
    function calcPress(btn) {
      const display = document.getElementById('calcDisplay');
      if (btn === 'C') {
        calcValue = '0';
      } else if (btn === '=') {
        try { calcValue = String(eval(calcValue)); } catch { calcValue = 'Error'; }
      } else {
        if (calcValue === '0' && !btn.match(/[+\-*/]/)) calcValue = btn;
        else calcValue += btn;
      }
      display.value = calcValue;
    }

    // Speed test (simulated)
    function runSpeedTest() {
      const result = document.getElementById('speedResult');
      result.textContent = '...';
      let i = 0;
      const interval = setInterval(() => {
        result.textContent = Math.floor(Math.random() * 100 + 50);
        i++;
        if (i > 20) {
          clearInterval(interval);
          result.textContent = Math.floor(Math.random() * 50 + 75);
        }
      }, 100);
    }

    // Notes functions
    function saveNotes() {
      const notes = document.getElementById('quickNotes').value;
      localStorage.setItem('quickNotes', notes);
      alert('Notes saved!');
    }

    // Timer functions
    let timerInterval = null;
    let timerRemaining = 0;
    function startTimer() {
      if (timerInterval) return;
      const mins = parseInt(document.getElementById('timerMinutes').value) || 0;
      const secs = parseInt(document.getElementById('timerSeconds').value) || 0;
      timerRemaining = mins * 60 + secs;
      timerInterval = setInterval(tickTimer, 1000);
    }
    function tickTimer() {
      if (timerRemaining <= 0) {
        stopTimer();
        alert('Timer finished!');
        return;
      }
      timerRemaining--;
      const m = String(Math.floor(timerRemaining / 60)).padStart(2, '0');
      const s = String(timerRemaining % 60).padStart(2, '0');
      document.getElementById('timerDisplay').textContent = `${m}:${s}`;
    }
    function stopTimer() {
      clearInterval(timerInterval);
      timerInterval = null;
    }
    function resetTimer() {
      stopTimer();
      document.getElementById('timerDisplay').textContent = '00:00';
      timerRemaining = 0;
    }

    // Color picker functions
    function updateColorPreview() {
      const color = document.getElementById('colorInput').value;
      document.getElementById('colorPreview').style.backgroundColor = color;
      document.getElementById('colorHex').value = color;
    }
    function updateFromHex() {
      const hex = document.getElementById('colorHex').value;
      document.getElementById('colorInput').value = hex;
      document.getElementById('colorPreview').style.backgroundColor = hex;
    }
    function copyColor() {
      const hex = document.getElementById('colorHex').value;
      navigator.clipboard.writeText(hex).then(() => alert('Copied: ' + hex));
    }

    // Close app modal on click outside
    document.getElementById('appsModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'appsModal') closeAppModal();
    });

    // --- Moments / Diary Functions (Part A) ---
    async function loadMomentsFeed() {
      const container = document.getElementById('momentsFeed');
      if (!container) return;
      container.innerHTML = '<div class="text-center py-8"><div class="animate-spin w-8 h-8 border-2 border-discord-blurple border-t-transparent rounded-full mx-auto"></div></div>';

      try {
        const res = await fetch('/api/explore/posts');
        const data = await res.json();

        if (data.success) {
          if (data.posts.length === 0) {
            container.innerHTML = '<div class="text-center text-discord-gray-500 py-10">No moments yet. Share yours!</div>';
            return;
          }
          container.innerHTML = data.posts.map(post => renderMomentCard(post)).join('');
          feather.replace();
        }
      } catch (err) {
        console.error('Failed to load moments:', err);
        container.innerHTML = '<div class="text-center text-red-400">Failed to load feed</div>';
      }
    }

    window.applyThemePreset = function (val) {
      if (!val) return;
      if (val === 'midnight') {
        const midnight = {
          ui: { navbarBg: '#050505', sidebarBg: '#080808', panelBg: 'rgba(0,0,0,0.6)', mainBg: '#020617' },
          textColor: '#e2e8f0', accentColor: '#22d3ee',
          background: { mode: 'gradient', gradient: { from: '#020617', to: '#000000', angle: 135 } }
        };
        // Apply manually
        document.body.style.setProperty('--navbar-bg', midnight.ui.navbarBg);
        document.body.style.setProperty('--sidebar-bg', midnight.ui.sidebarBg);
        document.body.style.setProperty('--panel-bg', midnight.ui.panelBg);
        document.body.style.setProperty('--text-color', midnight.textColor);
        document.body.style.setProperty('--accent-color', midnight.accentColor);
        document.body.style.setProperty('--main-bg', midnight.ui.mainBg);
        // Try accessing global applyThemeBackground if available, else skip or polyfill
        if (typeof applyThemeBackground === 'function') applyThemeBackground(midnight.background);
      } else {
        if (typeof setTheme === 'function') setTheme(val);
        else console.error("setTheme is not defined");
      }
    };

    window.resetAppearanceSettings = function () {
      if (!confirm("Reset appearance to default?")) return;
      if (typeof setTheme === 'function') setTheme('dark');
      const presetSelect = document.getElementById('themePresetSelect');
      if (presetSelect) presetSelect.value = 'dark';
      const solidToggle = document.getElementById('solidBgToggle');
      if (solidToggle) solidToggle.checked = false;
      localStorage.removeItem('bgImageDataUrl');
      localStorage.removeItem('currentCustomTheme');
      alert("Appearance reset.");
    };

    // Explicit Settings Tab Switching
    document.addEventListener('DOMContentLoaded', () => {
      const tabs = document.querySelectorAll('.settings-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // 1. Deactivate all tabs
          tabs.forEach(t => t.classList.remove('active', 'bg-discord-gray-700', 'font-bold'));
          // 2. Hide all contents
          document.querySelectorAll('.settings-content').forEach(c => c.classList.add('hidden'));

          // 3. Activate clicked
          tab.classList.add('active', 'bg-discord-gray-700', 'font-bold');

          // 4. Show target
          const targetId = tab.dataset.target;
          const target = document.getElementById(targetId);
          if (target) target.classList.remove('hidden');
        });
      });

      // Default to General
      document.getElementById('tabBtnGeneral')?.click();
    });

    function renderMomentCard(post) {
      const isLiked = post.reactions && post.reactions.includes(localStorage.getItem('username'));
      const likeCount = post.reactions ? post.reactions.length : 0;
      const comments = post.comments || [];

      return `
        <div class="bg-discord-gray-800 rounded-lg p-4 shadow-sm animate-fadeIn">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-full bg-discord-gray-700 overflow-hidden">
               <img src="/images/default_avatar.png" class="w-full h-full object-cover">
            </div>
            <div>
              <div class="font-semibold text-white">${post.username}</div>
              <div class="text-xs text-discord-gray-400">${new Date(post.createdAt * 1000).toLocaleString()}</div>
            </div>
          </div>
          
          <div class="mb-3 text-discord-gray-100 whitespace-pre-wrap">${post.caption}</div>
          
          ${post.url ? `<div class="mb-3 rounded-lg overflow-hidden bg-black max-h-[400px] flex items-center justify-center">
            <img src="${post.url}" class="max-w-full max-h-[400px] object-contain" loading="lazy">
          </div>` : ''}
          
          <div class="flex items-center gap-4 border-t border-discord-gray-700 pt-3">
            <button onclick="reactToMoment('${post.id}')" class="flex items-center gap-2 ${isLiked ? 'text-red-500' : 'text-discord-gray-400 hover:text-red-400'} transition">
              <i data-feather="heart" class="${isLiked ? 'fill-current' : ''} w-5 h-5"></i>
              <span>${likeCount || 'Like'}</span>
            </button>
            <button onclick="document.getElementById('commentInput-${post.id}').focus()" class="flex items-center gap-2 text-discord-gray-400 hover:text-white transition">
              <i data-feather="message-square" class="w-5 h-5"></i>
              <span>Comment</span>
            </button>
          </div>

          <!-- Comments Section -->
          ${comments.length > 0 ? `
            <div class="mt-3 space-y-2 pl-4 border-l-2 border-discord-gray-700">
              ${comments.slice(-3).map(c => `
                <div class="text-sm">
                  <span class="font-semibold text-white text-xs">${c.username}</span>: 
                  <span class="text-discord-gray-300">${c.text}</span>
                </div>
              `).join('')}
              ${comments.length > 3 ? `<div class="text-xs text-discord-gray-500 cursor-pointer">View all ${comments.length} comments</div>` : ''}
            </div>
          ` : ''}
          
          <div class="mt-3 flex gap-2">
            <input id="commentInput-${post.id}" type="text" placeholder="Write a comment..." 
              class="flex-1 bg-discord-gray-900 border-none rounded-full px-4 py-2 text-sm text-white focus:ring-1 focus:ring-discord-blurple"
              onkeydown="if(event.key === 'Enter') commentOnMoment('${post.id}', this.value)">
          </div>
        </div>
      `;
    }

    async function reactToMoment(postId) {
      const username = localStorage.getItem('username');
      if (!username) return;

      try {
        const res = await fetch('/api/moments/react', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ postId, username })
        });
        const data = await res.json();
        if (data.success) {
          // Optimistic reload or targeted update could be better, but reload is easiest
          loadMomentsFeed();
        }
      } catch (e) { console.error(e); }
    }

    async function commentOnMoment(postId, text) {
      const username = localStorage.getItem('username');
      if (!username || !text.trim()) return;

      try {
        const res = await fetch('/api/moments/comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ postId, username, comment: text })
        });
        const data = await res.json();
        if (data.success) {
          loadMomentsFeed();
        }
      } catch (e) { console.error(e); }
    }

    // Share Button Logic
    document.getElementById('momentsShareBtn')?.addEventListener('click', async () => {
      const caption = document.getElementById('momentsCaption').value;
      const fileInput = document.getElementById('momentsFile');
      const file = fileInput.files[0];
      const username = localStorage.getItem('username');

      if (!username) return alert('Please log in');
      if (!caption && !file) return; // Empty

      const btn = document.getElementById('momentsShareBtn');
      btn.disabled = true;
      btn.textContent = 'Posting...';

      const payload = {
        username,
        caption,
        fileData: null,
        fileName: null
      };

      if (file) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          payload.fileData = e.target.result;
          payload.fileName = file.name;
          await sendPost(payload);
        };
        reader.readAsDataURL(file);
      } else {
        // Usually API requires fileData for image posts, but let's try just caption if allowed? 
        // Looking at backend: "if not username or not file_data: return error". 
        // So we MUST have a file? User request said "Add photos...". 
        // If backend insists on file, we might need a dummy or change backend.
        // Let's assume file is required based on backend code I saw.
        if (!file) {
          alert("Please attach an image (Backend requires it currently).");
          btn.disabled = false;
          btn.textContent = 'Share';
          return;
        }
      }
    });

    async function sendPost(payload) {
      try {
        const res = await fetch('/api/explore/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('momentsCaption').value = '';
          document.getElementById('momentsFile').value = '';
          loadMomentsFeed();
        } else {
          alert('Failed: ' + data.error);
        }
      } catch (e) {
        console.error(e);
        alert('Error posting');
      } finally {
        const btn = document.getElementById('momentsShareBtn');
        btn.disabled = false;
        btn.textContent = 'Share';
      }
    }

    // Auto-load feed handler
    window.addEventListener('load', () => {
      // Hook into switchTab legacy global if possible, or just poll
      const oldSwitch = window.switchTab;
      window.switchTab = function (tab) {
        if (oldSwitch) oldSwitch(tab);
        if (tab === 'moments') loadMomentsFeed();
        if (tab === 'cloud') loadCloudFiles(); // Load cloud files when tab is active
      };
    });

  </script>
  <script src="/files/sw-register.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      feather.replace();
    });
  </script>
  <script src="/files/vendor/cropper.min.js"></script>

  <script>
    // Cloud Functions
    async function loadCloudFiles() {
      const username = localStorage.getItem('username');
      if (!username) return;

      const container = document.getElementById('filesListContainer');
      container.innerHTML = '<div class="col-span-full text-center py-8"><div class="animate-spin w-8 h-8 border-2 border-discord-blurple border-t-transparent rounded-full mx-auto"></div></div>';

      try {
        const res = await fetch(`/api/cloud/files?username=${encodeURIComponent(username)}`);
        const data = await res.json();

        if (data.success && data.files.length > 0) {
          container.innerHTML = data.files.map(file => {
            let previewHtml = '';
            // Backend stores 'url', frontend upload flow might have 'fileData' temporarily but we check url first
            const imgSrc = file.url || file.fileData;

            if (file.fileType.startsWith('image/') && imgSrc) {
              previewHtml = `<img src="${imgSrc}" class="w-10 h-10 rounded object-cover border border-discord-gray-600 bg-black">`;
            } else {
              previewHtml = `<div class="w-10 h-10 rounded bg-discord-gray-700 flex items-center justify-center text-2xl">${getFileIcon(file.fileType)}</div>`;
            }

            return `
            <div class="bg-discord-gray-800 p-3 rounded-lg flex items-center gap-3 group hover:bg-discord-gray-700 transition relative">
              ${previewHtml}
              <div class="overflow-hidden flex-1">
                <h4 class="text-sm font-medium text-white truncate" title="${file.fileName}">${file.fileName}</h4>
                <p class="text-xs text-discord-gray-400">${new Date(file.createdAt * 1000).toLocaleDateString()}</p>
              </div>
               <button onclick="deleteCloudFile('${file.id}')" class="p-2 text-red-400 opacity-0 group-hover:opacity-100 transition hover:bg-discord-gray-600 rounded">
                <i data-feather="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          `}).join('');
          feather.replace();
        } else {
          container.innerHTML = `
            <div class="col-span-full py-12 text-center text-discord-gray-500">
              <i data-feather="folder" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
              <p>No files yet. Upload your first file!</p>
            </div>
          `;
          feather.replace();
        }
      } catch (err) {
        console.error('Failed to load files:', err);
        container.innerHTML = '<p class="text-red-500 text-center col-span-full">Failed to load files.</p>';
      }
    }

    function getFileIcon(type) {
      if (!type) return '‚ùì';
      if (type.startsWith('image/')) return 'üñºÔ∏è';
      if (type.startsWith('video/')) return 'üé•';
      if (type.startsWith('audio/')) return 'üéµ';
      if (type.includes('pdf')) return 'üìÑ';
      if (type.includes('zip') || type.includes('compressed')) return 'üì¶';
      return 'üìÅ';
    }

    async function uploadCloudFile(files) {
      if (!files || files.length === 0) return;

      const username = localStorage.getItem('username');
      if (!username) return alert("Please log in first.");

      const progress = document.getElementById('cloudUploadProgress');
      progress.classList.remove('hidden');

      for (let file of files) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            await fetch('/api/cloud/upload', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                username,
                fileName: file.name,
                fileType: file.type,
                fileData: e.target.result
              })
            });
            loadCloudFiles(); // Refresh list
          } catch (err) {
            console.error('Upload failed:', err);
            alert('Failed to upload ' + file.name);
          }
        };
        reader.readAsDataURL(file);
      }

      setTimeout(() => progress.classList.add('hidden'), 2000);
    }

    async function deleteCloudFile(fileId) {
      if (!confirm("Delete this file?")) return;
      const username = localStorage.getItem('username');
      try {
        const res = await fetch('/api/cloud/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, fileId })
        });
        const data = await res.json();
        if (data.success) {
          loadCloudFiles();
        } else {
          alert("Delete failed: " + data.error);
        }
      } catch (err) {
        alert("Delete failed");
      }
    }

    // Initialize logic
    // Add drag-drop listeners
    const dropZone = document.getElementById('cloudUploadArea');
    if (dropZone) {
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-discord-blurple');
      });
      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-discord-blurple');
      });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-discord-blurple');
        uploadCloudFile(e.dataTransfer.files);
      });
    }

    // Helper for legacy calls
    window.refreshFilesList = loadCloudFiles;

    // Auto-load if settings is open (optional)
  </script>

  <!-- Mobile Bottom Navigation Bar -->
  <nav id="mobileBottomNav"
    class="fixed bottom-0 left-0 right-0 bg-discord-gray-800 border-t border-discord-gray-700 z-50 md:hidden">
    <div class="flex items-center justify-around h-14">
      <button id="mobileNavHome" onclick="mobileNavTo('messages')" class="mobile-nav-btn group" data-tab="messages">
        <i data-feather="message-circle" class="w-6 h-6 mb-0.5"></i>
        <span class="text-[10px]">DMs</span>
      </button>
      <button id="mobileNavCloud" onclick="mobileNavTo('cloud')" class="mobile-nav-btn group" data-tab="cloud">
        <i data-feather="cloud" class="w-6 h-6 mb-0.5"></i>
        <span class="text-[10px]">Cloud</span>
      </button>
      <button id="mobileNavSettings" onclick="mobileNavTo('settings')" class="mobile-nav-btn group" data-tab="settings">
        <i data-feather="settings" class="w-6 h-6 mb-0.5"></i>
        <span class="text-[10px]">Settings</span>
      </button>
      <button id="mobileNavProfile" onclick="mobileNavTo('profile')" class="mobile-nav-btn group" data-tab="profile">
        <i data-feather="user" class="w-6 h-6 mb-0.5"></i>
        <span class="text-[10px]">Profile</span>
      </button>
    </div>
  </nav>

  <style>
    /* Mobile Bottom Nav Styles */
    .mobile-nav-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      padding: 8px 0;
      color: var(--text-muted, #8e9297);
      transition: color 0.15s ease;
    }

    .mobile-nav-btn:hover,
    .mobile-nav-btn.active {
      color: var(--text-normal, #ffffff);
    }

    .mobile-nav-btn.active {
      color: var(--brand-primary, #5865f2);
    }

    /* Add bottom padding to main content when mobile nav is visible */
    @media (max-width: 767px) {
      body {
        padding-bottom: 56px;
      }

      /* Fix top spacing on mobile */
      .chat-area {
        margin-top: 0 !important;
        padding-top: 0 !important;
        height: calc(100dvh - 3.5rem - 3.5rem) !important;
        /* Adjust height: 100dvh - header - nav */
      }

      .chat-messages {
        padding-top: 1rem !important;
      }
    }

    @media (min-width: 768px) {
      #mobileBottomNav {
        display: none !important;
      }
    }
  </style>

  <script>
    // --- Mobile Profile Menu Functions ---
    window.openMobileProfileMenu = function () {
      const modal = document.getElementById('mobileProfileMenuModal');
      const content = document.getElementById('mobileProfileMenuContent');
      if (modal) {
        modal.classList.remove('hidden');
        // Animate in
        setTimeout(() => {
          content.classList.remove('translate-y-full');
        }, 10);
      }
    };

    window.closeMobileProfileMenu = function () {
      const modal = document.getElementById('mobileProfileMenuModal');
      const content = document.getElementById('mobileProfileMenuContent');
      if (modal && content) {
        content.classList.add('translate-y-full');
        setTimeout(() => {
          modal.classList.add('hidden');
        }, 200);
      }
    };

    window.selectMobileProfileTab = function (tabName) {
      closeMobileProfileMenu();
      // Find the desktop/hidden button and trigger click
      const btn = document.querySelector(`#profileTabs button[data-tab="${tabName}"]`);
      if (btn) btn.click();
    };
    // Mobile navigation function
    function mobileNavTo(tab) {
      navigateTo(tab);

      // Update active state
      document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tab) {
          btn.classList.add('active');
        }
      });

      feather.replace();
    }

    // Set initial active state based on current tab
    document.addEventListener('DOMContentLoaded', () => {
      const currentTab = localStorage.getItem('lastTab') || 'messages';
      const mobileBtn = document.querySelector(`.mobile-nav-btn[data-tab="${currentTab}"]`);
      if (mobileBtn) mobileBtn.classList.add('active');

      // Initialize Data
      loadGroups();

      feather.replace();
    });
  </script>
  <!-- Edit History Modal -->
  <div id="editHistoryModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-discord-gray-800 w-full max-w-lg rounded-md shadow-2xl flex flex-col max-h-[80vh]">
      <div class="p-4 border-b border-discord-gray-700 flex justify-between items-center">
        <h3 class="text-lg font-bold text-white">Message Edits</h3>
        <button onclick="closeEditHistory()" class="text-discord-gray-400 hover:text-white">
          <i data-feather="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div id="editHistoryContent" class="flex-1 overflow-y-auto p-4 space-y-4">
        <!-- Items go here -->
      </div>
    </div>
  </div>

  <script>
    function showEditHistory(history, currentContent, currentTs) {
      const modal = document.getElementById('editHistoryModal');
      const content = document.getElementById('editHistoryContent');
      if (!modal || !content) return;

      content.innerHTML = '';

      // Helper
      const createItem = (text, ts, isCurrent = false) => {
        const div = document.createElement('div');
        div.className = "flex flex-col gap-1";

        const timeStr = ts ? new Date(ts * 1000).toLocaleString() : 'Recently';

        div.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-xs text-discord-gray-400 font-mono">${timeStr}</span>
                     ${isCurrent ? '<span class="text-[10px] bg-discord-blurple text-white px-1.5 rounded uppercase font-bold tracking-wide">Current</span>' : ''}
                </div>
                <div class="bg-discord-gray-900 rounded p-3 text-discord-gray-200 text-sm whitespace-pre-wrap leading-relaxed">${window.parseDiscordMarkdown ? window.parseDiscordMarkdown(text) : text}</div>
             `;
        return div;
      };

      // Parse history (Oldest ?? Backend appends, so array is likely Oldest -> Newest or Newest -> Oldest?)
      // Backend: append({content: old}). So [Old1, Old2, Old3].
      // We want to show sequence.

      if (history && history.length > 0) {
        history.forEach(h => {
          content.appendChild(createItem(h.content, h.timestamp));
        });
      }

      // Add current
      content.appendChild(createItem(currentContent, currentTs || Date.now() / 1000, true));

      modal.classList.remove('hidden');
      feather.replace();
    }

    function closeEditHistory() {
      document.getElementById('editHistoryModal').classList.add('hidden');
    }

    // Listen for real-time edits
    if (typeof socket !== 'undefined') {
      socket.on('group_message_update', (data) => {
        // data = { groupId, channel, message }
        // Find element by timestamp (since ID might vary or not be set reliably in early versions)
        const ts = data.message.timestamp || data.message.ts;
        const el = document.querySelector(`[data-timestamp="${ts}"]`);

        if (el) {
          const bodyEl = el.querySelector('.msg-body-text');
          const parser = window.parseDiscordMarkdown || ((t) => t);
          if (bodyEl) {
            // Update content
            bodyEl.innerHTML = parser(data.message.message);

            // Re-attach (edited) label
            if (data.message.edited) {
              const span = document.createElement('span');
              span.className = "text-discord-gray-400 text-xs ml-1 italic cursor-pointer hover:underline hover:text-white transition-colors select-none";
              span.textContent = "(edited)";
              span.title = "View edit history";
              span.onclick = (e) => {
                e.stopPropagation();
                showEditHistory(data.message.history || [], data.message.message, data.message.editedAt);
              };
              bodyEl.appendChild(span);
            }
          }
        }
      });

      // Listen for read receipts
      socket.on('group_message_read_update', (data) => {
        // data = { groupId, channel, timestamp, readBy }
        const el = document.querySelector(`[data-timestamp="${data.timestamp}"]`);
        if (el) {
          // Find status span (it's the last child of header)
          // Structure: msgWrapper -> contentWrapper -> header -> [user, time, status]
          const contentWrapper = el.children[1]; // Avatar is 0, contentWrapper is 1
          if (contentWrapper) {
            const header = contentWrapper.children[0];
            if (header && header.children.length >= 3) {
              const statusSpan = header.children[2];
              const isRead = data.readBy && data.readBy.length > 1;
              if (isRead) {
                statusSpan.innerHTML = '<span class="text-blue-400" title="Read">‚úì‚úì</span>';
              }
            }
          }
        }
      });
    }

    // Auto-mark messages as read when channel opens
    window.markChannelRead = function (groupId, channelId) {
      if (!groupId || !channelId) return;

      const username = localStorage.getItem('savedUsername');
      if (!username) return;

      // Delay slightly to ensure render
      setTimeout(() => {
        const messages = document.querySelectorAll('#group-chat-messages > div');
        // Take last 50 messages to catch up
        const recent = Array.from(messages).slice(-50);

        recent.forEach(msg => {
          const ts = msg.getAttribute('data-timestamp');
          // Only mark if SENT (single check) - avoiding redundant calls if already read (checking UI state is hard, so just brute force for now or check backend)
          // Or better: Just fire requests, backend handles dedupe
          if (ts) {
            fetch('/api/groups/message/read', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                groupId,
                channel: channelId,
                timestamp: parseInt(ts),
                username
              })
            }).catch(e => console.log('Read receipt error', e)); // Silent fail
          }
        });
      }, 2000);
    };
    // --- Mute / DND Helpers ---
    function toggleFriendMute() {
      if (!activeFriendChat) return;
      const isMuted = window.toggleMute(activeFriendChat);
      updateMuteIcons();
      showToast(isMuted ? `Muted notifications for this user` : `Unmuted notifications`);
    }

    function toggleGroupMute() {
      if (!currentGroupId) return;
      const isMuted = window.toggleMute(currentGroupId);
      updateMuteIcons();
      showToast(isMuted ? `Muted notifications for this group` : `Unmuted group notifications`);
    }

    function updateMuteIcons() {
      // Friend Chat
      const friendBtn = document.getElementById('friendMuteBtn');
      if (friendBtn && activeFriendChat) {
        const muted = window.getMuteStatus(activeFriendChat);
        // Use bell-off if muted, bell if not
        const icon = muted ? 'bell-off' : 'bell';
        friendBtn.innerHTML = `<i data-feather="${icon}" class="w-5 h-5 ${muted ? 'text-red-400' : ''}"></i>`;
        if (window.feather) feather.replace();
      }

      // Group Panel
      const groupBtn = document.getElementById('groupMuteBtn');
      if (groupBtn && currentGroupId) {
        const muted = window.getMuteStatus(currentGroupId);
        const icon = muted ? 'bell-off' : 'bell';
        groupBtn.innerHTML = `<i data-feather="${icon}" class="w-4 h-4 ${muted ? 'text-red-400' : ''}"></i>`;
        if (window.feather) feather.replace();
      }
    }

    // Call updateMuteIcons when switching views
    // (This needs to be hooked into switchMessagesView or setActiveFriend/setActiveGroup)
    // For now, we'll rely on it being called manually or we can inject it.
    // Better: Hook into logic or use an interval/observer? 
    // Let's hook into `openDM` and `setActiveGroup` by ensuring we call updateMuteIcons there.

    // Simplest approach: Observe changes or just call it periodically/on-click is fine for now, 
    // but better to inject into the view switching logic. 
    // I'll add a global listener for 'viewChanged' if it existed, but it doesn't.
    // I will export updateMuteIcons to window and call it from the respective functions if I can find them,
    // or just rely on the user clicking for now, but that doesn't show initial state.
    // Let's expose it globally.
    window.updateMuteIcons = updateMuteIcons;

    // Initialize DND toggle state
    const dnd = document.getElementById('dndToggle');
    if (dnd) {
      dnd.checked = localStorage.getItem('doNotDisturb') === 'true';
    }

  </script>
</body>

</html>